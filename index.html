<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Licitaciones de Proyectos Ferroviarios</title>
    
    <!-- jQuery (requerido para Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- xlsx-js-style para leer y dar formato a archivos de Excel -->
    <script src="https://unpkg.com/xlsx-js-style/dist/xlsx.min.js"></script>
    
    <!-- Select2 for searchable dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- html2pdf para generar reportes en PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Librerías para manipulación de .docx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.34.1/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- SunEditor (Rich Text Editor) -->
    <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>

    <!-- Firebase App (el módulo principal de Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        /* ============================================= */
        /* === 1. RAÍZ Y ESTILOS BASE === */
        /* ============================================= */
        :root {
            --primary-color: #1E5B4F;
            --secondary-color: #A6802D;
            --accent-color: #9C2348;
            --success-color: #10B981;
            --danger-color: #EF4444;
        }        
        html { 
            font-size: 60%; 
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f2f5; 
        }
        /* ============================================= */
        /* === 2. UTILIDADES === */
        /* ============================================= */

        /* Clases de utilidad para aplicar la paleta de colores principal. */
        .bg-primary { background-color: var(--primary-color); }
        .text-primary { color: var(--primary-color); }
        .border-primary { border-color: var(--primary-color); }
        .focus\:ring-primary:focus { --tw-ring-color: var(--primary-color); }
        
        /* Clases de utilidad para el color secundario. */
        .bg-secondary { background-color: var(--secondary-color); }
        .text-secondary { color: var(--secondary-color); }
        .border-secondary { border-color: var(--secondary-color); }
        
        /* Clases de utilidad para el color de acento. */
        .bg-accent { background-color: var(--accent-color); }
        .text-accent { color: var(--accent-color); }
        .border-accent { border-color: var(--accent-color); }
        
        /* Clases de utilidad para colores de estado (éxito y peligro). */
        .bg-success { background-color: var(--success-color); }
        .hover\:bg-success-dark:hover { background-color: #059669; }
        
        .bg-danger { background-color: var(--danger-color); }
        .hover\:bg-danger-dark:hover { background-color: #DC2626; }
        
        /* Clase de utilidad para ocultar elementos. */
        .hidden { display: none; }

        /* Estilo para resaltar el texto que coincide con el término de búsqueda. */
        .highlight {
            background-color: #ffd966; /* Tailwind yellow-100 */
            border-radius: 2px;
        }
        /* ============================================= */
        /* === 3. COMPONENTES DE UI GENERALES === */
        /* ============================================= */

        .loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(255, 255, 255, 0.9); z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        /* Estilo y animación del spinner. */
        .loader .spinner { 
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; 
            border-left-color: var(--primary-color); animation: spin 1s ease infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilo para la pestaña activa en la barra de navegación. */
        .tab-btn.active { border-color: var(--primary-color); color: var(--primary-color); font-weight: bold; }

        /* Estilo para la tarjeta indicadora cuando está activa como filtro en el dashboard. */
        .indicator-card.active-filter {
            box-shadow: 0 0 0 2px var(--primary-color), 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }

        /* Estilo especial para resaltar la tarjeta de la semana actual en el dashboard. */
        .indicator-card.current-week-highlight {
            border-bottom: 3px solid var(--primary-color);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            background-color: #fcfdff;
        }
        /* ============================================= */
        /* === 4. TABLAS === */
        /* ============================================= */
        .table-container { 
            overflow-x: auto; 
            max-height: 455px;
            overflow-y: auto;
        }
        
        /* Table-container anterior
        .table-container {
            width: 100%;
            overflow-x: auto;
        }*/

        /* Altura específica para la tabla de histórico para un mejor layout. */
        #historical-table-container {
            max-height: 430px;
        }
        
        /* Estilos personalizados para la barra de scroll en navegadores WebKit (Chrome, Safari). */
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Encabezados de tabla fijos (sticky) para mantenerlos visibles al hacer scroll vertical. */
        .table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f1f5f9; /* Color de fondo para evitar transparencia. */
        }

        /* Icono de filtro en los encabezados. */
        .filterable-header { 
            cursor: pointer; 
            position: relative;
        }
        .filterable-header .filter-icon {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        /* El icono de filtro se vuelve más visible al pasar el ratón o cuando el filtro está activo. */
        .filterable-header:hover .filter-icon,
        .filterable-header.active .filter-icon {
            opacity: 1;
            color: var(--primary-color);
        }

        /* Contenedor del menú desplegable para los filtros de columna. */
        .filter-dropdown {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 6px;
            z-index: 20;
            max-height: 250px;
            overflow-y: auto;
            min-width: 200px;
        }        
        .clickable-cell {
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        
        /* ============================================= */
        /* === 5. LAYOUT Y FORMULARIOS === */
        /* ============================================= */

        /* Anula el ancho máximo por defecto para que la app ocupe más espacio horizontal. */
        .max-w-7xl {
            max-width: 100% !important;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        /* Título de sección dentro de los formularios. */
        .section-title { font-weight: bold; color: var(--primary-color); margin-bottom: 1rem; }

        .table-container table {
            width: 100%; /* La tabla ocupa el 100% de su contenedor. */
            min-width: 1200px; /* Ancho mínimo para evitar que las columnas se compriman demasiado. */
        }

        /* Grid responsivo para los campos del formulario. */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            align-items: end;
            gap: 1rem;
        }
        @media (min-width: 640px) {
            /* En pantallas más grandes, el grid se expande a dos columnas. */
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Espaciado inferior para cada campo del formulario. */
        .form-field {
            margin-bottom: 0.5rem;
        }

        /* Estilo base para las etiquetas de los campos del formulario. */
        .form-field label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        
        /* Campo de formulario que ocupa todo el ancho del grid. */
        .form-field.full-width {
            grid-column: 1 / -1;
        }

        /* Asegura que el contenedor flexible dentro de un campo de ancho completo también ocupe todo el ancho. */
        .form-field.full-width .flex-with-buttons {
            min-width: 100%;
            max-width: 100%;
        }

        /* Caso específico para el campo de link, asegurando que ocupe el ancho completo. */
        .form-field:has(#licitacion-linkComprasXM) .flex-with-buttons, .form-field:has(#edit-licitacion-linkComprasXM) .flex-with-buttons {
            min-width: 100%;
            max-width: 100%;
        }

        /* Oculta el botón de edición para campos de texto multilínea (textarea) y el campo de link. */
        .form-field:has(textarea) .edit-btn,
        .form-field:has(#licitacion-linkComprasXM) .edit-btn,
        .form-field:has(#edit-licitacion-linkComprasXM) .edit-btn {
            display: none;
        }

        .licitacion-form-container {
            max-height: 75vh; /* Altura máxima para el contenedor del formulario. */
            overflow-y: auto; /* Habilita el scroll vertical si el contenido excede la altura. */
            padding-right: 0.5rem; /* Espacio a la derecha para la barra de scroll. */
        }

        /* Estilos personalizados para la barra de scroll en navegadores WebKit (Chrome, Safari). */
        /* Ancho de la barra de scroll. */
        .licitacion-form-container::-webkit-scrollbar {
            width: 6px;
        }

        .licitacion-form-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .licitacion-form-container::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }

        .licitacion-form-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Contenedor flexible para alinear campos de formulario con sus botones de acción. */
        .flex-with-buttons {
            display: flex; 
            align-items: flex-end; 
            min-width: 340px;
            max-width: 340px;
        }

        /* Estilos para el contenedor de Select2 dentro del layout flexible. */
        .flex-with-buttons .select2-container {
            flex-grow: 1;
            margin-bottom: 1px; /* Alineación vertical fina. */
            min-width: 0; /* Permite que el select se encoja si es necesario. */
        }

        .flex-with-buttons input,
        .flex-with-buttons textarea {
            min-width: 0; /* Permite que el campo se encoja. */
        }

        /* Estilos base para los botones de acción (ej. editar) junto a los campos. */
        .flex-with-buttons button {
            height: 38px;
            width: 38px;
            margin-bottom: 1px;
            flex-shrink: 0;
            border-radius: 0.25rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }

        /* Estilo específico para el botón de edición. */
        .flex-with-buttons button.edit-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .flex-with-buttons button.paste-btn:hover {
            background-color: #16463c;
        }
        
        /* Estilos para normalizar la apariencia de Select2 con Tailwind. */
        .select2-container--default .select2-selection--single {
            height: 38px;
            padding: 5px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 26px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }

        /* Asegura que el contenedor de Select2 ocupe el 100% del ancho disponible. */
        .select2-container {
            width: 100% !important;
        }

        /* Trunca el texto largo en los campos Select2 para evitar desbordamiento. */
        .select2-container .select2-selection--single .select2-selection__rendered {
            display: block;
            padding-left: 8px;
            padding-right: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Estilo para celdas que contienen un link, con truncamiento de texto. */
        .link-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #1a56db;
            text-decoration: underline;
            cursor: pointer;
        }

        /* ============================================= */
        /* === 6. MODALES === */
        /* ============================================= */
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }

        /* Ancho específico para modales que necesitan más espacio horizontal. */
        .wide-modal .relative {
            max-width: 76rem !important;
        }

        /* Bloquea el scroll del body cuando un modal está abierto para evitar scroll dual. */
        body.modal-open {
            overflow: hidden;
        }

        /* Contenedor principal para cada sección de gráfico en la pestaña de reportes. */
        .dynamic-chart-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Encabezado de la sección de gráfico, con título y selector de variable. */
        .dynamic-chart-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        
        /* Grid para el contenido del gráfico (gráfico a la izquierda, tabla a la derecha). */
        .dynamic-chart-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        /* Contenedor para la tabla de datos que acompaña al gráfico. */
        .dynamic-table-container {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Estilos base para la tabla de datos dinámica. */
        .dynamic-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .dynamic-table th, .dynamic-table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        
        .dynamic-table th {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            font-weight: 600;
        }
        
        .dynamic-table tr:nth-child(even) {
            background-color: #f3f4f6;
        }
        
        /* Estilos para el botón de alternar etiquetas en los gráficos. */
        #toggle-labels-btn {
            transition: all 0.3s ease;
        }

        #toggle-labels-btn.bg-primary {
            background-color: var(--primary-color) !important;
        }

        /* Estilos para el modal que muestra una vista web (iframe). */
        .webview-modal {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .webview-container {
            width: 90vw;
            height: 90vh;
            max-width: 1200px;
        }

        .webview-modal iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0.5rem;
        }

        /* Contenedor principal del contenido en el modal de detalles. */
        .details-modal-content {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 2rem;
            background-color: #f9fafb;
        }
        .details-header { /* Encabezado del modal con título y fechas. */
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        .details-header .date {
            font-size: 1rem;
            color: #6b7280;
            font-weight: 500;
        }
        .details-header .project {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin-top: 0.25rem;
        }

        /* Estilo para cada sección dentro del modal de detalles. */
        .details-section {
            margin-bottom: 1.5rem;
        }
        .details-section h4 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 0.75rem;
        }

        /* Estilos para contenido formateado (ej. descripciones con saltos de línea, listas). */
        .formatted-content {
            font-size: 1rem;
            line-height: 1.5;
            overflow-wrap: break-word; 
        }

        .formatted-content p {
            margin-bottom: 0.5rem;
        }

        .formatted-content ul, .formatted-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .formatted-content ul li, .formatted-content ol li {
            list-style-position: outside !important; 
            padding-left: 1.5em; 
            text-indent: -1.5em; 
            margin-left: 1.5em; 
        }

        .formatted-content strong, .formatted-content b {
            font-weight: bold;
        }

        .formatted-content em, .formatted-content i {
            font-style: italic;
        }

        .formatted-content u {
            text-decoration: underline;
        }
        
        /* Estilo base para las tablas dentro del modal de detalles. */
        .details-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .details-table th, .details-table td { border: 1px solid #e5e7eb; padding: 0.75rem; text-align: left; vertical-align: top; }
        .details-table th { background-color: var(--primary-color); font-weight: 600; color: white; }

        /* Utilidad para tablas con columnas de igual ancho. */
        .details-table.equal-cols th, .details-table.equal-cols td {
            width: 33.33%;
        }

        /* Resalta visualmente los campos relacionados con el fallo y el monto. */
        .highlight-fallo {
            background-color: #fefce8; /* bg-yellow-50 */
            border: 1px solid var(--secondary-color);
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        /* Estilo para cada item en el modal de múltiples detalles. */
        .multi-details-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background-color: #f9fafb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .multi-details-item:last-child {
            margin-bottom: 0;
        }

        /* ============================================= */
        /* === 7. COMPONENTES ESPECÍFICOS === */
        /* ============================================= */

        /* Tooltip de vista rápida */
        #quick-view-tooltip {
            position: fixed; 
            display: none;   
            background-color: #ffffff; 
            color: #374151; 
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb; /* Borde sutil (gray-200) */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* Sombra más pronunciada */
            z-index: 100;
            pointer-events: none; /* Para que no interfiera con el cursor */
            font-size: 0.9rem; /* Tamaño de fuente mejorado */
            line-height: 1.5;
            max-width: 350px;
            transition: opacity 0.2s ease-in-out;
            opacity: 0;
        }

        #quick-view-tooltip.visible {
            display: block;
            opacity: 1;
        }

        #quick-view-tooltip strong { color: var(--primary-color); }
        #quick-view-tooltip p { margin-bottom: 0.25rem; }
        
        /* Contenedor para la sección de fecha de fallo y monto en el tooltip. */
        #quick-view-tooltip .fallo-monto-container {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            border-top: 1px solid #e5e7eb; padding-top: 0.5rem; margin-top: 0.5rem;
        }
        /* Resaltado para el monto en el tooltip. */
        #quick-view-tooltip .monto-highlight { 
            font-size: 1.1rem; font-weight: 700; color: var(--primary-color); 
            text-align: right;
        }
        /* ============================================= */
        /* === 8. ANIMACIONES === */
        /* ============================================= */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#1E5B4F', // Coincide con --primary-color
                            light: '#267c6c',
                            dark: '#16463c'
                        },
                        secondary: {
                            DEFAULT: '#A6802D', // Coincide con --secondary-color
                            light: '#bf9a41',
                            dark: '#8a6b22'
                        },
                        accent: {
                            DEFAULT: '#9C2348', // Coincide con --accent-color
                            light: '#b52e5a',
                            dark: '#7d1c3a'
                        }
                    }
                }
            }
        }
    </script>
    <!-- Estilos para la pantalla de inicio de sesión -->
    <style>
        #login-screen {
            background: linear-gradient(135deg, #f0f2f5 0%, #e6e9ed 100%);
        }
        .login-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            overflow: hidden;
            display: flex;
            max-width: 900px;
            width: 100%;
        }
        .login-art {
            background-color: #1E5B4F;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 40%);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            width: 45%;
        }
        .login-form-container {
            padding: 3rem;
            width: 55%;
            position: relative; /* Añadido para posicionar el botón de cierre */
        }
        @media (max-width: 768px) {
            .login-card { flex-direction: column; }
            .login-art, .login-form-container { width: 100%; }
            .login-art { padding: 2rem 1rem; }
            .login-form-container { padding: 2rem 1.5rem; }
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <!-- ================================================================= -->
    <!-- =========== 1. LOADER INICIAL E INICIO DE SESIÓN ================ -->
    <!-- ================================================================= -->
    <div id="loader" class="loader">
        <div class="spinner"></div>
        <p class="mt-4 text-sm text-slate-600">Cargando datos, por favor espera...</p>
    </div>

    <!----------------- PANTALLA DE INICIO DE SESIÓN ---------------->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="login-card">
            <!-- Columna de Arte y Logo -->
            <div class="login-art">
                <img src="https://github.com/SAGB-JCM/Gesti-n-de-Licitaciones/blob/main/icono_licitaciones.png?raw=true" alt="Logo Sistema Licitaciones" class="h-32 w-auto mb-6">
                <h2 class="text-2xl font-bold text-center mb-2">Seguimiento de Licitaciones de Proyectos Ferroviarios</h2>
                <p class="text-center text-sm opacity-80">Bienvenido. Por favor, inicie sesión para continuar.</p>
            </div>
            <!-- Columna del Formulario -->
            <div class="login-form-container">
                <!-- Botón sutil para cerrar el modal de login -->
                <button id="close-login-screen-btn" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors z-10" title="Cerrar">
                    <i class="fa-solid fa-times-circle fa-lg"></i>
                </button>
                <h3 class="text-2xl font-bold text-primary mb-2">Iniciar Sesión</h3>
                <p class="text-slate-500 mb-6">Ingrese sus credenciales de acceso.</p>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-slate-600 mb-1">Correo Electrónico</label>
                        <input type="email" id="login-email" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="usuario@dominio.com">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-slate-600 mb-1">Contraseña</label>
                        <div class="relative">
                            <input type="password" id="login-password" required class="w-full px-4 py-2 pr-10 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="••••••••">
                            <button type="button" id="toggle-password-visibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-400 hover:text-slate-600">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <p id="login-error" class="text-red-500 text-sm text-center mb-4 hidden"></p>
                    <button type="submit" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all duration-300">
                        Acceder
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ================================================================= -->
    <!-- ================ 2. CONTENEDOR PRINCIPAL DE LA APP ============== -->
    <!-- ================================================================= -->
    <div id="app" class="min-h-screen hidden">

        <!-- ENCABEZADO SUPERIOR: Contiene el logo, título y la información del usuario. Es fijo en la parte superior. -->
        <header class="bg-primary shadow-lg sticky top-0 z-30">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img src="https://github.com/SAGB-JCM/Gesti-n-de-Licitaciones/blob/main/icono_licitaciones.png?raw=true" alt="Logo Sistema Licitaciones" class="h-16 w-auto">
                    <h1 class="text-xl sm:text-2xl font-bold text-white tracking-tight">Seguimiento de Licitaciones de Proyectos Ferroviarios</h1>
                </div>
                <!-- Contenedor para mostrar información del usuario (ej. ID anónimo) -->
                <button id="login-btn" class="bg-white/20 hover:bg-white/30 text-white text-xs font-bold py-2 px-3 rounded-lg transition-colors hidden">
                    <i class="fa-solid fa-right-to-bracket mr-2"></i>Iniciar Sesión
                </button>
                <div id="user-info" class="flex items-center space-x-4 hidden">
                    <span id="user-email" class="text-white text-sm font-medium"></span>
                    <button id="logout-btn" class="bg-white/20 hover:bg-white/30 text-white text-xs font-bold py-2 px-3 rounded-lg transition-colors">
                        <i class="fa-solid fa-right-from-bracket mr-2"></i>Cerrar Sesión
                    </button>
                </div>
            </div>
        </header>

        <!-- BARRA DE PESTAÑAS: Navegación principal entre "Licitaciones" y "Reportes". Es fija debajo del encabezado. -->
        <div class="bg-white shadow-sm sticky top-[56px] z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="tabs" class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button data-tab="historico" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Licitaciones</button>
                        <button data-tab="reportes" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Reportes</button>
                    </nav>
                </div>
            </div>
        </div>

        <!-- ÁREA DE CONTENIDO PRINCIPAL: Aquí se renderiza el contenido de la pestaña activa. -->
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">

            <!-- ================================================================= -->
            <!-- ================ PESTAÑA 1: LICITACIONES (HISTÓRICO) ============ -->
            <!-- ================================================================= -->
            <!-- NOTA: Esta pestaña está actualmente oculta y no se utiliza. La funcionalidad principal está en 'tab-content-historico'. -->
            <main id="tab-content-licitaciones" class="tab-content hidden">
                <section id="licitacion-log-main">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Registro de Licitaciones</h2>
                        <div class="flex items-center space-x-2">
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="main-table-header">
                                    <th scope="col" class="py-3 px-6">No.</th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="proyecto">Proyecto<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="nombre">Nombre<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="descripcion">Descripción<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="generalidades">Generalidades<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="siglasDependencia">Dependencia<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="codigoExpediente">Cód. Expediente<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="procedimientoContratacion">Procedimiento<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="tipo">Tipo<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="anoPublicacion">Año Pub.<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fechaPresentacionApertura">Fecha Apertura<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fechaFallo">Fecha Fallo<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fechaEstimadaInicio">Fecha Inicio<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="registradosInteres">Participantes<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="nombreLicitantes">Licitantes<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="ganadorLicitacion">Ganador<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="monto">Monto<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6">Link</th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="licitacion-table-body"></tbody>
                        </table>
                        <div id="no-licitacion-message" class="p-6 text-center text-slate-500 hidden">
                            <p>No hay licitaciones registradas en la base de datos.</p>
                        </div>
                    </div>
                </section>
            </main>

            <!-- CONTENIDO DE LA PESTAÑA "LICITACIONES" (Actualmente la principal) -->
            <div id="tab-content-historico" class="tab-content">
                
                <!-- SECCIÓN DASHBOARD (RADAR DE FECHAS): Muestra tarjetas interactivas con el conteo de licitaciones por semana de fallo. -->
                <section id="dashboard-historico" class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Radar de Fechas de Fallo</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        <!-- Semana -2 -->
                        <div id="fallo-indicator-minus-2" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para Ver">
                            <div class="bg-secondary/10 p-2 rounded-full"><i class="fa-solid fa-angles-left text-secondary text-xl"></i></div>
                            <div><p id="fallo-label-minus-2" class="text-sm text-slate-500">Fallo (Semana -2)</p><p id="fallo-count-minus-2" class="text-2xl font-bold text-secondary">0</p></div>
                        </div>
                        <!-- Semana -1 -->
                        <div id="fallo-indicator-minus-1" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para Ver">
                            <div class="bg-secondary/10 p-2 rounded-full"><i class="fa-solid fa-angle-left text-secondary text-xl"></i></div>
                            <div><p id="fallo-label-minus-1" class="text-sm text-slate-500">Fallo (Semana -1)</p><p id="fallo-count-minus-1" class="text-2xl font-bold text-secondary">0</p></div>
                        </div>
                        <!-- Semana Actual -->
                        <div id="fallo-indicator-current" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 transition-all duration-200 current-week-highlight">
                            <div id="fallo-date-picker-trigger" class="relative bg-primary/10 p-2 rounded-full cursor-pointer" title="Seleccionar otra fecha">
                                <i id="fallo-current-icon" class="fa-solid fa-calendar-week text-primary text-xl transition-colors"></i>
                                <input type="date" id="fallo-date-picker" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer">
                            </div>
                            <div id="fallo-current-content" class="cursor-pointer" title="Hacer clic para Ver">
                                <p id="fallo-label-current" class="text-sm text-slate-500 font-medium">Semana Actual</p>
                                <p id="fallo-count-current" class="text-2xl font-bold text-primary">0</p>
                            </div>
                        </div>
                        <!-- Semana +1 -->
                        <div id="fallo-indicator-plus-1" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para Ver">
                            <div class="bg-accent/10 p-2 rounded-full"><i class="fa-solid fa-angle-right text-accent text-xl"></i></div>
                            <div><p id="fallo-label-plus-1" class="text-sm text-slate-500">Fallo (Semana +1)</p><p id="fallo-count-plus-1" class="text-2xl font-bold text-accent">0</p></div>
                        </div>
                        <!-- Semana +2 -->
                        <div id="fallo-indicator-plus-2" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para Ver">
                            <div class="bg-accent/10 p-2 rounded-full"><i class="fa-solid fa-angles-right text-accent text-xl"></i></div>
                            <div><p id="fallo-label-plus-2" class="text-sm text-slate-500">Fallo (Semana +2)</p><p id="fallo-count-plus-2" class="text-2xl font-bold text-accent">0</p></div>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN TABLA DE LICITACIONES: Contiene los controles de la tabla y la tabla principal de datos. -->
                <section id="historical-log-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Licitaciones Registradas</h2>
                        <div class="flex items-center space-x-2">
                            <div id="filtered-total-amount-container" class="text-sm font-medium text-slate-500 mr-4 flex items-center gap-x-2"></div>
                            <div class="flex items-center space-x-2">
                                <button id="view-all-details-btn" class="text-slate-500 hover:text-primary p-2 rounded-lg" title="Ver detalles de todos los resultados visibles">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                                <button id="clear-all-filters-btn" class="text-slate-500 hover:text-primary p-2 rounded-lg" title="Limpiar todos los filtros">
                                    <i class="fa-solid fa-broom"></i>
                                </button>
                                <div class="relative flex-grow">
                                    <input type="text" id="filter-input-historical" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                    <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                                    <button id="clear-filter-btn-historical" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden"><i class="fa-solid fa-times-circle"></i></button>
                                </div>
                            </div>
                            <button id="add-licitacion-btn" class="bg-success hover:bg-success-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-plus"></i>
                                <span>Agregar Licitación</span>
                            </button>
                            <button id="download-historical-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-file-excel"></i>
                                <span>Descargar Excel</span>
                            </button>
                            <label for="historical-file-input" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg shadow-sm transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap"><i class="fa-solid fa-file-upload"></i><span>Subir Excel</span><input type="file" id="historical-file-input" class="hidden" accept=".xlsx, .xls"></label>
                        </div>
                    </div>
                    <div id="historical-table-container" class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="historical-table-header">
                                    <th scope="col" class="py-3 px-6">No.</th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="proyecto">Proyecto<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="nombre">Nombre<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="descripcion">Descripción<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="generalidades">Generalidades<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="siglasDependencia">Dependencia<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="codigoExpediente">Cód. Expediente<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="procedimientoContratacion">Procedimiento<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="tipo">Tipo<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="anoPublicacion">Año Pub.<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fechaPresentacionApertura">Fecha Apertura<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fechaFallo">Fecha Fallo<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fechaEstimadaInicio">Fecha Inicio<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="registradosInteres">Participantes<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="nombreLicitantes">Licitantes<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="ganadorLicitacion">Ganador<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="monto">Monto<span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6">Link</th>
                                    <th scope="col" class="py-3 px-6 actions-header">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historical-table-body"></tbody>
                        </table>
                        <div id="no-historical-message" class="p-6 text-center text-slate-500 hidden">
                            <p>No hay datos históricos cargados.</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- ================================================================= -->
            <!-- ================ PESTAÑA 2: REPORTES ============================ -->
            <!-- ================================================================= -->
            <div id="tab-content-reportes" class="tab-content hidden">
                
                <!-- SECCIÓN DE REPORTES: Contenedor para todos los gráficos y tablas de la pestaña de reportes. -->
                <section id="reportes" class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Reportes</h2>
                        <div class="flex items-center space-x-2">                            
                            <!-- BOTÓN DE CONFIGURACIÓN DE REPORTES AÑADIDO -->
                            <button id="report-settings-btn" class="text-slate-500 hover:text-primary p-2 rounded-lg transition-colors" title="Configuración de Reportes">
                                <i class="fa-solid fa-cog fa-lg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- GRÁFICO DINÁMICO 1: "Licitaciones por..." - Permite al usuario seleccionar una variable para visualizar la distribución. -->
                    <div class="dynamic-chart-container">
                        <div class="dynamic-chart-header">
                            <h3 class="text-xl font-semibold text-slate-800">Licitaciones por</h3>
                            <select id="dynamic-chart-variable" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                <option value="proyecto">Proyecto</option>
                                <option value="siglasDependencia">Dependencia</option>
                                <option value="procedimientoContratacion">Procedimiento</option>
                                <option value="tipo">Tipo</option>
                                <option value="ganadorLicitacion">Ganador</option>
                            </select>
                            <button id="toggle-labels-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded ml-2">
                                <i class="fa-solid fa-tag"></i>
                            </button>
                        </div>
                        <div class="dynamic-chart-content">
                            <div class="chart-wrapper">
                                <canvas id="dynamicChart"></canvas>
                            </div>
                            <div class="dynamic-table-container">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-lg font-semibold text-slate-800 text-center flex-grow">Distribución</h4>
                                    <!-- INICIO: Botón de ordenamiento para la primera tabla -->
                                    <button id="toggle-dynamic-table-sort-btn" class="text-slate-400 hover:text-primary p-2 rounded-lg transition-colors" title="Ordenar por Cantidad">
                                        <i class="fa-solid fa-sort"></i>
                                    </button>
                                    <button id="download-dynamic-table-excel-btn" class="text-slate-400 hover:text-primary p-2 rounded-lg transition-colors" title="Descargar tabla como Excel">
                                        <i class="fa-solid fa-file-excel"></i>
                                    </button>
                                </div>
                                <table id="dynamic-distribution-table" class="dynamic-table">
                                    <thead>
                                        <tr>
                                            <th id="dynamic-table-header">Variable</th>
                                            <th>Total</th>
                                            <th>Monto (mdp)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dynamic-table-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- GRÁFICO DINÁMICO 2: "Proyectos por..." - Gráfico de barras agrupadas/apiladas para comparar variables por proyecto. -->
                    <div class="dynamic-chart-container">
                        <div class="dynamic-chart-header">
                            <h3 class="text-xl font-semibold text-slate-800">Proyectos por</h3>
                            <select id="project-chart-variable" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                <option value="tipo">Tipo</option>
                                <option value="procedimientoContratacion">Procedimiento de Contratación</option>
                                <option value="ganadorLicitacion">Ganador</option>
                            </select>
                            <button id="toggle-chart-type-btn" class="bg-primary text-white font-bold py-2 px-3 rounded ml-2 transition-colors duration-200" title="Cambiar tipo de gráfica (Agrupada/Apilada)">
                                <i class="fa-solid fa-chart-bar"></i>
                            </button>
                            <button id="toggle-legend-btn" class="bg-primary text-white font-bold py-2 px-3 rounded ml-2" title="Alternar visibilidad de la leyenda">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                        <div class="chart-wrapper" style="height: 400px;">
                            <canvas id="projectProcedureChart"></canvas>
                        </div>
                        <div class="dynamic-table-container mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-lg font-semibold text-slate-800 text-center flex-grow">Montos Detallados por Procedimiento (mdp)</h4>
                                <!-- INICIO: Botón de ordenamiento para la segunda tabla -->
                                <button id="toggle-project-table-sort-btn" class="text-slate-400 hover:text-primary p-2 rounded-lg transition-colors" title="Ordenar por Cantidad">
                                    <i class="fa-solid fa-sort"></i>
                                </button>
                                <button id="download-project-procedure-table-excel-btn" class="text-slate-400 hover:text-primary p-2 rounded-lg transition-colors" title="Descargar tabla como Excel">
                                    <i class="fa-solid fa-file-excel"></i>
                                </button>
                            </div>
                            <table id="projectProcedureTable" class="dynamic-table">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                                <tfoot></tfoot>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    
    <!-- ================================================================= -->
    <!-- ================ 3. MODALES DE LA APLICACIÓN ==================== -->
    <!-- ================================================================= -->

    <!-- MODAL PARA AGREGAR NUEVA LICITACIÓN -->
    <div id="licitacion-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-6xl mx-4">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <h3 class="text-2xl font-bold text-primary mb-6">Registrar Nueva Licitación</h3>
            <div class="licitacion-form-container"> <!-- Contenedor con scroll para el formulario -->
                <form id="licitacion-form" class="space-y-6" novalidate>
                    <!-- Grupo 1: Identificación del Proyecto -->
                    <div class="section-title">Identificación del Proyecto</div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="licitacion-proyecto">Proyecto</label>
                            <div class="flex-with-buttons">
                                <select id="licitacion-proyecto" name="proyecto" required></select>
                                <button type="button" id="edit-proyecto-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="licitacion-nombre">Nombre</label>
                            <div class="flex-with-buttons">
                                <select id="licitacion-nombre" name="nombre"></select>
                                <button type="button" id="edit-nombre-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field full-width">
                            <label for="licitacion-descripcion">Descripción</label>
                            <div class="flex-with-buttons">
                                <textarea id="licitacion-descripcion" name="descripcion" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2"></textarea>
                                <button type="button" id="edit-descripcion-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                            </div>
                        </div>
                        <div class="form-field full-width">
                            <label for="licitacion-generalidades">Generalidades Del Proyecto</label>
                            <div class="flex-with-buttons">
                                <textarea id="licitacion-generalidades" name="generalidades" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2"></textarea>
                                <button type="button" id="edit-generalidades-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Grupo 2: Detalles Administrativos de la Licitación -->
                    <div class="section-title">Detalles Administrativos de la Licitación</div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="licitacion-siglasDependencia">Siglas Dependencia</label>
                            <div class="flex-with-buttons">
                                <select id="licitacion-siglasDependencia" name="siglasDependencia"></select>
                                <button type="button" id="edit-siglasDependencia-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="licitacion-codigoExpediente">Código De Expediente</label>
                            <input type="text" id="licitacion-codigoExpediente" name="codigoExpediente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                        </div>
                        <div class="form-field">
                            <label for="licitacion-procedimientoContratacion">Procedimiento de Contratación</label>
                            <div class="flex-with-buttons">
                                <select id="licitacion-procedimientoContratacion" name="procedimientoContratacion"></select>
                                <button type="button" id="edit-procedimientoContratacion-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="licitacion-tipo">Tipo</label>
                            <div class="flex-with-buttons">
                                <select id="licitacion-tipo" name="tipo"></select>
                                <button type="button" id="edit-tipo-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Grupo 3: Cronología del Proceso -->
                    <div class="section-title">Cronología del Proceso</div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="licitacion-anoPublicacion">Año De Publicación</label>
                            <div class="flex-with-buttons">
                                <select id="licitacion-anoPublicacion" name="anoPublicacion"></select>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="licitacion-fechaPresentacionApertura">Fecha De Presentación Y Apertura De Proposiciones</label>
                            <input type="date" id="licitacion-fechaPresentacionApertura" name="fechaPresentacionApertura" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                        </div>
                        <div class="form-field">
                            <label for="licitacion-fechaFallo">Fecha De Fallo</label>
                            <input type="date" id="licitacion-fechaFallo" name="fechaFallo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                        </div>
                        <div class="form-field">
                            <label for="licitacion-fechaEstimadaInicio">Fecha Estimada De Inicio De Contrato</label>
                            <input type="date" id="licitacion-fechaEstimadaInicio" name="fechaEstimadaInicio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                        </div>
                    </div>

                    <!-- Grupo 4: Participantes y Resultados -->
                    <div class="section-title">Participantes y Resultados</div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="licitacion-registradosInteres">Registrados o Manifestaron interés por participar</label>
                            <div class="flex-with-buttons">
                                <select id="licitacion-registradosInteres" name="registradosInteres"></select>
                                <button type="button" id="edit-registradosInteres-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="licitacion-nombreLicitantes">Nombre del o de los licitantes o cotizantes</label>
                            <div class="flex-with-buttons">
                                <select id="licitacion-nombreLicitantes" name="nombreLicitantes"></select>
                                <button type="button" id="edit-nombreLicitantes-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="licitacion-ganadorLicitacion">Ganador De La Licitación</label>
                            <div class="flex-with-buttons">
                                <select id="licitacion-ganadorLicitacion" name="ganadorLicitacion"></select>
                                <button type="button" id="edit-ganadorLicitacion-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="licitacion-monto">Monto</label>
                            <input type="number" id="licitacion-monto" name="monto" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                        </div>
                    </div>

                    <!-- Grupo 5: Verificación -->
                    <div class="section-title">Verificación</div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field sm:col-span-2">
                            <label for="licitacion-linkComprasXM">Link Compras XM</label>
                            <div class="flex-with-buttons">
                                <input type="url" id="licitacion-linkComprasXM" name="linkComprasXM" placeholder="https://compras.xm.com/licitacion" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                <button type="button" id="edit-linkComprasXM-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-end pt-4">
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Licitación</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- TOOLTIP DE VISTA RÁPIDA: Elemento flotante que muestra un resumen de la fila al pasar el cursor. -->
    <div id="quick-view-tooltip"></div>

    <!-- MODAL PARA EDITAR LICITACIÓN EXISTENTE -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-6xl mx-4">
            <button id="close-edit-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <h3 class="text-2xl font-bold text-primary mb-6">Editar Licitación</h3>
            <div class="licitacion-form-container"> <!-- Contenedor con scroll para el formulario -->
                <form id="edit-form" class="space-y-6" novalidate>
                    <input type="hidden" id="edit-id">
                    
                    <!-- Grupo 1: Identificación del Proyecto -->
                    <div class="section-title">Identificación del Proyecto</div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="edit-licitacion-proyecto">Proyecto</label>
                            <div class="flex-with-buttons">
                                <select id="edit-licitacion-proyecto" name="proyecto" required></select>
                                <button type="button" id="edit-proyecto-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="edit-licitacion-nombre">Nombre</label>
                            <div class="flex-with-buttons">
                                <select id="edit-licitacion-nombre" name="nombre"></select>
                                <button type="button" id="edit-nombre-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field full-width">
                            <label for="edit-licitacion-descripcion">Descripción</label>
                            <div class="flex-with-buttons">
                                <textarea id="edit-licitacion-descripcion" name="descripcion" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2"></textarea>
                                <button type="button" id="edit-descripcion-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                            </div>
                        </div>
                        <div class="form-field full-width">
                            <label for="edit-licitacion-generalidades">Generalidades Del Proyecto</label>
                            <div class="flex-with-buttons">
                                <textarea id="edit-licitacion-generalidades" name="generalidades" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2"></textarea>
                                <button type="button" id="edit-generalidades-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Grupo 2: Detalles Administrativos de la Licitación -->
                    <div class="section-title">Detalles Administrativos de la Licitación</div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="edit-licitacion-siglasDependencia">Siglas Dependencia</label>
                            <div class="flex-with-buttons">
                                <select id="edit-licitacion-siglasDependencia" name="siglasDependencia"></select>
                                <button type="button" id="edit-siglasDependencia-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="edit-licitacion-codigoExpediente">Código De Expediente</label>
                            <input type="text" id="edit-licitacion-codigoExpediente" name="codigoExpediente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                        </div>
                        <div class="form-field">
                            <label for="edit-licitacion-procedimientoContratacion">Procedimiento de Contratación</label>
                            <div class="flex-with-buttons">
                                <select id="edit-licitacion-procedimientoContratacion" name="procedimientoContratacion"></select>
                                <button type="button" id="edit-procedimientoContratacion-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="edit-licitacion-tipo">Tipo</label>
                            <div class="flex-with-buttons">
                                <select id="edit-licitacion-tipo" name="tipo"></select>
                                <button type="button" id="edit-tipo-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Grupo 3: Cronología del Proceso -->
                    <div class="section-title">Cronología del Proceso</div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="edit-licitacion-anoPublicacion">Año De Publicación</label>
                            <div class="flex-with-buttons">
                                <select id="edit-licitacion-anoPublicacion" name="anoPublicacion"></select>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="edit-licitacion-fechaPresentacionApertura">Fecha De Presentación Y Apertura De Proposiciones</label>
                            <input type="date" id="edit-licitacion-fechaPresentacionApertura" name="fechaPresentacionApertura" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                        </div>
                        <div class="form-field">
                            <label for="edit-licitacion-fechaFallo">Fecha De Fallo</label>
                            <input type="date" id="edit-licitacion-fechaFallo" name="fechaFallo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                        </div>
                        <div class="form-field">
                            <label for="edit-licitacion-fechaEstimadaInicio">Fecha Estimada De Inicio De Contrato</label>
                            <input type="date" id="edit-licitacion-fechaEstimadaInicio" name="fechaEstimadaInicio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                        </div>
                    </div>

                    <!-- Grupo 4: Participantes y Resultados -->
                    <div class="section-title">Participantes y Resultados</div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="edit-licitacion-registradosInteres">Registrados o Manifestaron interés por participar</label>
                            <div class="flex-with-buttons">
                                <select id="edit-licitacion-registradosInteres" name="registradosInteres"></select>
                                <button type="button" id="edit-registradosInteres-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="edit-licitacion-nombreLicitantes">Nombre del o de los licitantes o cotizantes</label>
                            <div class="flex-with-buttons">
                                <select id="edit-licitacion-nombreLicitantes" name="nombreLicitantes"></select>
                                <button type="button" id="edit-nombreLicitantes-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="edit-licitacion-ganadorLicitacion">Ganador De La Licitación</label>
                            <div class="flex-with-buttons">
                                <select id="edit-licitacion-ganadorLicitacion" name="ganadorLicitacion"></select>
                                <button type="button" id="edit-ganadorLicitacion-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="edit-licitacion-monto">Monto</label>
                            <input type="number" id="edit-licitacion-monto" name="monto" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                        </div>
                    </div>

                    <!-- Grupo 5: Verificación -->
                    <div class="section-title">Verificación</div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field sm:col-span-2">
                            <label for="edit-licitacion-linkComprasXM">Link Compras XM</label>
                            <div class="flex-with-buttons">
                                <input type="url" id="edit-licitacion-linkComprasXM" name="linkComprasXM" placeholder="https://compras.xm.com/licitacion" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                <button type="button" id="edit-linkComprasXM-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-end pt-4">
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMACIÓN: Genérico, usado principalmente para confirmar la eliminación de un registro. -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Confirmar Eliminación</h3>
            <p class="text-slate-600 mb-6">¿Estás seguro de que deseas eliminar este registro?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-danger hover:bg-danger-dark text-white font-bold py-2 px-4 rounded-lg">Eliminar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE REEMPLAZO DE HISTÓRICO: Pregunta al usuario si desea reemplazar los datos al subir un nuevo archivo Excel. -->
    <div id="replace-historical-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Reemplazar Histórico</h3>
            <p class="text-slate-600 mb-6">¿Desea reemplazar el histórico actual?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-replace-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">No</button>
                <button id="confirm-replace-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Sí</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE EDICIÓN DE OPCIÓN: Permite al usuario editar el texto de una opción de un campo de tipo 'select'. -->
    <div id="edit-option-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Editar Opción</h3>
            <input type="text" id="edit-option-input" placeholder="Edite la opción" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-edit-option-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-edit-option-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONTRASEÑA: Requiere autenticación para acciones críticas (editar, eliminar, subir archivos). -->
    <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[55] flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Verificación de Seguridad</h3>
            <p class="text-slate-600 mb-4">Esta acción requiere autenticación. Por favor, ingrese la contraseña.</p>
            <input type="password" id="password-input" placeholder="Contraseña" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-password-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-password-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Verificar</button>
            </div>
        </div>
    </div>

    <!-- MODAL WEBVIEW: Muestra una página web externa dentro de un iframe. -->
    <div id="webview-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center webview-modal">
        <div class="relative bg-white rounded-lg shadow-xl webview-container">
            <button id="close-webview-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors z-10 bg-white rounded-full p-1">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <iframe id="webview-frame" src="about:blank"></iframe>
        </div>
    </div>

    <!-- MODAL DE CARGA DE PLANTILLAS: Permite al usuario subir plantillas de Word para la generación de reportes. -->
    <div id="template-upload-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-primary">Seleccionar Plantilla para Cargar</h3>
                <button id="close-template-upload-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fa-solid fa-times-circle fa-lg"></i>
                </button>
            </div>
            <div class="space-y-4">
                <button data-template-type="default" class="upload-template-type-btn w-full bg-secondary hover:bg-secondary-dark text-white font-bold py-3 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center justify-center space-x-2">
                    <i class="fa-solid fa-file-word"></i><span>Plantilla de Licitaciones (Default)</span></button>
            </div>
        </div>
    </div>

    <!-- ALERTA DE FECHAS DE FALLO: Notificación flotante que avisa sobre fechas de fallo próximas. -->
    <div id="fallo-alert-container" class="hidden fixed bottom-4 right-4 w-full max-w-sm z-40">
        <div class="bg-white rounded-xl shadow-2xl border border-slate-200 overflow-hidden">
            <div class="p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fa-solid fa-bell text-primary text-xl"></i>
                    </div>
                    <div class="ml-3 w-0 flex-1 pt-0.5">
                        <p class="text-sm font-bold text-slate-800">Notificaciones de Fallo</p>
                        <div id="fallo-alert-content" class="mt-2 space-y-2">
                            <!-- El contenido se generará dinámicamente -->
                        </div>
                    </div>
                    <div class="ml-4 flex-shrink-0 flex">
                        <button id="close-fallo-alert-btn" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                            <span class="sr-only">Cerrar</span>
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estilos para la animación de entrada/salida de la alerta de fallo. -->
    <style>
        #fallo-alert-container.alert-enter { animation: slideInUp 0.5s ease-out forwards; }
        #fallo-alert-container.alert-leave { animation: slideOutDown 0.5s ease-in forwards; }

        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideOutDown { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }
    </style>

    <!-- MODAL DE DETALLES: Muestra una vista detallada y formateada de una única licitación. -->
    <div id="view-details-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-6xl mx-4">
            <button id="close-details-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <div class="flex items-center space-x-4 mb-6">
                <img src="https://github.com/SAGB-JCM/Gesti-n-de-Licitaciones/blob/main/icono_licitaciones.png?raw=true" alt="Logo Sistema Licitaciones" class="h-16 w-auto">
                <h3 class="text-2xl font-bold text-primary">Detalle de la Licitación</h3>
            </div>
            <div class="licitacion-form-container"> <!-- Contenedor con scroll -->
                <div id="details-modal-content" class="details-modal-content">
                    <!-- El contenido se generará dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIGURACIÓN DE REPORTES: Permite al usuario definir filtros de fecha y gestionar plantillas. -->
    <div id="report-settings-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-primary">Configuración de Reportes</h3>
                <button id="close-report-settings-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fa-solid fa-times-circle fa-lg"></i>
                </button>
            </div>
            <div class="space-y-6">
                <!-- Sección para cargar plantillas de Word -->
                <div>
                    <h4 class="text-md font-semibold text-slate-700 mb-2">Plantillas</h4>
                    <button id="open-template-uploader-btn" class="w-full bg-secondary hover:bg-secondary-dark text-white font-bold py-3 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center justify-center space-x-2">
                        <i class="fa-solid fa-upload"></i>
                        <span>Cargar Plantilla Word</span>
                    </button>
                </div>
                <!-- Sección para filtrar los reportes por un rango de fechas -->
                <div class="border-t border-gray-200 pt-4">
                    <h4 class="text-md font-semibold text-slate-700 mb-3">Filtro de Fechas para Reportes (por Fecha de Fallo)</h4>
                    <fieldset class="space-y-2">
                        <div class="flex items-center">
                            <input id="date-filter-all" name="date-filter-mode" type="radio" class="focus:ring-primary h-4 w-4 text-primary border-gray-300" value="all" checked>
                            <label for="date-filter-all" class="ml-3 block text-sm font-medium text-gray-700">Todos los datos</label>
                        </div>
                        <div class="flex items-center">
                            <input id="date-filter-period" name="date-filter-mode" type="radio" class="focus:ring-primary h-4 w-4 text-primary border-gray-300" value="period">
                            <label for="date-filter-period" class="ml-3 block text-sm font-medium text-gray-700">Seleccionar periodo</label>
                        </div>
                    </fieldset>
                    <div id="date-range-picker-container" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 opacity-50 transition-opacity">
                        <div>
                            <label for="report-start-date" class="block text-sm font-medium text-gray-700">Fecha de inicio</label>
                            <input type="date" id="report-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2 disabled:bg-gray-100 disabled:cursor-not-allowed" disabled>
                        </div>
                        <div>
                            <label for="report-end-date" class="block text-sm font-medium text-gray-700">Fecha de fin</label>
                            <input type="date" id="report-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2 disabled:bg-gray-100 disabled:cursor-not-allowed" disabled>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end">
                <button id="save-report-settings-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE MÚLTIPLES DETALLES: Muestra una vista detallada de todas las licitaciones actualmente visibles en la tabla. -->
    <div id="multi-details-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-6xl mx-4">
            <button id="close-multi-details-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <div class="flex items-center space-x-4 mb-6">
                <img src="https://github.com/SAGB-JCM/Gesti-n-de-Licitaciones/blob/main/icono_licitaciones.png?raw=true" alt="Logo Sistema Licitaciones" class="h-16 w-auto">
                <h3 class="text-2xl font-bold text-primary">Detalle de Licitaciones Filtradas</h3>
            </div>
            <div id="multi-details-content-container" class="licitacion-form-container"> <!-- Contenedor con scroll -->
                <!-- El contenido se generará dinámicamente -->
            </div>
        </div>
    </div>

    <!-- ================================================================= -->
    <!-- ================ 4. SCRIPT PRINCIPAL DE LA APP ================== -->
    <!-- ================================================================= -->
    <!-- Contiene toda la lógica de la aplicación: Firebase, manipulación del DOM, eventos, filtros, gráficos, etc. -->
    <script>
        // =============================================
        // MÓDULO: Verificación de dependencias
        // =============================================
        
        /**
         * Verifica que todas las librerías de JavaScript externas necesarias estén cargadas.
         * @returns {string[]} Un array con los nombres de las librerías que no se encontraron.
         */
        function checkRequiredLibraries() {
            // Retrocompatibilidad: si PizZip se carga como PizZipUtils, asignarlo.
            if (typeof window.PizZip === 'undefined' && typeof window.PizZipUtils !== 'undefined') {
                window.PizZip = window.PizZipUtils;
            }

            const libraries = {
                'PizZip': typeof window.PizZip,
                'docxtemplater': typeof window.docxtemplater,
                'saveAs': typeof window.saveAs,
                'XLSX': typeof window.XLSX,
                'firebase': typeof firebase,
                'Chart': typeof Chart,
                '$': typeof window.$,
                'select2': typeof $.fn.select2
            };
            
            const missing = Object.entries(libraries)
                .filter(([lib, type]) => type === 'undefined')
                .map(([lib]) => lib);
            
            return missing;
        }
        
        /**
         * Carga un script dinámicamente en el <head> del documento.
         * @param {string} src - La URL del script a cargar.
         * @returns {Promise<void>} Una promesa que se resuelve cuando el script se ha cargado o se rechaza si hay un error.
         */
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
                document.head.appendChild(script);
            });
        }

        /**
         * Intenta cargar librerías faltantes desde una URL de respaldo (CDN).
         * @param {string[]} missingLibs - Un array con los nombres de las librerías que faltan.
         * @returns {Promise<any[]>} Una promesa que se resuelve cuando todos los scripts de respaldo han intentado cargarse.
         */
        function loadFallbackLibraries(missingLibs) {
            const fallbacks = {
                'PizZip': 'https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js',
                'docxtemplater': 'https://cdn.jsdelivr.net/npm/docxtemplater@3.34.1/build/docxtemplater.min.js'
            };
            return Promise.all(missingLibs.filter(lib => fallbacks[lib]).map(lib => loadScript(fallbacks[lib])));
        }

        // =============================================
        // MÓDULO: Configuración de Firebase
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAM-s449e94yeJ89EBDqNo-iMQdUDeDaLE",
            authDomain: "gestion-de-licitaciones.firebaseapp.com",
            projectId: "gestion-de-licitaciones",
            storageBucket: "gestion-de-licitaciones.firebasestorage.app",
            messagingSenderId: "864617389687",
            appId: "1:864617389687:web:6304345019f280e9c2f072",
            measurementId: "G-K3LL4TNB5W"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();


        // =============================================
        // MÓDULO: Variables globales y estado de la aplicación
        // =============================================
        let licitaciones = [];
        let historicalLicitaciones = [];
        let userId;

        // Referencias a colecciones de Firebase
        const licitacionesCollectionRef = db.collection("licitaciones");
        const historicalLicitacionesCollectionRef = db.collection("historicalLicitaciones");

        // Variables de estado de la aplicación        let loader, appContainer, userInfo, tabsContainer, tabContents, addLicitacionBtn, licitacionTableBody, noLicitacionMessage, historicalTableBody, noHistoricalMessage, historicalFileInput, historicalFileName, importHistoricalBtn, dynamicChartCanvas, dynamicChartVariable, toggleLabelsBtn, dynamicTableBody, dynamicTableHeader, dynamicChart, licitacionModal, licitacionForm, closeModalBtn, editModal, editForm, closeEditModalBtn, confirmModal, cancelDeleteBtn, confirmDeleteBtn, replaceHistoricalModal, cancelReplaceBtn, confirmReplaceBtn, editOptionModal, editOptionInput, cancelEditOptionBtn, confirmEditOptionBtn, passwordModal, passwordInput, cancelPasswordBtn, confirmPasswordBtn, webviewModal, webviewFrame, closeWebviewBtn, uploadTemplateBtn, viewDetailsModal, closeDetailsModalBtn, detailsModalContent, templateUploadModal, closeTemplateUploadModalBtn;
        let loader, appContainer, userInfo, tabsContainer, tabContents, addLicitacionBtn, licitacionTableBody, noLicitacionMessage, historicalTableBody, noHistoricalMessage, historicalFileInput, historicalFileName, dynamicChartCanvas, dynamicChartVariable, toggleLabelsBtn, dynamicTableBody, dynamicTableHeader, dynamicChart, licitacionModal, licitacionForm, closeModalBtn, editModal, editForm, closeEditModalBtn, confirmModal, cancelDeleteBtn, confirmDeleteBtn, replaceHistoricalModal, cancelReplaceBtn, confirmReplaceBtn, editOptionModal, editOptionInput, cancelEditOptionBtn, confirmEditOptionBtn, passwordModal, passwordInput, cancelPasswordBtn, confirmPasswordBtn, webviewModal, webviewFrame, closeWebviewBtn, uploadTemplateBtn, viewDetailsModal, closeDetailsModalBtn, detailsModalContent, templateUploadModal, closeTemplateUploadModalBtn, multiDetailsModal, closeMultiDetailsModalBtn, multiDetailsContentContainer;

        // --- Variables para el login ---
        let loginScreen, loginForm, loginBtn, logoutBtn, userEmailSpan, loginError, togglePasswordVisibility;

        // --- INICIO: Variables para la nueva funcionalidad ---
        let reportSettingsModal, reportSettingsBtn, closeReportSettingsModalBtn, openTemplateUploaderBtn;
        // Objeto para almacenar la configuración de los reportes
        let reportSettings = {
            dateFilterMode: 'all', // 'all' o 'period'
            startDate: '',
            endDate: ''
        };
        // --- FIN: Variables para la nueva funcionalidad ---

        let currentEditIsHistorical = false;
        let quickViewTooltip;
        let fieldOptions = {
            proyectos: [],
            nombres: [],
            siglasDependencias: [],
            procedimientosContratacion: [],
            tipos: [],
            anosPublicacion: [],
            registradosInteres: [],
            nombreLicitantes: [],
            ganadoresLicitacion: []
        };

        let currentEditingField = null;
        let currentEditingValue = null;
        let pendingAction = null;
        let showChartLabels = true;
        let activeFilters = { // No se usa 'main' en esta app, pero se mantiene la estructura
            main: {},
            historical: {}
        };
        let currentFilterDropdown = null;
        let activeSelectElement = null;
        let openModalCount = 0; // Contador para modales anidados
        let selectedBaseDate = null; // Para el selector de fecha dinámico del radar
        let charts = { // Objeto para gestionar las instancias de Chart.js
            dynamic: null,
            projectProcedure: null
        };
        let showProjectChartLegend = true; // Variable de estado para la leyenda de la segunda gráfica
        let isProjectChartStacked = true; // Variable de estado para el tipo de la segunda gráfica
        let activeFalloDashboardFilter = null; // Para el filtro del radar de fallo

        // --- INICIO: Variables para el ordenamiento dinámico de tablas de reportes ---
        let dynamicChartSortBy = 'amount'; // 'count' o 'amount'
        let projectChartSortBy = 'amount'; // 'count' o 'amount'
        // --- FIN: Variables para el ordenamiento dinámico ---
        // =============================================
        // MÓDULO: Gestión de Listeners de Firebase
        // =============================================
        let unsubscribeHistorical = null; // Variable para guardar la función de des-suscripción del listener
        // MÓDULO: Utilidades
        // =============================================
        
        /**
         * Oculta el loader inicial y muestra el contenido principal de la aplicación.
         */
        function showApp() {
            loader.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }

        /**
         * Muestra una notificación flotante (toast) en la esquina inferior derecha.
         * @param {string} message - El mensaje a mostrar.
         * @param {'info'|'success'|'warning'|'error'} [type='info'] - El tipo de alerta, que determina su color.
         */
        function showAlert(message, type = 'info') {
            const alertContainer = document.createElement('div');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-gray-500' };
            alertContainer.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white transform transition-all duration-300 z-[60] ${colors[type]}`;
            alertContainer.textContent = message;
            document.body.appendChild(alertContainer);
            setTimeout(() => { alertContainer.remove(); }, 3000);
        }

        /**
         * Resalta las coincidencias de un término de búsqueda dentro de un texto.
         * @param {string} text - El texto original.
         * @param {string} searchTerm - El término a buscar y resaltar.
         * @returns {string} El texto con las coincidencias envueltas en un span con la clase 'highlight'.
         */
        function highlightText(text, searchTerm) {
            if (!searchTerm || searchTerm.trim() === '' || typeof text !== 'string') {
                return text;
            }
            // Escapar caracteres especiales en el término de búsqueda para la expresión regular
            const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
            return text.replace(regex, `<span class="highlight">$1</span>`);
        }

        /**
         * Abre un modal, gestionando el z-index y bloqueando el scroll del body.
         * @param {HTMLElement} modal - El elemento del modal a abrir.
         */
        function openModal(modal) {
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
            if (openModalCount === 0) {
                document.body.classList.add('modal-open'); // Bloquear scroll solo si es el primer modal
            }
            openModalCount++;
        }

        /**
         * Cierra un modal, gestionando el z-index y restaurando el scroll del body si es necesario.
         * @param {HTMLElement} modal - El elemento del modal a cerrar.
         */
        function closeModal(modal) {
            modal.classList.remove('modal-enter');
            modal.classList.add('modal-leave');
            setTimeout(() => {
                modal.classList.add('hidden');
                openModalCount--;
                if (openModalCount <= 0) {
                    document.body.classList.remove('modal-open'); // Restaurar scroll solo si no quedan modales abiertos
                    openModalCount = 0; // Resetear por seguridad
                }
            }, 300);
        }

        /**
         * Abre un modal y enfoca un elemento específico dentro de él.
         * @param {HTMLElement} modal - El modal a abrir.
         * @param {HTMLElement} elementToFocus - El elemento que recibirá el foco.
         */
        function openModalWithFocus(modal, elementToFocus) {
            openModal(modal);
            setTimeout(() => elementToFocus.focus(), 150); // Pequeño delay para la animación
        }

        /**
         * Formatea una cadena de fecha en formato "YYYY-MM-DD" a un formato localizado "DD/MM/YYYY".
         * @param {string} dateString - La fecha en formato "YYYY-MM-DD".
         * @returns {string} La fecha formateada o "N/A" si la entrada no es válida.
         */
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                // Tratar la fecha como UTC para evitar problemas de zona horaria.
                // new Date('2024-01-15') se interpreta como UTC midnight.
                const [year, month, day] = dateString.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                return date.toLocaleDateString('es-ES', { timeZone: 'UTC' });
            } catch (e) {
                return dateString;
            }
        }

        /**
         * Trunca un texto a una longitud máxima y añade puntos suspensivos.
         * @param {string} text - El texto a truncar.
         * @param {number} [maxLength=50] - La longitud máxima permitida.
         * @returns {string} El texto truncado o "N/A" si la entrada es nula.
         */
        function truncateText(text, maxLength = 50) {
            if (!text) return 'N/A';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        /**
         * Valida si una cadena de texto es una URL válida.
         * @param {string} string - La cadena a validar.
         * @returns {boolean} `true` si es una URL válida, `false` en caso contrario.
         */
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        /**
         * Elimina todas las etiquetas HTML de una cadena de texto.
         * @param {string} html - La cadena HTML a limpiar.
         * @returns {string} El texto plano sin etiquetas HTML.
         */
        function stripHtml(html) {
            if (!html) return '';
            const doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.body.textContent || "";
        }

        /**
         * Escapa caracteres HTML y reemplaza saltos de línea por etiquetas <br>.
         * @param {string} text - El texto a formatear.
         * @returns {string} El texto formateado como HTML seguro.
         */
        function formatTextWithLineBreaks(text) {
            if (!text) return 'N/A';
            // Escapa HTML para seguridad y luego reemplaza saltos de línea
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;').replace(/\n/g, '<br>');
        }

        /**
         * Formatea una fecha en formato "YYYY-MM-DD" a un formato largo (ej. "lunes, 1 de enero de 2024").
         * @param {string} dateString - La fecha en formato "YYYY-MM-DD".
         * @returns {string} La fecha en formato largo.
         */
        function formatLongDate(dateString) {
            if (!dateString) return 'Fecha no disponible';
            try {
                const [year, month, day] = dateString.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    timeZone: 'UTC'
                };
                return new Intl.DateTimeFormat('es-ES', options).format(date);
            } catch (e) { return dateString; }
        }

        /**
         * Obtiene el nombre del mes a partir de una fecha en formato "YYYY-MM-DD".
         * @param {string} dateString - La fecha en formato "YYYY-MM-DD".
         * @returns {string} El nombre del mes capitalizado.
         */
        function getMonthName(dateString) {
            if (!dateString) return 'Mes no disponible';
            try {
                const [year, month, day] = dateString.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                
                const monthName = new Intl.DateTimeFormat('es-ES', { 
                    month: 'long',
                    timeZone: 'UTC'
                }).format(date);

                // Capitalizar la primera letra
                return monthName.charAt(0).toUpperCase() + monthName.slice(1);
            } catch (e) { return 'Error de mes'; }
        }

        /**
         * Convierte una cadena Base64 a un ArrayBuffer.
         * @param {string} base64 - La cadena en formato Base64.
         * @returns {ArrayBuffer} El ArrayBuffer resultante.
         */
        function base64ToArrayBuffer(base64) {
            // Primero, removemos el prefijo "data:application/..." si existe
            const base64Data = base64.substring(base64.indexOf(',') + 1);
            const binary_string = window.atob(base64Data);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Calcula semanas tradicionales (Dom-Sáb) relativas a la fecha actual.
         * @param {Date | string | null} baseDate - La fecha de referencia para el cálculo. Si es null, usa la fecha actual.
         * @param {number} offset - El desplazamiento de semanas (-2, -1, 0, 1, etc.).
         * @returns {{start: Date, end: Date, label: string}} Objeto con las fechas de inicio/fin y una etiqueta descriptiva.
         */
        function getMonthlyPeriod(offset = 0, baseDate = null) {
            const today = baseDate ? new Date(baseDate + 'T12:00:00Z') : new Date(); // Usar mediodía para evitar problemas de zona horaria
            // Nos movemos a la semana objetivo. El offset ahora representa semanas completas.
            today.setDate(today.getDate() + (offset * 7));
        
            // Calculamos el inicio de la semana (domingo).
            // getDay() devuelve 0 para domingo, 1 para lunes, etc.
            const dayOfWeek = today.getDay();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - dayOfWeek);
            startDate.setUTCHours(0, 0, 0, 0); // Normalizar al inicio del día UTC

            // Calculamos el fin de la semana (sábado).
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setUTCHours(23, 59, 59, 999); // Normalizar al final del día UTC

            // Formatear la etiqueta
            // Usamos 'short' para el día de la semana para que sea más claro (Dom, Sáb)
            const options = { weekday: 'short', month: 'short', day: 'numeric', timeZone: 'UTC' };
            const startLabel = startDate.toLocaleDateString('es-ES', options);
            const endLabel = endDate.toLocaleDateString('es-ES', options);
            const label = `${startLabel} - ${endLabel}`;

            return { start: startDate, end: endDate, label: label };
        }

        /**
         * Actualiza el dashboard de fechas de fallo (radar) basándose en los datos del histórico.
         * Calcula y muestra el número de licitaciones cuyo fallo ocurre en las semanas relativas a la fecha base.
         * @param {Date | string | null} [baseDate=null] - La fecha de referencia para el cálculo. Si es null, usa la fecha actual.
         */
        function updateFalloDashboard(baseDate = null) {
            const weeks = {
                minus2: getMonthlyPeriod(-2, baseDate),
                minus1: getMonthlyPeriod(-1, baseDate),
                current: getMonthlyPeriod(0, baseDate),
                plus1: getMonthlyPeriod(1, baseDate),
                plus2: getMonthlyPeriod(2, baseDate),
            };

            const counts = { minus2: 0, minus1: 0, current: 0, plus1: 0, plus2: 0 };

            historicalLicitaciones.forEach(licitacion => {
                if (licitacion.fechaFallo) {
                    try {
                        // El formato es YYYY-MM-DD, new Date() lo interpreta correctamente como UTC.
                        const falloDate = new Date(licitacion.fechaFallo + 'T00:00:00');
                        if (isNaN(falloDate)) return;

                        if (falloDate >= weeks.minus2.start && falloDate <= weeks.minus2.end) counts.minus2++;
                        else if (falloDate >= weeks.minus1.start && falloDate <= weeks.minus1.end) counts.minus1++;
                        else if (falloDate >= weeks.current.start && falloDate <= weeks.current.end) counts.current++;
                        else if (falloDate >= weeks.plus1.start && falloDate <= weeks.plus1.end) counts.plus1++;
                        else if (falloDate >= weeks.plus2.start && falloDate <= weeks.plus2.end) counts.plus2++;
                    } catch (e) { /* Ignorar fechas inválidas */ }
                }
            });

            document.getElementById('fallo-label-minus-2').textContent = weeks.minus2.label;
            document.getElementById('fallo-label-minus-1').textContent = weeks.minus1.label;
            
            // Actualizar la etiqueta de la semana actual/seleccionada
            const currentLabelEl = document.getElementById('fallo-label-current');
            if (baseDate) {
                currentLabelEl.innerHTML = `${weeks.current.label} <span class="font-normal text-accent">(Seleccionada)</span>`;
            } else {
                currentLabelEl.innerHTML = `${weeks.current.label} <span class="font-normal text-slate-400">(Actual)</span>`;
            }

            document.getElementById('fallo-label-plus-1').textContent = weeks.plus1.label;
            document.getElementById('fallo-label-plus-2').textContent = weeks.plus2.label;

            document.getElementById('fallo-count-minus-2').textContent = counts.minus2;
            document.getElementById('fallo-count-minus-1').textContent = counts.minus1;
            document.getElementById('fallo-count-current').textContent = counts.current;
            document.getElementById('fallo-count-plus-1').textContent = counts.plus1;
            document.getElementById('fallo-count-plus-2').textContent = counts.plus2;

            // Una vez actualizados los contadores, revisamos si mostramos la alerta inicial
            // Se usa un setTimeout para asegurar que el resto de la UI se haya cargado
            setTimeout(() => checkAndShowFalloAlert(counts), 500);
        }

        /**
         * Actualiza el indicador visual con la suma de los montos de los datos filtrados.
         * Muestra el monto total de las licitaciones visibles en la tabla.
         * @param {Array} filteredData - Los datos actualmente visibles en la tabla.
         */
        function updateFilteredTotalAmount(filteredData) {
            const totalAmount = filteredData.reduce((sum, item) => sum + (Number(item.monto) || 0), 0);
            const formattedAmount = '$' + totalAmount.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const container = document.getElementById('filtered-total-amount-container');
            if (container) container.innerHTML = `<span>Monto:</span> <strong class="text-primary font-semibold">${formattedAmount}</strong>`;
        }

        // =============================================
        // MÓDULO: Interfaz de usuario
        // =============================================

        /**
         * Renderiza las filas de la tabla de licitaciones con los datos proporcionados.
         * @param {HTMLTableSectionElement} tableBody - El `<tbody>` de la tabla a poblar.
         * @param {Array<Object>} data - El array de objetos de licitación.
         * @param {boolean} [isHistorical=false] - Indica si la tabla es la del histórico.
         */
        function renderTable(tableBody, data, isHistorical = false) {
            const noDataMessage = isHistorical ? noHistoricalMessage : noLicitacionMessage;
            tableBody.innerHTML = '';
            noDataMessage.classList.toggle('hidden', data.length > 0);

            const isLoggedIn = auth.currentUser && !auth.currentUser.isAnonymous;
            const filterKey = isHistorical ? 'historical' : 'main';
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.trim() : '';

            data.forEach((licitacionItem, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                // Añadir atributos de datos para el tooltip de vista rápida
                // SOLUCIÓN: Añadir el ID directamente a la fila para un acceso fiable.
                row.dataset.id = licitacionItem.id;

                row.dataset.quickview = 'true';

                row.dataset.nombre = licitacionItem.nombre || 'N/A';
                row.dataset.proyecto = licitacionItem.proyecto || 'N/A';
                row.dataset.dependencia = licitacionItem.siglasDependencia || 'N/A';
                row.dataset.expediente = licitacionItem.codigoExpediente || 'N/A';
                row.dataset.apertura = formatDate(licitacionItem.fechaPresentacionApertura);
                row.dataset.fallo = licitacionItem.fechaFallo || 'N/A'; // Guardar fecha en formato YYYY-MM-DD
                row.dataset.procedimiento = licitacionItem.procedimientoContratacion || 'N/A';
                row.dataset.tipo = licitacionItem.tipo || 'N/A';
                row.dataset.ganador = licitacionItem.ganadorLicitacion || 'N/A';
                row.dataset.monto = licitacionItem.monto ? '$' + Number(licitacionItem.monto).toLocaleString('es-MX') : 'N/A';
                
                const linkCell = licitacionItem.linkComprasXM && isValidUrl(licitacionItem.linkComprasXM)
                    ? `<a href="${licitacionItem.linkComprasXM}" target="_blank" class="text-blue-600 hover:underline" title="${licitacionItem.linkComprasXM}"><i class="fa-solid fa-link"></i></a>`
                    : `<span class="text-slate-400" title="No hay link válido"><i class="fa-solid fa-link-slash"></i></span>`;

                const applyHighlight = (text) => highlightText(String(text), searchText);

                row.innerHTML = `
                    <td class="py-4 px-6">${applyHighlight(index + 1)}</td>
                    <td class="py-4 px-6">${applyHighlight(truncateText(licitacionItem.proyecto, 30))}</td>
                    <td class="py-4 px-6 clickable-cell">${applyHighlight(truncateText(licitacionItem.nombre, 30))}</td>
                    <td class="py-4 px-6">${applyHighlight(truncateText(licitacionItem.descripcion, 30))}</td>
                    <td class="py-4 px-6">${applyHighlight(truncateText(licitacionItem.generalidades, 30))}</td>
                    <td class="py-4 px-6">${applyHighlight(truncateText(licitacionItem.siglasDependencia, 30))}</td>
                    <td class="py-4 px-6">${applyHighlight(truncateText(licitacionItem.codigoExpediente, 30))}</td>
                    <td class="py-4 px-6">${applyHighlight(truncateText(licitacionItem.procedimientoContratacion, 30))}</td>
                    <td class="py-4 px-6">${applyHighlight(truncateText(licitacionItem.tipo, 30))}</td>
                    <td class="py-4 px-6">${applyHighlight(truncateText(licitacionItem.anoPublicacion, 30))}</td>
                    <td class="py-4 px-6">${applyHighlight(formatDate(licitacionItem.fechaPresentacionApertura))}</td>
                    <td class="py-4 px-6">${applyHighlight(formatDate(licitacionItem.fechaFallo))}</td>
                    <td class="py-4 px-6">${applyHighlight(formatDate(licitacionItem.fechaEstimadaInicio))}</td>
                    <td class="py-4 px-6">${applyHighlight(truncateText(licitacionItem.registradosInteres, 30))}</td>
                    <td class="py-4 px-6">${applyHighlight(truncateText(licitacionItem.nombreLicitantes, 30))}</td>
                    <td class="py-4 px-6">${applyHighlight(truncateText(licitacionItem.ganadorLicitacion, 30))}</td>
                    <td class="py-4 px-6">${applyHighlight(licitacionItem.monto ? '$' + Number(licitacionItem.monto).toLocaleString('es-MX') : 'N/A')}</td>
                    <td class="py-4 px-6 text-center">${linkCell}</td>
                    ${isLoggedIn ? `
                        <td class="py-4 px-6 flex space-x-2 actions-cell">
                            <button data-id="${licitacionItem.id}" data-is-historical="${isHistorical}" class="generate-doc-btn text-blue-600 hover:text-blue-800 actions-btn" title="Generar Reporte Individual">
                                <i class="fa-solid fa-file-word"></i>
                            </button>
                            <button data-id="${licitacionItem.id}" data-is-historical="${isHistorical}" class="edit-btn text-blue-500 hover:text-blue-700 actions-btn">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            <button data-id="${licitacionItem.id}" data-is-historical="${isHistorical}" class="delete-btn text-red-500 hover:text-red-700 actions-btn">
                                <i class="fa-solid fa-trash-alt"></i>
                            </button>
                        </td>
                    ` : ''}
                `;
                
                tableBody.appendChild(row);
            });

            // Después de renderizar la tabla, actualiza el monto total si es la tabla histórica.
            if (isHistorical) {
                updateFilteredTotalAmount(data);
            }
        }

        /**
         * Aplica todos los filtros activos (búsqueda general, filtros de columna, filtro de radar) a un conjunto de datos.
         * @param {Array<Object>} data - El conjunto de datos a filtrar.
         * @param {'main'|'historical'} filterKey - La clave que identifica el conjunto de filtros a usar.
         * @returns {Array<Object>} Los datos filtrados.
         */
        function applyAllFilters(data, filterKey) {
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';
            const columnFilters = activeFilters[filterKey];

            return data.filter(item => {
                // 1. Check search box filter
                const matchesSearch = searchText === '' || Object.values(item).some(value => 
                    String(value).toLowerCase().includes(searchText)
                );

                // 0. Check fallo dashboard filter (only for historical table)
                if (filterKey === 'historical' && activeFalloDashboardFilter) {
                    const falloDate = new Date(item.fechaFallo + 'T00:00:00');
                    if (isNaN(falloDate) || 
                        falloDate < activeFalloDashboardFilter.start || 
                        falloDate > activeFalloDashboardFilter.end) {
                        return false;
                    }
                }

                if (!matchesSearch) return false;

                // 2. Check column filters
                for (const col in columnFilters) {
                    if (columnFilters[col].length > 0) {
                        const itemValue = col === 'fechaPresentacionApertura' || col === 'fechaFallo' ? formatDate(item[col]) : (item[col] || 'N/A');
                        if (!columnFilters[col].includes(itemValue)) {
                            return false;
                        }
                    }
                }
                return true;
            });
        }

        /**
         * Obtiene los datos pre-filtrados por todas las columnas excepto la especificada.
         * Esto es crucial para que los menús desplegables de filtro muestren solo opciones relevantes.
         * @param {function} dataProvider - Función que devuelve el conjunto de datos completo.
         * @param {'main'|'historical'} filterKey - La clave del conjunto de filtros a usar.
         * @param {string} excludeColumn - La clave de la columna a excluir del pre-filtrado.
         * @returns {Array} - Los datos filtrados.
         */
        function getPreFilteredData(dataProvider, filterKey, excludeColumn) {
            const allData = dataProvider() || [];
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';
            const columnFilters = activeFilters[filterKey];

            return allData.filter(item => { // Usamos allData que es el set completo
                // Primero, aplicar el filtro del dashboard si está activo
                if (filterKey === 'historical' && activeFalloDashboardFilter) {
                    const falloDate = new Date(item.fechaFallo + 'T00:00:00');
                    if (isNaN(falloDate) || 
                        falloDate < activeFalloDashboardFilter.start || 
                        falloDate > activeFalloDashboardFilter.end) {
                        return false;
                    }
                }

                const matchesSearch = searchText === '' || Object.values(item).some(value => String(value).toLowerCase().includes(searchText));
                if (!matchesSearch) return false;

                return Object.entries(columnFilters).every(([col, values]) => {
                    if (col === excludeColumn || values.length === 0) return true;
                    const itemValue = col === 'fechaPresentacionApertura' || col === 'fechaFallo' ? formatDate(item[col]) : (item[col] || 'N/A');
                    return values.includes(itemValue);
                });
            });
        }

        /**
         * Configura los manejadores de eventos para los encabezados de columna filtrables.
         * Crea y gestiona los menús desplegables de filtro.
         * @param {string} headerId - El ID del `<tr>` que contiene los encabezados.
         * @param {Function} dataProvider - Una función que devuelve los datos a filtrar.
         * @param {Function} renderFunc - La función que renderiza la tabla.
         * @param {'main'|'historical'} filterKey - La clave del conjunto de filtros.
         */
        function setupColumnFilters(headerId, dataProvider, renderFunc, filterKey) {
            const headerRow = document.getElementById(headerId);
            headerRow.addEventListener('click', e => {
                const header = e.target.closest('.filterable-header');
                if (!header) return;

                if (currentFilterDropdown) {
                    currentFilterDropdown.remove();
                    currentFilterDropdown = null;
                }

                const filterBy = header.dataset.filterBy;
                // Usar los datos pre-filtrados para generar las opciones del dropdown.
                const preFilteredData = getPreFilteredData(dataProvider, filterKey, filterBy);

                const uniqueValues = [...new Set(preFilteredData.map(item => {
                    let value = item[filterBy] || 'N/A';
                    // Normalización para campos de texto (proyecto, resumen, etc.)
                    if (typeof value === 'string') {
                        // Para la fecha, usamos el formato específico.
                        if (filterBy === 'fechaPresentacionApertura' || filterBy === 'fechaFallo') return formatDate(value);
                        // Para otros strings, normalizamos eliminando espacios al inicio y final.
                        return value.trim();
                    }
                    return value;
                }))].sort((a, b) => {
                    // Lógica de ordenamiento personalizada para fechas en el filtro
                    if (filterBy === 'fechaPresentacionApertura' || filterBy === 'fechaFallo') {
                        try {
                            const dateA = new Date(a.split('/').reverse().join('-'));
                            const dateB = new Date(b.split('/').reverse().join('-'));
                            return dateA - dateB; // Orden ascendente
                        } catch (err) { return a.localeCompare(b); }
                    }
                    return a.localeCompare(b, 'es', { numeric: true });
                });

                const dropdown = document.createElement('div');
                dropdown.className = 'filter-dropdown p-2 space-y-1';
                
                const activeColumnFilters = activeFilters[filterKey][filterBy] || [];

                dropdown.innerHTML = `
                    <div class="p-1 border-b border-gray-200">
                        <input type="text" placeholder="Buscar opciones..." class="filter-search-input w-full text-xs p-1 border rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                    <div class="filter-options-container max-h-48 overflow-y-auto">
                        ${uniqueValues.map(value => `
                            <label class="flex items-center space-x-2 p-1 hover:bg-gray-100 rounded cursor-pointer filter-option-label">
                                <input type="checkbox" class="filter-checkbox" value="${value}" ${activeColumnFilters.includes(value) ? 'checked' : ''}>
                                <span class="text-sm text-gray-700">${truncateText(value, 40)}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="border-t my-1"></div>
                    <div class="p-1"><button class="clear-filter-btn text-blue-500 hover:underline text-xs" data-filter-by="${filterBy}">Limpiar filtro</button></div>
                `;

                document.body.appendChild(dropdown);
                const rect = header.getBoundingClientRect();
                dropdown.style.top = `${rect.bottom + window.scrollY}px`;
                dropdown.style.left = `${rect.left + window.scrollX}px`;
                currentFilterDropdown = dropdown;

                // Lógica para el buscador dentro del filtro
                const searchInput = dropdown.querySelector('.filter-search-input');
                const labels = dropdown.querySelectorAll('.filter-option-label');
                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    labels.forEach(label => {
                        const text = label.textContent.toLowerCase();
                        const isVisible = text.includes(searchTerm);
                        label.style.display = isVisible ? 'flex' : 'none';
                    });
                });

                dropdown.addEventListener('change', e => {
                    if (e.target.classList.contains('filter-checkbox')) {
                        const checkedValues = Array.from(dropdown.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);
                        activeFilters[filterKey][filterBy] = checkedValues;
                        
                        header.classList.toggle('active', checkedValues.length > 0);

                        const filteredData = applyAllFilters(dataProvider(), filterKey);
                        renderFunc(document.getElementById(filterKey === 'main' ? 'licitacion-table-body' : 'historical-table-body'), filteredData, filterKey === 'historical');
                    }
                });

                dropdown.querySelector('.clear-filter-btn').addEventListener('click', () => {
                    activeFilters[filterKey][filterBy] = [];
                    header.classList.remove('active');
                    const filteredData = applyAllFilters(dataProvider(), filterKey);
                    renderFunc(document.getElementById(filterKey === 'main' ? 'licitacion-table-body' : 'historical-table-body'), filteredData, filterKey === 'historical');
                    if (currentFilterDropdown) currentFilterDropdown.remove();
                });
            });

            // Close dropdown if clicked outside
            document.addEventListener('click', (e) => {
                if (currentFilterDropdown && !currentFilterDropdown.contains(e.target) && !e.target.closest('.filterable-header')) {
                    currentFilterDropdown.remove();
                    currentFilterDropdown = null;
                }
            }, true);
        }
        
        /**
         * Configura el campo de búsqueda general para una tabla.
         * @param {string} inputId - El ID del campo de input para la búsqueda.
         * @param {Function} dataProvider - Función que devuelve los datos a filtrar.
         * @param {Function} renderFunc - La función que renderiza la tabla.
         * @param {boolean} [isHistorical=false] - Indica si es la tabla histórica.
         */
        function setupFiltering(inputId, dataProvider, renderFunc, isHistorical = false) {
            const filterInput = document.getElementById(inputId);
            if (!filterInput) return; // Si el input no existe, no hacer nada.

            const filterKey = isHistorical ? 'historical' : 'main';
            const clearFilterBtn = document.getElementById(`clear-filter-btn-${filterKey}`);
            filterInput.addEventListener('input', () => {
                const filterText = filterInput.value.toLowerCase();
                if (clearFilterBtn) clearFilterBtn.classList.toggle('hidden', !filterText);
                const filteredData = applyAllFilters(dataProvider(), filterKey);
                renderFunc(document.getElementById(isHistorical ? 'historical-table-body' : 'licitacion-table-body'), filteredData, isHistorical);
            });
            if (clearFilterBtn) clearFilterBtn.addEventListener('click', () => {
                filterInput.value = ''; filterInput.dispatchEvent(new Event('input'));
            });
        }

        /**
         * Limpia todos los filtros aplicados a una tabla y la vuelve a renderizar.
         * @param {'historical'} filterKey - La clave de la tabla a limpiar.
         */
        function clearAllFilters(filterKey) {
            // 1. Limpiar el estado de los filtros de columna
            activeFilters[filterKey] = {};

            // 2. Limpiar el campo de búsqueda de texto
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            if (searchInput) {
                searchInput.value = '';
                searchInput.dispatchEvent(new Event('input')); // Disparar evento para actualizar la UI
            }

            // 3. Limpiar visualmente los encabezados de columna activos
            const tableId = 'historical-table-header';
            document.querySelectorAll(`#${tableId} .filterable-header.active`).forEach(h => h.classList.remove('active'));

            // 4. Limpiar el filtro del dashboard de fechas de fallo
            activeFalloDashboardFilter = null;
            document.querySelectorAll('#dashboard-historico .indicator-card.active-filter').forEach(card => card.classList.remove('active-filter'));

            // 5. Re-renderizar la tabla con los datos completos y el orden por defecto
            sortAndRenderTable(historicalTableBody, historicalLicitaciones, true);
        }

        /**
         * Ordena los datos por fecha de fallo y luego por fecha de creación (más recientes primero) y los renderiza en la tabla.
         * @param {HTMLTableSectionElement} tableBody - El `<tbody>` de la tabla.
         * @param {Array<Object>} data - El array de datos de licitaciones.
         * @param {boolean} isHistorical - Indica si son datos históricos.
         */
        function sortAndRenderTable(tableBody, data, isHistorical) {
            // Lógica de ordenamiento corregida y definitiva:
            // 1. Criterio principal: Fecha de fallo (descendente).
            // 2. Criterio de desempate: Fecha de creación del registro (descendente).
            data.sort((a, b) => {
                try {
                    // Normalizar fechas para evitar errores. Se usa una fecha muy antigua como fallback.
                    const dateA = a.fechaFallo ? new Date(a.fechaFallo) : new Date(0);
                    const dateB = b.fechaFallo ? new Date(b.fechaFallo) : new Date(0);

                    // 1. Comparar por fecha de presentación y apertura (descendente).
                    const dateComparison = dateB.getTime() - dateA.getTime();
                    if (dateComparison !== 0) return dateComparison;

                    // 2. Si las fechas son iguales, desempatar por fecha de creación (descendente).
                    const timeB = b.createdAt?.toMillis() || 0;
                    const timeA = a.createdAt?.toMillis() || 0; // Si las fechas de fallo son iguales, desempatar por fecha de creación (descendente).
                    return timeB - timeA;
                } catch (e) {
                    return 0; // Fallback si alguna fecha no es válida
                }
            });

            const filterKey = isHistorical ? 'historical' : 'main';
            const filteredData = applyAllFilters(data, filterKey);
            renderTable(tableBody, filteredData, isHistorical);
        }

        /**
         * Abre un modal con un iframe para mostrar una página web.
         * @param {string} url - La URL a cargar en el iframe.
         */
        function openWebviewModal(url) {
            webviewFrame.src = url;
            openModal(webviewModal);
        }

        // =============================================
        // MÓDULO: Gestión de licitaciones
        // =============================================
        
        /**
         * Guarda un nuevo registro de licitación en Firestore.
         * @param {Object} licitacionData - El objeto con los datos de la licitación a guardar.
         * @param {boolean} [isHistorical=false] - Si es `true`, guarda en la colección histórica.
         * @returns {Promise<void>}
         */
        async function saveLicitacion(licitacionData, isHistorical = false) {
            try {
                const collectionRef = isHistorical ? historicalLicitacionesCollectionRef : licitacionesCollectionRef;
                await collectionRef.add({ 
                    ...licitacionData, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
                showAlert("Licitación guardada con éxito!", "success");
            } catch (error) {
                console.error("Error al guardar la licitación:", error);
                showAlert(`Error al guardar: ${error.message}`, "error");
            }
        }

        /**
         * Actualiza un registro de licitación existente en Firestore.
         * @param {string} id - El ID del documento a actualizar.
         * @param {Object} updateData - El objeto con los campos a actualizar.
         * @param {boolean} isHistorical - `true` si la licitación está en la colección histórica.
         * @returns {Promise<void>}
         */
        async function updateLicitacion(id, updateData, isHistorical) {
            if (!id) {
                console.error("ID no válido para actualización");
                showAlert("Error interno: ID no válido", "error");
                return;
            }
            
            try {
                const collectionRef = isHistorical ? historicalLicitacionesCollectionRef : licitacionesCollectionRef;
                const licitacionDocRef = collectionRef.doc(id);
                
                const docSnapshot = await licitacionDocRef.get();
                if (!docSnapshot.exists) {
                    showAlert("El registro que intentas actualizar no existe", "error");
                    return;
                }
                
                await licitacionDocRef.update({ ...updateData, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                showAlert("Licitación actualizada con éxito!", "success");
            } catch (error) {
                console.error("Error al actualizar la licitación:", error);
                showAlert(`Error al actualizar: ${error.message}`, "error");
            }
        }

        /**
         * Elimina un registro de licitación de Firestore.
         * @param {string} id - El ID del documento a eliminar.
         * @param {boolean} isHistorical - `true` si la licitación está en la colección histórica.
         * @returns {Promise<void>}
         */
        async function deleteLicitacion(id, isHistorical) {
            if (!id) {
                console.error("ID no válido para eliminación");
                showAlert("Error interno: ID no válido", "error");
                return;
            }
            
            try {
                const collectionRef = isHistorical ? historicalLicitacionesCollectionRef : licitacionesCollectionRef;
                const licitacionDocRef = collectionRef.doc(id);
                
                const docSnapshot = await licitacionDocRef.get();
                if (!docSnapshot.exists) {
                    showAlert("El registro que intentas eliminar no existe", "error");
                    return;
                }
                
                await licitacionDocRef.delete();
                showAlert("Licitación eliminada con éxito!", "success");
            } catch (error) {
                console.error("Error al eliminar la licitación:", error);
                showAlert(`Error al eliminar: ${error.message}`, "error");
            }
        }

        /**
         * Maneja el evento de clic en el botón de editar de una fila de la tabla.
         * @param {HTMLElement} button - El botón que fue presionado.
         */
        function handleEditClick(button) {
            const currentUser = auth.currentUser;
            if (!currentUser || currentUser.isAnonymous) {
                showAlert("Debe iniciar sesión para editar registros.", "warning");
                return;
            }

            requirePassword(() => {
                const licitacionId = button.getAttribute('data-id');
                const isHistorical = button.getAttribute('data-is-historical') === 'true';

                if (!licitacionId) {
                    console.error("ID de licitación no encontrado para edición");
                    return;
                }

                currentEditIsHistorical = isHistorical;
                const allData = isHistorical ? historicalLicitaciones : licitaciones;
                const licitacionToEdit = allData.find(item => item.id === licitacionId);

                if (!licitacionToEdit) {
                    showAlert("No se pudo encontrar la licitación para editar", "error");
                    return;
                }

                document.getElementById('edit-id').value = licitacionId;

                // Set form values
                document.getElementById('edit-licitacion-fechaPresentacionApertura').value = licitacionToEdit.fechaPresentacionApertura || '';
                document.getElementById('edit-licitacion-fechaFallo').value = licitacionToEdit.fechaFallo || '';
                document.getElementById('edit-licitacion-fechaEstimadaInicio').value = licitacionToEdit.fechaEstimadaInicio || '';
                document.getElementById('edit-licitacion-linkComprasXM').value = licitacionToEdit.linkComprasXM || '';
                document.getElementById('edit-licitacion-codigoExpediente').value = licitacionToEdit.codigoExpediente || '';
                document.getElementById('edit-licitacion-descripcion').value = licitacionToEdit.descripcion || '';
                document.getElementById('edit-licitacion-generalidades').value = licitacionToEdit.generalidades || '';
                document.getElementById('edit-licitacion-monto').value = licitacionToEdit.monto || '';

                // Set select values
                $('#edit-licitacion-proyecto').val(licitacionToEdit.proyecto || '').trigger('change');
                $('#edit-licitacion-nombre').val(licitacionToEdit.nombre || '').trigger('change');
                $('#edit-licitacion-siglasDependencia').val(licitacionToEdit.siglasDependencia || '').trigger('change');
                $('#edit-licitacion-procedimientoContratacion').val(licitacionToEdit.procedimientoContratacion || '').trigger('change');
                $('#edit-licitacion-tipo').val(licitacionToEdit.tipo || '').trigger('change');
                $('#edit-licitacion-anoPublicacion').val(licitacionToEdit.anoPublicacion || '').trigger('change');
                $('#edit-licitacion-registradosInteres').val(licitacionToEdit.registradosInteres || '').trigger('change');
                $('#edit-licitacion-nombreLicitantes').val(licitacionToEdit.nombreLicitantes || '').trigger('change');
                $('#edit-licitacion-ganadorLicitacion').val(licitacionToEdit.ganadorLicitacion || '').trigger('change');

                openModal(editModal);
            });
        }

        /**
         * Maneja el evento de clic en el botón de eliminar de una fila de la tabla.
         * @param {HTMLElement} button - El botón que fue presionado.
         */
        function handleDeleteClick(button) {
            requirePassword(() => {
                licitacionToDeleteId = button.getAttribute('data-id');
                licitacionToDeleteIsHistorical = button.getAttribute('data-is-historical') === 'true';
                
                if (!licitacionToDeleteId) {
                    console.error("ID de licitación no encontrado para eliminación");
                    return;
                }
                
                openModal(confirmModal);
            });
        }

        /**
         * Muestra un modal con los detalles completos de una licitación.
         * @param {Object} licitacionItem - El objeto de la licitación a mostrar.
         * @param {boolean} [isHistorical=false] - Indica si el registro es del histórico.
         */
        function showDetailsModal(licitacionItem, isHistorical = false) {
            if (!licitacionItem) return;

            const filterKey = isHistorical ? 'historical' : 'main';
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.trim() : '';

            // Ocultar el tooltip de vista rápida al abrir el modal de detalles.
            if (quickViewTooltip) quickViewTooltip.classList.remove('visible');
 
            const downloadButtonHTML = `
                <button id="download-details-docx-btn" data-id="${licitacionItem.id}" data-is-historical="${isHistorical}" class="text-slate-400 hover:text-primary p-2 rounded-lg transition-colors" title="Descargar reporte DOCX">
                    <i class="fa-solid fa-file-word fa-lg"></i>
                </button>
            `;

            // --- INICIO: Lógica para la tabla de participantes inteligente ---
            const interesados = (licitacionItem.registradosInteres || '').split('\n').map(s => s.trim()).filter(Boolean);
            const licitantes = (licitacionItem.nombreLicitantes || '').split('\n').map(s => s.trim()).filter(Boolean);
            const ganadores = (licitacionItem.ganadorLicitacion || '').split('\n').map(s => s.trim()).filter(Boolean);

            const maxRows = Math.max(interesados.length, licitantes.length, ganadores.length);
            let participantesTbody = '';

            if (maxRows === 0) {
                participantesTbody = `
                    <tr>
                        <td>N/A</td>
                        <td>N/A</td>
                        <td class="highlight-fallo">N/A</td>
                    </tr>`;
            } else {
                for (let i = 0; i < maxRows; i++) {
                    participantesTbody += `
                        <tr>
                            <td>${highlightText(interesados[i] || '—', searchText)}</td>
                            <td>${highlightText(licitantes[i] || '—', searchText)}</td>
                            <td class="highlight-fallo">${highlightText(ganadores[i] || '—', searchText)}</td>
                        </tr>`;
                }
            }
            // --- FIN: Lógica para la tabla de participantes inteligente ---

            const sourceLink = licitacionItem.linkComprasXM && isValidUrl(licitacionItem.linkComprasXM) 
                ? `<a href="${licitacionItem.linkComprasXM}" target="_blank" class="text-blue-600 hover:underline break-all">${highlightText(licitacionItem.linkComprasXM, searchText)}</a>` 
                : `<p class="text-gray-700">${highlightText(licitacionItem.linkComprasXM || 'N/A', searchText)}</p>`;
        
            detailsModalContent.innerHTML = `
                <div class="details-header flex justify-between items-start">
                    <div>
                        <h3 class="project">${highlightText(licitacionItem.proyecto || 'Proyecto no especificado', searchText)}</h3>
                        <p class="date">${highlightText(licitacionItem.siglasDependencia || 'Dependencia no especificada', searchText)}</p>
                        <p class="date">Código de expediente: ${highlightText(licitacionItem.codigoExpediente || 'N/A', searchText)}</p>
                        <p class="date">Fecha de presentación y apertura: ${highlightText(formatDate(licitacionItem.fechaPresentacionApertura) || 'N/A', searchText)}</p>
                    </div>
                    ${downloadButtonHTML}
                </div>
        
                <div class="details-section">
                    <h4>Información General de la Licitación</h4>
                    <table class="details-table">
                        <tbody>
                            <tr>
                                <th>Nombre</th>
                                <td>${highlightText(licitacionItem.nombre || 'No especificado.', searchText)}</td>
                            </tr>
                            <tr>
                                <th>Descripción</th>
                                <td class="formatted-content">${highlightText(formatTextWithLineBreaks(licitacionItem.descripcion), searchText)}</td>
                            </tr>
                            <tr>
                                <th>Generalidades del Proyecto</th>
                                <td class="formatted-content">${highlightText(formatTextWithLineBreaks(licitacionItem.generalidades), searchText)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="details-section">
                    <h4>Detalles de Contratación</h4>
                    <table class="details-table">
                        <thead>
                            <tr>
                                <th>Procedimiento de Contratación</th>
                                <th>Tipo</th>
                                <th>Monto</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${highlightText(licitacionItem.procedimientoContratacion || 'N/A', searchText)}</td>
                                <td>${highlightText(licitacionItem.tipo || 'N/A', searchText)}</td>
                                <td class="highlight-fallo">${highlightText(licitacionItem.monto ? '$' + Number(licitacionItem.monto).toLocaleString('es-MX') : 'N/A', searchText)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
        
                <div class="details-section">
                    <h4>Cronología del Proceso</h4>
                    <table class="details-table">
                        <thead>
                            <tr>
                                <th>Fecha de Presentación y Apertura</th>
                                <th>Fecha de Fallo</th>
                                <th>Fecha Estimada de Inicio</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${highlightText(formatDate(licitacionItem.fechaPresentacionApertura) || 'N/A', searchText)}</td>
                                <td class="highlight-fallo">${highlightText(formatDate(licitacionItem.fechaFallo) || 'N/A', searchText)}</td> 
                                <td>${highlightText(formatDate(licitacionItem.fechaEstimadaInicio) || 'N/A', searchText)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
        
                <div class="details-section">
                    <h4>Participantes en el Proceso</h4>
                    <table class="details-table equal-cols">
                        <thead>
                            <tr>
                                <th>Registrados o manifestaron interés</th>
                                <th>Nombre de licitantes</th>
                                <th>Ganador de la licitación</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${participantesTbody}
                        </tbody>
                    </table>
                </div>
        
                <div class="details-section">
                    <h4>Link de Compras MX</h4>
                    ${sourceLink}
                </div>
            `;

            // Añadir el listener para el nuevo botón de descarga
            const downloadBtn = detailsModalContent.querySelector('#download-details-docx-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => {
                    const id = downloadBtn.dataset.id;
                    const isHist = downloadBtn.dataset.isHistorical === 'true';
                    generateDoc(id, isHist);
                });
            }
            openModal(viewDetailsModal);
        }

        /**
         * Genera el HTML para mostrar los detalles de una sola licitación dentro del modal de vista múltiple.
         * @param {Object} licitacionItem - El objeto de la licitación.
         * @param {number} index - El índice del elemento en la lista filtrada.
         * @param {boolean} [isHistorical=false] - Indica si el registro es del histórico.
         */
        function generateSingleDetailHtml(licitacionItem, index, isHistorical = false) {
            if (!licitacionItem) return '';

            const filterKey = isHistorical ? 'historical' : 'main';
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.trim() : '';

            // --- Botón de descarga para cada item ---
            const downloadButtonHTML = `
                <button data-id="${licitacionItem.id}" data-is-historical="${isHistorical}" class="generate-doc-btn text-slate-400 hover:text-primary p-2 rounded-lg transition-colors" title="Descargar reporte DOCX">
                    <i class="fa-solid fa-file-word fa-lg"></i>
                </button>
            `;

            // --- Lógica para la tabla de participantes ---
            const interesados = (licitacionItem.registradosInteres || '').split('\n').map(s => s.trim()).filter(Boolean);
            const licitantes = (licitacionItem.nombreLicitantes || '').split('\n').map(s => s.trim()).filter(Boolean);
            const ganadores = (licitacionItem.ganadorLicitacion || '').split('\n').map(s => s.trim()).filter(Boolean);

            const maxRows = Math.max(interesados.length, licitantes.length, ganadores.length);
            let participantesTbody = '';

            if (maxRows === 0) {
                participantesTbody = `<tr><td>N/A</td><td>N/A</td><td class="highlight-fallo">N/A</td></tr>`;
            } else {
                for (let i = 0; i < maxRows; i++) {
                    participantesTbody += `
                        <tr>
                            <td>${highlightText(interesados[i] || '—', searchText)}</td>
                            <td>${highlightText(licitantes[i] || '—', searchText)}</td>
                            <td class="highlight-fallo">${highlightText(ganadores[i] || '—', searchText)}</td>
                        </tr>`;
                }
            }

            const sourceLink = licitacionItem.linkComprasXM && isValidUrl(licitacionItem.linkComprasXM) 
                ? `<a href="${licitacionItem.linkComprasXM}" target="_blank" class="text-blue-600 hover:underline break-all">${highlightText(licitacionItem.linkComprasXM, searchText)}</a>` 
                : `<p class="text-gray-700">${highlightText(licitacionItem.linkComprasXM || 'N/A', searchText)}</p>`;
        
            return `
                <div class="multi-details-item">
                    <div class="details-header flex justify-between items-start">
                        <div>
                           <h3 class="project">${highlightText(licitacionItem.proyecto || 'Proyecto no especificado', searchText)}</h3>
                            <p class="date">${highlightText(licitacionItem.siglasDependencia || 'Dependencia no especificada', searchText)}</p>
                            <p class="date">Código de expediente: ${highlightText(licitacionItem.codigoExpediente || 'N/A', searchText)}</p>
                            <p class="date">Fecha de presentación y apertura: ${highlightText(formatDate(licitacionItem.fechaPresentacionApertura) || 'N/A', searchText)}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-lg font-bold text-primary bg-primary/10 px-3 py-1 rounded-full">${index + 1}</span>
                            ${downloadButtonHTML}
                        </div>
                    </div>
            
                    <div class="details-section">
                        <h4>Información General de la Licitación</h4>
                        <table class="details-table"><tbody><tr><th>Nombre</th><td>${highlightText(licitacionItem.nombre || 'No especificado.', searchText)}</td></tr><tr><th>Descripción</th><td class="formatted-content">${highlightText(formatTextWithLineBreaks(licitacionItem.descripcion), searchText)}</td></tr><tr><th>Generalidades del Proyecto</th><td class="formatted-content">${highlightText(formatTextWithLineBreaks(licitacionItem.generalidades), searchText)}</td></tr></tbody></table>
                    </div>

                    <div class="details-section">
                        <h4>Detalles de Contratación</h4>
                        <table class="details-table"><thead><tr><th>Procedimiento de Contratación</th><th>Tipo</th><th>Monto</th></tr></thead><tbody><tr><td>${highlightText(licitacionItem.procedimientoContratacion || 'N/A', searchText)}</td><td>${highlightText(licitacionItem.tipo || 'N/A', searchText)}</td><td class="highlight-fallo">${highlightText(licitacionItem.monto ? '$' + Number(licitacionItem.monto).toLocaleString('es-MX') : 'N/A', searchText)}</td></tr></tbody></table>
                    </div>
            
                    <div class="details-section">
                        <h4>Cronología del Proceso</h4>
                        <table class="details-table"><thead><tr><th>Fecha de Presentación y Apertura</th><th>Fecha de Fallo</th><th>Fecha Estimada de Inicio</th></tr></thead><tbody><tr><td>${highlightText(formatDate(licitacionItem.fechaPresentacionApertura) || 'N/A', searchText)}</td><td class="highlight-fallo">${highlightText(formatDate(licitacionItem.fechaFallo) || 'N/A', searchText)}</td><td>${highlightText(formatDate(licitacionItem.fechaEstimadaInicio) || 'N/A', searchText)}</td></tr></tbody></table>
                    </div>
            
                    <div class="details-section">
                        <h4>Participantes en el Proceso</h4>
                        <table class="details-table equal-cols"><thead><tr><th>Registrados o manifestaron interés</th><th>Nombre de licitantes</th><th>Ganador de la licitación</th></tr></thead><tbody>${participantesTbody}</tbody></table>
                    </div>
            
                    <div class="details-section"><h4>Link de Compras MX</h4>${sourceLink}</div>
                </div>`;
        }

        /**
         * Devuelve una función de comparación para ordenar las licitaciones por fecha de fallo descendente,
         * que es el orden por defecto de la tabla principal.
         * @returns {function(Object, Object): number} La función de comparación para `Array.prototype.sort()`.
         */
        function getSortComparator() {
            return (a, b) => {
                try {
                    const dateA = a.fechaFallo ? new Date(a.fechaFallo) : new Date(0);
                    const dateB = b.fechaFallo ? new Date(b.fechaFallo) : new Date(0);
                    const dateComparison = dateB.getTime() - dateA.getTime();
                    if (dateComparison !== 0) return dateComparison;

                    const timeB = b.createdAt?.toMillis() || 0;
                    const timeA = a.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                } catch (e) { return 0; }
            };
        }

        /**
         * Muestra un modal con los detalles de todas las licitaciones actualmente visibles en la tabla.
         * @param {boolean} [isHistorical=true] - Indica si se deben usar los datos históricos.
         */
        function showMultiDetailsModal(isHistorical = true) {
            // 1. Ordenar los datos como en la tabla
            const sortedData = [...historicalLicitaciones].sort(getSortComparator());
            // 2. Aplicar los filtros a los datos ya ordenados
            const filteredData = applyAllFilters(sortedData, 'historical');
            if (filteredData.length === 0) {
                showAlert("No hay licitaciones en la tabla para mostrar.", "warning");
                return;
            }
            multiDetailsContentContainer.innerHTML = filteredData.map((item, index) => generateSingleDetailHtml(item, index, isHistorical)).join('');
            openModal(multiDetailsModal);
        }

        /**
         * Obtiene la referencia al documento de la plantilla de Word por defecto en Firestore.
         * @returns {{ref: firebase.firestore.DocumentReference, type: string}} Objeto con la referencia y el tipo.
         */
        function getTemplateDocRef() {
            return {
                ref: db.collection('config').doc('wordTemplate_default'),
                type: 'default'
            };
        }

        /**
         * Genera un documento .docx a partir de una plantilla almacenada en Firestore.
         * @param {string} licitacionId - El ID del registro de la licitación.
         * @param {boolean} isHistorical - Indica si el registro es del histórico.
         */
        async function generateDoc(licitacionId, isHistorical) {
            // Módulo para manejar HTML en docxtemplater
            const HTMLModule = {
                name: "HTMLModule",
                set: function(options) { this.options = options; },
                get: function(scope, context) { if (scope.startsWith('@')) { return { _type: "html", value: context.scopeList[context.scopeList.length - 1] }; } },
                render: function(part, scope) { if (part.type === "html") { return { value: part.value }; } }
            };

            // 1. Verificar que las librerías necesarias estén cargadas y cargar fallbacks si es necesario
            let missingLibs = checkRequiredLibraries();
            if (missingLibs.includes('PizZip') || missingLibs.includes('docxtemplater')) {
                showAlert("Cargando librerías necesarias...", "info");
                try {
                    await loadFallbackLibraries(missingLibs);
                    // Verificar nuevamente después de cargar los fallbacks
                    missingLibs = checkRequiredLibraries();
                    if (missingLibs.includes('PizZip') || missingLibs.includes('docxtemplater')) {
                        const errorMessage = `No se pudieron cargar las librerías: ${missingLibs.join(', ')}. Verifique su conexión.`;
                        console.error(errorMessage);
                        return showAlert(errorMessage, "error");
                    }
                } catch (error) {
                    const errorMessage = "Error al cargar librerías para generar documentos.";
                    console.error(errorMessage, error);
                    return showAlert(errorMessage, "error");
                }
            } else if (missingLibs.includes('saveAs')) {
                 return showAlert("Error: La librería FileSaver.js no se cargó correctamente.", "error");
            }

            showAlert("Generando reporte...", "info");
            const dataSet = isHistorical ? historicalLicitaciones : licitaciones;
            const record = dataSet.find(item => item.id === licitacionId);

            if (!record) {
                return showAlert("No se encontró el registro de la licitación.", "error");
            }

            try {
                // 2. Obtener la plantilla correcta desde Firestore
                const { ref: templateDocRef, type: templateType } = getTemplateDocRef();
                let templateDoc = await templateDocRef.get();

                if (!templateDoc.exists || !templateDoc.data().templateData) {
                    return showAlert("No se encontró la plantilla de licitaciones. Por favor, cárguela en la pestaña de Reportes.", "error");
                }
                const base64String = templateDoc.data().templateData;

                // Convertir la plantilla de Base64 a un formato que docxtemplater pueda usar
                const templateBlob = base64ToArrayBuffer(base64String);

                // 3. Procesar la plantilla con docxtemplater
                // Usamos PizZip directamente desde el objeto window
                const zip = new PizZip(templateBlob);
                const doc = new window.docxtemplater(zip, {
                    modules: [HTMLModule], // Cargar el módulo HTML
                    paragraphLoop: true,
                    linebreaks: true
                });

                // 4. Mapeo de datos (asegurando que no haya valores nulos)
                const dataForTemplate = {
                    palabra_clave_0: record.proyecto || 'No especificado',
                    palabra_clave_1: record.nombre || 'No especificado',
                    palabra_clave_2: record.descripcion || 'No especificado',
                    palabra_clave_3: record.generalidades || 'No especificado',
                    palabra_clave_4: record.siglasDependencia || 'No especificado',
                    palabra_clave_5: record.codigoExpediente || 'No especificado',
                    palabra_clave_6: record.procedimientoContratacion || 'No especificado',
                    palabra_clave_7: record.tipo || 'No especificado',
                    palabra_clave_8: record.anoPublicacion || 'No especificado',
                    palabra_clave_9: formatDate(record.fechaPresentacionApertura) || 'No especificado',
                    palabra_clave_10: formatDate(record.fechaFallo) || 'No especificado',
                    palabra_clave_11: formatDate(record.fechaEstimadaInicio) || 'No especificado',
                    palabra_clave_12: record.registradosInteres || 'No especificado',
                    palabra_clave_13: record.nombreLicitantes || 'No especificado',
                    palabra_clave_14: record.ganadorLicitacion || 'No especificado',
                    palabra_clave_15: record.monto ? '$' + Number(record.monto).toLocaleString('es-MX') : 'No especificado',
                    palabra_clave_16: record.linkComprasXM || 'No especificado',
                };

                doc.setData(dataForTemplate);
                doc.render();

                // 5. Generar y descargar el archivo
                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });

                const fileName = `Reporte-${(record.proyecto || 'Licitacion').replace(/ /g, '_')}.docx`;
                saveAs(out, fileName);
                showAlert("¡Reporte generado con éxito!", "success");

            } catch (error) {
                console.error("Error en docxtemplater:", error);
                // Error mejorado para distinguir problemas de plantilla
                if (error.properties && error.properties.errors) {
                    showAlert("Error en la plantilla: " + error.properties.errors[0].message, "error");
                } else {
                    showAlert("Error al generar el reporte. Revise la consola.", "error");
                }
            }
        }

        // =============================================
        // MÓDULO: Gestión de datos históricos
        // =============================================
        
        /**
         * Elimina todos los documentos de la colección 'historicalLicitaciones'.
         */
        async function deleteAllHistorical() {
            const batch = db.batch();
            historicalLicitaciones.forEach(licitacionItem => {
                const ref = historicalLicitacionesCollectionRef.doc(licitacionItem.id);
                batch.delete(ref);
            });
            await batch.commit(); 
        }

        /**
         * Importa un lote de registros de licitaciones a la colección 'historicalLicitaciones'.
         * @param {Array<Object>} data - Un array de objetos de licitación para importar.
         */
        async function importHistoricalData(data) {
            try {
                const batch = db.batch();
                data.forEach(item => {
                    const docRef = historicalLicitacionesCollectionRef.doc();
                    batch.set(docRef, { ...item, importedAt: firebase.firestore.FieldValue.serverTimestamp() });
                });
                await batch.commit();
                showAlert(`Se han importado ${data.length} registros históricos.`, "success");
                
                updateDynamicSelectOptions();
                renderTable(historicalTableBody, historicalLicitaciones, true);

            } catch (error) {
                console.error("Error al importar datos históricos:", error);
                showAlert(`Error al importar: ${error.message}`, "error");
            }
        }

        // =============================================================
        // MÓDULO: Catálogos de opciones dinámicas (Actualizado)
        // =============================================================

        // Catálogo de proyectos
        const catalogoProyectos = [
        ];

        // Catálogo de nombres de licitaciones
        const catalogoNombres = [
        ];

        // Catálogo de siglas de dependencias
        const catalogoSiglasDependencias = [
            "AGN - Archivo General de la Nación",
            "CEPROPIE - Centro de Producción de Programas Informativos y Especiales",
            "CONAVIM - Comisión Nacional para Prevenir y Erradicar la Violencia Contra las Mujeres",
            "CONAPRED - Consejo Nacional para Prevenir la Discriminación",
            "COMAR - Coordinación General de la Comisión Mexicana de Ayuda a Refugiados",
            "INM - Instituto Nacional de Migración",
            "INAFED - Instituto Nacional para el Federalismo y el Desarrollo Municipal",
            "SEGOB - Secretaría de Gobernación",
            "CONAPO - Secretaría General del Consejo Nacional de Población",
            "SIPINNA - Sistema Nacional de Protección Integral de Niñas, Niños y Adolescentes",
            "TGM - Talleres Gráficos de México",
            "AMEXCID - Agencia Mexicana de Cooperación Internacional para el Desarrollo",
            "IME - Instituto de Mexicanas y Mexicanos en el Exterior",
            "IMR - Instituto Matías Romero",
            "SRE  - Secretaría de Relaciones Exteriores",
            "AGROASEMEX - Agroasemex, S.A.",
            "BANBI - Banco del Bienestar, S.N.C., I.B.D.",
            "BANJERCITO - Banco Nacional del Ejército, Fuerza Aérea y Armada, S.N.C.",
            "CMM - Casa de Moneda de México",
            "CNBV - Comisión Nacional Bancaria y de Valores",
            "CNSF - Comisión Nacional de Seguros y Fianzas",
            "CONSAR - Comisión Nacional del Sistema de Ahorro para el Retiro",
            "CONDUSEF - Comisión Nacional para la Protección y Defensa de los Usuarios de Servicios Financieros",
            "FOCIR - Fondo de Capitalización e Inversión del Sector Rural",
            "INDAABIN - Instituto de Administración y Avalúos de Bienes Nacionales",
            "INDEP - Instituto para Devolver al Pueblo lo Robado",
            "IPAB - Instituto para la Protección al Ahorro Bancario",
            "LOTENAL - Lotería Nacional",
            "LOTENAL - Lotería Nacional Para la Asistencia Pública",
            "SHCP - Secretaría de Hacienda y Crédito Público",
            "SAT - Servicio de Administración Tributaria",
            "ISSFAM - Instituto de Seguridad Social para las Fuerzas Armadas Mexicanas",
            "DEFENSA - Secretaría de la Defensa Nacional",
            "COLPOS - Colegio de Postgraduados",
            "CSAEGRO - Colegio Superior Agropecuario del Estado de Guerrero",
            "CONAPESCA - Comisión Nacional de Acuacultura y Pesca",
            "CONAZA - Comisión Nacional de las Zonas Áridas",
            "CONADESUCA - Comité Nacional para el Desarrollo Sustentable de la Caña de Azúcar",
            "DICONSA - Diconsa, S.A de C.V.",
            "FIRCO - Fideicomiso de Riesgo Compartido",
            "INIFAP - Instituto Nacional de Investigaciones Forestales, Agrícolas y Pecuarias",
            "INCARURAL - Instituto Nacional para el Desarrollo de Capacidades del Sector Rural, A.C.",
            "LICONSA - Liconsa, S.A. de C.V.",
            "PRONABIVE - Productora Nacional de Biológicos Veterinarios",
            "AGRICULTURA - Secretaría de Agricultura y Desarrollo Rural",
            "SIAP - Servicio de Información Agroalimentaria y Pesquera",
            "SNICS - Servicio Nacional de Inspección y Certificación de Semillas",
            "SENASICA - Servicio Nacional de Sanidad, Inocuidad y Calidad Agroalimentaria",
            "ASA - Aeropuertos y Servicios Auxiliares",
            "AEM - Agencia Espacial Mexicana",
            "CAPUFE - Caminos y Puentes Federales de Ingresos y Servicios Conexos",
            "FINABIEN - Financiera para el Bienestar",
            "GACM - Grupo Aeroportuario de la Ciudad de México, S.A. de C.V.",
            "IMT - Instituto Mexicano del Transporte",
            "SICT - Secretaría de Infraestructura, Comunicaciones y Transportes",
            "SEPOMEX - Servicio Postal Mexicano",
            "SENEAM - Servicios a la Navegación en el Espacio Aéreo Mexicano",
            "CENAM - Centro Nacional de Metrología",
            "CONADIC - Comisión Nacional de Salud Mental y Adicciones",
            "CONAMER - Comisión Nacional de Mejora Regulatoria",
            "EXPOSAL - Exportadora de Sal, S.A. de C.V.",
            "FIFOMI - Fideicomiso de Fomento Minero",
            "IMPI - Instituto Mexicano de la Propiedad Industrial",
            "INDESOL - Instituto Nacional de Desarrollo Social",
            "INADEM - Instituto Nacional del Emprendedor",
            "PROFECO - Procuraduría Federal del Consumidor",
            "SE - Secretaría de Economía",
            "SCCPRI - Secretaría Técnica de la Comisión Calificadora de Publicaciones y Revistas Ilustradas",
            "SGM - Servicio Geológico Mexicano",
            "AEFCM - Autoridad Educativa Federal en la Ciudad de México",
            "CETI - Centro de Enseñanza Técnica Industrial",
            "CINVESTAV - Centro de Investigación y de Estudios Avanzados del Instituto Politécnico Nacional",
            "CRAE - Centro Regional de Alta Especialidad de Chiapas",
            "COLBACH - Colegio de Bachilleres",
            "CONALEP - Colegio Nacional de Educación Profesional Técnica",
            "CAAD - Comisión de Apelación y Arbitraje del Deporte",
            "COFAA - Comisión de Operación y Fomento de Actividades Académicas del Instituto Politécnico Nacional",
            "CONADE - Comisión Nacional de Cultura Física y Deporte",
            "CONALITEG - Comisión Nacional de Libros de Texto Gratuitos",
            "CONAFE - Consejo Nacional de Fomento Educativo",
            "PRENDE - Coordinación General @prende.mx",
            "CNBBBJ - Coordinación Nacional de Becas para el Bienestar Benito Juárez",
            "CONOCER - Fideicomiso de los Sistemas Normalizados de Competencia Laboral y de Certificación de Competencia Laboral",
            "FND - Financiera Nacional de Desarrollo Agropecuario, Rural, Forestal y Pesquero",
            "FCE - Fondo de Cultura Económica",
            "HRAEI - Hospital Regional de Alta Especialidad de Ixtapaluca",
            "HRAEPY - Hospital Regional de Alta Especialidad de la Península de Yucatán",
            "HRAEO - Hospital Regional de Alta Especialidad de Oaxaca",
            "HRAEB - Hospital Regional de Alta Especialidad del Bajío",
            "IEPSA - Impresora y Encuadernadora Progreso, S.A. de C.V.",
            "INSABI - Instituto de Salud para el Bienestar",
            "IMER - Instituto Mexicano de la Radio",
            "INIFED - Instituto Nacional de la Infraestructura Física Educativa",
            "INEA - Instituto Nacional para la Educación de los Adultos",
            "IPN - Instituto Politécnico Nacional",
            "NOTIMEX - Notimex, Agencia de Noticias del Estado Mexicano",
            "POI-IPN - Patronato de Obras e Instalaciones del Instituto Politécnico Nacional",
            "SEP - Secretaría de Educación Pública",
            "TecNM - Tecnológico Nacional de México",
            "USICAMM - Unidad del Sistema para la Carrera de las Maestras y los Maestros",
            "UNADM - Universidad Abierta y a Distancia de México",
            "UPN - Universidad Pedagógica Nacional",
            "APBP - Administración del Patrimonio de la Beneficencia Pública",
            "CNEGSR - Centro Nacional de Equidad de Género y Salud Reproductiva",
            "CENETEC - Centro Nacional de Excelencia Tecnológica en Salud",
            "CENAPRECE - Centro Nacional de Programas Preventivos y Control de Enfermedades",
            "CNTS - Centro Nacional de la Transfusión Sanguínea",
            "CENATRA - Centro Nacional de Trasplantes",
            "CENSIDA - Centro Nacional para la Prevención y el Control del VIH/SIDA",
            "CENSIA - Centro Nacional para la Salud de la Infancia y la Adolescencia",
            "CIJ - Centros de Integración Juvenil, A.C.",
            "COFEPRIS - Comisión Federal para la Protección contra Riesgos Sanitarios",
            "CONAMED - Comisión Nacional de Arbitraje Médico",
            "CNB - Comisión Nacional de Bioética",
            "COMESA - Compañía Mexicana de Exploraciones, S.A. de C.V",
            "CPTM - Consejo de Promoción Turística de México, S.A. de C.V.",
            "HGM - Hospital General de México \"Dr. Eduardo Liceaga\"",
            "GEA - Hospital General \"Dr. Manuel Gea González\"",
            "HIM - Hospital infantil de México Federico Gómez",
            "HJM - Hospital Juárez de México",
            "HRAEV - Hospital Regional de Alta Especialidad de Ciudad Victoria \"Bicentenario 2010\"",
            "INCAN - Instituto Nacional de Cancerología",
            "INCAR - Instituto Nacional de Cardiología Ignacio Chávez",
            "INCMNSZ - Instituto Nacional de Ciencias Médicas y Nutrición Salvador Zubirán",
            "INER - Instituto Nacional de Enfermedades Respiratorias Ismael Cosío Villegas",
            "GERIATRIA - Instituto Nacional de Geriatría",
            "INMEGEN - Instituto Nacional de Medicina Genómica",
            "INNN - Instituto Nacional de Neurología y Neurocirugía Manuel Velasco Suárez",
            "INP - Instituto Nacional de Pediatría",
            "INPER - Instituto Nacional de Perinatología Isidro Espinosa de los Reyes",
            "INPRFM - Instituto Nacional de Psiquiatría Ramón de la Fuente Muñiz",
            "INR - Instituto Nacional de Rehabilitación Luis Guillermo Ibarra Ibarra",
            "INSP - Instituto Nacional de Salud Pública",
            "BIRMEX - Laboratorios de Biológicos y Reactivos de México, S.A. de C.V.",
            "SALUD - Secretaría de Salud",
            "SAP - Servicios de Atención Psiquiátrica",
            "DIF - Sistema Nacional para el Desarrollo Integral de la Familia",
            "ASIPONA ALTAMIRA - Administración del Sistema Portuario Nacional Altamira, S.A. de C.V.",
            "ASIPONA COATZACOALCOS - Administración del Sistema Portuario Nacional Coatzacoalcos, S.A. de C.V.",
            "ASIPONA DOS BOCAS - Administración del Sistema Portuario Nacional Dos Bocas, S.A. de C.V.",
            "ASIPONA ENSENADA - Administración del Sistema Portuario Nacional Ensenada, S.A. de C.V.",
            "ASIPONA GUAYMAS - Administración del Sistema Portuario Nacional Guaymas, S.A. de C.V.",
            "ASIPONA LÁZARO CARDENAS - Administración del Sistema Portuario Nacional Lázaro Cárdenas, S.A. de C.V.",
            "ASIPONA MANZANILLO - Administración del Sistema Portuario Nacional Manzanillo, S.A. de C.V.",
            "ASIPONA MAZATLÁN - Administración del Sistema Portuario Nacional Mazatlán, S.A. de C.V.",
            "ASIPONA PROGRESO - Administración del Sistema Portuario Nacional Progreso, S.A. de C.V.",
            "ASIPONA CHIAPAS - Administración del Sistema Portuario Nacional Puerto Chiapas, S.A. de C.V.",
            "ASIPONA VALLARTA - Administración del Sistema Portuario Nacional Puerto Vallarta, S.A. de C.V.",
            "ASIPONA SALINA CRUZ - Administración del Sistema Portuario Nacional Salina Cruz, S.A. de C.V.",
            "ASIPONA TAMPICO - Administración del Sistema Portuario Nacional Tampico, S.A. de C.V.",
            "ASIPONA TOPOLOBAMPO - Administración del Sistema Portuario Nacional Topolobampo, S.A. de C.V.",
            "ASIPONA TUXPAN - Administración del Sistema Portuario Nacional Tuxpan, S.A. de C.V.",
            "ASIPONA VERACRUZ - Administración del Sistema Portuario Nacional Veracruz, S.A. de C.V.",
            "AICM - Aeropuerto Internacional de la Ciudad de México, S.A. de C.V.",
            "FUMPM - Fideicomiso Universidad Marítima y Portuaria de México",
            "MARINA - Secretaría de Marina",
            "CONASAMI - Comisión Nacional de los Salarios Mínimos",
            "CONAMPROS - Comité Nacional Mixto de Protección al Salario",
            "INFONACOT - Instituto del Fondo Nacional para el Consumo de los Trabajadores",
            "PROFEDET - Procuraduría Federal de la Defensa del Trabajo",
            "STyPS - Secretaría del Trabajo y Previsión Social",
            "CONAVI - Comisión Nacional de Vivienda",
            "FIFONAFE - Fideicomiso Fondo Nacional de Fomento Ejidal",
            "FONHAPO - Fidecomiso Fondo Nacional de Habitaciones Populares",
            "PROMEXICO - Fideicomiso ProMéxico",
            "INSUS - Instituto Nacional del Suelo Sustentable",
            "PA - Procuraduría Agraria",
            "RAN - Registro Agrario Nacional",
            "SEDATU - Secretaría de Desarrollo Agrario, Territorial y Urbano",
            "ASEA - Agencia Nacional de Seguridad Industrial y de Protección al Medio Ambiente del Sector Hidrocarburos",
            "CONANP - Comisión Nacional de Áreas Naturales Protegidas",
            "CONAGUA - Comisión Nacional del Agua",
            "CONAFOR - Comisión Nacional Forestal",
            "IMTA - Instituto Mexicano de Tecnología del Agua",
            "INECC - Instituto Nacional de Ecología y Cambio Climático",
            "PROFEPA - Procuraduría Federal de Protección al Ambiente",
            "SEMARNAT - Secretaría de Medio Ambiente y Recursos Naturales",
            "CENACE - Centro Nacional de Control de Energía",
            "CENAGAS - Centro Nacional de Control del Gas Natural",
            "CNH - Comisión Nacional de Hidrocarburos",
            "CNSNS - Comisión Nacional de Seguridad Nuclear y Salvaguardias",
            "CONUEE - Comisión Nacional para el Uso Eficiente de la Energía",
            "CNE - Comisión Nacional de Energía",
            "IMP - Instituto Mexicano del Petróleo",
            "INEEL - Instituto Nacional de Electricidad y Energías Limpias",
            "ININ - Instituto Nacional de Investigaciones Nucleares",
            "SENER - Secretaría de Energía",
            "CONADIS - Consejo Nacional para el Desarrollo y la Inclusión de las Personas con Discapacidad",
            "FONART - Fondo Nacional para el Fomento de las Artesanías",
            "IMJ - Instituto Mexicano de la Juventud",
            "INAES - Instituto Nacional de la Economía Social",
            "INAPAM - Instituto Nacional de las Personas Adultas Mayores",
            "BIENESTAR - Secretaría de Bienestar",
            "INFRAESTRUCTURA - FONATUR Infraestructura, S.A. de C.V.",
            "FTM - FONATUR Tren Maya, S.A. de C.V.",
            "FONATUR - Fondo Nacional de Fomento al Turismo",
            "SECTUR - Secretaría de Turismo",
            "CENAPRED - Centro Nacional de Prevención de Desastres",
            "CONASE - Coordinación Nacional Antisecuestro y Delitos de Alto Impacto",
            "PF - Policía Federal",
            "PRS - Prevención y Reinserción Social",
            "SESNSP - Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública",
            "SPF - Servicio de Protección Federal",
            "CJEF - Consejería Jurídica del Ejecutivo Federal",
            "CIDESI - Centro de Ingeniería y Desarrollo Industrial",
            "CICY - Centro de Investigación Científica de Yucatán, A.C.",
            "CICESE - Centro de investigación Científica y de Educación Superior de Ensenada, Baja California",
            "INFOTEC - INFOTEC Centro de Investigación e Innovación en Tecnologías de la Información y Comunicación",
            "CIAD - Centro de Investigación en Alimentación y Desarrollo, A.C.",
            "CENTROGEO - Centro de Investigación en Ciencias de Información Geoespacial, A.C.",
            "CIMAT - Centro de Investigación en Matemáticas, A.C.",
            "CIMAV - Centro de Investigación en Materiales Avanzados, S.C.",
            "CIQA - Centro de Investigación en Química Aplicada",
            "CIATEJ - Centro de Investigación y Asistencia en Tecnología y Diseño del Estado de Jalisco, A.C.",
            "CIDETEQ - Centro de Investigación y Desarrollo Tecnológico en Electroquímica, S.C.",
            "CIDE - Centro de Investigación y Docencia Económicas, A.C.",
            "CIESAS - Centro de Investigaciones y Estudios Superiores en Antropología Social",
            "CIBNOR - Centro de Investigaciones Biológicas del Noroeste, S.C.",
            "CIO - Centro de Investigaciones en Óptica, A.C.",
            "CIATEC - CIATEC, A.C. \"Centro de Innovación Aplicada en Tecnologías Competitivas\"",
            "CIATEQ - CIATEQ, A.C. Centro de Tecnología Avanzada",
            "COLEF - EI Colegio de la Frontera Norte, A.C.",
            "ECOSUR - EI Colegio de la Frontera Sur",
            "COLMICH - El Colegio de Michoacán, A.C.",
            "COLSAN - EI Colegio de San Luis, A.C.",
            "INECOL - Instituto de Ecología, A.C.",
            "MORA - Instituto de Investigaciones \"Dr. José María Luis Mora\"",
            "INAOE - Instituto Nacional de Astrofísica, Óptica y Electrónica",
            "IPICYT - Instituto Potosino de Investigación Científica y Tecnológica, A.C.",
            "SECIHTI - Secretaría de Ciencia, Humanidades, Tecnología e Innovación",
            "CCC - Centro de Capacitación Cinematográfica, A.C.",
            "CECUT - Compañía Operadora del Centro Cultural y Turístico de Tijuana, S.A. de C.V.",
            "EDUCAL - Educal, S.A. de C.V.",
            "ECHASA - Estudios Churubusco Azteca, S.A.",
            "FICINE - Fideicomiso para la Cineteca Nacional",
            "IMCINE - Instituto Mexicano de Cinematografía",
            "INAH - Instituto Nacional de Antropología e Historia",
            "INBAL - Instituto Nacional de Bellas Artes y Literatura",
            "INEHRM - Instituto Nacional de Estudios Históricos de las Revoluciones de México ",
            "INALI - Instituto Nacional de Lenguas Indígenas",
            "INDAUTOR - Instituto Nacional del Derecho de Autor ",
            "RE - Radio Educación",
            "CULTURA - Secretaría de Cultura",
            "CANAL 22 - Televisión Metropolitana, S.A. de C.V.",
            "ASERCA - Agencia de Servicios a la Comercialización y Desarrollo de Mercados Agropecuarios",
            "CEAV - Comisión Ejecutiva de Atención a Víctimas",
            "FIT - Ferrocarril del Istmo de Tehuantepec, S.A. de C.V.",
            "FCONST - FONATUR Constructora, S.A. de C.V.",
            "FOVISSSTE - Fondo de la Vivienda del Instituto de Seguridad y Servicios Sociales de los Trabajadores del Estado",
            "INNOVA BIENESTAR - InnovaBienestar de México, S.A.P.I. de C.V.",
            "ISSSTE - Instituto de Seguridad y Servicios Sociales de los Trabajadores del Estado",
            "IMSS - Instituto Mexicano del Seguro Social",
            "INACIPE - Instituto Nacional de Ciencias Penales",
            "INMUJERES - Instituto Nacional de las Mujeres",
            "INPI - Instituto Nacional de los Pueblos Indígenas",
            "INAPESCA - Instituto Mexicano de Investigación en Pesca y Acuacultura Sustentables",
            "PRODECON - Procuraduría de la Defensa del Contribuyente",
            "PGR - Fiscalía General de la República",
            "SABG - Secretaría Anticorrupción y Buen Gobierno",
            "SPR - Sistema Público de Radiodifusión del Estado Mexicano",
            "SUPERISSSTE - SUPERISSSTE",
            "PROMTEL - Organismo Promotor de Inversiones en Telecomunicaciones",
            "ZEE - Autoridad Federal para el Desarrollo de las Zonas Económicas Especiales",
            "CAIMFS - Coordinación para la Atención Integral de la Migración en la Frontera Sur",
            "SESNA - Secretaría Ejecutiva del Sistema Nacional Anticorrupción",
            "CIIT - Corredor Interoceánico del Istmo de Tehuantepec",
            "CONEVAL - Consejo Nacional de Evaluación de la Política de Desarrollo Social",
            "SSPC - Secretaría de Seguridad y Protección Ciudadana",
            "SEGALMEX - Seguridad Alimentaria Mexicana",
            "AFAC - Agencia Federal de Aviación Civil",
            "ARTF - Agencia Reguladora del Transporte Ferroviario",
            "CFCRL - Centro Federal de Conciliación y Registro Laboral",
            "ANAM - Agencia Nacional de Aduanas de México",
            "AIFA - Aeropuerto Internacional Felipe Ángeles, S.A. de C.V.",
            "GN - Guardia Nacional",
            "MEJOREDU - Comisión Nacional para la Mejora Continua de la Educación",
            "SHF - Sociedad Hipotecarla Federal, S.N.C.",
            "IMIPAS - Instituto Mexicano de Investigación en Pesca y Acuacultura Sustentables",
            "OCUBBJG - Organismo Coordinador de las Universidades para el Bienestar Benito Juárez García",
            "CONASAMA - Comisión Nacional de Salud Mental y Adicciones",
            "IMSS BIENESTAR - Servicios de Salud del Instituto Mexicano del Seguro Social para el Bienestar (IMSS-BIENESTAR)",
            "TREN MAYA - Tren Maya, S.A. de C.V.",
            "ATDT - Agencia de Transformación Digital y Telecomunicaciones",
            "GAFSACOMM - Grupo Aeroportuario, Ferroviario, de Servicios Auxiliares y Conexos Olmeca - Maya - Mexica, S.A. de C.V.",
            "No Capturado - No Capturado",
            "ASOCIACIÓN MEXICANA - Asociación Mexicana",
            "MUJERES - Secretaría de las Mujeres"
        ];

        // Catálogo de procedimientos de contratación
        const catalogoProcedimientosContratacion = [
        ];

        // Catálogo de tipos
        const catalogoTipos = [
        ];

        // Catálogo de años de publicación
        const catalogoAnosPublicacion = [
            "2020",
            "2021",
            "2022",
            "2023",
            "2024",
            "2025"
        ];

        /**
         * Actualiza las opciones de todos los selectores dinámicos de la aplicación.
         * Extrae valores únicos de los datos existentes y los fusiona con catálogos base.
         */
        // Catálogo de participantes
        const catalogoParticipantes = [
        ];

        /**
         * Actualiza las opciones de todos los selectores dinámicos de la aplicación.
         * Extrae valores únicos de los datos existentes y los fusiona con catálogos base.
         */
        function updateDynamicSelectOptions() {
            const allData = [...licitaciones, ...historicalLicitaciones];
            
            // Función de ayuda para procesar opciones de forma segura
            const getUniqueTrimmedOptions = (data, field) => {
                return data.map(item => item[field])
                           .filter(Boolean) // Elimina nulos o undefined
                           .map(value => String(value).trim()); // Convierte a string y luego aplica trim
            };

            // Proyectos
            const historicalProyectos = getUniqueTrimmedOptions(allData, 'proyecto');
            const combinedProyectos = [...new Set([...catalogoProyectos, ...historicalProyectos])].sort();
            fieldOptions.proyectos = combinedProyectos;
            updateSelectOptions('proyectos', fieldOptions.proyectos);
        
            // Nombres
            const historicalNombres = getUniqueTrimmedOptions(allData, 'nombre');
            const combinedNombres = [...new Set([...catalogoNombres, ...historicalNombres])].sort();
            fieldOptions.nombres = combinedNombres;
            updateSelectOptions('nombres', fieldOptions.nombres);

            // Siglas Dependencias
            const historicalSiglasDependencias = getUniqueTrimmedOptions(allData, 'siglasDependencia');
            const combinedSiglasDependencias = [...new Set([...catalogoSiglasDependencias, ...historicalSiglasDependencias])].sort();
            fieldOptions.siglasDependencias = combinedSiglasDependencias;
            updateSelectOptions('siglasDependencias', fieldOptions.siglasDependencias);

            // Procedimientos Contratación
            const historicalProcedimientosContratacion = getUniqueTrimmedOptions(allData, 'procedimientoContratacion');
            const combinedProcedimientosContratacion = [...new Set([...catalogoProcedimientosContratacion, ...historicalProcedimientosContratacion])].sort();
            fieldOptions.procedimientosContratacion = combinedProcedimientosContratacion;
            updateSelectOptions('procedimientosContratacion', fieldOptions.procedimientosContratacion);

            // Tipos
            const historicalTipos = getUniqueTrimmedOptions(allData, 'tipo');
            const combinedTipos = [...new Set([...catalogoTipos, ...historicalTipos])].sort();
            fieldOptions.tipos = combinedTipos;
            updateSelectOptions('tipos', fieldOptions.tipos);

            // Años Publicación
            const historicalAnosPublicacion = getUniqueTrimmedOptions(allData, 'anoPublicacion');
            const combinedAnosPublicacion = [...new Set([...catalogoAnosPublicacion, ...historicalAnosPublicacion])].sort();
            fieldOptions.anosPublicacion = combinedAnosPublicacion;
            updateSelectOptions('anosPublicacion', fieldOptions.anosPublicacion);

            // Registrados Interés, Nombre Licitantes y Ganadores (usando la misma lógica)
            const historicalRegistradosInteres = getUniqueTrimmedOptions(allData, 'registradosInteres');
            const combinedRegistradosInteres = [...new Set([...catalogoParticipantes, ...historicalRegistradosInteres])].sort();
            fieldOptions.registradosInteres = combinedRegistradosInteres;
            updateSelectOptions('registradosInteres', fieldOptions.registradosInteres);

            const historicalNombreLicitantes = getUniqueTrimmedOptions(allData, 'nombreLicitantes');
            const combinedNombreLicitantes = [...new Set([...catalogoParticipantes, ...historicalNombreLicitantes])].sort();
            fieldOptions.nombreLicitantes = combinedNombreLicitantes;
            updateSelectOptions('nombreLicitantes', fieldOptions.nombreLicitantes);

            const historicalGanadoresLicitacion = getUniqueTrimmedOptions(allData, 'ganadorLicitacion');
            const combinedGanadoresLicitacion = [...new Set([...catalogoParticipantes, ...historicalGanadoresLicitacion])].sort();
            fieldOptions.ganadoresLicitacion = combinedGanadoresLicitacion;
            updateSelectOptions('ganadoresLicitacion', fieldOptions.ganadoresLicitacion);
        }

        /**
         * Actualiza las opciones de un conjunto de selectores Select2.
         * @param {string} field - La clave del campo (ej. 'proyectos', 'siglasDependencias').
         * @param {Array<string|Object>} options - El array de nuevas opciones.
         * @param {string|null} [selectedId=null] - El ID de la opción que debe quedar seleccionada.
         */
        function updateSelectOptions(field, options, selectedId = null) {
            const fieldToSelectMap = {
                'proyectos': ['licitacion-proyecto', 'edit-licitacion-proyecto'],
                'nombres': ['licitacion-nombre', 'edit-licitacion-nombre'],
                'siglasDependencias': ['licitacion-siglasDependencia', 'edit-licitacion-siglasDependencia'],
                'procedimientosContratacion': ['licitacion-procedimientoContratacion', 'edit-licitacion-procedimientoContratacion'],
                'tipos': ['licitacion-tipo', 'edit-licitacion-tipo'],
                'anosPublicacion': ['licitacion-anoPublicacion', 'edit-licitacion-anoPublicacion'],
                'registradosInteres': ['licitacion-registradosInteres', 'edit-licitacion-registradosInteres'],
                'nombreLicitantes': ['licitacion-nombreLicitantes', 'edit-licitacion-nombreLicitantes'],
                'ganadoresLicitacion': ['licitacion-ganadorLicitacion', 'edit-licitacion-ganadorLicitacion']
            };

            const normalizedOptions = options.map(opt => ({id: opt, text: opt}));
            
            if (fieldToSelectMap[field]) {
                fieldToSelectMap[field].forEach(selectId => {
                    const select = $(`#${selectId}`);
                    if (select.length) {
                        const currentValue = select.val();
                        
                        select.empty().select2({
                            data: normalizedOptions,
                            tags: true,
                            placeholder: "Seleccione o escriba una opción",
                            allowClear: true,
                            width: '100%'
                        });

                        if (currentValue && normalizedOptions.some(o => o.id === currentValue)) {
                            select.val(currentValue).trigger('change.select2');
                        }
                        else if (selectedId && normalizedOptions.some(o => o.id === selectedId)) {
                            select.val(selectedId).trigger('change.select2');
                        }
                    }
                });
            }
        }

        /**
         * Busca y reemplaza un valor en un campo específico en todos los registros de la base de datos (ambas colecciones).
         * Se utiliza para actualizar en masa cuando se edita una opción de un selector.
         * @param {string} field - La clave del campo (ej. 'proyectos').
         * @param {string} oldValue - El valor antiguo a reemplazar.
         * @param {string} newValue - El nuevo valor.
         * @param {string} activeFormId - El ID del formulario activo para restaurar su estado.
         * @param {Object} formStateBeforeEdit - El estado del formulario antes de la edición.
         */
        async function findAndReplaceInDatabase(field, oldValue, newValue, activeFormId, formStateBeforeEdit) {
            const fieldToDbFieldMap = {
                'proyectos': 'proyecto', 
                'nombres': 'nombre',
                'siglasDependencias': 'siglasDependencia',
                'procedimientosContratacion': 'procedimientoContratacion',
                'tipos': 'tipo',
                'anosPublicacion': 'anoPublicacion',
                'registradosInteres': 'registradosInteres',
                'nombreLicitantes': 'nombreLicitantes',
                'ganadoresLicitacion': 'ganadorLicitacion'
            };
            
            const dbField = fieldToDbFieldMap[field];
            if (!dbField) return;
            
            try {
                const licitacionesQuery = licitacionesCollectionRef.where(dbField, '==', oldValue);
                const licitacionesSnapshot = await licitacionesQuery.get();
                
                const batch = db.batch();
                licitacionesSnapshot.forEach(doc => {
                    batch.update(doc.ref, { [dbField]: newValue });
                });
                
                const historicalQuery = historicalLicitacionesCollectionRef.where(dbField, '==', oldValue);
                const historicalSnapshot = await historicalQuery.get();
                
                historicalSnapshot.forEach(doc => {
                    batch.update(doc.ref, { [dbField]: newValue });
                });
                
                await batch.commit();
                
                // 1. Actualizar las opciones globales y redibujar los selects
                fieldOptions[field] = [...new Set([...fieldOptions[field].filter(opt => opt !== oldValue), newValue])].sort();
                updateSelectOptions(field, fieldOptions[field]);
                
                // 2. Restaurar el estado del formulario
                if (formStateBeforeEdit) {
                    restoreFormState(activeFormId, formStateBeforeEdit);
                }

                // 3. Asegurarse de que el campo editado tenga el nuevo valor seleccionado
                if (activeSelectElement) {
                    $(activeSelectElement).val(newValue).trigger('change.select2');
                }
                
                showAlert(`Se actualizaron ${licitacionesSnapshot.size + historicalSnapshot.size} registros.`, "success");
            } catch (error) {
                console.error("Error al actualizar registros:", error);
                showAlert("Error al actualizar registros existentes", "error");
            }
        }

        /**
         * Captura el estado actual de un formulario (valores de inputs, textareas y selects).
         * @param {string} formId - El ID del formulario.
         * @returns {Object|null} Un objeto que representa el estado del formulario.
         */
        function getFormState(formId) {
            const form = document.getElementById(formId);
            if (!form) return null;
            const state = {};
            
            // Guardar estado de inputs y textareas
            $(form).find('input, textarea').each(function() {
                const input = $(this);
                const inputName = input.attr('name');
                if (inputName) {
                    state[inputName] = { value: input.val() };
                }
            });

            // Guardar estado de selects (incluyendo tags)
            $(form).find('select').each(function() {
                const select = $(this);
                const selectName = select.attr('name');
                if (selectName) {
                    const select2Data = select.select2('data') || [];
                    state[selectName] = {
                        value: select.val(),
                        tags: select2Data.filter(item => item.element === undefined || $(item.element).data('select2-tag') === true)
                    };
                }
            });
            
            return state;
        }

        /**
         * Restaura el estado de un formulario a partir de un objeto de estado guardado.
         * @param {string} formId - El ID del formulario a restaurar.
         * @param {Object} state - El objeto de estado previamente guardado con `getFormState`.
         */
        function restoreFormState(formId, state) {
            const form = document.getElementById(formId);
            if (!form || !state) return;
            
            Object.entries(state).forEach(([fieldName, fieldState]) => {
                const element = $(form).find(`[name="${fieldName}"]`);
                if (element.is('select')) {
                    // Restaurar tags para selects
                    if (fieldState.tags) {
                        fieldState.tags.forEach(tag => {
                            if (!element.find(`option[value="${tag.id}"]`).length) {
                                const newOption = new Option(tag.text, tag.id);
                                $(newOption).attr('data-select2-tag', 'true'); // Marcar como etiqueta para la siguiente captura de estado.
                                element.append(newOption);
                            }
                        });
                    }
                    element.val(fieldState.value).trigger('change.select2');
                } else if(element.is('input') || element.is('textarea')) {
                    element.val(fieldState.value);
                }
            });
        }

        /**
         * Configura los manejadores de eventos para los botones de edición (lápiz)
         * asociados a cada campo en los formularios.
         */
        function setupAddEditButtons() {
            const buttonToFieldMap = {
                'edit-proyecto-btn': 'proyectos',
                'edit-nombre-btn': 'nombres',
                'edit-descripcion-btn': 'descripcion',
                'edit-generalidades-btn': 'generalidades',
                'edit-siglasDependencia-btn': 'siglasDependencias',
                'edit-procedimientoContratacion-btn': 'procedimientosContratacion',
                'edit-tipo-btn': 'tipos',
                'edit-registradosInteres-btn': 'registradosInteres',
                'edit-nombreLicitantes-btn': 'nombreLicitantes',
                'edit-ganadorLicitacion-btn': 'ganadoresLicitacion',
                'edit-monto-btn': 'monto',
                'edit-linkComprasXM-btn': 'linkComprasXM',
                'edit-proyecto-edit-btn': 'proyectos',
                'edit-nombre-edit-btn': 'nombres',
                'edit-descripcion-edit-btn': 'descripcion',
                'edit-generalidades-edit-btn': 'generalidades',
                'edit-siglasDependencia-edit-btn': 'siglasDependencias',
                'edit-procedimientoContratacion-edit-btn': 'procedimientosContratacion',
                'edit-tipo-edit-btn': 'tipos',
                'edit-registradosInteres-edit-btn': 'registradosInteres',
                'edit-nombreLicitantes-edit-btn': 'nombreLicitantes',
                'edit-ganadorLicitacion-edit-btn': 'ganadoresLicitacion',
                'edit-monto-edit-btn': 'monto',
                'edit-linkComprasXM-edit-btn': 'linkComprasXM'
            };
            
            Object.entries(buttonToFieldMap).forEach(([buttonId, field]) => {
                const button = document.getElementById(buttonId);
                if (!button) return;

                button.addEventListener('click', (e) => {
                    let inputElement;
                    
                    if (['descripcion', 'generalidades', 'codigoExpediente', 'monto', 'linkComprasXM'].includes(field)) {
                        inputElement = e.currentTarget.parentElement.querySelector('input') || 
                                      e.currentTarget.parentElement.querySelector('textarea');
                    } else {
                        inputElement = e.currentTarget.parentElement.querySelector('select');
                        activeSelectElement = inputElement;
                    }
                    
                    const currentValue = inputElement.value;
                        
                    if (!currentValue) {
                        return showAlert("Por favor, ingrese un valor para editar.", "warning");
                    }
                       
                    currentEditingField = field;
                    currentEditingValue = currentValue;
                    editOptionInput.value = currentValue;
                    editOptionInput.placeholder = `Edite la opción para ${field}`;
                    openModalWithFocus(editOptionModal, editOptionInput);
                });
            });

            confirmEditOptionBtn.addEventListener('click', () => {
                const newValue = editOptionInput.value.trim();

                if (!newValue || !currentEditingField || !currentEditingValue) {
                    return;
                }

                closeModal(editOptionModal);
                
                const activeFormId = !licitacionModal.classList.contains('hidden') ? 'licitacion-form' : 
                                     !editModal.classList.contains('hidden') ? 'edit-form' : null;
                
                const formStateBeforeEdit = activeFormId ? getFormState(activeFormId) : null;
                requirePassword(async () => {
                    try {
                        if (['proyectos', 'nombres', 'siglasDependencias', 'procedimientosContratacion', 'tipos', 'anosPublicacion', 'registradosInteres', 'nombreLicitantes', 'ganadoresLicitacion'].includes(currentEditingField)) {
                            await findAndReplaceInDatabase(currentEditingField, currentEditingValue, newValue, activeFormId, formStateBeforeEdit);
                        } else {
                            // Lógica para campos de texto (no afecta a otros campos)
                            let inputElement;
                            if (currentEditingField === 'descripcion') {
                                inputElement = document.getElementById(activeFormId === 'licitacion-form' ? 'licitacion-descripcion' : 'edit-licitacion-descripcion');
                            } else if (currentEditingField === 'generalidades') {
                                inputElement = document.getElementById(activeFormId === 'licitacion-form' ? 'licitacion-generalidades' : 'edit-licitacion-generalidades');
                            } else if (currentEditingField === 'codigoExpediente') {
                                inputElement = document.getElementById(activeFormId === 'licitacion-form' ? 'licitacion-codigoExpediente' : 'edit-licitacion-codigoExpediente');
                            } else if (currentEditingField === 'monto') {
                                inputElement = document.getElementById(activeFormId === 'licitacion-form' ? 'licitacion-monto' : 'edit-licitacion-monto');
                            } else if (currentEditingField === 'linkComprasXM') {
                                inputElement = document.getElementById(activeFormId === 'licitacion-form' ? 'licitacion-linkComprasXM' : 'edit-licitacion-linkComprasXM');
                            }
                            
                            if (inputElement) {
                                inputElement.value = newValue;
                            }
                        }
                    } catch (dbErr) {
                        console.error('Error al actualizar la base de datos:', dbErr);
                        showAlert("Error al actualizar la opción", "error");
                    } finally {
                        activeSelectElement = null; // Limpiar el elemento activo
                    }
                });
            });
            cancelEditOptionBtn.addEventListener('click', () => {
                closeModal(editOptionModal);
                activeSelectElement = null;
            });
        }

        /**
         * Configura la navegación por pestañas (Licitaciones, Reportes).
         */
        function setupTabs() {
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    const tabName = e.target.dataset.tab;
                    
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `tab-content-${tabName}`));
                    
                    if (tabName === 'reportes') {
                        setTimeout(updateCharts, 50); // Delay para asegurar que el contenedor es visible
                    } else if (tabName === 'historico') {
                        setTimeout(() => updateFalloDashboard(selectedBaseDate), 50); // Actualizar el radar al cambiar a la pestaña
                    }
                }
            });
        }

        // =============================================
        // MÓDULO: Autenticación y seguridad
        // =============================================

        /**
         * Verifica la contraseña introducida en el modal de seguridad.
         */
        function verifyPassword() {
            const password = passwordInput.value;
            
            if (password === 'admin') {
                closeModal(passwordModal); // Usar la función closeModal mejorada
                passwordInput.value = '';
                if (pendingAction) {
                    pendingAction();
                    pendingAction = null;
                }
            } else {
                showAlert("Contraseña incorrecta", "error");
                passwordInput.value = '';
            }
        }

        /**
         * Configura los manejadores de eventos para el modal de verificación de contraseña.
         */
        function setupPasswordVerification() {
            confirmPasswordBtn.addEventListener('click', verifyPassword);
            cancelPasswordBtn.addEventListener('click', () => {
                closeModal(passwordModal);
                pendingAction = null;
            });
            
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });
        }

        /**
         * Muestra el modal de contraseña y guarda la acción a ejecutar tras una verificación exitosa.
         * @param {Function} action - La función a ejecutar si la contraseña es correcta.
         * @param {boolean} [isAsync=false] - Indica si la acción es asíncrona.
         */
        function requirePassword(action, isAsync = false) {
            pendingAction = action;    
            openModalWithFocus(passwordModal, passwordInput); // Llamada única para abrir el modal y enfocar
            
            if (isAsync) {
                return new Promise((resolve, reject) => {
                    const originalAction = pendingAction;
                    pendingAction = async () => {
                        try {
                            const result = await originalAction();
                            resolve(result);
                        } catch (error) {
                            reject(error);
                        }
                    };
                });
            }
        }
    
        /**
         * @summary Gestiona el estado de la UI basado en si el usuario es anónimo o ha iniciado sesión.
         * @param {object|null} user - El objeto de usuario de Firebase.
         */
        function updateUserUI(user) {
             const isLoggedIn = user && !user.isAnonymous;
 
             // --- Control de visibilidad de botones principales ---
             document.getElementById('add-licitacion-btn').classList.toggle('hidden', !isLoggedIn);
             document.querySelector('label[for="historical-file-input"]').classList.toggle('hidden', !isLoggedIn);
 
             // --- Control de visibilidad en el modal de configuración de reportes ---
             const templateSection = document.querySelector('#report-settings-modal #open-template-uploader-btn')?.parentElement;
             if (templateSection) {
                 templateSection.classList.toggle('hidden', !isLoggedIn);
             }

             // --- Control de visibilidad de la columna de acciones ---
             document.querySelector('.actions-header')?.classList.toggle('hidden', !isLoggedIn);

             // --- Control de la UI de sesión (header) ---
             if (isLoggedIn) {
                 userEmailSpan.textContent = user.email;
                 userInfo.classList.remove('hidden');
                 loginBtn.classList.add('hidden');
                 loginScreen.classList.add('hidden'); // Asegurarse de ocultar la pantalla de login
             } else {
                 userEmailSpan.textContent = '';
                 userInfo.classList.add('hidden');
                 loginBtn.classList.remove('hidden');
             }
 
             // --- Forzar re-renderizado de la tabla para mostrar/ocultar la columna de acciones ---
             // Esto es crucial para que los cambios se apliquen inmediatamente después de iniciar/cerrar sesión.
             if (historicalLicitaciones.length > 0) {
                 sortAndRenderTable(historicalTableBody, historicalLicitaciones, true);
             }
        }

        /**
         * @summary Inicializa la autenticación de Firebase. Reutiliza la sesión existente o crea una anónima si no hay ninguna.
         */
         function initializeAppWithAuth() {
             // Apagar cualquier listener activo antes de cambiar de usuario.
             if (unsubscribeHistorical) unsubscribeHistorical();

             auth.onAuthStateChanged(async (user) => {
                 if (user) {
                     // --- Caso 1: Ya existe un usuario (anónimo o con email) ---
                     // La sesión persiste entre recargas. Simplemente usamos el usuario existente.
                     // Apagamos listeners previos para evitar duplicados.
                     if (unsubscribeHistorical) unsubscribeHistorical();
                     userId = user.uid;
                     console.log("Sesión existente reutilizada:", userId, "Anónima:", user.isAnonymous);
 
                     updateUserUI(user);
                     setupRealtimeListeners();
                     showApp();
                 } else {
                     // --- Caso 2: No hay ningún usuario ---
                     // Esto ocurre en la primera visita o después de un signOut().
                     // Apagamos el listener del usuario que acaba de cerrar sesión.
                     if (unsubscribeHistorical) unsubscribeHistorical();
                     // Creamos una nueva sesión anónima.
                     try {
                         const userCredential = await auth.signInAnonymously();
                         const newAnonymousUser = userCredential.user;
                         console.log("Nueva sesión anónima creada:", newAnonymousUser.uid);
                         // El listener onAuthStateChanged se volverá a disparar con este nuevo usuario,
                         // entrando en el `if (user)` y cargando la app.
                     } catch (error) {
                         // Si falla el login anónimo, mostramos la pantalla de login principal
                         // como último recurso para que el usuario pueda acceder.
                         loginScreen.classList.remove('hidden');
                         loginError.textContent = "Error de conexión. Inicie sesión para continuar.";
                         console.error("Error en la autenticación anónima:", error);
                         showAlert("Error de conexión. No se pudo iniciar la sesión.", "error");
                         showLoader(false);
                     }
                 }
             });
         }
                 
        /**
         * Configura los listeners de Firestore (`onSnapshot`) para recibir actualizaciones
         * en tiempo real de las colecciones de licitaciones (histórico).
         */
        function setupRealtimeListeners() {            
            // Si ya hay un listener, lo apagamos antes de crear uno nuevo.
            if (unsubscribeHistorical) unsubscribeHistorical();

            unsubscribeHistorical = historicalLicitacionesCollectionRef.onSnapshot((snapshot) => {
                historicalLicitaciones = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUserUI(auth.currentUser); // Re-evaluar la UI por si el estado de login cambió
                sortAndRenderTable(historicalTableBody, historicalLicitaciones, true);
                updateCharts(); // Actualiza los gráficos de reportes
                updateFalloDashboard(selectedBaseDate); // Actualiza el radar con la fecha base actual
                updateDynamicSelectOptions();
            }, (error) => console.error("Error en listener de histórico:", error));
        }

        // =============================================
        // MÓDULO: Gráficos y reportes
        // =============================================
        
        /**
         * Obtiene y filtra los datos para los reportes según la configuración guardada.
         * Aplica un filtro de rango de fechas si está activado.
         * @returns {Array} El conjunto de datos de licitaciones filtrado por fecha si aplica.
         */
        function getReportData() {
            const baseData = historicalLicitaciones;

            // Aplicar filtro de fecha si está configurado
            if (reportSettings.dateFilterMode === 'period' && reportSettings.startDate && reportSettings.endDate) {
                try {
                    return baseData.filter(item => {
                        // La comparación de strings 'YYYY-MM-DD' funciona correctamente para rangos.
                        return item.fechaFallo && item.fechaFallo >= reportSettings.startDate && item.fechaFallo <= reportSettings.endDate;
                    });
                } catch (e) {
                    console.error("Error al filtrar fechas:", e);
                    return baseData; // Devuelve los datos sin filtrar en caso de error.
                }
            }
            return baseData; // Devuelve todos los datos si el filtro no está activo.
        }

        /**
         * Actualiza todos los gráficos en la pestaña de "Reportes".
         */
        function updateCharts() {
            // Verificación robusta: Asegurarse de que dynamicChart es una instancia de Chart antes de destruirla.
            if (charts.dynamic) charts.dynamic.destroy();
            if (charts.projectProcedure) charts.projectProcedure.destroy();

            // Limpiar las referencias después de destruir para evitar errores futuros
            charts.dynamic = null;
            charts.projectProcedure = null;

            // Update dynamic chart
            updateDynamicChart();
            updateProjectProcedureChart();
            
        }

        /**
         * Navega a la pestaña de licitaciones y aplica los filtros especificados.
         * Útil para hacer clic en los gráficos y ver los datos correspondientes en la tabla.
         * @param {Object} filtersToApply - Un objeto donde las claves son los campos a filtrar y los valores son arrays de los valores a incluir.
         */
        function navigateAndFilter(filtersToApply) {
            // 1. Cambiar a la pestaña de Licitaciones (que es 'historico' en esta app)
            document.querySelector('button[data-tab="historico"]').click();

            // 2. Limpiar todos los filtros existentes
            clearAllFilters('historical');

            // --- INICIO DE LA MEJORA: Aplicar filtro de fecha si hay un periodo activo en reportes ---
            if (reportSettings.dateFilterMode === 'period' && reportSettings.startDate && reportSettings.endDate) {
                const dataForDateFiltering = historicalLicitaciones; // Obtener todos los datos.
                
                // Encontrar todas las fechas de fallo únicas que caen dentro del rango del reporte.
                const datesInRange = [...new Set(
                    dataForDateFiltering
                        .filter(item => item.fechaFallo && item.fechaFallo >= reportSettings.startDate && item.fechaFallo <= reportSettings.endDate)
                        .map(item => formatDate(item.fechaFallo)) // Usar la fecha formateada, que es como el filtro la espera.
                )];

                // Añadir las fechas encontradas al objeto de filtros a aplicar.
                filtersToApply['fechaFallo'] = datesInRange;
            }
            // --- FIN DE LA MEJORA ---

            // 3. Aplicar los nuevos filtros
            Object.entries(filtersToApply).forEach(([key, value]) => {
                activeFilters.historical[key] = Array.isArray(value) ? value : [value];
                // Marcar visualmente el encabezado como activo
                const header = document.querySelector(`#historical-table-header .filterable-header[data-filter-by="${key}"]`);
                if (header) header.classList.add('active');
            });

            // 4. Re-renderizar la tabla con los nuevos filtros
            sortAndRenderTable(historicalTableBody, historicalLicitaciones, true);
        }

        /**
         * Actualiza la gráfica de "Proyectos por Procedimiento/Tipo/Ganador" y su tabla de datos asociada.
         */
        function updateProjectProcedureChart() {
            const data = getReportData(); // Usar los datos filtrados por fecha
            const selectedVariable = document.getElementById('project-chart-variable').value;
            const projectProcedureCounts = {};
            const projectProcedureAmounts = {};
            const allProcedures = new Set();
            
            // Objeto para almacenar los totales de cada proyecto para el ordenamiento
            const projectTotals = {};
 
            data.forEach(item => {
                const project = item.proyecto || 'N/A';
                const procedure = item[selectedVariable] || 'N/A';
                const amount = parseFloat(item.monto) || 0;

                if (project !== 'N/A' && procedure !== 'N/A') {
                    if (!projectProcedureCounts[project]) {
                        // Inicializar totales para el proyecto
                        if (!projectTotals[project]) {
                            projectTotals[project] = { count: 0, amount: 0 };
                        }

                        projectProcedureCounts[project] = {};
                        projectProcedureAmounts[project] = {};
                    }
                    projectProcedureCounts[project][procedure] = (projectProcedureCounts[project][procedure] || 0) + 1; // Conteo
                    projectProcedureAmounts[project][procedure] = (projectProcedureAmounts[project][procedure] || 0) + amount; // Suma de montos
                    allProcedures.add(procedure);
                }

                // Acumular totales para el ordenamiento
                if (project !== 'N/A') {
                    if (!projectTotals[project]) {
                        projectTotals[project] = { count: 0, amount: 0 };
                    }
                    projectTotals[project].count += 1;
                    projectTotals[project].amount += amount;
                }
            });

            const sortedProcedures = Array.from(allProcedures).sort(); // Ordenar procedimientos alfabéticamente

            // Ordenar proyectos dinámicamente según el estado de `projectChartSortBy`
            const projects = Object.keys(projectTotals).sort((a, b) => {
                return projectChartSortBy === 'amount' ? projectTotals[b].amount - projectTotals[a].amount : projectTotals[b].count - projectTotals[a].count;
            });

            // --- Lógica de la tabla con montos y totales ---
            const table = document.getElementById('projectProcedureTable');
            // Encabezado de dos niveles
            const headerRow1 = `<tr class="bg-slate-200"><th rowspan="2" class="align-bottom text-center">Proyecto</th>${sortedProcedures.map(proc => `<th colspan="2" class="text-center">${proc}</th>`).join('')}<th colspan="2" class="text-center">Total</th></tr>`;
            const headerRow2 = `<tr>${sortedProcedures.map(() => `<th class="text-center">Cantidad</th><th class="text-center">Monto (mdp)</th>`).join('')}<th class="text-center">Cantidad</th><th class="text-center">Monto (mdp)</th></tr>`;
            table.querySelector('thead').innerHTML = headerRow1 + headerRow2;
            
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            
            const procedureAmountTotals = {};
            const procedureCountTotals = {};
            let grandTotalAmount = 0;
            let grandTotalCount = 0;

            projects.forEach(project => {
                const row = document.createElement('tr');
                let rowHTML = `<td class="clickable-cell hover:bg-slate-100 hover:text-primary" data-filter-project="${project}">${project}</td>`;
                let projectTotalAmount = 0;
                let projectTotalCount = 0;

                sortedProcedures.forEach(proc => {
                    const count = projectProcedureCounts[project][proc] || 0;
                    const amount = projectProcedureAmounts[project][proc] || 0;
                    
                    // Celda de Cantidad
                    rowHTML += `<td class="text-center clickable-cell hover:bg-slate-100 hover:text-primary" data-filter-project="${project}" data-filter-variable="${selectedVariable}" data-filter-value="${proc}">${count}</td>`;
                    // Celda de Monto
                    rowHTML += `<td class="text-right">${(amount / 1000000).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`;
                    
                    projectTotalAmount += amount;
                    projectTotalCount += count;
                    procedureAmountTotals[proc] = (procedureAmountTotals[proc] || 0) + amount;
                    procedureCountTotals[proc] = (procedureCountTotals[proc] || 0) + count;
                });

                // Celdas de Total por fila
                rowHTML += `<td class="font-bold text-center">${projectTotalCount}</td>`;
                rowHTML += `<td class="font-bold text-right">${(projectTotalAmount / 1000000).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`;
                row.innerHTML = rowHTML;
                tbody.appendChild(row);
                grandTotalAmount += projectTotalAmount;
                grandTotalCount += projectTotalCount;
            });

            let footerHTML = `<tr class="bg-slate-200 font-bold"><td>Total</td>`;
            sortedProcedures.forEach(proc => {
                // Total Cantidad por columna
                footerHTML += `<td class="text-center">${procedureCountTotals[proc] || 0}</td>`;
                // Total Monto por columna
                footerHTML += `<td class="text-right">${((procedureAmountTotals[proc] || 0) / 1000000).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>`;
            });
            // Gran Total Cantidad
            footerHTML += `<td class="text-center">${grandTotalCount}</td>`;
            // Gran Total Monto
            footerHTML += `<td class="text-right">${(grandTotalAmount / 1000000).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td></tr>`;
            table.querySelector('tfoot').innerHTML = footerHTML;

            // --- Lógica del gráfico (conteo) ---
            const colors = ['#1E5B4F', '#A6802D', '#9C2348', '#64748B', '#3B82F6', '#F59E0B', '#10B981'];
            const datasets = sortedProcedures.map((procedure, index) => ({
                label: procedure,
                data: projects.map(project => projectProcedureCounts[project][procedure] || 0),
                backgroundColor: colors[index % colors.length],
            }));

            if (charts.projectProcedure) charts.projectProcedure.destroy();

            charts.projectProcedure = new Chart(document.getElementById('projectProcedureChart'), {
                type: 'bar',
                data: {
                    labels: projects,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        // La propiedad 'stacked' se controla dinámicamente
                        x: { stacked: isProjectChartStacked },
                        y: { 
                            stacked: isProjectChartStacked, 
                            beginAtZero: true 
                        }
                    },
                    plugins: {
                        legend: {
                            display: showProjectChartLegend, // Controlar visibilidad de la leyenda
                            position: 'top',
                        }
                    }
                }
            });
        }

        /**
         * Actualiza el gráfico dinámico principal y su tabla de distribución de datos asociada.
         */
        function updateDynamicChart() {
            const data = getReportData(); // Usar los datos filtrados por fecha
            const selectedVariable = dynamicChartVariable.value;
            const variableStats = {};
            
            data.forEach(licitacionItem => {
                const value = licitacionItem[selectedVariable] || 'N/A';
                if (!variableStats[value]) {
                    variableStats[value] = { count: 0, sum: 0 };
                }
                variableStats[value].count++;
                const monto = parseFloat(licitacionItem.monto) || 0;
                variableStats[value].sum += monto;
            });
            
            // Update dynamic table
            dynamicTableBody.innerHTML = '';
            dynamicTableHeader.textContent = selectedVariable.charAt(0).toUpperCase() + selectedVariable.slice(1);
            
            // --- INICIO DE LA MEJORA: Ordenar los datos por monto descendente ---
            // Ordenamiento dinámico basado en la variable de estado `dynamicChartSortBy`
            const sortedStats = Object.entries(variableStats).sort(([, a], [, b]) => {
                return dynamicChartSortBy === 'amount' ? b.sum - a.sum : b.count - a.count;
            });
            // --- FIN DE LA MEJORA ---

            let totalCount = 0; // Usar los datos ordenados (sortedStats) para renderizar la tabla
            let totalSum = 0;

            // Usar los datos ordenados (sortedStats) para renderizar la tabla
            sortedStats.forEach(([value, stats]) => {
                totalCount += stats.count;
                totalSum += stats.sum;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="clickable-cell hover:bg-slate-100 hover:text-primary" data-filter-variable="${selectedVariable}" data-filter-value="${value}">${value}</td>
                    <td class="clickable-cell hover:bg-slate-100 hover:text-primary">${stats.count}</td>
                    <td class="text-right">${(stats.sum / 1000000).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                `;
                dynamicTableBody.appendChild(row);
            });

            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'bg-slate-200 font-bold';
            totalRow.innerHTML = `
                <td>Total</td>
                <td>${totalCount}</td>
                <td class="text-right">${(totalSum / 1000000).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            `;
            dynamicTableBody.appendChild(totalRow);
            
            // Update dynamic chart
            if (charts.dynamic) charts.dynamic.destroy();
            
            // Usar los datos ordenados para la gráfica
            const labels = sortedStats.map(([value]) => truncateText(value, 25));
            const chartData = sortedStats.map(([, stats]) => stats.count);
            
            charts.dynamic = new Chart(dynamicChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad',
                        data: chartData,
                        backgroundColor: '#1E5B4F'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                display: showChartLabels,
                                maxRotation: showChartLabels ? 90 : 0,
                                minRotation: showChartLabels ? 45 : 0
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                footer: function(tooltipItems) {
                                    const context = tooltipItems[0];
                                    const originalStat = sortedStats[context.dataIndex];
                                    const amountInMillions = originalStat ? (originalStat[1].sum / 1000000) : 0;
                                    const formattedAmount = amountInMillions.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' mdp';
                                    return `Monto Total: ${formattedAmount}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // MÓDULO: Exportación/Importación
        // =============================================

        const exportHeaders = [
            "No.", "Proyecto", "Nombre", "Descripción", "Generalidades", "Siglas Dependencia",
            "Código Expediente", "Procedimiento", "Tipo", "Año Publicación", "Fecha Apertura",
            "Fecha Fallo", "Fecha Estimada Inicio", "Participantes", "Licitantes", "Ganador", "Monto (Pesos)", "Link Compras XM"
        ];

        /**
         * Prepara los datos para la exportación a Excel, asegurando el formato y el orden correctos.
         */
        function prepareExportData(data) {
            return data.map((licitacionItem, index) => {
                const fallback = (value) => value || "N/A";
                return {
                    "No.": index + 1,
                    "Proyecto": fallback(licitacionItem.proyecto),
                    "Nombre": fallback(licitacionItem.nombre),
                    "Descripción": fallback(licitacionItem.descripcion),
                    "Generalidades": fallback(licitacionItem.generalidades),
                    "Siglas Dependencia": fallback(licitacionItem.siglasDependencia),
                    "Código Expediente": fallback(licitacionItem.codigoExpediente),
                    "Procedimiento": fallback(licitacionItem.procedimientoContratacion),
                    "Tipo": fallback(licitacionItem.tipo),
                    "Año Publicación": fallback(licitacionItem.anoPublicacion),
                    "Fecha Apertura": fallback(formatDate(licitacionItem.fechaPresentacionApertura)),
                    "Fecha Fallo": fallback(formatDate(licitacionItem.fechaFallo)),
                    "Fecha Estimada Inicio": fallback(formatDate(licitacionItem.fechaEstimadaInicio)),
                    "Participantes": fallback(licitacionItem.registradosInteres),
                    "Licitantes": fallback(licitacionItem.nombreLicitantes),
                    "Ganador": fallback(licitacionItem.ganadorLicitacion),
                    "Monto (Pesos)": licitacionItem.monto ? Number(licitacionItem.monto) : "N/A", // Exportar como número o "N/A"
                    "Link Compras XM": fallback(licitacionItem.linkComprasXM)
                };
            });
        }

        /**
         * Aplica formato profesional a una hoja de cálculo de Excel antes de descargarla.
         * Añade título, totales, estilos de celda y autofiltros.
         * @param {object} ws - La hoja de cálculo (worksheet) de la librería XLSX.
         * @param {Array<object>} data - Los datos que se van a exportar, para calcular dimensiones.
         */
        function applyExcelFormatting(ws, data) {
            // 1. Definir estilos
            const fontStyle = { name: "Noto Sans", sz: 11 };
            const borderStyle = { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } };

            const titleStyle = {
                font: { ...fontStyle, bold: true, sz: 12, color: { rgb: "000000" } }, // Fuente negra
                alignment: { vertical: "center" }
            };

            const totalAmountStyle = {
                font: { ...fontStyle, bold: true, color: { rgb: "FFFFFF" } }, // Texto blanco
                fill: { fgColor: { rgb: "CC3333" } }, // Fondo rojo sutil
                alignment: { vertical: "center", horizontal: "right" }
            };

            const headerStyle = {
                font: { ...fontStyle, bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "1E5B4F" } }, // Color primario de la app
                alignment: { horizontal: "center", vertical: "center" },
                border: borderStyle
            };

            const cellStyle = {
                font: fontStyle,
                border: borderStyle
            };

            const centeredCellStyle = {
                ...cellStyle,
                alignment: { horizontal: "center", vertical: "center" }
            };

            const rightAlignedCellStyle = {
                ...cellStyle,
                alignment: { horizontal: "right", vertical: "center" }
            };

            const currencyCellStyle = {
                ...rightAlignedCellStyle,
                numFmt: "#,##0.00"
            };

            // 2. Añadir fila de título en la parte superior
            const today = new Date();
            const longDate = today.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const titleText = `Seguimiento de Licitaciones de Proyectos Ferroviarios al ${longDate}`;
            
            // Insertar el título en A1. La hoja ya viene con los datos y encabezados.
            XLSX.utils.sheet_add_aoa(ws, [[titleText]], { origin: "A1" }); // El título va en la celda A1

            // 3. Calcular y añadir la suma de montos en la celda Q1
            const numCols = exportHeaders.length;
            const montoColIndex = exportHeaders.indexOf("Monto (Pesos)");
            if (montoColIndex !== -1) {
                const montoColLetter = XLSX.utils.encode_col(montoColIndex);
                const formula = `SUBTOTAL(9,${montoColLetter}3:${montoColLetter}${data.length + 2})`;

                const totalCellRef = XLSX.utils.encode_cell({ r: 0, c: montoColIndex -1 }); // Celda P1 para la etiqueta
                const totalValueCellRef = XLSX.utils.encode_cell({ r: 0, c: montoColIndex }); // Celda Q1 para el valor
                
                XLSX.utils.sheet_add_aoa(ws, [["Monto Total:"]], { origin: totalCellRef });
                // Añadir la fórmula en lugar del valor estático
                ws[totalValueCellRef] = { f: formula };
                
                ws[totalValueCellRef].s = { ...totalAmountStyle, numFmt: "$#,##0.00" }; // Formato de moneda para el total
                ws[totalCellRef].s = { font: { ...fontStyle, bold: true }, alignment: { horizontal: "right", vertical: "center" } };
            }

            // 4. Aplicar estilos y ajustar dimensiones
            const numRows = data.length;

            // Aplicar altura a la fila del título
            if (!ws['!rows']) ws['!rows'] = [];
            ws['!rows'][0] = { hpt: 30 }; // Altura en puntos

            // Aplicar altura a la fila de encabezados
            ws['!rows'][1] = { hpt: 20 }; // Fila 2 (índice 1) para los encabezados

            // Definir columnas con alineación especial
            const centeredColumns = ["No.", "Código Expediente", "Tipo", "Año Publicación", "Fecha Apertura", "Fecha Fallo", "Fecha Estimada Inicio"];
            const montoColumnIndex = exportHeaders.indexOf("Monto (Pesos)");
            const centeredColumnIndices = centeredColumns.map(header => exportHeaders.indexOf(header)); // Esto no cambia

            // Recorrer y aplicar estilos a encabezados y celdas de datos
            for (let R = 1; R <= numRows + 1; ++R) { // El bucle empieza en la fila de encabezados (R=1, que es la Fila 2 en Excel)
                for (let C = 0; C < numCols; ++C) {
                    const cell_address = { c: C, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    if (!ws[cell_ref]) continue;

                    if (R === 1) { // Fila de encabezados (Fila 2 en Excel)
                        ws[cell_ref].s = headerStyle;
                    } else { // Filas de datos
                        if (centeredColumnIndices.includes(C)) {
                            ws[cell_ref].s = centeredCellStyle;
                        } else if (C === montoColumnIndex) {
                            // Si el valor es un número, aplicar formato de moneda. Si no (ej. "N/A"), solo alinear a la derecha.
                            if (typeof ws[cell_ref].v === 'number') {
                                ws[cell_ref].s = currencyCellStyle;
                            } else {
                                ws[cell_ref].s = rightAlignedCellStyle;
                            }
                        } else {
                            ws[cell_ref].s = cellStyle;
                        }
                    }
                }
            }
            
            // Aplicar estilo al título (celda A1) y fusionar celdas
            if (ws['A1']) {
                ws['A1'].s = titleStyle;
            }

            // 6. Habilitar AutoFiltro en la fila de encabezados (Fila 2)
            ws['!autofilter'] = { ref: `A2:${XLSX.utils.encode_col(numCols - 1)}2` };

            // 5. Ajustar el ancho de las columnas automáticamente
            ws['!cols'] = [
                { wch: 5 }, // Columna A (No.)
                ...Array(exportHeaders.length - 1).fill({ wpx: 130 }) // Resto de columnas
            ];

            return ws;
        }

        /**
         * Exporta una tabla HTML a un archivo Excel con formato profesional.
         * Es útil para exportar las tablas de datos de la pestaña de reportes.
         * @param {string} tableId - El ID de la tabla HTML a exportar.
         * @param {string} sheetName - El nombre para la hoja de Excel.
         * @param {string} fileName - El nombre del archivo a descargar.
         */
        function exportTableToExcel(tableId, sheetName, fileName) { // REFACTORIZADO
            const table = document.getElementById(tableId);
            if (!table) {
                showAlert("No se encontró la tabla para exportar.", "error");
                return;
            }
        
            // 1. Extraer datos y encabezados de la tabla HTML
            const headers = [];
            const data = [];
            const merges = []; // Para las celdas combinadas del encabezado
        
            // Procesar encabezados (thead)
             const headerRows = Array.from(table.querySelectorAll('thead tr'));
             headerRows.forEach((tr, rowIndex) => {
                 if (!headers[rowIndex]) headers[rowIndex] = [];
                 let colIndex = 0;
                 Array.from(tr.children).forEach(th => {
                     // Saltar columnas ya ocupadas por un rowspan de una fila anterior
                     while (headers[rowIndex][colIndex] !== undefined) {
                         colIndex++;
                     }
 
                     const colspan = parseInt(th.getAttribute('colspan') || '1');
                     const rowspan = parseInt(th.getAttribute('rowspan') || '1');
                     
                     // Registrar la fusión de celdas
                     if (rowspan > 1 || colspan > 1) {
                         merges.push({ s: { r: rowIndex, c: colIndex }, e: { r: rowIndex + rowspan - 1, c: colIndex + colspan - 1 } });
                     }
 
                     // Rellenar la matriz de encabezados, marcando las celdas ocupadas por la fusión
                     for (let r = 0; r < rowspan; r++) {
                         if (!headers[rowIndex + r]) headers[rowIndex + r] = [];
                         for (let c = 0; c < colspan; c++) {
                             // La celda principal obtiene el texto, las demás se marcan como ocupadas
                             headers[rowIndex + r][colIndex + c] = (r === 0 && c === 0) ? th.innerText : null;
                         }
                     }
                     colIndex += colspan;
                 });
             });
 
             // Limpiar los valores nulos que se usaron para marcar celdas ocupadas
             headers.forEach(row => {
                 for (let i = 0; i < row.length; i++) {
                     if (row[i] === null) row[i] = '';
                 }
             });
        
            // Procesar cuerpo de la tabla (tbody)
            table.querySelectorAll('tbody tr').forEach(tr => {
                const rowData = [];
                tr.querySelectorAll('td').forEach(td => {
                    let cellValue = td.innerText;
                    if (cellValue.startsWith('$')) {
                        cellValue = parseFloat(cellValue.replace(/[$,]/g, ''));
                    }
                    rowData.push(cellValue);
                });
                data.push(rowData);
            });
        
            // Procesar pie de la tabla (tfoot)
            table.querySelectorAll('tfoot tr').forEach(tr => {
                const rowData = [];
                tr.querySelectorAll('td').forEach(td => {
                    let cellValue = td.innerText;
                    if (cellValue.startsWith('$')) {
                        cellValue = parseFloat(cellValue.replace(/[$,]/g, ''));
                    }
                    rowData.push(cellValue);
                });
                data.push(rowData);
            });
        
            // 2. Crear la hoja de cálculo
            const ws = XLSX.utils.aoa_to_sheet([...headers, ...data]);
        
            // 3. Definir y aplicar estilos
            const fontStyle = { name: "Noto Sans", sz: 11 };
            const borderStyle = { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } };
            const centerAlign = { alignment: { horizontal: "center", vertical: "center", wrapText: true } };
        
            const headerStyle = { font: { ...fontStyle, bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "1E5B4F" } }, ...centerAlign, border: borderStyle };
            const totalRowStyle = { font: { ...fontStyle, bold: true }, fill: { fgColor: { rgb: "E2E8F0" } }, ...centerAlign, border: borderStyle };
            const cellStyle = { font: fontStyle, ...centerAlign, border: borderStyle };
            const currencyStyle = { numFmt: "$#,##0.00" };
        
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
                    if (!ws[cell_ref]) continue;
        
                    if (R < headers.length) { // Es un encabezado
                        ws[cell_ref].s = headerStyle;
                    } else { // Es una celda de datos o total
                        const isTotalRow = (ws[XLSX.utils.encode_cell({c: 0, r: R})]?.v === 'Total');
                        if (isTotalRow) {
                            ws[cell_ref].s = totalRowStyle;
                        } else {
                            ws[cell_ref].s = cellStyle;
                        }
                    }
        
                    if (typeof ws[cell_ref].v === 'number') {
                        // Combina el estilo base (celda o total) con el formato de moneda
                        ws[cell_ref].s = { ...ws[cell_ref].s, numFmt: currencyStyle.numFmt };
                    }
                }
            }
        
            // 4. Aplicar fusiones y anchos de columna
            ws['!merges'] = merges; // Aplicar las celdas combinadas
            
            // Validar que headers[0] exista antes de acceder a su longitud
            if (headers.length > 0 && headers[0]) {
                ws['!cols'] = Array(headers[0].length).fill({ wch: 20 }); // Ancho de columna de 20 caracteres
            } else if (data.length > 0 && data[0]) {
                // Fallback si no hay encabezados pero sí datos
                ws['!cols'] = Array(data[0].length).fill({ wch: 20 });
            }
        
            // 5. Generar y descargar el libro de trabajo
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, fileName);
        }

        /**
         * Muestra una alerta sutil si hay fechas de fallo próximas.
         * La alerta aparece una vez por sesión y se cierra automáticamente.
         * @param {Object} counts - Objeto con los conteos de fallos por semana.
         * Se ejecuta solo una vez por carga de página.
         */
        let falloAlertShown = false;
        let falloAlertTimeout; // Variable para el temporizador
        function checkAndShowFalloAlert(counts) {
            if (falloAlertShown) return; // Asegura que solo se muestre una vez

            const alertContainer = document.getElementById('fallo-alert-container');
            const alertContent = document.getElementById('fallo-alert-content');
            alertContent.innerHTML = '';

            const alerts = [];

            if (counts.minus1 > 0) {
                alerts.push({
                    message: `Hay <strong>${counts.minus1}</strong> licitacion(es) con fallo la semana pasada.`,
                    target: 'fallo-indicator-minus-1'
                });
            }
            if (counts.current > 0) {
                alerts.push({
                    message: `Hay <strong>${counts.current}</strong> licitacion(es) con fallo esta semana.`,
                    target: 'fallo-current-content' // <-- CORRECCIÓN: Apuntar al elemento clickeable correcto
                });
            }
            if (counts.plus1 > 0) {
                alerts.push({
                    message: `Hay <strong>${counts.plus1}</strong> licitacion(es) con fallo la próxima semana.`,
                    target: 'fallo-indicator-plus-1'
                });
            }
            if (counts.plus2 > 0) {
                alerts.push({
                    message: `Hay <strong>${counts.plus2}</strong> licitacion(es) con fallo en 2 semanas.`,
                    target: 'fallo-indicator-plus-2'
                });
            }

            if (alerts.length > 0) {
                alerts.forEach(alert => {
                    const item = document.createElement('button');
                    item.className = 'w-full text-left text-sm text-slate-600 p-2 rounded-md hover:bg-slate-100 transition-colors';
                    item.dataset.target = alert.target;
                    item.innerHTML = `
                        <p>${alert.message}</p>
                    `;
                    alertContent.appendChild(item);
                });

                alertContainer.classList.remove('hidden', 'alert-leave');
                alertContainer.classList.add('alert-enter');
                falloAlertShown = true;

                // Iniciar temporizador para cerrar automáticamente la alerta
                startFalloAlertTimeout();
            }
        }

        // =============================================
        // MÓDULO: Links clickeables y generar docx
        // =============================================
        
        /**
         * Maneja el evento de doble clic en una fila de la tabla para mostrar los detalles.
         * @param {MouseEvent} e - El evento de clic.
         * @param {boolean} isHistorical - Indica si la fila pertenece a la tabla histórica.
         */
        function handleRowDoubleClick(e, isHistorical) {
            // SOLUCIÓN: Buscar la fila que tiene el atributo data-id.
            const row = e.target.closest('tr[data-id]');
            if (!row || e.target.closest('button') || e.target.closest('.link-cell')) {
                return; // No hacer nada si se hace clic en un botón o en el enlace
            }
            // SOLUCIÓN: Leer el ID directamente del dataset de la fila.
            const licitacionId = row.dataset.id;
            if (!licitacionId) return;

            const data = isHistorical ? historicalLicitaciones : licitaciones;
            const licitacionItem = data.find(item => item.id === licitacionId);
            showDetailsModal(licitacionItem, isHistorical);
        }

        /**
         * Maneja el clic en el botón de generar documento Word (.docx).
         * @param {HTMLElement} button - El botón que fue presionado.
         */
        function handleGenerateDocClick(button) {
            const licitacionId = button.dataset.id;
            const isHistorical = button.dataset.isHistorical === 'true';
            // Llamada directa a la función de generación de documento, sin contraseña.
            generateDoc(licitacionId, isHistorical);
        }

        // =============================================
        // MÓDULO: Configuración de eventos
        // =============================================
        
        /**
         * Configura todos los `event listeners` principales de la aplicación.
         */
        function setupEventListeners() {
            setupTabs();
            setupColumnFilters('main-table-header', () => licitaciones, renderTable, 'main');
            setupColumnFilters('historical-table-header', () => historicalLicitaciones, renderTable, 'historical');
            setupFiltering('filter-input-historical', () => historicalLicitaciones, renderTable, true);
            setupQuickViewTooltip();
            setupAddEditButtons();
            // Listener para el nuevo botón de limpiar filtros
            document.getElementById('clear-all-filters-btn').addEventListener('click', () => clearAllFilters('historical'));

            // Listener para el botón de cerrar el modal de carga de plantillas
            if (closeTemplateUploadModalBtn) {
                closeTemplateUploadModalBtn.addEventListener('click', () => closeModal(templateUploadModal));
            }

            // Listener para el botón de carga de plantilla (ahora dentro del modal de configuración)
            if (openTemplateUploaderBtn) {
                openTemplateUploaderBtn.addEventListener('click', () => {
                    closeModal(reportSettingsModal); // Cierra el modal de config
                    openModal(templateUploadModal); // Abre el modal de plantillas
                });
            }

            // --- INICIO: Listeners para la nueva funcionalidad de configuración de reportes ---
            if (reportSettingsBtn) {
                reportSettingsBtn.addEventListener('click', () => {
                    // Cargar la configuración actual en el modal antes de abrirlo
                    document.querySelector(`input[name="date-filter-mode"][value="${reportSettings.dateFilterMode}"]`).checked = true;
                    const startDateInput = document.getElementById('report-start-date');
                    const endDateInput = document.getElementById('report-end-date');
                    const dateContainer = document.getElementById('date-range-picker-container');

                    startDateInput.value = reportSettings.startDate;
                    endDateInput.value = reportSettings.endDate;

                    if (reportSettings.dateFilterMode === 'period') {
                        dateContainer.classList.remove('opacity-50');
                        startDateInput.disabled = false;
                        endDateInput.disabled = false;
                    } else {
                        dateContainer.classList.add('opacity-50');
                        startDateInput.disabled = true;
                        endDateInput.disabled = true;
                    }
                    openModal(reportSettingsModal);
                });
            }

            if (document.getElementById('save-report-settings-btn')) {
                document.getElementById('save-report-settings-btn').addEventListener('click', () => {
                    const dateFilterMode = document.querySelector('input[name="date-filter-mode"]:checked').value;
                    const startDate = document.getElementById('report-start-date').value;
                    const endDate = document.getElementById('report-end-date').value;

                    if (dateFilterMode === 'period' && (!startDate || !endDate)) {
                        return showAlert("Por favor, seleccione una fecha de inicio y una de fin para el período.", "warning");
                    }
                    reportSettings = { dateFilterMode, startDate, endDate };
                    showAlert("Configuración de reportes guardada.", "success");
                    updateCharts(); // Actualizar los gráficos inmediatamente
                    closeModal(reportSettingsModal);
                });
            }

            // 1. Cierre del modal de configuración de reportes al hacer clic fuera.
            if (reportSettingsModal) {
                reportSettingsModal.addEventListener('click', (e) => {
                    if (e.target === reportSettingsModal) {
                        closeModal(reportSettingsModal);
                    }
                });

                // 2. Guardar cambios en el modal de configuración con la tecla "Enter".
                reportSettingsModal.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Prevenir cualquier comportamiento por defecto.
                        document.getElementById('save-report-settings-btn').click();
                    }
                });
            }

            if (closeReportSettingsModalBtn) {
                closeReportSettingsModalBtn.addEventListener('click', () => closeModal(reportSettingsModal));
            }

            document.querySelectorAll('input[name="date-filter-mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isPeriod = e.target.value === 'period';
                    const container = document.getElementById('date-range-picker-container');
                    const startDateInput = document.getElementById('report-start-date');
                    const endDateInput = document.getElementById('report-end-date');

                    container.classList.toggle('opacity-50', !isPeriod);
                    startDateInput.disabled = !isPeriod;
                    endDateInput.disabled = !isPeriod;
                });
            });
            // --- FIN: Listeners para la nueva funcionalidad ---

            setupPasswordVerification();
            dynamicChartVariable.addEventListener('change', updateDynamicChart);
            
            toggleLabelsBtn.addEventListener('click', () => {
                showChartLabels = !showChartLabels;
                toggleLabelsBtn.classList.toggle('bg-primary', showChartLabels);
                toggleLabelsBtn.classList.toggle('text-white', showChartLabels);
                updateDynamicChart();
            });
            
            // Fortalecer la responsividad de las gráficas al cambiar el tamaño de la ventana (zoom)
            window.addEventListener('resize', updateCharts);

            // Listener para la tabla de distribución dinámica (Reportes)
            dynamicTableBody.addEventListener('click', e => {
                const row = e.target.closest('tr');
                if (!row) return;

                // Busca la primera celda de la fila, que es la que contiene los datos del filtro.
                const firstCell = row.querySelector('td');
                if (!firstCell) return;

                // Extrae los datos del filtro de la primera celda.
                const { filterVariable, filterValue } = firstCell.dataset;
                
                if (filterVariable && filterValue && filterValue !== 'Total') { // Asegurarse de no hacer clic en la fila de total
                    navigateAndFilter({ [filterVariable]: [filterValue] }); // Llama a la función de navegación y filtro.
                }
            });

            // Listener para la tabla de proyectos por procedimiento (Reportes)
            document.getElementById('projectProcedureTable').addEventListener('click', e => {
                const cell = e.target.closest('td[data-filter-project]');
                if (!cell) return;
                const { filterProject, filterVariable, filterValue } = cell.dataset;
                navigateAndFilter({ 'proyecto': [filterProject], [filterVariable]: [filterValue] });
            });

            addLicitacionBtn.addEventListener('click', () => {
                const currentUser = auth.currentUser;
                if (!currentUser || currentUser.isAnonymous) {
                    showAlert("Debe iniciar sesión para agregar licitaciones.", "warning");
                    return;
                }

                // Clear form
                licitacionForm.reset();
                $('#licitacion-proyecto, #licitacion-nombre, #licitacion-siglasDependencia, #licitacion-procedimientoContratacion, #licitacion-tipo, #licitacion-anoPublicacion, #licitacion-registradosInteres, #licitacion-nombreLicitantes, #licitacion-ganadorLicitacion').val(null).trigger('change');

                openModalWithFocus(licitacionModal, document.getElementById('licitacion-proyecto'));
            });
            
            closeModalBtn.addEventListener('click', () => closeModal(licitacionModal));
            
            licitacionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!licitacionForm.checkValidity()) {
                    return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                }
                
                const formData = new FormData(licitacionForm);
                const licitacionData = Object.fromEntries(formData.entries());
                
                saveLicitacion(licitacionData, true); // Guardar directamente en el histórico
                closeModal(licitacionModal);
            });
            
            closeEditModalBtn.addEventListener('click', () => closeModal(editModal));
            
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!editForm.checkValidity()) {
                    return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                }
                
                const formData = new FormData(editForm);
                const updateData = Object.fromEntries(formData.entries());
                const id = document.getElementById('edit-id').value;
                
                await updateLicitacion(id, updateData, currentEditIsHistorical);
                closeModal(editModal);
            });

            let licitacionToDeleteId = null;
            let licitacionToDeleteIsHistorical = false;

             function handleDeleteClick(button) {
                 const currentUser = auth.currentUser;
                 if (!currentUser || currentUser.isAnonymous) {
                     showAlert("Debe iniciar sesión para eliminar registros.", "warning");
                     return;
                 }
 
                 requirePassword(() => {
                     licitacionToDeleteId = button.getAttribute('data-id');
                     licitacionToDeleteIsHistorical = button.getAttribute('data-is-historical') === 'true';
                     if (!licitacionToDeleteId) return;
                     openModal(confirmModal);
                 });
             }

            licitacionTableBody.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;
                if (target.classList.contains('edit-btn')) handleEditClick(target);
                if (target.classList.contains('delete-btn')) handleDeleteClick(target);
                if (target.classList.contains('generate-doc-btn')) handleGenerateDocClick(target);
            });


            document.querySelectorAll('.upload-template-type-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const templateType = e.currentTarget.dataset.templateType;
                    uploadTemplateFile(templateType);
                });
            });

            function uploadTemplateFile(templateType) {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.docx';
                fileInput.style.display = 'none';

                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        requirePassword(async () => {
                            showAlert(`Subiendo plantilla para '${templateType}'...`, "info");
                            const reader = new FileReader();
                            reader.onload = async (event) => {
                                const base64String = event.target.result;
                                try {
                                    const docRef = db.collection('config').doc(`wordTemplate_${templateType}`);
                                    await docRef.set({ templateData: base64String, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                                    showAlert(`¡Plantilla para '${templateType}' actualizada con éxito!`, "success");
                                    closeModal(templateUploadModal); // Cierra el modal de plantillas al terminar
                                } catch (dbError) {
                                    console.error("Error al guardar plantilla en Firestore:", dbError);
                                    showAlert("Error al guardar la plantilla.", "error");
                                }
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                };
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            }

        licitacionTableBody.addEventListener('dblclick', (e) => handleRowDoubleClick(e, false));

            historicalTableBody.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;
                if (target.classList.contains('edit-btn')) handleEditClick(target);
                if (target.classList.contains('delete-btn')) handleDeleteClick(target);
                if (target.classList.contains('generate-doc-btn')) handleGenerateDocClick(target);
            });

        historicalTableBody.addEventListener('dblclick', (e) => handleRowDoubleClick(e, true));

            cancelDeleteBtn.addEventListener('click', () => {
                closeModal(confirmModal);
                licitacionToDeleteId = null;
            });
            
            confirmDeleteBtn.addEventListener('click', async () => {
                if (licitacionToDeleteId) {
                    await deleteLicitacion(licitacionToDeleteId, licitacionToDeleteIsHistorical);
                    closeModal(confirmModal);
                }
            });

            historicalFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const currentUser = auth.currentUser;
                if (!currentUser || currentUser.isAnonymous) {
                    showAlert("Debe iniciar sesión para subir archivos.", "warning");
                    return;
                }

                requirePassword(async () => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const workbook = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            
                            // --- INICIO: Detección inteligente de la fila de encabezado ---
                            let jsonData;
                            const firstCell = worksheet['A1'];
                            // Comprueba si la celda A1 existe y contiene el título del reporte.
                            if (firstCell && typeof firstCell.v === 'string' && firstCell.v.includes('Seguimiento de Licitaciones')) {
                                // Si tiene el título, ignora la primera fila y empieza a leer desde la segunda (índice 1).
                                jsonData = XLSX.utils.sheet_to_json(worksheet, { range: 1 });
                            } else {
                                // Si no tiene el título, procesa el archivo de forma normal.
                                jsonData = XLSX.utils.sheet_to_json(worksheet);
                            }
                            // --- FIN: Detección inteligente de la fila de encabezado ---

                            if (jsonData.length === 0) return showAlert("El archivo no contiene datos válidos.", "warning");

                            const processedData = jsonData.map(row => {
                                const mapKeys = (obj, keyMap) => Object.keys(obj).reduce((acc, key) => {
                                    const newKey = keyMap[key.toLowerCase().trim()] || key.toLowerCase().trim();
                                    acc[newKey] = obj[key];
                                    return acc;
                                }, {});

                                // Función para limpiar espacios en blanco si el valor es un string
                                const trimIfString = (value) => {
                                    if (typeof value === 'string') return value.trim();
                                    return value;
                                };

                                const keyMapping = {
                                    'no.': 'no',
                                    'proyecto': 'proyecto',
                                    'nombre': 'nombre',
                                    'descripción': 'descripcion', // Con acento
                                    'descripcion': 'descripcion', // Sin acento
                                    'generalidades': 'generalidades',
                                    'siglas dependencia': 'siglasDependencia',
                                    'código expediente': 'codigoExpediente',
                                    'procedimiento': 'procedimientoContratacion', // Nombre corto
                                    'procedimiento contratación': 'procedimientoContratacion',
                                    'tipo': 'tipo',
                                    'año publicación': 'anoPublicacion',
                                    'fecha apertura': 'fechaPresentacionApertura', // Nombre corto
                                    'fecha presentación apertura': 'fechaPresentacionApertura',
                                    'fecha fallo': 'fechaFallo',
                                    'fecha estimada inicio': 'fechaEstimadaInicio',
                                    'participantes': 'registradosInteres', // Nombre corto
                                    'registrados interés': 'registradosInteres',
                                    'licitantes': 'nombreLicitantes', // Nombre corto
                                    'nombre licitantes': 'nombreLicitantes',
                                    'ganador': 'ganadorLicitacion', // Nombre corto
                                    'monto (pesos)': 'monto', // Nuevo alias para importación
                                    'ganador licitación': 'ganadorLicitacion',
                                    'monto': 'monto',
                                    'link compras xm': 'linkComprasXM',
                                    'link': 'linkComprasXM' // Alias común para el link
                                };
                                const mappedRow = mapKeys(row, keyMapping);

                                // Procesamiento robusto de fecha
                                let fechaPresentacionApertura = mappedRow.fechaPresentacionApertura;
                                let fechaFallo = mappedRow.fechaFallo;
                                let fechaEstimadaInicio = mappedRow.fechaEstimadaInicio;
                                
                                // Función para procesar fechas
                                const processDate = (fecha) => {
                                    if (fecha instanceof Date) {
                                        const year = fecha.getFullYear();
                                        const month = (fecha.getMonth() + 1).toString().padStart(2, '0');
                                        const day = fecha.getDate().toString().padStart(2, '0');
                                        return `${year}-${month}-${day}`;
                                    } else if (typeof fecha === 'number') {
                                        const excelEpoch = new Date(1900, 0, 1);
                                        const jsDate = new Date(excelEpoch.getTime() + (fecha - 2) * 24 * 60 * 60 * 1000);
                                        const year = jsDate.getFullYear();
                                        const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
                                        const day = jsDate.getDate().toString().padStart(2, '0');
                                        return `${year}-${month}-${day}`;
                                    } else if (typeof fecha === 'string') {
                                        if (fecha.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                                            const [day, month, year] = fecha.split('/');
                                            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                        } else if (fecha.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                                            return fecha;
                                        } else {
                                            try {
                                                const parsedDate = new Date(fecha);
                                                if (!isNaN(parsedDate)) {
                                                    const year = parsedDate.getFullYear();
                                                    const month = (parsedDate.getMonth() + 1).toString().padStart(2, '0');
                                                    const day = parsedDate.getDate().toString().padStart(2, '0');
                                                    return `${year}-${month}-${day}`;
                                                } else {
                                                    return '';
                                                }
                                            } catch (e) {
                                                return '';
                                            }
                                        }
                                    } else {
                                        return '';
                                    }
                                };

                                return {
                                    proyecto: trimIfString(mappedRow.proyecto) || '',
                                    nombre: trimIfString(mappedRow.nombre) || '',
                                    descripcion: trimIfString(mappedRow.descripcion) || '',
                                    generalidades: trimIfString(mappedRow.generalidades) || '',
                                    siglasDependencia: trimIfString(mappedRow.siglasDependencia) || '',
                                    codigoExpediente: trimIfString(mappedRow.codigoExpediente) || '',
                                    procedimientoContratacion: trimIfString(mappedRow.procedimientoContratacion) || '',
                                    tipo: trimIfString(mappedRow.tipo) || '',
                                    anoPublicacion: trimIfString(mappedRow.anoPublicacion) || '',
                                    fechaPresentacionApertura: processDate(fechaPresentacionApertura),
                                    fechaFallo: processDate(fechaFallo),
                                    fechaEstimadaInicio: processDate(fechaEstimadaInicio),
                                    registradosInteres: trimIfString(mappedRow.registradosInteres) || '',
                                    nombreLicitantes: trimIfString(mappedRow.nombreLicitantes) || '',
                                    ganadorLicitacion: trimIfString(mappedRow.ganadorLicitacion) || '',
                                    // Si el monto es "N/A" (texto del excel exportado), se convierte a '' para que sea un valor falsy.
                                    // Si es un número, se mantiene. Si no, se trata como vacío.
                                    monto: mappedRow.monto === "N/A" ? '' : mappedRow.monto || '',
                                    linkComprasXM: trimIfString(mappedRow.linkComprasXM) || ''
                                };
                            });

                            if (processedData.length === 0) return showAlert("El archivo Excel está vacío o no es válido.", "warning");
                            
                            let proceedWithImport = false;

                            if (historicalLicitaciones.length > 0) {
                                openModal(replaceHistoricalModal);
                                const userConfirmed = await new Promise(resolve => {
                                    confirmReplaceBtn.onclick = () => {
                                        closeModal(replaceHistoricalModal);
                                        resolve(true);
                                    };
                                    cancelReplaceBtn.onclick = () => {
                                        closeModal(replaceHistoricalModal);
                                        resolve(false);
                                    };
                                });

                                if (userConfirmed) {
                                    await deleteAllHistorical();
                                    proceedWithImport = true;
                                }
                            } else {
                                proceedWithImport = true; // No hay datos, así que se puede importar directamente.
                            }

                            if (proceedWithImport) {
                                await importHistoricalData(processedData);
                            }

                            historicalFileInput.value = '';
                            
                        } catch (error) {
                            console.error("Error al procesar el archivo:", error);
                            showAlert("Error al procesar el archivo. Asegúrese de que es un Excel válido.", "error");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
            });
            
            document.getElementById('download-historical-excel-btn').addEventListener('click', () => {
                // Obtener los datos actualmente filtrados en la tabla
                const filteredData = applyAllFilters(historicalLicitaciones, 'historical');

                if (filteredData.length === 0) return showAlert("No hay datos en la tabla para descargar.", "warning");
                const dataToExport = prepareExportData(filteredData);
                
                // Crear la hoja de cálculo directamente con los datos y encabezados, pero dejando espacio para el título.
                // 1. Crear un array de arrays, empezando con los encabezados.
                const sheetData = [exportHeaders];
                // 2. Añadir los datos de cada fila.
                dataToExport.forEach(item => sheetData.push(Object.values(item)));
                // 3. Crear la hoja a partir de este array, insertándola desde la celda A2.
                const ws = XLSX.utils.aoa_to_sheet(sheetData, { origin: "A2" });

                // Aplicar todo el formato
                applyExcelFormatting(ws, dataToExport); // Llamada corregida, sin reasignación

                const wb = XLSX.utils.book_new();
                // Generar nombre de archivo con fecha actual
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0'); // Enero es 0
                const year = today.getFullYear();
                const hours = String(today.getHours()).padStart(2, '0');
                const minutes = String(today.getMinutes()).padStart(2, '0');
                const formattedDateTime = `${day}-${month}-${year}_${hours}h${minutes}m`;
                const fileName = `Seguimiento de Licitaciones - ${formattedDateTime}.xlsx`;

                XLSX.utils.book_append_sheet(wb, ws, "Seguimiento de Licitaciones");

                XLSX.writeFile(wb, fileName);
            });
            
            closeWebviewBtn.addEventListener('click', () => {
                webviewFrame.src = 'about:blank';
                closeModal(webviewModal);
            });

            closeDetailsModalBtn.addEventListener('click', () => closeModal(viewDetailsModal));

            // Cierre del modal de detalles al hacer clic fuera
            viewDetailsModal.addEventListener('click', (e) => {
                if (e.target === viewDetailsModal) {
                    closeModal(viewDetailsModal);
                }
            });

            document.getElementById('view-all-details-btn').addEventListener('click', () => {
                showMultiDetailsModal(true);
            });

            closeMultiDetailsModalBtn.addEventListener('click', () => closeModal(multiDetailsModal));

            // Mejora: Cerrar el modal de múltiples detalles al hacer clic en el fondo
            multiDetailsModal.addEventListener('click', (e) => {
                if (e.target === multiDetailsModal) {
                    closeModal(multiDetailsModal);
                }
            });

            // Listener para los botones de descarga en el modal de múltiples detalles
            multiDetailsContentContainer.addEventListener('click', e => {
                const target = e.target.closest('.generate-doc-btn');
                if (!target) return;
                handleGenerateDocClick(target);
            });

            // Listeners para los nuevos botones de descarga de tablas de reportes
            document.getElementById('download-dynamic-table-excel-btn').addEventListener('click', () => {
                const variable = document.getElementById('dynamic-chart-variable').value;
                const fileName = `Reporte_Distribucion_por_${variable}.xlsx`;
                exportTableToExcel('dynamic-distribution-table', 'Distribución', fileName);
            });

            document.getElementById('download-project-procedure-table-excel-btn').addEventListener('click', () => {
                const variable = document.getElementById('project-chart-variable').value;
                const fileName = `Reporte_Detallado_por_${variable}.xlsx`;
                // El ID de la tabla completa es 'projectProcedureTable', la función buscará el thead, tbody y tfoot dentro de ella.
                exportTableToExcel('projectProcedureTable', 'Detalle Procedimientos', fileName);
            });

            // Listeners para los nuevos botones de ordenamiento de tablas de reportes
            document.getElementById('toggle-dynamic-table-sort-btn').addEventListener('click', (e) => {
                dynamicChartSortBy = dynamicChartSortBy === 'count' ? 'amount' : 'count';
                const button = e.currentTarget;
                button.title = dynamicChartSortBy === 'count' ? 'Ordenar por Monto' : 'Ordenar por Cantidad';
                // Actualizar solo el gráfico y tabla dinámicos
                updateDynamicChart();
            });

            document.getElementById('toggle-project-table-sort-btn').addEventListener('click', (e) => {
                projectChartSortBy = projectChartSortBy === 'count' ? 'amount' : 'count';
                const button = e.currentTarget;
                button.title = projectChartSortBy === 'count' ? 'Ordenar por Monto' : 'Ordenar por Cantidad';
                // Actualizar solo el gráfico y tabla de proyectos
                // No es necesario destruir el otro gráfico, solo el que se va a redibujar.
                if (charts.projectProcedure) charts.projectProcedure.destroy();
                charts.projectProcedure = null;
                updateProjectProcedureChart();
            });

            // Eventos para la nueva alerta de fallos
            document.getElementById('close-fallo-alert-btn').addEventListener('click', () => {
                const container = document.getElementById('fallo-alert-container');
                container.classList.remove('alert-enter');
                container.classList.add('alert-leave'); // La animación de salida se maneja con CSS
            });

            // Detener el temporizador si el usuario pasa el mouse sobre la alerta
            document.getElementById('fallo-alert-container').addEventListener('mouseenter', () => {
                clearTimeout(falloAlertTimeout);
            });

            // Reanudar el temporizador si el usuario saca el mouse de la alerta
            document.getElementById('fallo-alert-container').addEventListener('mouseleave', () => {
                startFalloAlertTimeout();
            });

            document.getElementById('fallo-alert-content').addEventListener('click', (e) => {
                const alertButton = e.target.closest('button[data-target]');
                if (alertButton) {
                    const indicator = document.getElementById(alertButton.dataset.target);
                    if (indicator) {
                        indicator.click(); // Simula el clic en el indicador del dashboard
                        document.getElementById('close-fallo-alert-btn').click(); // Cierra la alerta
                    }
                }
            });
        }

        /**
         * Configura la funcionalidad del tooltip de vista rápida que aparece al pasar el ratón sobre las filas de la tabla.
         */
        function setupQuickViewTooltip() {
            const showTooltip = (e) => {
                const row = e.target.closest('tr[data-quickview="true"]'); // Asegurarse de que el tooltip solo se active en las filas correctas
                if (!row) return;
        
                const { dependencia, proyecto, nombre, procedimiento, tipo, ganador, monto, fallo } = row.dataset;
        
                // Función auxiliar para mostrar el valor o un guion si está vacío
                const displayValue = (value, formatter = v => v) => {
                    return (value && value.trim() !== '' && value !== 'N/A') ? formatter(value) : '-';
                };
        
                // Construcción del contenido del tooltip usando la función auxiliar
                quickViewTooltip.innerHTML = `
                    <p><strong>Dependencia:</strong> ${truncateText(dependencia, 100)}</p>
                    <p><strong>Proyecto:</strong> ${truncateText(proyecto, 100)}</p>
                    <p><strong>Nombre:</strong> ${truncateText(nombre, 100)}</p>
                    <p><strong>Procedimiento:</strong> ${displayValue(truncateText(procedimiento, 100))}</p>
                    <p><strong>Tipo:</strong> ${displayValue(truncateText(tipo, 100))}</p>
                    <p><strong>Ganador:</strong> ${displayValue(truncateText(ganador, 100))}</p>
                    <div class="fallo-monto-container">
                        <p class="text-sm text-gray-500 m-0"><strong>Fallo:</strong> ${displayValue(fallo, formatLongDate)}</p>
                        <div class="monto-highlight">${displayValue(monto)}</div>
                    </div>
                `;
        
                quickViewTooltip.classList.add('visible');
            };
        
            const hideTooltip = () => {
                quickViewTooltip.classList.remove('visible');
            };
        
            const moveTooltip = (e) => {
                if (quickViewTooltip.classList.contains('visible')) {
                    quickViewTooltip.style.left = `${e.clientX + 15}px`;
                    quickViewTooltip.style.top = `${e.clientY + 15}px`;
                }
            };

            [historicalTableBody].forEach(tbody => { // Aplicar solo a la tabla de licitaciones
                tbody.addEventListener('mouseover', showTooltip);
                tbody.addEventListener('mouseout', hideTooltip);
                tbody.addEventListener('mousemove', moveTooltip);
            });
        }

        /**
         * Configura el selector de fecha dinámico en el radar de fallos.
         */
        function setupDynamicDatePicker() {
            const datePicker = document.getElementById('fallo-date-picker');
            const currentIcon = document.getElementById('fallo-current-icon');

            // Función para comparar si dos fechas son el mismo día (ignorando la hora)
            const isSameDay = (date1, date2) =>
                date1.getFullYear() === date2.getFullYear() &&
                date1.getMonth() === date2.getMonth() &&
                date1.getDate() === date2.getDate();

            datePicker.addEventListener('change', (e) => {
                const newDate = e.target.value;
                
                if (!newDate) { // Si el usuario borra la fecha (ej. con el botón 'x' en Chrome)
                    selectedBaseDate = null;
                } else {
                    const chosenDate = new Date(newDate + 'T12:00:00Z');
                    const today = new Date();
                    // Si la fecha seleccionada es hoy, trátala como si no hubiera selección.
                    selectedBaseDate = isSameDay(chosenDate, today) ? null : newDate;
                }

                // Actualizar el estado visual del icono
                currentIcon.classList.toggle('text-accent', !!selectedBaseDate);
                currentIcon.classList.toggle('text-primary', !selectedBaseDate);

                updateFalloDashboard(selectedBaseDate);
            });
        }

        /**
         * Configura los filtros del dashboard de radar de fechas de fallo.
         */
        function setupFalloDashboardFilter() {
            const indicators = {
                'minus-2': document.getElementById('fallo-indicator-minus-2'),
                'minus-1': document.getElementById('fallo-indicator-minus-1'),
                'plus-1': document.getElementById('fallo-indicator-plus-1'),
                'plus-2': document.getElementById('fallo-indicator-plus-2')
            };

            // El clic en el contenido de la tarjeta actual también debe funcionar
            const currentContent = document.getElementById('fallo-current-content');
            indicators['current'] = currentContent; // Usar 'current' como clave para la lógica existente

            Object.entries(indicators).forEach(([key, element]) => {
                element.addEventListener('click', (e) => {
                    const isDeactivating = activeFalloDashboardFilter && activeFalloDashboardFilter.key === key;

                    document.querySelectorAll('.indicator-card').forEach(card => card.classList.remove('active-filter'));

                    if (isDeactivating) {
                        // Si se hace clic en el filtro ya activo, se desactiva.
                        activeFalloDashboardFilter = null;

                        // Limpiar todos los filtros asociados a la tabla histórica
                        activeFilters.historical = {};
                        document.querySelectorAll('#historical-table-header .filterable-header.active').forEach(header => {
                            header.classList.remove('active');
                        });
                        const searchInput = document.getElementById('filter-input-historical');
                        if (searchInput) {
                            searchInput.value = '';
                            searchInput.dispatchEvent(new Event('input')); // Para ocultar el botón 'x'
                        }
                    } else {
                        // Activar nuevo filtro
                        const offsetMap = {
                            'minus-2': -2,
                            'minus-1': -1,
                            'current': 0,
                            'plus-1': 1,
                            'plus-2': 2
                        };
                        const offset = offsetMap[key];
                        // Usar la fecha base seleccionada para calcular el período del filtro
                        const period = getMonthlyPeriod(offset, selectedBaseDate);
                        activeFalloDashboardFilter = { key: key, start: period.start, end: period.end };

                        // El resaltado visual se aplica a la tarjeta contenedora, no solo al texto.
                        const parentCard = element.closest('.indicator-card');
                        if (parentCard) {
                            parentCard.classList.add('active-filter');
                        }

                    }
                    // Re-renderizar la tabla de histórico con el filtro (o sin él)
                    sortAndRenderTable(historicalTableBody, historicalLicitaciones, true);
                });
            });
        }

        /**
         * Inicia un temporizador para cerrar automáticamente la alerta de fechas de fallo.
         */
        function startFalloAlertTimeout() {
            // Limpiar cualquier temporizador existente antes de iniciar uno nuevo
            clearTimeout(falloAlertTimeout);
            // Iniciar el temporizador para cerrar la alerta después de 15 segundos
            falloAlertTimeout = setTimeout(() => {
                // Simula un clic en el botón de cerrar si no hay interacción
                const closeBtn = document.getElementById('close-fallo-alert-btn');
                if (closeBtn) closeBtn.click();
            }, 15000); // 15000 milisegundos = 15 segundos
        }


        // =============================================
        // MÓDULO: Inicialización
        // =============================================

        /**
         * Función de inicialización principal. Se ejecuta cuando el DOM está completamente cargado.
         */
        document.addEventListener('DOMContentLoaded', () => {
            // Asignar elementos del DOM una vez que la página esté cargada
            loader = document.getElementById('loader');
            appContainer = document.getElementById('app');
            userInfo = document.getElementById('user-info');
            tabsContainer = document.getElementById('tabs');
            tabContents = document.querySelectorAll('.tab-content');
            addLicitacionBtn = document.getElementById('add-licitacion-btn');
            licitacionTableBody = document.getElementById('licitacion-table-body');
            noLicitacionMessage = document.getElementById('no-licitacion-message');
            historicalTableBody = document.getElementById('historical-table-body');
            noHistoricalMessage = document.getElementById('no-historical-message');
            historicalFileInput = document.getElementById('historical-file-input');
            historicalFileName = document.getElementById('file-name');
            dynamicChartCanvas = document.getElementById('dynamicChart');
            dynamicChartVariable = document.getElementById('dynamic-chart-variable');
            toggleLabelsBtn = document.getElementById('toggle-labels-btn');
            dynamicTableBody = document.getElementById('dynamic-table-body');
            dynamicTableHeader = document.getElementById('dynamic-table-header');
            licitacionModal = document.getElementById('licitacion-modal');
            licitacionForm = document.getElementById('licitacion-form');
            closeModalBtn = document.getElementById('close-modal-btn');
            editModal = document.getElementById('edit-modal');
            editForm = document.getElementById('edit-form');
            closeEditModalBtn = document.getElementById('close-edit-modal-btn');
            confirmModal = document.getElementById('confirm-modal');
            cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            replaceHistoricalModal = document.getElementById('replace-historical-modal');
            cancelReplaceBtn = document.getElementById('cancel-replace-btn');
            confirmReplaceBtn = document.getElementById('confirm-replace-btn');
            editOptionModal = document.getElementById('edit-option-modal');
            editOptionInput = document.getElementById('edit-option-input');
            cancelEditOptionBtn = document.getElementById('cancel-edit-option-btn');
            confirmEditOptionBtn = document.getElementById('confirm-edit-option-btn');
            passwordModal = document.getElementById('password-modal');
            passwordInput = document.getElementById('password-input');
            cancelPasswordBtn = document.getElementById('cancel-password-btn');
            confirmPasswordBtn = document.getElementById('confirm-password-btn');
            webviewModal = document.getElementById('webview-modal');
            webviewFrame = document.getElementById('webview-frame');
            closeWebviewBtn = document.getElementById('close-webview-btn');
            uploadTemplateBtn = document.getElementById('upload-template-btn');
            viewDetailsModal = document.getElementById('view-details-modal');
            templateUploadModal = document.getElementById('template-upload-modal');
            closeTemplateUploadModalBtn = document.getElementById('close-template-upload-modal-btn');
            closeDetailsModalBtn = document.getElementById('close-details-modal-btn');
            multiDetailsModal = document.getElementById('multi-details-modal');
            closeMultiDetailsModalBtn = document.getElementById('close-multi-details-modal-btn');
            multiDetailsContentContainer = document.getElementById('multi-details-content-container');

            // --- Asignación de elementos para el login
            loginScreen = document.getElementById('login-screen');
            loginForm = document.getElementById('login-form');
            loginBtn = document.getElementById('login-btn');
            logoutBtn = document.getElementById('logout-btn');
            userEmailSpan = document.getElementById('user-email');
            loginError = document.getElementById('login-error');
            togglePasswordVisibility = document.getElementById('toggle-password-visibility');

            // --- INICIO: Asignación de elementos para la nueva funcionalidad ---
            reportSettingsModal = document.getElementById('report-settings-modal');
            reportSettingsBtn = document.getElementById('report-settings-btn');
            closeReportSettingsModalBtn = document.getElementById('close-report-settings-modal-btn');
            openTemplateUploaderBtn = document.getElementById('open-template-uploader-btn');
            // --- FIN: Asignación de elementos ---

            // Listener para el modal de detalles content
            detailsModalContent = document.getElementById('details-modal-content');
            
            // Listener para el tooltip de vista rápida
            quickViewTooltip = document.getElementById('quick-view-tooltip');

            // Inicializar la autenticación y los listeners
            initializeAppWithAuth();
            setupEventListeners();
            setupFalloDashboardFilter();
            setupDynamicDatePicker();
            
            // --- Lógica de Autenticación ---
            loginBtn.addEventListener('click', () => {
                loginScreen.classList.remove('hidden');
                loginError.classList.add('hidden');
                loginForm.reset();
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // El onAuthStateChanged se encargará de actualizar la UI
                        loginScreen.classList.add('hidden');
                    })
                    .catch((error) => {
                        loginError.textContent = "Credenciales incorrectas. Por favor, intente de nuevo.";
                        loginError.classList.remove('hidden');
                        console.error("Error de inicio de sesión:", error);
                    });
            });

            logoutBtn.addEventListener('click', () => {
                // 1. Apagar los listeners activos para evitar errores de permisos.
                if (unsubscribeHistorical) {
                    unsubscribeHistorical();
                }
                // 2. Cerrar la sesión. onAuthStateChanged se encargará del resto.
                auth.signOut().catch(error => console.error("Error al cerrar sesión:", error));
            });

            // --- Lógica mejorada para visibilidad de contraseña (mantener presionado) ---
            const passwordInputForToggle = document.getElementById('login-password');
            const iconForToggle = togglePasswordVisibility.querySelector('i');

            const showPassword = () => {
                passwordInputForToggle.type = 'text';
                iconForToggle.classList.remove('fa-eye');
                iconForToggle.classList.add('fa-eye-slash');
            };

            const hidePassword = () => {
                passwordInputForToggle.type = 'password';
                iconForToggle.classList.remove('fa-eye-slash');
                iconForToggle.classList.add('fa-eye');
            };

            // Eventos para ratón
            togglePasswordVisibility.addEventListener('mousedown', showPassword);
            togglePasswordVisibility.addEventListener('mouseup', hidePassword);
            togglePasswordVisibility.addEventListener('mouseleave', hidePassword); // Ocultar si el ratón se va del botón

            // Eventos para dispositivos táctiles
            togglePasswordVisibility.addEventListener('touchstart', (e) => { e.preventDefault(); showPassword(); });
            togglePasswordVisibility.addEventListener('touchend', hidePassword);

            document.getElementById('close-login-screen-btn').addEventListener('click', () => {
                loginScreen.classList.add('hidden');
            });

            // Listener para el nuevo selector de la segunda gráfica
            document.getElementById('project-chart-variable').addEventListener('change', updateProjectProcedureChart);

            // Listener para el nuevo botón de la leyenda
            document.getElementById('toggle-legend-btn').addEventListener('click', () => {
                showProjectChartLegend = !showProjectChartLegend;
                const button = document.getElementById('toggle-legend-btn');
                const icon = button.querySelector('i');
                button.classList.toggle('bg-primary', showProjectChartLegend);
                button.classList.toggle('text-white', showProjectChartLegend);
                button.classList.toggle('bg-slate-200', !showProjectChartLegend);
                icon.className = showProjectChartLegend ? 'fa-solid fa-eye' : 'fa-solid fa-eye-slash';
                updateProjectProcedureChart();
            });

            // Listener para el nuevo botón de tipo de gráfica
            document.getElementById('toggle-chart-type-btn').addEventListener('click', (e) => {
                isProjectChartStacked = !isProjectChartStacked;
                const button = e.currentTarget;
                button.classList.toggle('bg-primary', isProjectChartStacked);
                button.classList.toggle('text-white', isProjectChartStacked);
                button.classList.toggle('bg-slate-200', !isProjectChartStacked);
                button.classList.toggle('text-slate-700', !isProjectChartStacked);
                updateProjectProcedureChart();
            });

            // Configurar Select2 para los selects
            $('#licitacion-proyecto, #licitacion-nombre, #licitacion-siglasDependencia, #licitacion-procedimientoContratacion, #licitacion-tipo, #licitacion-anoPublicacion, #licitacion-registradosInteres, #licitacion-nombreLicitantes, #licitacion-ganadorLicitacion, #edit-licitacion-proyecto, #edit-licitacion-nombre, #edit-licitacion-siglasDependencia, #edit-licitacion-procedimientoContratacion, #edit-licitacion-tipo, #edit-licitacion-anoPublicacion, #edit-licitacion-registradosInteres, #edit-licitacion-nombreLicitantes, #edit-licitacion-ganadorLicitacion').each(function() {
                 $(this).select2({
                     tags: true,
                     placeholder: "Seleccione o escriba una opción",
                     allowClear: true,
                     width: '100%'
                 });
             });

            // Mejora de UX: Auto-foco en el buscador de Select2 al abrirlo.
            $(document).on('select2:open', () => {
                // Usamos un pequeño timeout para asegurar que el campo de búsqueda ya es visible.
                setTimeout(() => document.querySelector('.select2-search__field').focus(), 50);
            });
            
             // Set current date as default
             const today = new Date().toISOString().split('T')[0];
             document.getElementById('licitacion-fechaPresentacionApertura').value = today;
             document.getElementById('licitacion-fechaFallo').value = today;
             document.getElementById('licitacion-fechaEstimadaInicio').value = today;
        });

        // Iniciar la aplicación
        // La inicialización ahora ocurre dentro del listener DOMContentLoaded

    </script>
</body> 
</html>
