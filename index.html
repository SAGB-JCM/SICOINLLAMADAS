<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noticias Sobre los Trenes de México</title>
    
    <!-- jQuery (requerido para Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- xlsx-js-style para leer/escribir archivos de Excel con formato -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>
    
    <!-- Select2 for searchable dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- html2pdf para generar reportes en PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Librerías para manipulación de .docx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.34.1/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- SunEditor (Rich Text Editor) -->
    <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>

    <!-- Firebase App (el módulo principal de Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #9C2348;
            --secondary-color: #A6802D;
            --accent-color: #1E5B4F;
            --success-color: #10B981;
            --danger-color: #EF4444;
        }
        
        html { font-size: 60%; }
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        
        .bg-primary { background-color: var(--primary-color); }
        .text-primary { color: var(--primary-color); }
        .border-primary { border-color: var(--primary-color); }
        .focus\:ring-primary:focus { --tw-ring-color: var(--primary-color); }
        
        .bg-secondary { background-color: var(--secondary-color); }
        .text-secondary { color: var(--secondary-color); }
        .border-secondary { border-color: var(--secondary-color); }
        
        .bg-accent { background-color: var(--accent-color); }
        .text-accent { color: var(--accent-color); }
        .border-accent { border-color: var(--accent-color); }
        
        .bg-success { background-color: var(--success-color); }
        .hover\:bg-success-dark:hover { background-color: #059669; }

        .bg-danger { background-color: var(--danger-color); }
        .hover\:bg-danger-dark:hover { background-color: #DC2626; }
        
        .indicator-card.active-filter {
            box-shadow: 0 0 0 2px var(--primary-color), 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }

        /* Estilo para resaltar el indicador de la semana actual */
        .indicator-card.current-week-highlight {
            border-bottom: 3px solid var(--primary-color);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            background-color: #fcfdff;
        }

        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        
        .hidden { display: none; }
        .tab-btn.active { border-color: var(--primary-color); color: var(--primary-color); font-weight: bold; }
        
        .loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(255, 255, 255, 0.9); z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        .loader .spinner { 
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; 
            border-left-color: var(--primary-color); animation: spin 1s ease infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .table-container { 
            overflow-x: auto; 
            max-height: 430px;
            overflow-y: auto;
        }

        /* Estilo específico para la altura de la tabla de histórico */
        #historical-table-container {
            max-height: 425px; /* <-- Puedes ajustar este valor a tu preferencia */
        }
        
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Mejora para encabezados de tabla fijos */
        .table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f1f5f9; /* Color de bg-slate-100 para evitar transparencia */
        }

        .sortable-header { cursor: pointer; }
        .sortable-header .sort-icon { display: none; }
        .sortable-header.asc .sort-icon.asc,
        .sortable-header.desc .sort-icon.desc { display: inline-block; }
        .filterable-header { 
            cursor: pointer; 
            position: relative;
        }
        .filterable-header .filter-icon {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .filterable-header:hover .filter-icon,
        .filterable-header.active .filter-icon {
            opacity: 1;
            color: var(--primary-color);
        }

        .filter-dropdown {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 6px;
            z-index: 20;
            max-height: 250px;
            overflow-y: auto;
            min-width: 200px;
        }
        
        input:invalid, select:invalid { border-color: #ef4444; }
        
        .section-title { font-weight: bold; color: var(--primary-color); margin-bottom: 1rem; }
        
        .max-w-7xl {
            max-width: 100% !important;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .table-container table {
            width: 100%;
            min-width: 1200px;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            align-items: end;
            gap: 1rem;
        }

        @media (min-width: 640px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .form-field {
            margin-bottom: 0.5rem;
        }

        .form-field label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        /* --- Reglas para restaurar el tamaño original de Resumen, Comentario y Fuente --- */

        /* 1. Hacer que el contenedor del campo ocupe todo el ancho del grid */
        .form-field.full-width {
            grid-column: 1 / -1; /* Ocupa todas las columnas del grid */
        }

        /* 2. Anular el ancho fijo del contenedor interno para los textareas */
        .form-field.full-width .flex-with-buttons {
            min-width: 100%;
            max-width: 100%;
        }

        /* Anular ancho fijo para el campo de fuente también */
        .form-field:has(#news-source) .flex-with-buttons, .form-field:has(#edit-news-source) .flex-with-buttons {
            min-width: 100%;
            max-width: 100%;
        }

        /* 3. Ocultar los botones de edición para los campos de texto libre */
        .form-field:has(textarea) .edit-btn,
        .form-field:has(#news-source) .edit-btn,
        .form-field:has(#edit-news-source) .edit-btn,
        .form-field:has(#news-summary) .edit-btn,
        .form-field:has(#edit-news-summary) .edit-btn {
            display: none;
        }

        .news-form-container {
            max-height: 75vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .news-form-container::-webkit-scrollbar {
            width: 6px;
        }

        .news-form-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .news-form-container::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }

        .news-form-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .flex-with-buttons {
            display: flex;
            align-items: flex-end; /* Alinea el botón con la base del campo */
            /* Clave: Establece un tamaño fijo para el contenedor del campo y el botón */
            min-width: 340px;
            max-width: 340px;
        }

        .flex-with-buttons .select2-container {
            flex-grow: 1;
            margin-bottom: 1px;
            min-width: 0; /* Permite que el select se encoja y no se desborde */
        }

        .flex-with-buttons input,
        .flex-with-buttons textarea {
            min-width: 0; /* Permite que el campo se encoja y no se desborde */
        }

        .flex-with-buttons button {
            height: 38px;
            width: 38px;
            margin-bottom: 1px;
            flex-shrink: 0;
            border-radius: 0.25rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }

        .flex-with-buttons button.edit-btn {
            background-color: var(--secondary-color);
            color: white;
        }

        .flex-with-buttons button.paste-btn:hover {
            background-color: #16463c;
        }
        
        .select2-container--default .select2-selection--single {
            height: 38px;
            padding: 5px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 26px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }

        .select2-container {
            width: 100% !important;
        }

        /* Regla clave para truncar el texto dentro del campo de selección */
        .select2-container .select2-selection--single .select2-selection__rendered {
            display: block;
            padding-left: 8px;
            padding-right: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .link-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #1a56db;
            text-decoration: underline;
            cursor: pointer;
        }

        .wide-modal .relative {
            max-width: 76rem !important;
        }

        .chart-wrapper {
            position: relative;
            height: 100%;
        }

        .dynamic-chart-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .dynamic-chart-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        
        .dynamic-chart-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .dynamic-table-container {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .dynamic-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .dynamic-table th, .dynamic-table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        
        .dynamic-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        .dynamic-table tr:nth-child(even) {
            background-color: #f3f4f6;
        }
        
        #toggle-labels-btn {
            transition: all 0.3s ease;
        }

        #toggle-labels-btn.bg-primary {
            background-color: var(--primary-color) !important;
        }

        .webview-modal {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .webview-container {
            width: 90vw;
            height: 90vh;
            max-width: 1200px;
        }

        .webview-modal iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0.5rem;
        }

        /* Estilos para el modal de detalles de la noticia */
        .details-modal-content {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 2rem;
            background-color: #f9fafb;
        }
        .details-header {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        .details-header .date {
            font-size: 1rem;
            color: #6b7280;
            font-weight: 500;
        }
        .details-header .project {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin-top: 0.25rem;
        }
        .details-section {
            margin-bottom: 1.5rem;
        }
        .details-section h4 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
            text-align: center; /* Centrar los títulos de sección */
        }
        .details-section .text-center {
            text-align: center;
        }

        .contenteditable {
            min-height: 100px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            overflow-wrap: break-word; /* Evita el desbordamiento horizontal con texto largo */
            background-color: white;
            overflow-y: auto;
        }

        .contenteditable:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(156, 35, 72, 0.2);
        }

        /* Estilos para tablas DENTRO del editor contenteditable */
        .contenteditable table {
            font-size: 0.9em; /* Letra más pequeña para tablas en el editor */
            border-collapse: collapse;
        }
        .contenteditable th, .contenteditable td {
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            height: auto; /* Asegura que la altura se ajuste al contenido */
        }

        .formatted-content {
            font-size: 1rem;
            line-height: 1.5;
            overflow-wrap: break-word; /* Evita que el texto largo se desborde del contenedor */
        }

        .formatted-content p {
            margin-bottom: 0.5rem;
        }

        .formatted-content ul, .formatted-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }

        /* Regla mejorada para la sangría de las listas */
        .formatted-content ul li, .formatted-content ol li {
            list-style-position: outside !important; /* Asegura que la viñeta esté fuera del flujo de texto */
            padding-left: 1.5em; /* Espacio para la viñeta y un poco más */
            text-indent: -1.5em; /* Sangría negativa para alinear el texto de las siguientes líneas */
            margin-left: 1.5em; /* Empuja todo el elemento a la derecha para crear el espacio de la sangría */
        }

        .formatted-content strong, .formatted-content b {
            font-weight: bold;
        }

        .formatted-content em, .formatted-content i {
            font-style: italic;
        }

        .formatted-content u {
            text-decoration: underline;
        }

        /* Estilos de tabla replicados de la app de licitaciones */
        .details-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .details-table th, .details-table td { border: 1px solid #e5e7eb; padding: 0.75rem; text-align: left; vertical-align: top; }
        .details-table th { background-color: var(--primary-color); font-weight: 600; color: white; }

        /* Clase para bloquear el scroll del body cuando un modal está abierto */
        .multi-details-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background-color: #f9fafb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .multi-details-item:last-child {
            margin-bottom: 0;
        }

        body.modal-open {
            overflow: hidden;
        }

        /* Estilos para tablas pegadas desde Word */
        .details-table-container {
            overflow-x: auto;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .details-table-container table {
            font-size: 0.9em; /* Letra ligeramente más pequeña para tablas */
            border-collapse: collapse;
            border: 1px solid #e5e7eb;
        }
        /* Estilo para resaltar el texto de búsqueda */
        .highlight {
            background-color: #ffd966; /* Tailwind yellow-100 */
            border-radius: 2px;
        }

        /* Estilo para celdas clickeables en tablas de reportes */
        .clickable-cell {
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        /* Estilos para la Alerta de Resumen (copiado de Licitaciones y Llamadas) */
        .train-alert.alert-enter { animation: slideInUp 0.5s ease-out forwards; }
        .train-alert.alert-leave { animation: slideOutDown 0.5s ease-in forwards; }

        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideOutDown { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }

        /* Estilos para el tooltip de vista rápida (replicado de la app de llamadas) */
        #quick-view-tooltip {
            position: fixed;
            display: none; /* Oculto por defecto */
            background-color: #ffffff; /* Fondo blanco */
            color: #374151; /* Texto oscuro (gray-700) */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb; /* Borde sutil (gray-200) */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* Sombra más pronunciada */
            z-index: 100;
            pointer-events: none; /* Para que no interfiera con el cursor */
            font-size: 0.9rem; /* Tamaño de fuente mejorado */
            line-height: 1.5;
            max-width: 350px;
            transition: opacity 0.2s ease-in-out;
            opacity: 0;
        }

        /* Estilo especial para el tooltip de conferencias/eventos */
        #quick-view-tooltip.quick-view-conference {
            color: #f9fafb; /* Texto claro (gray-50) */
            text-align: center;
        }
        #quick-view-tooltip.quick-view-conference .medio-title {
            font-size: 1.15rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
        }
        #quick-view-tooltip.quick-view-conference .medio-icon {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }
        #quick-view-tooltip.quick-view-conference .fecha-larga {
            font-size: 0.9rem;
            color: #d1d5db; /* gris claro */
        }

        #quick-view-tooltip.visible {
            display: block;
            opacity: 1;
        }
        #quick-view-tooltip strong { color: var(--primary-color); } /* Títulos en color primario */
        #quick-view-tooltip p { margin-bottom: 0.25rem; }
        #quick-view-tooltip .cita-text { font-style: italic; color: #4b5563; border-left: 3px solid var(--secondary-color); padding-left: 0.75rem; margin-top: 0.5rem; }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#9C2348',
                            light: '#b52e5a',
                            dark: '#7d1c3a'
                        },
                        secondary: {
                            DEFAULT: '#A6802D',
                            light: '#bf9a41',
                            dark: '#8a6b22'
                        },
                        accent: {
                            DEFAULT: '#1E5B4F',
                            light: '#267c6c',
                            dark: '#16463c'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="antialiased text-slate-700">

    <div id="loader" class="loader">
        <div class="spinner"></div>
        <p class="mt-4 text-sm text-slate-600">Cargando datos, por favor espera...</p>
    </div>

    <div id="app" class="min-h-screen hidden">

        <header class="bg-primary shadow-lg sticky top-0 z-30">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img src="https://github.com/SAGB-JCM/NoticiasTrenesM-xico/blob/main/Trenes%20de%20M%C3%A9xico%20-%20LOGO.png?raw=true" alt="Logo Tren México" class="h-16 w-auto">
                    <h1 class="text-xl sm:text-2xl font-bold text-white tracking-tight">Noticias Sobre los Trenes de México</h1>
                </div>
                <div id="user-info" class="text-white text-sm font-mono"></div>
            </div>
        </header>

        <div class="bg-white shadow-sm sticky top-[56px] z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="tabs" class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button data-tab="noticias" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Noticias</button>
                        <button data-tab="historico" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Histórico</button>
                        <button data-tab="reportes" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Reportes</button>
                    </nav>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">

            <main id="tab-content-noticias" class="tab-content">
                <section id="news-dashboard-medios" class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Radar de Medios</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Total Noticias -->
                        <div id="news-medio-indicator-total" data-medio="__NOTICIAS_ONLY__" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para filtrar">
                            <div class="bg-primary/10 p-2 rounded-full"><i class="fa-solid fa-newspaper text-primary text-xl"></i></div>
                            <div><p class="text-sm text-slate-500">Noticias</p><p id="news-medio-count-total" class="text-2xl font-bold text-primary">0</p></div>
                        </div>
                        <!-- Conferencia Matutina -->
                        <div id="news-medio-indicator-mananera" data-medio="Conferencia de prensa matutina" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para filtrar">
                            <div class="bg-accent/10 p-2 rounded-full"><i class="fa-solid fa-microphone-lines text-accent text-xl"></i></div>
                            <div><p class="text-sm text-slate-500">Conferencia Matutina</p><p id="news-medio-count-mananera" class="text-2xl font-bold text-accent">0</p></div>
                        </div>
                        <!-- Evento Presidencial -->
                        <div id="news-medio-indicator-evento" data-medio="Evento Presidencial" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para filtrar">
                            <div class="bg-secondary/10 p-2 rounded-full"><i class="fa-solid fa-users-rays text-secondary text-xl"></i></div>
                            <div><p class="text-sm text-slate-500">Evento Presidencial</p><p id="news-medio-count-evento" class="text-2xl font-bold text-secondary">0</p></div>
                        </div>
                        <!-- Informe de Gobierno -->
                        <div id="news-medio-indicator-informe" data-medio="Informe de Gobierno" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para filtrar">
                            <div class="bg-slate-500/10 p-2 rounded-full"><i class="fa-solid fa-landmark-flag text-slate-500 text-xl"></i></div>
                            <div><p class="text-sm text-slate-500">Informe de Gobierno</p><p id="news-medio-count-informe" class="text-2xl font-bold text-slate-600">0</p></div>
                        </div>
                    </div>
                </section>
                <section id="news-log">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Registro de Noticias</h2>
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center space-x-2">
                                <button id="clear-all-filters-main-btn" class="text-slate-500 hover:text-primary p-2 rounded-lg" title="Limpiar todos los filtros">
                                    <i class="fa-solid fa-paint-brush"></i>
                                </button>
                                <button id="view-all-details-main-btn" class="text-slate-500 hover:text-primary p-2 rounded-lg" title="Ver detalles de todos los resultados visibles">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                                <div class="relative flex-grow">
                                    <input type="text" id="filter-input-main" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                    <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                                    <button id="clear-filter-btn-main" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden"><i class="fa-solid fa-times-circle"></i></button>
                                </div>
                            </div>                            
                            <button id="add-news-btn" class="bg-success hover:bg-success-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-plus"></i>
                                <span>Nueva Noticia</span>
                            </button>
                            <button id="add-conference-btn" class="bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-microphone"></i>
                                <span>Nueva Conferencia</span>
                            </button>
                            <button id="download-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-file-excel"></i>
                                <span>Descargar Excel</span>
                            </button>
                            <button id="start-migration-btn" class="bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-database"></i>
                                <span>Migrar Noticias</span>
                            </button>
                            <button id="confirm-migration-btn" class="hidden bg-success hover:bg-success-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap" disabled>
                                <i class="fa-solid fa-check"></i>
                                <span>Confirmar</span>
                            </button>
                            <button id="cancel-migration-btn" class="hidden bg-danger hover:bg-danger-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-times"></i>
                                <span>Cancelar</span>
                            </button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="main-table-header">
                                    <th scope="col" class="py-3 px-6 migration-select-col hidden">
                                        <input type="checkbox" id="select-all-news-checkbox" class="rounded border-gray-300 text-primary focus:ring-primary">
                                    </th>
                                    <th scope="col" class="py-3 px-6">No.</th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fecha">Fecha <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="proyecto">Proyecto <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="subproyecto">Subproyecto <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="categoria">Categoría <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="comentario">Noticia <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="cita">Cita <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="resumen">Resumen <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="medio">Medio <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fuente">Enlace <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="news-table-body"></tbody>
                        </table>
                        <div id="no-news-message" class="p-6 text-center text-slate-500 hidden">
                            <p>No hay noticias registradas en la base de datos.</p>
                        </div>
                    </div>
                </section>
            </main>

            <div id="tab-content-historico" class="tab-content hidden">
                <section id="dashboard-medios" class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Radar de Medios</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Total Noticias -->
                        <div id="medio-indicator-total" data-medio="__NOTICIAS_ONLY__" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para filtrar">
                            <div class="bg-primary/10 p-2 rounded-full"><i class="fa-solid fa-newspaper text-primary text-xl"></i></div>
                            <div><p class="text-sm text-slate-500">Noticias</p><p id="historical-medio-count-total" class="text-2xl font-bold text-primary">0</p></div>
                        </div>
                        <!-- Conferencia Matutina -->
                        <div id="medio-indicator-mananera" data-medio="Conferencia de prensa matutina" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para filtrar">
                            <div class="bg-accent/10 p-2 rounded-full"><i class="fa-solid fa-microphone-lines text-accent text-xl"></i></div>
                            <div><p class="text-sm text-slate-500">Conferencia Matutina</p><p id="historical-medio-count-mananera" class="text-2xl font-bold text-accent">0</p></div>
                        </div>
                        <!-- Evento Presidencial -->
                        <div id="medio-indicator-evento" data-medio="Evento Presidencial" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para filtrar">
                            <div class="bg-secondary/10 p-2 rounded-full"><i class="fa-solid fa-users-rays text-secondary text-xl"></i></div>
                            <div><p class="text-sm text-slate-500">Evento Presidencial</p><p id="historical-medio-count-evento" class="text-2xl font-bold text-secondary">0</p></div>
                        </div>
                        <!-- Informe de Gobierno -->
                        <div id="medio-indicator-informe" data-medio="Informe de Gobierno" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para filtrar">
                            <div class="bg-slate-500/10 p-2 rounded-full"><i class="fa-solid fa-landmark-flag text-slate-500 text-xl"></i></div>
                            <div><p class="text-sm text-slate-500">Informe de Gobierno</p><p id="historical-medio-count-informe" class="text-2xl font-bold text-slate-600">0</p></div>
                        </div>
                    </div>
                </section>
                <section id="historical-log">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Registro Histórico</h2>
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center space-x-2">
                                <button id="clear-all-filters-historical-btn" class="text-slate-500 hover:text-primary p-2 rounded-lg" title="Limpiar todos los filtros">
                                    <i class="fa-solid fa-paint-brush"></i>
                                </button>
                                <button id="view-all-details-historical-btn" class="text-slate-500 hover:text-primary p-2 rounded-lg" title="Ver detalles de todos los resultados visibles">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                                <div class="relative flex-grow">
                                    <input type="text" id="filter-input-historical" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                    <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                                    <button id="clear-filter-btn-historical" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden"><i class="fa-solid fa-times-circle"></i></button>
                                </div>
                            </div>                            
                            <button id="download-historical-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-file-excel"></i>
                                <span>Descargar Excel</span>
                            </button>
                            <label for="historical-file-input" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg shadow-sm transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap"><i class="fa-solid fa-file-upload"></i><span>Subir Excel</span><input type="file" id="historical-file-input" class="hidden" accept=".xlsx, .xls"></label>
                            <button id="import-historical-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out hidden items-center space-x-2 whitespace-nowrap" disabled><i class="fa-solid fa-database"></i><span>Importar Excel</span></button>
                            <button id="start-reverse-migration-btn" class="bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-arrow-left"></i>
                                <span>Migrar a Noticias</span>
                            </button>
                            <button id="confirm-reverse-migration-btn" class="hidden bg-success hover:bg-success-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap" disabled>
                                <i class="fa-solid fa-check"></i>
                                <span>Confirmar</span>
                            </button>
                            <button id="cancel-reverse-migration-btn" class="hidden bg-danger hover:bg-danger-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-times"></i>
                                <span>Cancelar</span>
                            </button>
                        </div>
                    </div>
                    <div id="historical-table-container" class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="historical-table-header">
                                    <th scope="col" class="py-3 px-6 reverse-migration-select-col hidden">
                                        <input type="checkbox" id="select-all-historical-news-checkbox" class="rounded border-gray-300 text-primary focus:ring-primary">
                                    </th>
                                    <th scope="col" class="py-3 px-6">No.</th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fecha">Fecha <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="proyecto">Proyecto <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="subproyecto">Subproyecto <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="categoria">Categoría <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="comentario">Noticia <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="cita">Cita <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="resumen">Resumen <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="medio">Medio <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fuente">Enlace <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historical-table-body"></tbody>
                        </table>
                        <div id="no-historical-message" class="p-6 text-center text-slate-500 hidden">
                            <p>No hay datos históricos cargados.</p>
                        </div>
                    </div>
                </section>
            </div>

            <div id="tab-content-reportes" class="tab-content hidden">
                <section id="reportes" class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Reportes</h2>
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center space-x-1">
                                <label for="reportes-data-source" class="block text-sm font-medium text-gray-700">Fuente de datos:</label>
                                <select id="reportes-data-source" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                    <option value="historico">Histórico</option>
                                    <option value="noticias">Noticias</option>
                                    <option value="combinado">Histórico + Noticias</option>
                                </select>
                                <button id="report-settings-btn" class="text-slate-500 hover:text-primary p-2 rounded-lg transition-colors" title="Configuración de Reportes">
                                    <i class="fa-solid fa-cog fa-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Total de Noticias y Conferencias Registradas -->
                    <div class="dynamic-chart-container">
                        <div class="dynamic-chart-header">
                            <h3 class="text-xl font-semibold text-slate-800">Total de Noticias y Conferencias Registradas</h3>
                            <button id="toggle-total-news-chart-type-btn" class="bg-primary text-white font-bold py-2 px-3 rounded ml-2 transition-colors duration-200" title="Cambiar a Gráfica de Barras">
                                <i class="fa-solid fa-chart-pie"></i>
                            </button>
                        </div>
                        <div class="dynamic-chart-content">
                            <div class="chart-wrapper">
                                <canvas id="totalNewsByTypeChart"></canvas>
                            </div>
                            <div class="dynamic-table-container">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-lg font-semibold text-slate-800 text-center flex-grow">Distribución por Tipo</h4>
                                    <button id="download-total-news-type-table-excel-btn" class="text-slate-400 hover:text-primary p-2 rounded-lg transition-colors" title="Descargar tabla como Excel">
                                        <i class="fa-solid fa-file-excel"></i>
                                    </button>
                                </div>
                                <table id="totalNewsByTypeTable" class="dynamic-table">
                                    <thead>
                                        <tr>
                                            <th>Tipo de Registro</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="totalNewsByTypeTableBody">
                                        <!-- El contenido se generará dinámicamente -->
                                    </tbody>
                                    <tfoot>
                                        <!-- El total se generará dinámicamente -->
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>


                    <div class="dynamic-chart-container">
                        <div class="dynamic-chart-header">
                            <h3 class="text-xl font-semibold text-slate-800">Noticias por</h3>
                            <select id="dynamic-chart-variable" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                <option value="proyecto">Proyecto</option>
                                <option value="subproyecto">Subproyecto</option>
                                <option value="categoria">Categoría</option>
                                <option value="medio">Medio</option>
                            </select>
                            <button id="toggle-labels-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded ml-2">
                                <i class="fa-solid fa-tag"></i>
                            </button>
                        </div>
                        <div class="dynamic-chart-content">
                            <div class="chart-wrapper">
                                <canvas id="dynamicChart"></canvas>
                            </div>
                            <div class="dynamic-table-container">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-lg font-semibold text-slate-800 text-center flex-grow">Distribución</h4>
                                    <button id="download-dynamic-table-excel-btn" class="text-slate-400 hover:text-primary p-2 rounded-lg transition-colors" title="Descargar tabla como Excel">
                                        <i class="fa-solid fa-file-excel"></i>
                                    </button>
                                </div>
                                <table id="dynamic-distribution-news-table" class="dynamic-table">
                                    <thead>
                                        <tr>
                                            <th id="dynamic-table-header">Variable</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dynamic-table-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Gráfica de Proyectos por Categoría (Movida aquí) -->
                    <div class="dynamic-chart-container">
                        <div class="dynamic-chart-header">
                            <h3 class="text-xl font-semibold text-slate-800">Proyectos por Categoría</h3>
                            <button id="toggle-chart-type-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded ml-2" title="Cambiar a Gráfica Apilada">
                                <i class="fa-solid fa-chart-bar"></i>
                            </button>
                        </div>
                        <div class="chart-wrapper" style="height: 400px;">
                            <canvas id="projectCategoryChart"></canvas>
                        </div>
                        <div class="dynamic-table-container mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-lg font-semibold text-slate-800 text-center flex-grow">Distribución Detallada</h4>
                                <button id="download-project-category-table-excel-btn" class="text-slate-400 hover:text-primary p-2 rounded-lg transition-colors" title="Descargar tabla como Excel">
                                    <i class="fa-solid fa-file-excel"></i>
                                </button>
                            </div>
                            <table id="projectCategoryTable" class="dynamic-table">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                                <tfoot></tfoot>
                            </table>
                        </div>
                    </div>

                </section>
            </div>
        </div>
    </div>
    
    <div id="news-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <h3 class="text-2xl font-bold text-primary mb-6">Registrar Nueva Noticia</h3>
            <div class="news-form-container">
                <form id="news-form" class="space-y-6" novalidate>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field ">
                            <label for="news-date">Fecha de la Noticia</label>
                            <input type="date" id="news-date" name="fecha" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required>
                        </div>
                        <div class="form-field sm:col-span-2">
                            <label for="news-source">Fuente de la Noticia (URL)</label>
                            <div class="flex-with-buttons">
                                <input type="url" id="news-source" name="fuente" placeholder="https://ejemplo.com/noticia" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required>
                                <button type="button" id="edit-source-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="news-project">Proyecto</label>
                            <div class="flex-with-buttons">
                                <select id="news-project" name="proyecto" required></select>
                                <button type="button" id="edit-project-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="news-subproject">Subproyecto</label>
                            <div class="flex-with-buttons">
                                <select id="news-subproject" name="subproyecto"></select>
                                <button type="button" id="edit-subproject-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="news-category">Categoría</label>
                            <div class="flex-with-buttons">
                                <select id="news-category" name="categoria" required></select>
                                <button type="button" id="edit-category-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="news-medio">Medio</label>
                            <div class="flex-with-buttons">
                                <select id="news-medio" name="medio" required></select>
                                <button type="button" id="edit-medio-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="news-comment">Noticia (Título)</label>
                        <div class="flex-with-buttons">
                            <textarea id="news-comment" name="comentario" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2"></textarea>
                            <button type="button" id="edit-comment-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="news-cita">Cita de la Noticia</label>
                        <div class="flex-with-buttons">
                            <textarea id="news-cita" name="cita" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2"></textarea>
                            <button type="button" id="edit-cita-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="news-summary">Resumen de la Noticia</label>
                        <div class="flex-with-buttons">
                            <div id="news-summary" name="resumen" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2 contenteditable" contenteditable="true"></div>
                            <button type="button" id="edit-summary-btn" class="edit-btn">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-end pt-4">
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Noticia</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-edit-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <h3 class="text-2xl font-bold text-primary mb-6">Editar Noticia</h3>
            <div class="news-form-container">
                <form id="edit-form" class="space-y-6" novalidate>
                    <input type="hidden" id="edit-id">
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field ">
                            <label for="edit-news-date">Fecha de la Noticia</label>
                            <input type="date" id="edit-news-date" name="fecha" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required>
                        </div>
                        <div class="form-field sm:col-span-2">
                            <label for="edit-news-source">Fuente de la Noticia (URL)</label>
                            <div class="flex-with-buttons">
                                <input type="url" id="edit-news-source" name="fuente" placeholder="https://ejemplo.com/noticia" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required>
                                <button type="button" id="edit-source-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="edit-news-project">Proyecto</label>
                            <div class="flex-with-buttons">
                                <select id="edit-news-project" name="proyecto" required></select>
                                <button type="button" id="edit-project-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="edit-news-subproject">Subproyecto</label>
                            <div class="flex-with-buttons">
                                <select id="edit-news-subproject" name="subproyecto"></select>
                                <button type="button" id="edit-subproject-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="edit-news-category">Categoría</label>
                            <div class="flex-with-buttons">
                                <select id="edit-news-category" name="categoria" required></select>
                                <button type="button" id="edit-category-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="edit-news-medio">Medio</label>
                            <div class="flex-with-buttons">
                                <select id="edit-news-medio" name="medio" required></select>
                                <button type="button" id="edit-medio-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="edit-news-comment">Noticia (Título)</label>
                        <div class="flex-with-buttons">
                            <textarea id="edit-news-comment" name="comentario" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2"></textarea>
                            <button type="button" id="edit-comment-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="edit-news-cita">Cita de la Noticia</label>
                        <div class="flex-with-buttons">
                            <textarea id="edit-news-cita" name="cita" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2"></textarea>
                            <button type="button" id="edit-cita-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="edit-news-summary">Resumen de la Noticia</label>
                        <div class="flex-with-buttons">
                            <div id="edit-news-summary" name="resumen" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2 contenteditable" contenteditable="true"></div>
                            <button type="button" id="edit-summary-edit-btn" class="edit-btn">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-end pt-4">
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="conference-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-conference-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <h3 class="text-2xl font-bold text-primary mb-6">Registrar Nueva Conferencia</h3>
            <div class="news-form-container">
                <form id="conference-form" class="space-y-6" novalidate>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="conference-date">Fecha de la Conferencia/Evento/Informe</label>
                            <input type="date" id="conference-date" name="fecha" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required>
                        </div>
                        <div class="form-field">
                            <label for="conference-medio">Medio</label>
                            <select id="conference-medio" name="medio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required></select>
                        </div>
                    </div>
                    <div class="form-field sm:col-span-2 full-width">
                        <label for="conference-source">Enlace(s) (URL)</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="conference-source" name="fuente" placeholder="https://ejemplo.com/noticia1; https://ejemplo.com/noticia2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required>
                            <button type="button" id="manage-links-conference-btn" class="bg-secondary hover:bg-secondary-dark text-white font-bold p-2 rounded-lg shadow-md transition-all duration-200 ease-in-out mt-1" title="Gestionar múltiples enlaces">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="conference-summary" id="conference-summary-label">Resumen de la Conferencia</label>
                        <div id="conference-summary" name="resumen" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2 contenteditable" contenteditable="true"></div>
                    </div>
                    <div class="form-field full-width">
                        <label for="conference-docx">Subir Documento (docx)</label>
                        <input type="file" id="conference-docx" name="conferenceDocx" accept=".docx" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary-dark" />
                        <p class="mt-1 text-sm text-gray-500" id="conference-docx-label">Cargue un archivo .docx para usarlo como reporte individual. Si no se carga nada, se usará la plantilla.</p>
                    </div>
                    <div class="flex items-center justify-end pt-4">
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Conferencia</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="edit-conference-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-edit-conference-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <h3 class="text-2xl font-bold text-primary mb-6">Editar Conferencia</h3>
            <div class="news-form-container">
                <form id="edit-conference-form" class="space-y-6" novalidate>
                    <input type="hidden" id="edit-conference-id">
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="edit-conference-date">Fecha de la Conferencia/Evento/Informe</label>
                            <input type="date" id="edit-conference-date" name="fecha" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required>
                        </div>
                        <div class="form-field">
                            <label for="edit-conference-medio">Medio</label>
                            <select id="edit-conference-medio" name="medio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required></select>
                        </div>
                    </div>
                    <div class="form-field sm:col-span-2 full-width">
                        <label for="edit-conference-source">Enlace(s) (URL)</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="edit-conference-source" name="fuente" placeholder="https://ejemplo.com/noticia1; https://ejemplo.com/noticia2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required>
                            <button type="button" id="manage-links-edit-conference-btn" class="bg-secondary hover:bg-secondary-dark text-white font-bold p-2 rounded-lg shadow-md transition-all duration-200 ease-in-out mt-1" title="Gestionar múltiples enlaces">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="edit-conference-summary" id="edit-conference-summary-label">Resumen de la Conferencia</label>
                        <div id="edit-conference-summary" name="resumen" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2 contenteditable" contenteditable="true"></div>
                    </div>
                    <div class="form-field full-width">
                        <label for="edit-conference-docx">Subir Documento (docx)</label>
                        <input type="file" id="edit-conference-docx" name="editConferenceDocx" accept=".docx" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary-dark" />
                        <p class="mt-1 text-sm text-gray-500" id="edit-conference-docx-label">Cargue un archivo .docx para usarlo como reporte individual. Si no se carga nada, se usará la plantilla.</p>
                    </div>
                    <div class="flex items-center justify-end pt-4">
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="multi-link-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-[51] flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl mx-4">
            <h3 class="text-xl font-bold text-primary mb-4">Gestionar Enlaces</h3>
            <div class="space-y-4">
                <div class="flex space-x-2">
                    <input type="url" id="new-link-input" placeholder="Pegue un nuevo enlace aquí" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    <button id="add-link-btn" class="bg-success hover:bg-success-dark text-white font-bold py-2 px-4 rounded-lg">Añadir</button>
                </div>
                <div id="link-list-container" class="max-h-60 overflow-y-auto border rounded-md p-2 space-y-2 bg-gray-50">
                    <!-- Los enlaces se añadirán aquí dinámicamente -->
                    <p id="no-links-message" class="text-gray-500 text-center">No hay enlaces añadidos.</p>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancel-links-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="save-links-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Guardar Enlaces</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Confirmar Eliminación</h3>
            <p class="text-slate-600 mb-6">¿Estás seguro de que deseas eliminar este registro?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-danger hover:bg-danger-dark text-white font-bold py-2 px-4 rounded-lg">Eliminar</button>
            </div>
        </div>
    </div>
    
    <div id="replace-historical-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Reemplazar Histórico</h3>
            <p class="text-slate-600 mb-6">¿Desea reemplazar el histórico actual?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-replace-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">No</button>
                <button id="confirm-replace-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Sí</button>
            </div>
        </div>
    </div>
    
    <div id="edit-option-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Editar Opción</h3>
            <input type="text" id="edit-option-input" placeholder="Edite la opción" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-edit-option-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-edit-option-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[55] flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Verificación de Seguridad</h3>
            <p class="text-slate-600 mb-4">Esta acción requiere autenticación. Por favor, ingrese la contraseña.</p>
            <input type="password" id="password-input" placeholder="Contraseña" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-password-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-password-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Verificar</button>
            </div>
        </div>
    </div>

    <div id="webview-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center webview-modal">
        <div class="relative bg-white rounded-lg shadow-xl webview-container">
            <button id="close-webview-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors z-10 bg-white rounded-full p-1">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <iframe id="webview-frame" src="about:blank"></iframe>
        </div>
    </div>

    <div id="import-warning-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Advertencia de Importación</h3>
            <p class="text-slate-600 mb-2">Está a punto de importar un nuevo archivo de histórico.</p>
            <p class="text-slate-600 mb-6">Esta acción <strong class="text-danger">reemplazará todas las noticias existentes</strong> en la pestaña "Histórico", pero <strong class="text-success">NO afectará</strong> los registros de "Conferencia Matutina", "Evento Presidencial" o "Informe de Gobierno".</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-import-warning-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-import-warning-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Continuar</button>
            </div>
        </div>
    </div>

    <div id="migrate-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Migrar Noticias</h3>
            <p class="text-slate-600 mb-6">¿Está seguro de que desea migrar todas las noticias al Histórico? Esta acción no se puede deshacer.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-migrate-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-migrate-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Migrar</button>
            </div>
        </div>
    </div>

    <div id="template-upload-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-primary">Seleccionar Plantilla para Cargar</h3>
                <button id="close-template-upload-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fa-solid fa-times-circle fa-lg"></i>
                </button>
            </div>
            <div class="space-y-4">
                <button data-template-type="medios" class="upload-template-type-btn w-full bg-secondary hover:bg-secondary-dark text-white font-bold py-3 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center justify-center space-x-2">
                    <i class="fa-solid fa-file-word"></i><span>Plantilla de Medios (Default)</span></button>
                <button data-template-type="mananera" class="upload-template-type-btn w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center justify-center space-x-2">
                    <i class="fa-solid fa-file-word"></i><span>Plantilla de Mañanera</span></button>
                <button data-template-type="evento" class="upload-template-type-btn w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center justify-center space-x-2">
                    <i class="fa-solid fa-file-word"></i><span>Plantilla Evento Presidencial</span></button>
                <button data-template-type="informe" class="upload-template-type-btn w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center justify-center space-x-2">
                    <i class="fa-solid fa-file-word"></i><span>Plantilla Informe de Gobierno</span></button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIGURACIÓN DE REPORTES -->
    <div id="report-settings-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-primary">Configuración de Reportes</h3>
                <button id="close-report-settings-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fa-solid fa-times-circle fa-lg"></i>
                </button>
            </div>
            <div class="space-y-6">
                <div>
                    <h4 class="text-md font-semibold text-slate-700 mb-2">Plantillas</h4>
                    <button id="open-template-uploader-btn" class="w-full bg-secondary hover:bg-secondary-dark text-white font-bold py-3 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center justify-center space-x-2">
                        <i class="fa-solid fa-upload"></i><span>Cargar Plantilla Word</span>
                    </button>
                </div>
                <div class="border-t border-gray-200 pt-4">
                    <h4 class="text-md font-semibold text-slate-700 mb-3">Filtro de Fechas para Reportes</h4>
                    <fieldset class="space-y-2">
                        <div class="flex items-center">
                            <input id="date-filter-all" name="date-filter-mode" type="radio" class="focus:ring-primary h-4 w-4 text-primary border-gray-300" value="all" checked>
                            <label for="date-filter-all" class="ml-3 block text-sm font-medium text-gray-700">Todos los datos</label>
                        </div>
                        <div class="flex items-center">
                            <input id="date-filter-period" name="date-filter-mode" type="radio" class="focus:ring-primary h-4 w-4 text-primary border-gray-300" value="period">
                            <label for="date-filter-period" class="ml-3 block text-sm font-medium text-gray-700">Seleccionar periodo</label>
                        </div>
                    </fieldset>
                    <div id="date-range-picker-container" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 opacity-50 transition-opacity">
                        <div>
                            <label for="report-start-date" class="block text-sm font-medium text-gray-700">Fecha de inicio</label>
                            <input type="date" id="report-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2 disabled:bg-gray-100 disabled:cursor-not-allowed" disabled>
                        </div>
                        <div>
                            <label for="report-end-date" class="block text-sm font-medium text-gray-700">Fecha de fin</label>
                            <input type="date" id="report-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2 disabled:bg-gray-100 disabled:cursor-not-allowed" disabled>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end">
                <button id="save-report-settings-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out">
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <div id="view-details-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-details-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <div class="flex items-center space-x-4 mb-6">
                <img src="https://github.com/SAGB-JCM/NoticiasTrenesM-xico/blob/main/Trenes%20de%20M%C3%A9xico%20-%20LOGO.png?raw=true" alt="Logo Tren México" class="h-16 w-auto">
                <h3 class="text-2xl font-bold text-primary">Detalle de la Noticia</h3>
            </div>
            <div class="news-form-container">
                <div id="details-modal-content" class="details-modal-content">
                    <!-- El contenido se generará dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <div id="multi-details-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-multi-details-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <div class="flex items-center space-x-4 mb-6">
                <img src="https://github.com/SAGB-JCM/NoticiasTrenesM-xico/blob/main/Trenes%20de%20M%C3%A9xico%20-%20LOGO.png?raw=true" alt="Logo Tren México" class="h-16 w-auto">
                <h3 class="text-2xl font-bold text-primary">Detalle de Noticias Filtradas</h3>
            </div>
            <div id="multi-details-content-container" class="news-form-container">
                <!-- El contenido se generará dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Contenedor para las Alertas de Noticias (adaptado de Licitaciones) -->
    <div id="notifications-wrapper" class="fixed bottom-4 right-4 w-full max-w-sm z-40 space-y-3"></div>

    <!-- Tooltip para vista rápida en tablas (Elemento Faltante) -->
    <div id="quick-view-tooltip"></div>

    <script>
        // =============================================
        // MÓDULO: Verificación de dependencias
        // =============================================
        
        function checkRequiredLibraries() {
            // Retrocompatibilidad: si PizZip se carga como PizZipUtils, asignarlo.
            if (typeof window.PizZip === 'undefined' && typeof window.PizZipUtils !== 'undefined') {
                window.PizZip = window.PizZipUtils;
            }

            const libraries = {
                'PizZip': typeof window.PizZip,
                'docxtemplater': typeof window.docxtemplater,
                'saveAs': typeof window.saveAs,
                'XLSX': typeof window.XLSX,
                'firebase': typeof firebase,
                'Chart': typeof Chart,
                '$': typeof window.$,
                'select2': typeof $.fn.select2
            };
            
            const missing = Object.entries(libraries)
                .filter(([lib, type]) => type === 'undefined')
                .map(([lib]) => lib);
            
            return missing;
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
                document.head.appendChild(script);
            });
        }

        function loadFallbackLibraries(missingLibs) {
            const fallbacks = {
                'PizZip': 'https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js',
                'docxtemplater': 'https://cdn.jsdelivr.net/npm/docxtemplater@3.34.1/build/docxtemplater.min.js'
            };
            return Promise.all(missingLibs.filter(lib => fallbacks[lib]).map(lib => loadScript(fallbacks[lib])));
        }

        // =============================================
        // MÓDULO: Configuración de Firebase
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDbvGa-79AsyP1KJv78YzKoTSBhF-1iDYU",
            authDomain: "noticiastrenesm-xico.firebaseapp.com",
            projectId: "noticiastrenesm-xico",
            storageBucket: "noticiastrenesm-xico.firebasestorage.app",
            messagingSenderId: "566647349885",
            appId: "1:566647349885:web:1ebf1d30757eadf1494714",
            measurementId: "G-NTHDMJV2EM"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // =============================================
        // MÓDULO: Variables globales y estado de la aplicación
        // =============================================
        let news = [];
        let historicalNews = [];
        let userId;

        // Referencias a colecciones de Firebase
        const newsCollectionRef = db.collection("news");
        const historicalNewsCollectionRef = db.collection("historicalNews");

        // Variables de estado de la aplicación y referencias DOM
        let loader, appContainer, userInfo, tabsContainer, tabContents, addNewsBtn, downloadExcelBtn, newsTableBody, noNewsMessage, historicalTableBody, noHistoricalMessage, historicalFileInput, historicalFileName, importHistoricalBtn, reportesDataSource, dynamicChartCanvas, dynamicChartVariable, toggleLabelsBtn, dynamicTableBody, dynamicTableHeader, dynamicChart, newsModal, newsForm, closeModalBtn, editModal, editForm, closeEditModalBtn, confirmModal, cancelDeleteBtn, confirmDeleteBtn, replaceHistoricalModal, cancelReplaceBtn, confirmReplaceBtn, editOptionModal, editOptionInput, cancelEditOptionBtn, confirmEditOptionBtn, passwordModal, passwordInput, cancelPasswordBtn, confirmPasswordBtn, webviewModal, webviewFrame, closeWebviewBtn, uploadTemplateBtn, viewDetailsModal, closeDetailsModalBtn, detailsModalContent, templateUploadModal, closeTemplateUploadModalBtn, addConferenceBtn, conferenceModal, conferenceForm, closeConferenceModalBtn, editConferenceModal, editConferenceForm, closeEditConferenceModalBtn, multiLinkModal, newLinkInput, addLinkBtn, linkListContainer, noLinksMessage, cancelLinksBtn, saveLinksBtn, multiDetailsModal, closeMultiDetailsModalBtn, multiDetailsContentContainer;
        let importWarningModal, cancelImportWarningBtn, confirmImportWarningBtn;
        let quickViewTooltip, projectCategoryChart;
        let reportSettingsModal, closeReportSettingsModalBtn, openTemplateUploaderBtn, reportSettingsBtn;
        let currentEditIsHistorical = false;
        
        let newsSummaryEditor, editNewsSummaryEditor;
        // Objeto para almacenar la configuración de los reportes
        let reportSettings = {
            dateFilterMode: 'all', // 'all' o 'period'
            startDate: '',
            endDate: '',
            dataSource: 'historico' // Valor por defecto
        };
        let fieldOptions = {
            proyectos: [],
            categorias: [],
            medios: [],
            subproyectos: []
        };

        let currentEditingField = null;
        let currentEditingValue = null;
        let pendingAction = null;
        let showChartLabels = true;
        let activeFilters = {
            main: {},
            historical: {}
        }; 
        let charts = {
            dynamic: null,
            projectCategory: null
        };

        let currentFilterDropdown = null;
        let activeSelectElement = null;
        let openModalCount = 0; // Contador para modales anidados
        let activeNewsMedioFilter = null; // Para el filtro del radar de medios en la pestaña de Noticias (main)
        let activeMedioDashboardFilter = null; // Para el filtro del radar de medios
        let currentLinkTargetInput = null; // Para saber a qué campo de texto actualizar
        let isProjectChartStacked = false; // Estado para controlar si la gráfica de proyectos es apilada
        let isTotalNewsChartPie = true; // Estado para controlar si la gráfica de totales es de pastel (por defecto)

        // Estado para la funcionalidad de migración
        let isMigrationModeActive = false;
        let selectedNewsIdsToMigrate = new Set();
        let isReverseMigrationModeActive = false;

        // Variable de estado para las notificaciones
        let weeklyAlertsShown = false;
        let selectedHistoricalNewsIdsToMigrate = new Set();

        // =============================================
        // MÓDULO: Utilidades
        // =============================================
        
        function showApp() {
            loader.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.createElement('div');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-gray-500' };
            alertContainer.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white transform transition-all duration-300 z-[60] ${colors[type]}`;
            alertContainer.textContent = message;
            document.body.appendChild(alertContainer);
            setTimeout(() => { alertContainer.remove(); }, 3000);
        }

        //Función para resaltar texto
        function highlightText(text, searchTerm) {
            if (!searchTerm || searchTerm.trim() === '' || typeof text !== 'string') {
                return text;
            }
            // Escapar caracteres especiales en el término de búsqueda para la expresión regular
            const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
            return text.replace(regex, `<span class="highlight">$1</span>`);
        }

        /**
         * Resalta el término de búsqueda dentro de un contenido HTML de forma segura.
         * Recorre los nodos de texto y envuelve las coincidencias sin romper las etiquetas HTML.
         * @param {string} htmlContent - El contenido HTML a procesar.
         * @param {string} searchTerm - El término de búsqueda.
         * @returns {string} - El HTML con el texto resaltado.
         */
        function highlightHtmlContent(htmlContent, searchTerm) {
            if (!searchTerm || !htmlContent) {
                return htmlContent;
            }

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;

            const walker = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const nodesToProcess = [];

            while (node = walker.nextNode()) {
                nodesToProcess.push(node);
            }

            nodesToProcess.forEach(textNode => {
                const parent = textNode.parentNode;
                if (parent && parent.nodeName !== 'SCRIPT' && parent.nodeName !== 'STYLE') {
                    const highlightedHtml = highlightText(textNode.textContent, searchTerm);
                    if (highlightedHtml !== textNode.textContent) {
                        const fragment = document.createRange().createContextualFragment(highlightedHtml);
                        parent.replaceChild(fragment, textNode);
                    }
                }
            });

            return tempDiv.innerHTML;
        }

        function openModal(modal) {
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
            if (openModalCount === 0) {
                document.body.classList.add('modal-open'); // Bloquear scroll solo si es el primer modal
            }
            openModalCount++;
        }

        function closeModal(modal) {
            modal.classList.remove('modal-enter');
            modal.classList.add('modal-leave');
            setTimeout(() => {
                modal.classList.add('hidden');
                openModalCount--;
                if (openModalCount <= 0) {
                    document.body.classList.remove('modal-open'); // Restaurar scroll solo si no quedan modales abiertos
                    openModalCount = 0; // Resetear por seguridad
                }
            }, 300);
        }

        function openModalWithFocus(modal, elementToFocus) {
            openModal(modal);
            setTimeout(() => elementToFocus.focus(), 150); // Pequeño delay para la animación
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                // Tratar la fecha como UTC para evitar problemas de zona horaria.
                // new Date('2024-01-15') se interpreta como UTC midnight.
                const [year, month, day] = dateString.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                return date.toLocaleDateString('es-ES', { timeZone: 'UTC' });
            } catch (e) {
                return dateString;
            }
        }

        function truncateText(text, maxLength = 50) {
            if (!text) return 'N/A';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function htmlToPlainText(html) {
            if (!html) return '';
            
            // Crear un div temporal para no afectar el DOM principal
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // Reemplazar <br> con saltos de línea
            tempDiv.querySelectorAll('br').forEach(br => br.parentNode.replaceChild(document.createTextNode('\n'), br));

            // Añadir saltos de línea después de los bloques de elementos
            tempDiv.querySelectorAll('p, div, li, h1, h2, h3, h4, h5, h6').forEach(block => {
                block.appendChild(document.createTextNode('\n'));
            });

            // Obtener el texto, que ahora incluye los saltos de línea
            // .trim() al final para eliminar cualquier salto de línea extra al inicio o al final.
            return tempDiv.textContent.trim() || "";
        }

        function isHtml(str) {
            if (typeof str !== 'string') return false;
            // Una expresión regular simple para detectar la presencia de etiquetas HTML.
            const htmlRegex = /<[a-z][\s\S]*>/i;
            return htmlRegex.test(str);
        }

        function formatLongDate(dateString) {
            if (!dateString) return 'Fecha no disponible';
            try {
                const [year, month, day] = dateString.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    timeZone: 'UTC'
                };
                return new Intl.DateTimeFormat('es-ES', options).format(date);
            } catch (e) { return dateString; }
        }

        function getMonthName(dateString) {
            if (!dateString) return 'Mes no disponible';
            try {
                const [year, month, day] = dateString.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                
                const monthName = new Intl.DateTimeFormat('es-ES', { 
                    month: 'long',
                    timeZone: 'UTC'
                }).format(date);

                // Capitalizar la primera letra
                return monthName.charAt(0).toUpperCase() + monthName.slice(1);
            } catch (e) { return 'Error de mes'; }
        }

        function base64ToArrayBuffer(base64) {
            // Primero, removemos el prefijo "data:application/..." si existe
            const base64Data = base64.substring(base64.indexOf(',') + 1);
            const binary_string = window.atob(base64Data);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function sanitizePastedHtml(html) {
            if (!html) return '';

            // Crear un div temporal para manipular el DOM
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            tempDiv.querySelectorAll('table').forEach(table => {
                // Limpiar cualquier clase preexistente para evitar conflictos de ancho
                table.removeAttribute('class');
                
                // Envolver la tabla en un div para overflow y estilos
                const wrapper = document.createElement('div');
                wrapper.className = 'details-table-container';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });

            // 2. Limpieza de estilos y atributos, conservando viñetas originales de Word.
            // La estrategia es mantener los párrafos <p> y los spans de viñeta, pero limpiando sus estilos.
            tempDiv.querySelectorAll('p[style*="mso-list:"]').forEach(p => {
                // Al párrafo que es un item de lista, le decimos que no muestre su propia viñeta.
                // La viñeta real está como texto dentro de un <span>.
                p.style.display = 'list-item';
                p.style.listStyleType = 'none';
            });

            // Reemplazar viñetas específicas para mejorar la estética
            tempDiv.querySelectorAll('span').forEach(span => {
                if (span.textContent.includes('§')) {
                    span.textContent = span.textContent.replace(/§/g, '-');
                }
                if (span.textContent.includes('·')) {
                    span.textContent = span.textContent.replace(/·/g, '•');
                }
            });

            tempDiv.querySelectorAll('*').forEach(el => {
                if (el.style && el.style.length > 0) {
                    const isTableCell = el.tagName === 'TD' || el.tagName === 'TH';
                    let preservedStyles = {};

                    // Conservar estilos de borde y fondo para celdas de tabla
                    if (isTableCell) {
                        // Forzar la altura automática y un tamaño de fuente más pequeño para las celdas.
                        el.style.height = 'auto';
                        el.style.fontSize = '0.8em';

                        // Añadimos height y fontSize a la lista de estilos a conservar.
                        const stylesToKeep = ['backgroundColor', 'border', 'borderColor', 'borderWidth', 'borderStyle', 'height', 'fontSize'];
                        stylesToKeep.forEach(styleProp => {
                            // el.style.height = null; // Asegurar que la altura sea automática
                            if (el.style[styleProp]) {
                                preservedStyles[styleProp] = el.style[styleProp];
                            }
                        });
                    }

                    // Conservar solo estilos de indentación (margin-left, text-indent)
                    const indent = el.style.marginLeft;
                    const textIndent = el.style.textIndent;

                    // Limpiar todos los estilos en línea
                    el.removeAttribute('style');

                    if (indent) el.style.marginLeft = indent;
                    if (textIndent) el.style.textIndent = textIndent;
                    Object.assign(el.style, preservedStyles);
                }

                // Eliminar atributos específicos de Word y otros no deseados
                const attrsToRemove = ['class', 'id', 'lang', 'dir', 'valign', 'height', 'border', 'cellspacing', 'cellpadding'];
                attrsToRemove.forEach(attr => el.removeAttribute(attr));

                // Eliminar todos los atributos que empiecen con 'mso-' o 'o:'
                for (let i = el.attributes.length - 1; i >= 0; i--) {
                    const attr = el.attributes[i];
                    if (attr.name.startsWith('mso-') || attr.name.startsWith('o:')) {
                        el.removeAttribute(attr.name);
                    }
                }
            });

            return tempDiv.innerHTML;
        }

        /**
         * Actualiza el dashboard de medios basándose en los datos del histórico.
         */
        function updateMediosDashboard() {
            const specialMedios = ["Conferencia de prensa matutina", "Evento Presidencial", "Informe de Gobierno"];
            const counts = {
                noticias: 0,
                mananera: 0,
                evento: 0,
                informe: 0
            };

            historicalNews.forEach(newsItem => {
                if (newsItem.medio === specialMedios[0]) counts.mananera++;
                else if (newsItem.medio === specialMedios[1]) counts.evento++;
                else if (newsItem.medio === specialMedios[2]) counts.informe++;
                else {
                    // Si no es ninguno de los medios especiales, es una "noticia"
                    counts.noticias++;
                }
            });

            document.getElementById('historical-medio-count-total').textContent = counts.noticias;
            document.getElementById('historical-medio-count-mananera').textContent = counts.mananera;
            document.getElementById('historical-medio-count-evento').textContent = counts.evento;
            document.getElementById('historical-medio-count-informe').textContent = counts.informe;
        }

        /**
         * Actualiza el dashboard de medios basándose en los datos de Noticias.
         */
        function updateNewsMediosDashboard() {
            const specialMedios = ["Conferencia de prensa matutina", "Evento Presidencial", "Informe de Gobierno"];
            const counts = {
                noticias: 0,
                mananera: 0,
                evento: 0,
                informe: 0
            };

            news.forEach(newsItem => {
                if (newsItem.medio === specialMedios[0]) counts.mananera++;
                else if (newsItem.medio === specialMedios[1]) counts.evento++;
                else if (newsItem.medio === specialMedios[2]) counts.informe++;
                else {
                    counts.noticias++;
                }
            });

            const totalElement = document.getElementById('news-medio-count-total');
            const mananeraElement = document.getElementById('news-medio-count-mananera');
            const eventoElement = document.getElementById('news-medio-count-evento');
            const informeElement = document.getElementById('news-medio-count-informe');

            if (totalElement) totalElement.textContent = counts.noticias;
            if (mananeraElement) mananeraElement.textContent = counts.mananera;
            if (eventoElement) eventoElement.textContent = counts.evento;
            if (informeElement) informeElement.textContent = counts.informe;
        }

        function escapeXml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[<>&'"]/g, c => ({
                '<': '&lt;',
                '>': '&gt;',
                '&': '&amp;',
                '\'': '&apos;',
                '"': '&quot;'
            }[c]));
        }

        function htmlToOpenXml(html) {
            if (!html) return '';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            let resultXml = '';

            // --- INICIO: Funciones de ayuda ---
            const utils = {
                cssToTwips(value) {
                    if (typeof value !== 'string') return 0;
                    const val = parseFloat(value);
                    if (isNaN(val)) return 0;
                    if (value.endsWith('pt')) return Math.round(val * 20);
                    if (value.endsWith('px')) return Math.round(val * 15);
                    if (value.endsWith('in')) return Math.round(val * 1440);
                    if (value.endsWith('cm')) return Math.round(val * 567);
                    return Math.round(val * 15);
                },
                rgbToHex(rgb) {
                    if (!rgb || !rgb.includes('rgb')) return null;
                    const match = rgb.match(/(\d+),\s*(\d+),\s*(\d+)/);
                    if (!match) return null;
                    return [1, 2, 3].map(i => parseInt(match[i], 10).toString(16).padStart(2, '0')).join('').toUpperCase();
                }
            };
            // --- FIN: Funciones de ayuda ---

            // --- INICIO: Funciones de ayuda para la lógica de espaciado ---
            const isParagraph = (node) => node && node.nodeName === 'P';
            const isListItemNode = (node) => {
                if (!isParagraph(node)) return false;
                // Reutiliza la lógica de detección de viñetas de la versión anterior
                const marginLeft = node.style.marginLeft || '';
                const firstChild = node.firstElementChild;
                if (marginLeft && firstChild && firstChild.tagName === 'SPAN') {
                    const bulletText = firstChild.textContent.trim();
                    return bulletText.match(/^[•o–§·-]$/);
                }
                return false;
            };
            const getNextMeaningfulSibling = (node) => {
                let next = node.nextSibling;
                while (next && (next.nodeType === 3 && next.textContent.trim() === '')) { next = next.nextSibling; }
                return next;
            };
            // --- FIN: Funciones de ayuda para la lógica de espaciado ---

            function processNode(node, options = {}) {
                let xml = '';
                if (node.nodeType === 3 && node.textContent.trim() === '') return '';

                switch (node.nodeName) {
                    case '#text':
                        const rPrText = options.inTable ? '<w:rPr><w:sz w:val="18"/><w:szCs w:val="18"/></w:rPr>' : '<w:rPr/>';
                        xml += `<w:r>${rPrText}<w:t xml:space="preserve">${escapeXml(node.textContent)}</w:t></w:r>`;
                        break;
                    case 'P':
                        const marginLeft = node.style.marginLeft || '';
                        const nextSibling = getNextMeaningfulSibling(node);
                        const firstChild = node.firstElementChild;
                        let isListItem = false;
                        let listLevel = 0;

                        // Condición final y definitiva: requiere la estructura completa para ser una viñeta.
                        if (marginLeft && firstChild && firstChild.tagName === 'SPAN') {
                            const bulletText = firstChild.textContent.trim();
                            const bulletToLevelMap = { '•': 0, 'o': 1, '–': 2, '·': 0, '§': 2, '-': 2 }; // Mapa de precisión

                            // Solo si el span contiene un caracter de viñeta, procedemos.
                            if (bulletText.match(/^[•o–§·-]$/)) {
                                const indentValue = parseFloat(marginLeft);
                                if (indentValue > 0) {
                                    isListItem = true;
                                    // Prioridad 1: Usar el mapa de caracteres para máxima precisión.
                                    if (bulletToLevelMap.hasOwnProperty(bulletText)) {
                                        listLevel = bulletToLevelMap[bulletText];
                                    } else {
                                        // Prioridad 2 (Fallback): Calcular por sangría si el caracter es desconocido.
                                        listLevel = Math.max(0, Math.round(indentValue / 36) - 1);
                                    }
                                }
                            }
                        }

                        let pPrContent = '';

                        // Lógica de espaciado inteligente
                        const currentIsListItem = isListItemNode(node);
                        const nextIsListItem = isListItemNode(nextSibling);
                        const addSpacing = !options.inTable && (!currentIsListItem || !nextIsListItem);
                        const spacingXml = addSpacing ? '<w:spacing w:after="200"/>' : '';


                        if (isListItem) {
                            // Eliminar el span de la viñeta para que no se duplique en el DOCX.
                            firstChild.remove();

                            // Generar el XML para una viñeta real de Word.
                            pPrContent = `
                                <w:pStyle w:val="ListParagraph"/>
                                <w:numPr>
                                    <w:ilvl w:val="${listLevel}"/>
                                    <w:numId w:val="1"/>
                                </w:numPr>
                                <w:jc w:val="both"/>
                                ${spacingXml}`;
                        } else {
                            // Es un párrafo normal, solo justificamos
                            pPrContent = `<w:jc w:val="both"/>${spacingXml}`;
                        }

                        xml += `<w:p><w:pPr>${pPrContent}</w:pPr>`;
                        node.childNodes.forEach(child => xml += processNode(child, options));
                        xml += '</w:p>';
                        break;
                    case 'STRONG':
                    case 'B':
                        const rPrBold = options.inTable ? '<w:b/><w:sz w:val="18"/><w:szCs w:val="18"/>' : '<w:b/>';
                        xml += `<w:r><w:rPr>${rPrBold}</w:rPr><w:t xml:space="preserve">${escapeXml(node.textContent)}</w:t></w:r>`;
                        break;
                    case 'EM':
                    case 'I':
                        const rPrItalic = options.inTable ? '<w:i/><w:sz w:val="18"/><w:szCs w:val="18"/>' : '<w:i/>';
                        xml += `<w:r><w:rPr>${rPrItalic}</w:rPr><w:t xml:space="preserve">${escapeXml(node.textContent)}</w:t></w:r>`;
                        break;
                    case 'U':
                        const rPrUnderline = options.inTable ? '<w:u w:val="single"/><w:sz w:val="18"/><w:szCs w:val="18"/>' : '<w:u w:val="single"/>';
                        xml += `<w:r><w:rPr>${rPrUnderline}</w:rPr><w:t xml:space="preserve">${escapeXml(node.textContent)}</w:t></w:r>`;
                        break;
                    case 'UL':
                    case 'OL':
                        Array.from(node.children).forEach(li => {
                            if (li.nodeName === 'LI') {
                                const pPrList = `
                                    <w:pPr>
                                        <w:pStyle w:val="ListParagraph"/>
                                        <w:numPr><w:ilvl w:val="0"/><w:numId w:val="1"/></w:numPr>
                                        <w:ind w:left="360" w:hanging="360"/>
                                    </w:pPr>`;
                                xml += `<w:p>${pPrList}`;
                                li.childNodes.forEach(child => xml += processNode(child, options));
                                xml += '</w:p>';
                            }
                        });
                        break;
                    case 'BR':
                        xml += '<w:r><w:br/></w:r>';
                        break;
                    case 'A':
                        const href = node.getAttribute('href') || '';
                        const linkText = node.textContent || href;
                        const rPrLink = options.inTable ? '<w:rStyle w:val="Hyperlink"/><w:sz w:val="18"/><w:szCs w:val="18"/>' : '<w:rStyle w:val="Hyperlink"/>';
                        xml += `<w:r><w:rPr>${rPrLink}</w:rPr><w:t xml:space="preserve">${escapeXml(linkText)}</w:t></w:r>`;
                        break;

                    case 'TABLE':
                        const tblPr = `
                            <w:tblPr>
                                <w:tblStyle w:val="TableGrid"/>
                                <w:tblW w:w="0" w:type="autofit"/>
                                <w:jc w:val="center"/>
                                <w:tblBorders>
                                    <w:top w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                                    <w:left w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                                    <w:bottom w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                                    <w:right w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                                    <w:insideH w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                                    <w:insideV w:val="single" w:sz="4" w:space="0" w:color="auto"/>
                                </w:tblBorders>
                                <w:tblLayout w:type="fixed"/>
                                <w:tblLook w:val="04A0" w:firstRow="1" w:lastRow="0" w:firstColumn="1" w:lastColumn="0" w:noHBand="0" w:noVBand="1"/>
                            </w:tblPr>`;
                        const cols = Array.from(node.querySelectorAll('tr'))[0]?.children.length || 1;
                        const tblGrid = `<w:tblGrid>${'<w:gridCol/>'.repeat(cols)}</w:tblGrid>`;
                        xml += `<w:tbl>${tblPr}${tblGrid}`;
                        
                        const rows = Array.from(node.querySelectorAll('tr'));
                        const rowSpanTracker = {};

                        rows.forEach((tr, rowIndex) => {
                            xml += '<w:tr><w:trPr><w:trHeight w:hRule="auto"/></w:trPr>';
                            let colIndex = 0;
                            Array.from(tr.children).forEach(td => {
                                while (rowSpanTracker[colIndex]) {
                                    xml += '<w:tc><w:tcPr><w:vMerge/></w:tcPr><w:p/></w:tc>';
                                    rowSpanTracker[colIndex]--;
                                    colIndex++;
                                }
                                xml += processNode(td, { inTable: true });
                                const colspan = parseInt(td.getAttribute('colspan'), 10) || 1;
                                const rowspan = parseInt(td.getAttribute('rowspan'), 10) || 1;
                                if (rowspan > 1) {
                                    for (let i = 0; i < colspan; i++) {
                                        rowSpanTracker[colIndex + i] = rowspan - 1;
                                    }
                                }
                                colIndex += colspan;
                            });
                            while (colIndex < cols) {
                                if (rowSpanTracker[colIndex]) {
                                    xml += '<w:tc><w:tcPr><w:vMerge/></w:tcPr><w:p/></w:tc>';
                                    rowSpanTracker[colIndex]--;
                                }
                                colIndex++;
                            }
                            xml += '</w:tr>';
                        });
                        xml += '</w:tbl>';
                        break;

                    case 'TR': // Handled inside TABLE case
                        break;

                    case 'TH':
                    case 'TD':
                        const bgColor = node.style.backgroundColor;
                        const hexColor = utils.rgbToHex(bgColor);
                        const shading = hexColor ? `<w:shd w:val="clear" w:color="auto" w:fill="${hexColor}"/>` : '';
                        const colspanVal = node.getAttribute('colspan');
                        const gridSpan = colspanVal ? `<w:gridSpan w:val="${colspanVal}"/>` : '';
                        const rowspanVal = node.getAttribute('rowspan');
                        const vMerge = rowspanVal ? '<w:vMerge w:val="restart"/>' : '';

                        let tcPr = `
                            <w:tcPr>
                                <w:tcW w:w="0" w:type="auto"/>
                                <w:vAlign w:val="center"/>
                                ${gridSpan}
                                ${vMerge}
                                ${shading}
                            </w:tcPr>`;

                        xml += `<w:tc>${tcPr}`;
                        
                        // Si la celda está vacía, Word necesita un párrafo vacío para renderizar bordes.
                        if (node.innerHTML.trim() === '') {
                            xml += '<w:p/>';
                        } else {
                            // Procesar el contenido de la celda de forma recursiva.
                            // Si el contenido no está en un <p>, lo envolvemos en uno.
                            const hasP = Array.from(node.childNodes).some(n => n.nodeName === 'P');
                            if (!hasP) {
                                xml += '<w:p>';
                                node.childNodes.forEach(child => xml += processNode(child, options));
                                xml += '</w:p>';
                            } else {
                                node.childNodes.forEach(child => xml += processNode(child, options));
                            }
                        }
                        xml += '</w:tc>';
                        break;

                    case 'DIV':
                    case 'SPAN':
                        node.childNodes.forEach(child => xml += processNode(child, options));
                        break;
                    default:
                        // Para nodos no reconocidos, procesa sus hijos para no perder texto.
                        if (node.childNodes) {
                            node.childNodes.forEach(child => xml += processNode(child, options));
                        }
                        break;
                }
                return xml;
            }

            tempDiv.childNodes.forEach(node => {
                resultXml += processNode(node);
            });

            return resultXml;
        }

        /**
         * Limpia todos los filtros aplicados a la tabla de noticias principal.
         * Esto incluye el buscador, los filtros de columna y el filtro del radar de medios.
         */
        function clearAllMainFilters() {
            // 1. Limpiar filtro del radar de medios
            activeNewsMedioFilter = null;
            document.querySelectorAll('#news-dashboard-medios .indicator-card').forEach(card => card.classList.remove('active-filter'));

            // 2. Limpiar filtros de columna
            activeFilters.main = {};
            document.querySelectorAll('#main-table-header .filterable-header.active').forEach(header => {
                header.classList.remove('active');
            });

            // 3. Limpiar el campo de búsqueda
            const searchInput = document.getElementById('filter-input-main');
            if (searchInput) {
                searchInput.value = '';
                searchInput.dispatchEvent(new Event('input')); // Dispara el evento para que la UI reaccione
            }

            // 4. Re-renderizar la tabla para mostrar todos los datos
            sortAndRenderTable(newsTableBody, news, false);
            showAlert("Filtros de Noticias limpiados.", "info");
        }

        /**
         * Limpia todos los filtros aplicados a la tabla de noticias históricas.
         * Esto incluye el buscador, los filtros de columna y el filtro del radar de medios.
         */
        function clearAllHistoricalFilters() {
            // 1. Limpiar filtro del radar de medios
            activeMedioDashboardFilter = null; // Asegúrate de que esta variable controla el filtro del radar histórico
            document.querySelectorAll('#tab-content-historico #dashboard-medios .indicator-card').forEach(card => card.classList.remove('active-filter'));

            // 2. Limpiar filtros de columna
            activeFilters.historical = {};
            document.querySelectorAll('#historical-table-header .filterable-header.active').forEach(header => header.classList.remove('active'));

            // 3. Limpiar el campo de búsqueda
            const searchInput = document.getElementById('filter-input-historical');
            if (searchInput) { searchInput.value = ''; searchInput.dispatchEvent(new Event('input')); }

            // 4. Re-renderizar la tabla para mostrar todos los datos
            sortAndRenderTable(historicalTableBody, historicalNews, true);
        }

        function plainTextToOpenXml(text) {
            if (!text) return '';
            const lines = text.split('\n');
            return lines.map(line => {
                // Envuelve cada línea en un párrafo de Word.
                // xml:space="preserve" es crucial para mantener los espacios/sangrías al inicio.
                const textRun = `<w:r><w:t xml:space="preserve">${escapeXml(line)}</w:t></w:r>`;
                return `<w:p><w:pPr><w:jc w:val="both"/></w:pPr>${textRun}</w:p>`;
            }).join('');
        }

        function setupTabs() {
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    const tabName = e.target.dataset.tab;

                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');

                    tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `tab-content-${tabName}`));
                    if (tabName === 'reportes') {
                        setTimeout(updateCharts, 50); // Delay para asegurar que el contenedor es visible
                    } else if (tabName === 'historico') {
                        setTimeout(updateMediosDashboard, 50); // Actualizar el radar al cambiar a la pestaña
                    }
                }
            });
        }


        async function processFile(fileInput) {
            const file = fileInput.files[0];

            return new Promise((resolve, reject) => {
                if (file) {
                    const reader = new FileReader();

                    reader.onload = (event) => {
                        resolve(event.target.result.split(',')[1]);
                    };
                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(file);
                } else {
                    resolve(null);
                }
            });
        }
        // =============================================
        // MÓDULO: Interfaz de usuario
        // =============================================
        
        function handleTableClick(event) {
            const target = event.target; // El elemento exacto donde se hizo clic (ej. el <i>)
        
            // Usamos .closest() para encontrar el botón o enlace interactivo más cercano
            const editButton = target.closest('.edit-btn');
            if (editButton) {
                handleEditClick(editButton); // Tu función existente
                return; // Salimos para no procesar otros clics
            }
        
            const deleteButton = target.closest('.delete-btn');
            if (deleteButton) {
                handleDeleteClick(deleteButton); // Tu función existente
                return;
            }
        
            const docButton = target.closest('.generate-doc-btn');
            if (docButton) {
                handleGenerateDocClick(docButton); // Tu función existente
                return;
            }
        
            const linkCell = target.closest('.link-cell');
            if (linkCell) {
                const url = linkCell.getAttribute('data-url');
                if (url && isValidUrl(url)) {
                    openWebviewModal(url); // Tu función existente
                }
                return;
            }
        }
        
        function renderTable(tableBody, data, isHistorical = false) {
            const noDataMessage = isHistorical ? document.getElementById('no-historical-message') : document.getElementById('no-news-message');

            // Crear un DocumentFragment para la inserción masiva
            const fragment = document.createDocumentFragment();
 
            const isMainMigrationActive = !isHistorical && isMigrationModeActive;
            const isReverseMigrationActive = isHistorical && isReverseMigrationModeActive;

            const filterKey = isHistorical ? 'historical' : 'main';
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.trim() : '';

            const linkSeparator = ';';

            data.forEach((newsItem, index) => { // Corregido: `news` a `data`
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';

                // CORRECCIÓN: Añadir atributos data-* para el tooltip de vista rápida en el lugar correcto.
                row.dataset.quickview = 'true';
                row.dataset.proyecto = newsItem.proyecto || 'N/A';
                row.dataset.subproyecto = newsItem.subproyecto || 'N/A';
                row.dataset.categoria = newsItem.categoria || 'N/A';
                row.dataset.noticia = newsItem.comentario || 'N/A';
                row.dataset.medio = newsItem.medio || 'N/A';
                row.dataset.cita = newsItem.cita || ''; // Añadir la cita
                row.dataset.fecha = newsItem.fecha || 'N/A'; // Guardar la fecha en formato YYYY-MM-DD

                let migrationCell = '';
                if (isMainMigrationActive) {
                    const isSelected = selectedNewsIdsToMigrate.has(newsItem.id);
                    migrationCell = `<td class="py-4 px-6"><input type="checkbox" class="news-migration-checkbox rounded border-gray-300 text-primary focus:ring-primary" data-id="${newsItem.id}" ${isSelected ? 'checked' : ''}></td>`;
                }

                let reverseMigrationCell = '';
                if (isReverseMigrationActive) {
                    const isSelected = selectedHistoricalNewsIdsToMigrate.has(newsItem.id);
                    reverseMigrationCell = `<td class="py-4 px-6"><input type="checkbox" class="historical-news-migration-checkbox rounded border-gray-300 text-primary focus:ring-primary" data-id="${newsItem.id}" ${isSelected ? 'checked' : ''}></td>`;
                }

                const links = (newsItem.fuente || '').split(linkSeparator).map(link => link.trim()).filter(link => link);
                let linkCellContent = `<span class="text-slate-400" title="No hay enlace válido"><i class="fa-solid fa-link-slash"></i></span>`;

                if (links.length > 0) {
                    linkCellContent = links.map(link => 
                        isValidUrl(link) 
                            ? `<span class="link-cell text-blue-600 hover:underline cursor-pointer" data-url="${link}" title="${link}"><i class="fa-solid fa-link"></i></span>`
                            : ''
                    ).join('<span class="mx-1"></span>'); // Añade un pequeño espacio entre iconos
                }

                const applyHighlight = (text) => highlightText(String(text), searchText);
                
                let rowContent = `
                    <td class="py-4 px-6 whitespace-nowrap">${applyHighlight(index + 1)}</td>
                    <td class="py-4 px-6 whitespace-nowrap">${applyHighlight(formatDate(newsItem.fecha))}</td>
                    <td class="py-4 px-6 whitespace-nowrap">${applyHighlight(truncateText(newsItem.proyecto, 30))}</td>
                    <td class="py-4 px-6 whitespace-nowrap">${applyHighlight(truncateText(newsItem.subproyecto, 30))}</td>
                    <td class="py-4 px-6 whitespace-nowrap">${applyHighlight(truncateText(newsItem.categoria, 30))}</td>
                    <td class="py-4 px-6">${applyHighlight(truncateText(newsItem.comentario, 40))}</td>
                    <td class="py-4 px-6">${applyHighlight(truncateText(newsItem.cita, 40))}</td>                    
                    <td class="py-4 px-6">${applyHighlight(truncateText(htmlToPlainText(newsItem.resumen), 40))}</td>
                    <td class="py-4 px-6 whitespace-nowrap">${applyHighlight(truncateText(newsItem.medio, 30))}</td>
                    <td class="py-4 px-6 text-center">${linkCellContent}</td>
                    <td class="py-4 px-6 flex space-x-2">
                        <button data-id="${newsItem.id}" data-is-historical="${isHistorical}" class="generate-doc-btn text-blue-600 hover:text-blue-800" title="Generar Reporte Individual">
                            <i class="fa-solid fa-file-word"></i>
                        </button>
                        <button data-id="${newsItem.id}" data-is-historical="${isHistorical}" class="edit-btn text-blue-500 hover:text-blue-700">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                        <button data-id="${newsItem.id}" data-is-historical="${isHistorical}" class="delete-btn text-red-500 hover:text-red-700">
                            <i class="fa-solid fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                row.innerHTML = migrationCell + reverseMigrationCell + rowContent;

                fragment.appendChild(row); // Anexar la fila al fragmento en lugar de al DOM directamente
            });

            // 1. Limpiar el tbody justo antes de la inserción.
            tableBody.innerHTML = '';
            // 2. Realizar la única manipulación del DOM para insertar todas las filas.
            tableBody.appendChild(fragment);
            // 3. Actualizar el mensaje de "no hay datos" después de la inserción.
            noDataMessage.classList.toggle('hidden', data.length > 0);

        }

        /**
         * Obtiene el valor normalizado de un campo para ser usado en los filtros.
         * Asegura que el tratamiento de valores nulos/vacíos sea consistente.
         * @param {object} item - El objeto de datos (la fila).
         * @param {string} columnKey - La clave de la columna (ej. 'fecha', 'cita').
         * @returns {string} - El valor normalizado para el filtro.
         */
        function getFilterableValue(item, columnKey) {
            if (columnKey === 'fecha') return formatDate(item[columnKey]);
            const value = item[columnKey];
            return (value === null || value === undefined || String(value).trim() === '') ? 'N/A' : String(value).trim();
        }

        function applyAllFilters(data, filterKey) {
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';
            const columnFilters = activeFilters[filterKey];

            return (data || []).filter(item => {
                // AÑADE ESTE BLOQUE AL INICIO DE LA FUNCIÓN DE FILTRADO
                if (filterKey === 'main' && activeNewsMedioFilter) {
                    const specialMedios = ["Conferencia de prensa matutina", "Evento Presidencial", "Informe de Gobierno"];
                    if (activeNewsMedioFilter === '__NOTICIAS_ONLY__') {
                        if (specialMedios.includes(item.medio)) return false;
                    } else if (item.medio !== activeNewsMedioFilter) {
                        return false;
                    }
                }

                // 0. Check medio dashboard filter (only for historical table)
                if (filterKey === 'historical' && activeMedioDashboardFilter) {                    
                    const specialMedios = ["Conferencia de prensa matutina", "Evento Presidencial", "Informe de Gobierno"];
                    if (activeMedioDashboardFilter === '__NOTICIAS_ONLY__') {
                        // Si el filtro es para "Solo Noticias", el medio NO debe ser uno de los especiales.
                        if (specialMedios.includes(item.medio)) return false;
                    } else if (item.medio !== activeMedioDashboardFilter) {
                        return false;
                    }
                }
                // 1. Check search box filter
                const matchesSearch = searchText === '' || Object.values(item).some(value => 
                    String(value).toLowerCase().includes(searchText)
                );
                if (!matchesSearch) return false;

                // 2. Check column filters
                for (const col in columnFilters) {
                    if (columnFilters[col].length > 0) {
                        const filterableValue = getFilterableValue(item, col);
                        if (!columnFilters[col].includes(filterableValue)) {
                            return false;
                        }
                    }
                }
                return true;
            });
        }

        /**
         * Obtiene los datos pre-filtrados por todas las columnas excepto la especificada.
         * Esto es crucial para que los dropdowns de filtro muestren solo opciones relevantes.
         * @param {function} dataProvider - Función que devuelve el conjunto de datos completo.
         * @param {string} filterKey - 'main' o 'historical'.
         * @param {string} excludeColumn - La clave de la columna a excluir del filtrado.
         * @returns {Array} - Los datos filtrados.
         */
        function getPreFilteredData(dataProvider, filterKey, excludeColumn) {
            const allData = dataProvider() || [];
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';
            const columnFilters = activeFilters[filterKey];

            return allData.filter(item => {
                // Primero, aplicar el filtro del dashboard si está activo
                if (filterKey === 'historical' && activeMedioDashboardFilter) {                    
                    const specialMedios = ["Conferencia de prensa matutina", "Evento Presidencial", "Informe de Gobierno"];
                    if (activeMedioDashboardFilter === '__NOTICIAS_ONLY__') {
                        // Si el filtro es para "Solo Noticias", el medio NO debe ser uno de los especiales.
                        if (specialMedios.includes(item.medio)) return false;
                    } else if (item.medio !== activeMedioDashboardFilter) {
                        return false;
                    }
                }

                const matchesSearch = searchText === '' || Object.values(item).some(value => String(value).toLowerCase().includes(searchText));
                if (!matchesSearch) return false;

                return Object.entries(columnFilters).every(([col, values]) => {
                    if (col === excludeColumn || values.length === 0) return true;
                    return values.includes(getFilterableValue(item, col));
                });
            });
        }

        function setupColumnFilters(headerId, dataProvider, renderFunc, filterKey) {
            const headerRow = document.getElementById(headerId);
            headerRow.addEventListener('click', e => {
                const header = e.target.closest('.filterable-header');
                if (!header) return;

                if (currentFilterDropdown) {
                    currentFilterDropdown.remove();
                    currentFilterDropdown = null;
                }

                const filterBy = header.dataset.filterBy;
                // Usar los datos pre-filtrados para generar las opciones del dropdown.
                const preFilteredData = getPreFilteredData(dataProvider, filterKey, filterBy);

                const uniqueValues = [...new Set(preFilteredData.map(item => getFilterableValue(item, filterBy)))].sort((a, b) => {
                    // Lógica de ordenamiento personalizada para fechas en el filtro
                    if (filterBy === 'fecha') {
                        try {
                            const dateA = new Date(a.split('/').reverse().join('-'));
                            const dateB = new Date(b.split('/').reverse().join('-'));
                            return dateA - dateB; // Orden ascendente
                        } catch (err) { return a.localeCompare(b); }
                    }
                    return a.localeCompare(b, 'es', { numeric: true });
                });

                const dropdown = document.createElement('div');
                dropdown.className = 'filter-dropdown p-2 space-y-1';
                
                const activeColumnFilters = activeFilters[filterKey][filterBy] || [];

                dropdown.innerHTML = `
                    <div class="p-1 border-b border-gray-200">
                        <input type="text" placeholder="Buscar opciones..." class="filter-search-input w-full text-xs p-1 border rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                    <div class="filter-options-container max-h-48 overflow-y-auto">
                        ${uniqueValues.map(value => `
                            <label class="flex items-center space-x-2 p-1 hover:bg-gray-100 rounded cursor-pointer filter-option-label">
                                <input type="checkbox" class="filter-checkbox" value="${value}" ${activeColumnFilters.includes(value) ? 'checked' : ''}>
                                <span class="text-sm text-gray-700">${truncateText(value, 40)}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="border-t my-1"></div>
                    <div class="p-1"><button class="clear-filter-btn text-blue-500 hover:underline text-xs" data-filter-by="${filterBy}">Limpiar filtro</button></div>
                `;

                document.body.appendChild(dropdown);
                const rect = header.getBoundingClientRect();
                dropdown.style.top = `${rect.bottom + window.scrollY}px`;
                dropdown.style.left = `${rect.left + window.scrollX}px`;
                currentFilterDropdown = dropdown;

                // Lógica para el buscador dentro del filtro
                const searchInput = dropdown.querySelector('.filter-search-input');
                const labels = dropdown.querySelectorAll('.filter-option-label');
                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    labels.forEach(label => {
                        const text = label.textContent.toLowerCase();
                        const isVisible = text.includes(searchTerm);
                        label.style.display = isVisible ? 'flex' : 'none';
                    });
                });

                dropdown.addEventListener('change', e => {
                    if (e.target.classList.contains('filter-checkbox')) {
                        const checkedValues = Array.from(dropdown.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);
                        activeFilters[filterKey][filterBy] = checkedValues;
                        
                        header.classList.toggle('active', checkedValues.length > 0);

                        const filteredData = applyAllFilters(dataProvider(), filterKey);
                        renderFunc(document.getElementById(filterKey === 'main' ? 'news-table-body' : 'historical-table-body'), filteredData, filterKey === 'historical');
                    }
                });

                dropdown.querySelector('.clear-filter-btn').addEventListener('click', () => {
                    activeFilters[filterKey][filterBy] = [];
                    header.classList.remove('active');
                    const filteredData = applyAllFilters(dataProvider(), filterKey);
                    renderFunc(document.getElementById(filterKey === 'main' ? 'news-table-body' : 'historical-table-body'), filteredData, filterKey === 'historical');
                    if (currentFilterDropdown) currentFilterDropdown.remove();
                });
            });

            // Close dropdown if clicked outside
            document.addEventListener('click', (e) => {
                if (currentFilterDropdown && !currentFilterDropdown.contains(e.target) && !e.target.closest('.filterable-header')) {
                    currentFilterDropdown.remove();
                    currentFilterDropdown = null;
                }
            }, true);
        }

        // CORRECCIÓN: Implementación completa de la función del tooltip.
        function setupQuickViewTooltip() {
            const tooltip = quickViewTooltip;
            const specialMedios = ["Conferencia de prensa matutina", "Evento Presidencial", "Informe de Gobierno"];

            const showTooltip = (e) => { 
                const row = e.target.closest('tr[data-quickview="true"]');
                if (!row) return;

                // Extraer los datos desde los atributos data-* de la fila
                const { proyecto, subproyecto, noticia, medio, fecha, cita } = row.dataset;

                // Lógica para construir el contenido del tooltip de forma inteligente
                let tooltipContent = '';
                tooltip.classList.remove('quick-view-conference'); // Resetear clase especial

                const fechaLarga = formatLongDate(fecha);

                if (specialMedios.includes(medio)) {
                    // Tooltip especial para Conferencias/Eventos con iconos y colores dinámicos
                    tooltip.classList.add('quick-view-conference');
                    let iconClass = 'fa-microphone-lines';
                    let colorVar = '--accent-color';
                    let bgColor = '#16463c'; // accent-dark

                    if (medio === "Evento Presidencial") {
                        iconClass = 'fa-users-rays';
                        colorVar = '--secondary-color';
                        bgColor = '#8a6b22'; // secondary-dark
                    } else if (medio === "Informe de Gobierno") {
                        iconClass = 'fa-landmark-flag';
                        colorVar = '--slate-500-color'; // Usaremos un color base para slate
                        bgColor = '#475569'; // slate-600
                        // Definir la variable CSS si no existe
                        document.documentElement.style.setProperty('--slate-500-color', '#64748b');
                    }

                    // Aplicar estilos dinámicamente
                    tooltip.style.backgroundColor = bgColor;
                    tooltip.style.borderColor = `var(${colorVar})`;

                    tooltipContent = `
                        <div class="medio-icon" style="color: white;">
                            <i class="fa-solid ${iconClass} fa-lg"></i>
                        </div>
                        <div class="medio-title">${medio}</div>
                        <p class="fecha-larga">${fechaLarga}</p>
                    `;
                } else {
                    // Tooltip para noticias normales
                    let subproyectoHtml = '';
                    if (subproyecto && subproyecto !== 'N/A' && subproyecto.trim() !== '') {
                        subproyectoHtml = `<p><strong>Subproyecto:</strong> ${truncateText(subproyecto, 40)}</p>`;
                    }

                    let citaHtml = '';
                    if (cita && cita.trim() !== '') {
                        citaHtml = `<p class="cita-text">“${truncateText(cita, 150)}”</p>`;
                    }

                    tooltipContent = `
                        <p><strong>Proyecto:</strong> ${truncateText(proyecto, 40)}</p>
                        ${subproyectoHtml}
                        <p><strong>Noticia:</strong> ${truncateText(noticia, 100)}</p>
                        <p><strong>Medio:</strong> ${truncateText(medio, 40)}</p>
                        ${citaHtml}
                        <p class="text-right text-xs text-gray-400 mt-2">${fechaLarga}</p>
                    `;
                }

                tooltip.innerHTML = tooltipContent;
                tooltip.classList.add('visible');
            };

            const hideTooltip = () => {
                tooltip.classList.remove('visible');
                // Limpiar estilos en línea al ocultar para no afectar otros tooltips
                tooltip.style.backgroundColor = '';
                tooltip.style.borderColor = '';
                tooltip.classList.remove('quick-view-conference'); // Limpiar al ocultar
            };

            const moveTooltip = (e) => {
                if (tooltip.classList.contains('visible')) {
                    tooltip.style.left = `${e.clientX + 15}px`; // Desfase para no tapar el cursor
                    tooltip.style.top = `${e.clientY + 15}px`;
                }
            };

            [newsTableBody, historicalTableBody].forEach(tbody => {
                tbody.addEventListener('mouseover', showTooltip);
                tbody.addEventListener('mouseout', hideTooltip);
                tbody.addEventListener('mousemove', moveTooltip);
            });
        }

        function setupFiltering(inputId, dataProvider, renderFunc, isHistorical = false) {
            const filterInput = document.getElementById(inputId);
            const filterKey = isHistorical ? 'historical' : 'main';
            const clearFilterBtn = document.getElementById(`clear-filter-btn-${filterKey}`);
            filterInput.addEventListener('input', () => {
                const filterText = filterInput.value.toLowerCase();
                clearFilterBtn.classList.toggle('hidden', !filterText);
                const filteredData = applyAllFilters(dataProvider(), filterKey);
                renderFunc(document.getElementById(isHistorical ? 'historical-table-body' : 'news-table-body'), filteredData, isHistorical);
            });
            clearFilterBtn.addEventListener('click', () => {
                filterInput.value = ''; filterInput.dispatchEvent(new Event('input'));
            });
        }

        function sortAndRenderTable(tableBody, data, isHistorical) {
            // Lógica de ordenamiento corregida y definitiva:
            // 1. Criterio principal: Fecha de la noticia (descendente).
            // 2. Criterio de desempate: Fecha de creación del registro (descendente).
            data.sort((a, b) => {
                try {
                    // Normalizar fechas para evitar errores. Se usa una fecha muy antigua como fallback.
                    const dateA = a.fecha ? new Date(a.fecha) : new Date(0);
                    const dateB = b.fecha ? new Date(b.fecha) : new Date(0);

                    // 1. Comparar por fecha de la noticia (descendente).
                    const dateComparison = dateB.getTime() - dateA.getTime();
                    if (dateComparison !== 0) return dateComparison;

                    // 2. Si las fechas son iguales, desempatar por fecha de creación (descendente).
                    const timeB = b.createdAt?.toMillis() || 0;
                    const timeA = a.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                } catch (e) {
                    return 0; // Fallback si alguna fecha no es válida
                }
            });

            const filterKey = isHistorical ? 'historical' : 'main';
            const filteredData = applyAllFilters(data, filterKey);
            renderTable(tableBody, filteredData, isHistorical);
        }

        function openWebviewModal(url) {
            // 1. Limpiar el src anterior para evitar mostrar contenido viejo brevemente.
            webviewFrame.src = 'about:blank';
            
            // 2. Asignar la nueva URL al iframe.
            webviewFrame.src = url;
            
            // 3. Abrir el modal. El navegador intentará cargar la URL.
            openModal(webviewModal);
        }

        // =============================================
        // MÓDULO: Gestión de noticias
        // =============================================
        
        async function saveNews(newsData) {
            try {
                await newsCollectionRef.add({ 
                    ...newsData, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
                showAlert("Noticia guardada con éxito!", "success");
            } catch (error) {
                console.error("Error al guardar la noticia:", error);
                showAlert(`Error al guardar: ${error.message}`, "error");
            }
        }

        async function updateNews(id, updateData, isHistorical) {
            if (!id) {
                console.error("ID no válido para actualización");
                showAlert("Error interno: ID no válido", "error");
                return;
            }
            
            try {
                const collectionRef = isHistorical ? historicalNewsCollectionRef : newsCollectionRef;
                const newsDocRef = collectionRef.doc(id);
                
                const docSnapshot = await newsDocRef.get();
                if (!docSnapshot.exists) {
                    showAlert("El registro que intentas actualizar no existe", "error");
                    return;
                }
                
                await newsDocRef.update({ ...updateData, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                showAlert("Noticia actualizada con éxito!", "success");
            } catch (error) {
                console.error("Error al actualizar la noticia:", error);
                showAlert(`Error al actualizar: ${error.message}`, "error");
            }
        }

        async function deleteNews(id, isHistorical) {
            if (!id) {
                console.error("ID no válido para eliminación");
                showAlert("Error interno: ID no válido", "error");
                return;
            }
            
            try {
                const collectionRef = isHistorical ? historicalNewsCollectionRef : newsCollectionRef;
                const newsDocRef = collectionRef.doc(id);
                
                const docSnapshot = await newsDocRef.get();
                if (!docSnapshot.exists) {
                    showAlert("El registro que intentas eliminar no existe", "error");
                    return;
                }
                
                await newsDocRef.delete();
                showAlert("Noticia eliminada con éxito!", "success");
            } catch (error) {
                console.error("Error al eliminar la noticia:", error);
                showAlert(`Error al eliminar: ${error.message}`, "error");
            }
        }

        function handleEditClick(button) {
            requirePassword(() => {
                const newsId = button.getAttribute('data-id');
                const isHistorical = button.getAttribute('data-is-historical') === 'true';
                if (!newsId) {
                    console.error("ID de noticia no encontrado para edición");
                    return;
                }
                currentEditIsHistorical = isHistorical;
                const allData = isHistorical ? historicalNews : news;
                const newsToEdit = allData.find(item => item.id === newsId);

                if (!newsToEdit) {
                    showAlert("No se pudo encontrar la noticia para editar", "error");
                    return;
                }

                // Decidir qué modal abrir
                if (specialMedios.includes(newsToEdit.medio)) {
                    // Abrir modal de edición de conferencia
                    document.getElementById('edit-conference-id').value = newsId;
                    document.getElementById('edit-conference-date').value = newsToEdit.fecha || '';
                    document.getElementById('edit-conference-source').value = newsToEdit.fuente || '';
                    
                    const medioSelect = document.getElementById('edit-conference-medio');
                    medioSelect.value = newsToEdit.medio || '';
                    
                    const summaryLabel = document.getElementById('edit-conference-summary-label');
                    updateConferenceSummaryLabel(newsToEdit.medio, summaryLabel);

                    document.getElementById('edit-conference-summary').innerHTML = newsToEdit.resumen || '';

                    // SOLUCIÓN: Limpiar el input del archivo para evitar que se use un archivo anterior.
                    const docxInput = document.getElementById('edit-conference-docx');
                    if (docxInput) docxInput.value = '';

                    openModal(editConferenceModal);
                } else {
                    // Abrir modal de edición normal
                    document.getElementById('edit-id').value = newsId;
                    document.getElementById('edit-news-date').value = newsToEdit.fecha || '';
                    document.getElementById('edit-news-source').value = newsToEdit.fuente || '';
                    document.getElementById('edit-news-comment').value = newsToEdit.comentario || '';
                    document.getElementById('edit-news-cita').value = newsToEdit.cita || '';
                    document.getElementById('edit-news-summary').innerHTML = newsToEdit.resumen || '';
                    
                    // Set select values
                    $('#edit-news-project').val(newsToEdit.proyecto || '').trigger('change');
                    $('#edit-news-subproject').val(newsToEdit.subproyecto || '').trigger('change');
                    $('#edit-news-category').val(newsToEdit.categoria || '').trigger('change');
                    $('#edit-news-medio').val(newsToEdit.medio || '').trigger('change');

                    openModal(editModal);
                }
            });
        }

        //Función Anterior sin delegación de eventos
        //function handleDeleteClick(button) {
          //  requirePassword(() => {
            //    newsToDeleteId = button.getAttribute('data-id');
              //  newsToDeleteIsHistorical = button.getAttribute('data-is-historical') === 'true';
                
                //if (!newsToDeleteId) {
                  //  console.error("ID de noticia no encontrado para eliminación");
                    //return;
                //}
                
                //openModal(confirmModal);
           // });
        //}
        
        //Nueva funcion acorde a delegación de eventos
        function handleDeleteClick(button) {
            requirePassword(() => {
                confirmModal.dataset.pendingId = button.dataset.id || button.getAttribute('data-id');
                confirmModal.dataset.pendingIsHistorical = button.dataset.isHistorical || button.getAttribute('data-is-historical') || 'false';
                openModal(confirmModal);
            });
        }
        
        
        function showDetailsModal(newsItem, isHistorical = false) {
            if (!newsItem) return;

            const filterKey = isHistorical ? 'historical' : 'main';
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.trim() : '';

            // Ocultar el tooltip de vista rápida al abrir el modal de detalles.
            if (quickViewTooltip) {
                quickViewTooltip.classList.remove('visible');
            }

            // --- Botón de descarga para el modal individual ---
            const downloadButtonHTML = `
                <button data-id="${newsItem.id}" data-is-historical="${isHistorical}" class="generate-doc-btn text-slate-400 hover:text-primary p-2 rounded-lg transition-colors" title="Descargar reporte DOCX">
                    <i class="fa-solid fa-file-word fa-lg"></i>
                </button>
            `;

            if (specialMedios.includes(newsItem.medio)) {
                // --- NUEVO DISEÑO PARA CASOS ESPECIALES ---
                let resumenHeader = 'Resumen';
                if (newsItem.medio === 'Conferencia de prensa matutina') {
                    resumenHeader = 'Resumen de la Conferencia';
                } else if (newsItem.medio === 'Evento Presidencial') {
                    resumenHeader = 'Resumen del Evento';
                } else if (newsItem.medio === 'Informe de Gobierno') {
                    resumenHeader = 'Resumen del Informe';
                }

                const links = (newsItem.fuente || '').split(';').map(link => link.trim()).filter(link => link);
                let sourceLink = '<p class="text-gray-700">N/A</p>';
                if (links.length > 0) {
                    sourceLink = links.map(link => {
                        const highlightedLink = highlightText(link, searchText);
                        if (isValidUrl(link)) { return `<a href="${link}" target="_blank" class="text-blue-600 hover:underline break-all block mb-1">${highlightedLink}</a>`; }
                        return `<p class="text-gray-700 break-all block mb-1">${highlightedLink}</p>`;
                    }).join('');
                }

                detailsModalContent.innerHTML = `
                    <div class="details-header flex justify-between items-start">
                        <div>
                            <h3 class="project">${highlightText(newsItem.medio || 'Medio no especificado', searchText)}</h3>
                            <p class="date">${highlightText(formatLongDate(newsItem.fecha), searchText)}</p>
                        </div>
                        ${downloadButtonHTML}
                    </div>

                    <div class="details-section">
                        <table class="details-table">
                            <thead>
                                <tr>
                                    <th style="text-align: center;">${highlightText(resumenHeader, searchText)}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="formatted-content" style="text-align: justify;">${highlightHtmlContent(newsItem.resumen || 'No hay resumen disponible.', searchText)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="details-section text-center">
                        <h4>Enlace Original</h4>
                        ${sourceLink}
                    </div>
                `;
            } else {
                // --- DISEÑO ORIGINAL PARA NOTICIAS GENERALES ---
                const subproyectoHtml = (newsItem.subproyecto && newsItem.subproyecto.trim() !== '-') 
                    ? `<p class="date">${highlightText(newsItem.subproyecto, searchText)}</p>` : '';
                const citaHtml = newsItem.cita
                    ? `<tr><th style="vertical-align: middle;">Cita</th><td class="formatted-content"><i>${highlightText(newsItem.cita, searchText)}</i></td></tr>` : '';
                
                const links = (newsItem.fuente || '').split(';').map(link => link.trim()).filter(link => link);
                let sourceLink = '<p class="text-gray-700">N/A</p>';
                if (links.length > 0) {
                    sourceLink = links.map(link => {
                        const highlightedLink = highlightText(link, searchText);
                        if (isValidUrl(link)) { return `<a href="${link}" target="_blank" class="text-blue-600 hover:underline break-all block mb-1">${highlightedLink}</a>`; }
                        return `<p class="text-gray-700 break-all block mb-1">${highlightedLink}</p>`;
                    }).join('');
                }

                detailsModalContent.innerHTML = `
                    <div class="details-header flex justify-between items-start">
                        <div>
                            <h3 class="project">${highlightText(newsItem.proyecto || 'Proyecto no especificado', searchText)}</h3>
                            ${subproyectoHtml}                        
                            <p class="date">${highlightText(formatLongDate(newsItem.fecha), searchText)}</p>
                        </div>
                        ${downloadButtonHTML}
                    </div>

                    <div class="details-section">
                        <h4>Resumen de la Noticia</h4>
                        <table class="details-table">
                            <tbody>
                                <tr>
                                    <th style="vertical-align: middle;">Noticia</th>
                                    <td class="formatted-content" style="font-weight: bold; font-size: 1.1em;">${highlightText(newsItem.comentario || 'Sin título.', searchText)}</td>
                                </tr>
                                ${citaHtml}
                                <tr>
                                    <th>Resumen</th>
                                    <td class="formatted-content" style="text-align: justify;">${highlightHtmlContent(newsItem.resumen || 'No hay resumen disponible.', searchText)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="details-section">
                        <h4>Fecha y Medio</h4>
                        <table class="details-table">
                            <thead><tr><th>Fecha de Publicación</th><th>Medio</th><th>Categoría</th></tr></thead>
                            <tbody><tr><td>${highlightText(formatDate(newsItem.fecha) || 'N/A', searchText)}</td><td>${highlightText(newsItem.medio || 'N/A', searchText)}</td><td>${highlightText(newsItem.categoria || 'N/A', searchText)}</td></tr></tbody>
                        </table>
                    </div>

                    <div class="details-section text-center">
                        <h4>Fuente Original</h4>
                        ${sourceLink}
                    </div>
                `;
            }

            // Añadir el listener para el nuevo botón de descarga
            const downloadBtn = detailsModalContent.querySelector('.generate-doc-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => handleGenerateDocClick(downloadBtn));
            }

            openModal(viewDetailsModal);
        }

        function generateSingleDetailHtml(newsItem, index, isHistorical = false) {
            if (!newsItem) return '';

            const filterKey = isHistorical ? 'historical' : 'main';
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.trim() : '';

            // --- Botón de descarga para cada item ---
            const downloadButtonHTML = `
                <button data-id="${newsItem.id}" data-is-historical="${isHistorical}" class="generate-doc-btn text-slate-400 hover:text-primary p-2 rounded-lg transition-colors" title="Descargar reporte DOCX">
                    <i class="fa-solid fa-file-word fa-lg"></i>
                </button>
            `;
            
            if (specialMedios.includes(newsItem.medio)) {
                let resumenHeader = 'Resumen';
                if (newsItem.medio === 'Conferencia de prensa matutina') resumenHeader = 'Resumen de la Conferencia';
                else if (newsItem.medio === 'Evento Presidencial') resumenHeader = 'Resumen del Evento';
                else if (newsItem.medio === 'Informe de Gobierno') resumenHeader = 'Resumen del Informe';

                const links = (newsItem.fuente || '').split(';').map(link => link.trim()).filter(link => link);
                let sourceLink = '<p class="text-gray-700">N/A</p>';
                if (links.length > 0) {
                    sourceLink = links.map(link => {
                        const highlightedLink = highlightText(link, searchText);
                        if (isValidUrl(link)) { return `<a href="${link}" target="_blank" class="text-blue-600 hover:underline break-all block mb-1">${highlightedLink}</a>`; }
                        return `<p class="text-gray-700 break-all block mb-1">${highlightedLink}</p>`;
                    }).join('');
                }

                return `
                    <div class="multi-details-item">
                        <div class="details-header flex justify-between items-start">
                            <div>
                                <h3 class="project">${highlightText(newsItem.medio || 'Medio no especificado', searchText)}</h3>
                                <p class="date">${highlightText(formatLongDate(newsItem.fecha), searchText)}</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="text-lg font-bold text-primary bg-primary/10 px-3 py-1 rounded-full">${index + 1}</span>
                                ${downloadButtonHTML}
                            </div>
                        </div>
                        <div class="details-section"><table class="details-table"><thead><tr><th style="text-align: center;">${highlightText(resumenHeader, searchText)}</th></tr></thead><tbody><tr><td class="formatted-content" style="text-align: justify;">${highlightHtmlContent(newsItem.resumen || 'No hay resumen disponible.', searchText)}</td></tr></tbody></table></div>
                        <div class="details-section text-center"><h4>Enlace Original</h4>${sourceLink}</div>
                    </div>`;
            } else {
                const subproyectoHtml = (newsItem.subproyecto && newsItem.subproyecto.trim() !== '-') ? `<p class="date">${highlightText(newsItem.subproyecto, searchText)}</p>` : '';
                const citaHtml = newsItem.cita ? `<tr><th style="vertical-align: middle;">Cita</th><td class="formatted-content"><i>${highlightText(newsItem.cita, searchText)}</i></td></tr>` : '';
                
                const links = (newsItem.fuente || '').split(';').map(link => link.trim()).filter(link => link);
                let sourceLink = '<p class="text-gray-700">N/A</p>';
                if (links.length > 0) {
                    sourceLink = links.map(link => {
                        const highlightedLink = highlightText(link, searchText);
                        if (isValidUrl(link)) { return `<a href="${link}" target="_blank" class="text-blue-600 hover:underline break-all block mb-1">${highlightedLink}</a>`; }
                        return `<p class="text-gray-700 break-all block mb-1">${highlightedLink}</p>`;
                    }).join('');
                }

                return `
                    <div class="multi-details-item">
                        <div class="details-header flex justify-between items-start">
                            <div>
                                <h3 class="project">${highlightText(newsItem.proyecto || 'Proyecto no especificado', searchText)}</h3>${subproyectoHtml}<p class="date">${highlightText(formatLongDate(newsItem.fecha), searchText)}</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="text-lg font-bold text-primary bg-primary/10 px-3 py-1 rounded-full">${index + 1}</span>
                                ${downloadButtonHTML}
                            </div>
                        </div>
                        <div class="details-section"><h4>Resumen de la Noticia</h4><table class="details-table"><tbody><tr><th style="vertical-align: middle;">Noticia</th><td class="formatted-content" style="font-weight: bold; font-size: 1.1em;">${highlightText(newsItem.comentario || 'Sin título.', searchText)}</td></tr>${citaHtml}<tr><th>Resumen</th><td class="formatted-content" style="text-align: justify;">${highlightHtmlContent(newsItem.resumen || 'No hay resumen disponible.', searchText)}</td></tr></tbody></table></div>
                        <div class="details-section"><h4>Fecha y Medio</h4><table class="details-table"><thead><tr><th>Fecha de Publicación</th><th>Medio</th><th>Categoría</th></tr></thead><tbody><tr><td>${highlightText(formatDate(newsItem.fecha) || 'N/A', searchText)}</td><td>${highlightText(newsItem.medio || 'N/A', searchText)}</td><td>${highlightText(newsItem.categoria || 'N/A', searchText)}</td></tr></tbody></table></div>
                        <div class="details-section text-center"><h4>Fuente Original</h4>${sourceLink}</div>
                    </div>`;
            }
        }

        function showMultiDetailsModal(isHistorical) {
            const filterKey = isHistorical ? 'historical' : 'main';
            const dataProvider = isHistorical ? () => historicalNews : () => news;
            const data = dataProvider();
            const filteredData = applyAllFilters(data, filterKey);

            if (filteredData.length === 0) {
                showAlert("No hay noticias en la tabla para mostrar.", "warning");
                return;
            }
            
            let allDetailsHtml = filteredData.map((newsItem, index) => generateSingleDetailHtml(newsItem, index, isHistorical)).join('');
            multiDetailsContentContainer.innerHTML = allDetailsHtml;

            openModal(multiDetailsModal);
        }

        /**
         * Genera un documento .docx a partir de una plantilla en Firebase Storage.
         * @param {string} newsId - El ID del registro de la noticia.
         * @param {boolean} isHistorical - Indica si el registro es del histórico.
         */
        async function generateDoc(newsId, isHistorical) {
            // 1. Verificar que las librerías necesarias estén cargadas y cargar fallbacks si es necesario
            let missingLibs = checkRequiredLibraries();
            if (missingLibs.includes('PizZip') || missingLibs.includes('docxtemplater')) {
                showAlert("Cargando librerías necesarias...", "info");
                try {
                    await loadFallbackLibraries(missingLibs);
                    // Verificar nuevamente después de cargar los fallbacks
                    missingLibs = checkRequiredLibraries();
                    if (missingLibs.includes('PizZip') || missingLibs.includes('docxtemplater')) {
                        const errorMessage = `No se pudieron cargar las librerías: ${missingLibs.join(', ')}. Verifique su conexión.`;
                        console.error(errorMessage);
                        return showAlert(errorMessage, "error");
                    }
                } catch (error) {
                    const errorMessage = "Error al cargar librerías para generar documentos.";
                    console.error(errorMessage, error);
                    return showAlert(errorMessage, "error");
                }
            } else if (missingLibs.includes('saveAs')) {
                 return showAlert("Error: La librería FileSaver.js no se cargó correctamente.", "error");
            }

            showAlert("Generando reporte...", "info");
            const dataSet = isHistorical ? historicalNews : news;
            const record = dataSet.find(item => item.id === newsId);

            if (!record) {
                return showAlert("No se encontró el registro de la noticia.", "error");
            }

            try {
                // 2. Check if there's a conference docx attached
                let templateType = 'medios'; // Default
                if (record.medio === 'Conferencia de prensa matutina') {
                    templateType = 'mananera';
                } else if (record.medio === 'Evento Presidencial') {
                    templateType = 'evento';
                } else if (record.medio === 'Informe de Gobierno') {
                    templateType = 'informe';
                }

                if(record.conferenceDocx){
                    //Download docx, stop report creation.
                    const byteCharacters = atob(record.conferenceDocx);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
                    saveAs(blob, `Reporte_Conferencia_${record.fecha}.docx`);
                    showAlert("¡Reporte generado con éxito!", "success");
                    return;
                }

                // 3. Obtener la plantilla correcta desde Firestore
                const templateDocRef = db.collection('config').doc(`wordTemplate_${templateType}`);
                const defaultRef = db.collection('config').doc('wordTemplate_medios');


                let templateDoc = await templateDocRef.get();
                let usedTemplateType = templateType;

                // Fallback a la plantilla por defecto si la específica no existe
                if (!templateDoc.exists || !templateDoc.data().templateData) {
                    showAlert(`Plantilla para '${record.medio}' no encontrada. Usando plantilla de medios por defecto.`, "warning");
                    templateDoc = await defaultRef.get();
                    usedTemplateType = 'medios';
                    if (!templateDoc.exists || !templateDoc.data().templateData) {
                        return showAlert("No se encontró la plantilla de medios por defecto. Por favor, cárguela en la pestaña de Reportes.", "error");
                    }
                }
                const base64String = templateDoc.data().templateData;

                // Convertir la plantilla de Base64 a un formato que docxtemplater pueda usar
                const templateBlob = base64ToArrayBuffer(base64String);

                // 3. Procesar la plantilla con docxtemplater
                // Usamos PizZip directamente desde el objeto window
                const zip = new PizZip(templateBlob);
                const doc = new window.docxtemplater(zip, {
                    // Clave de la solución: Si un párrafo contiene solo un placeholder
                    // que resulta ser nulo o undefined, el párrafo completo se elimina.
                    // Esto evita los espacios en blanco de las líneas de "Cita" o "Subproyecto" cuando no tienen datos.
                    paragraphLoop: true,
                    paragraphLoop: true,
                    linebreaks: true,
                    nullGetter: () => "" // Trata los valores null y undefined como una cadena vacía.
                });

                // 4. Preparar el contenido del resumen (palabra_clave_5) con lógica condicional
                let resumenOriginal = record.resumen || 'No hay resumen disponible.';
                // Limpieza de fragmentos de MS Office y &nbsp;
                resumenOriginal = resumenOriginal.replace(/<!--\[if !supportLists\]-->|<!--\[endif\]-->|<!--StartFragment-->|<!--EndFragment-->|&nbsp;/g, ' ').trim();

                const isSummaryHtml = isHtml(resumenOriginal);
                const isSpecialReport = specialMedios.includes(record.medio);
                let resumenParaPlantilla;

                if (isSpecialReport) {
                    // Para conferencias/eventos, siempre procesar a OpenXML para mantener formato.
                    resumenParaPlantilla = htmlToOpenXml(isSummaryHtml ? resumenOriginal : `<p>${resumenOriginal.replace(/\n/g, '</p><p>')}</p>`);
                } else {
                    // Para noticias normales, usar texto plano. Si es HTML, limpiarlo.
                    resumenParaPlantilla = isSummaryHtml ? htmlToPlainText(resumenOriginal) : resumenOriginal;
                }

                const dataForTemplate = {
                    palabra_clave_0: getMonthName(record.fecha),
                    palabra_clave_1: formatLongDate(record.fecha),
                    palabra_clave_2: (record.fuente || '').split(';').map(link => link.trim()).filter(Boolean).join('\n'),
                    palabra_clave_3: record.proyecto,
                    palabra_clave_4: record.subproyecto,
                    palabra_clave_5: resumenParaPlantilla,
                    palabra_clave_6: record.categoria,
                    palabra_clave_7: record.medio,
                    palabra_clave_8: record.comentario, // Este es ahora el Título
                    palabra_clave_9: record.cita,
                };

                doc.setData(dataForTemplate);
                doc.render(); // render() ahora se llama después de setData()

                // 5. Generar y descargar el archivo
                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });

                // Lógica mejorada para generar el nombre del archivo
                let baseName = 'Reporte';
                const safeDate = record.fecha || new Date().toISOString().split('T')[0];

                // Función para limpiar strings para nombres de archivo
                const sanitize = (str) => {
                    if (!str) return '';
                    const a = 'àáâäæãåāăąçćčđďèéêëēėęěğǵḧîïíīįìłḿñńǹňôöòóœøōõőṕŕřßśšşșťțûüùúūǘůűųẃẍÿýžźż·/_,:;'
                    const b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz------'
                    const p = new RegExp(a.split('').join('|'), 'g')

                    return str.toString().toLowerCase()
                        .replace(p, c => b.charAt(a.indexOf(c))) // Reemplazar caracteres especiales
                        .replace(/[^a-z0-9 -]/g, '').replace(/\s+/g, '_').replace(/__+/g, '_').replace(/^-+|-+$/g, ''); // Limpiar y reemplazar
                };

                if (specialMedios.includes(record.medio)) {
                    // Para conferencias: [Tipo de Conferencia]_[Fecha].docx
                    baseName = `${sanitize(record.medio)}_${safeDate}`;
                } else {
                    // Para noticias: Noticia_[Medio]_[Fecha].docx
                    baseName = `Noticia_${sanitize(record.medio)}_${safeDate}`;
                }
                saveAs(out, `${baseName}.docx`);
                showAlert("¡Reporte generado con éxito!", "success");

            } catch (error) {
                console.error("Error en docxtemplater:", error);
                // Error mejorado para distinguir problemas de plantilla
                if (error.properties && error.properties.errors) {
                    showAlert("Error en la plantilla: " + error.properties.errors[0].message, "error");
                } else {
                    showAlert("Error al generar el reporte. Revise la consola.", "error");
                }
            }
        }


        function setupNewsMediosDashboardFilter() {
            const indicators = document.querySelectorAll('#news-dashboard-medios .indicator-card');

            indicators.forEach(element => {
                element.addEventListener('click', () => {
                    const medioFilter = element.dataset.medio;
                    const isDeactivating = (activeNewsMedioFilter && activeNewsMedioFilter === medioFilter) || !medioFilter;
                    
                    document.querySelectorAll('#news-dashboard-medios .indicator-card').forEach(card => card.classList.remove('active-filter'));

                    if (isDeactivating) {
                        activeNewsMedioFilter = null;

                        // Limpiar todos los filtros asociados a la tabla de noticias
                        activeFilters.main = {};
                        document.querySelectorAll('#main-table-header .filterable-header.active').forEach(header => {
                            header.classList.remove('active');
                        });
                        const searchInput = document.getElementById('filter-input-main');
                        if (searchInput) {
                            searchInput.value = '';
                            searchInput.dispatchEvent(new Event('input'));
                        }
                    } else {
                        activeNewsMedioFilter = medioFilter;
                        element.classList.add('active-filter');
                    }

                    // Re-renderizar la tabla de noticias con el filtro (o sin él)
                    sortAndRenderTable(newsTableBody, news, false);
                });
            });
        }

        function setupMediosDashboardFilter() {
            const indicators = document.querySelectorAll('#tab-content-historico #dashboard-medios .indicator-card');

            indicators.forEach(element => {
                element.addEventListener('click', () => {
                    const medioFilter = element.dataset.medio; // undefined para el total
                    const isDeactivating = activeMedioDashboardFilter === medioFilter;
                    
                    document.querySelectorAll('#tab-content-historico .indicator-card').forEach(card => card.classList.remove('active-filter'));

                    if (isDeactivating) {
                        // Si se hace clic en el filtro ya activo, o en el total, se desactiva todo.
                        activeMedioDashboardFilter = null;

                        // Limpiar todos los filtros asociados a la tabla histórica
                        activeFilters.historical = {};
                        document.querySelectorAll('#historical-table-header .filterable-header.active').forEach(header => {
                            header.classList.remove('active');
                        });
                        const searchInput = document.getElementById('filter-input-historical');
                        if (searchInput) {
                            searchInput.value = '';
                            searchInput.dispatchEvent(new Event('input')); // Para ocultar el botón 'x'
                        }
                    } else {
                        // Activar nuevo filtro
                        activeMedioDashboardFilter = medioFilter;
                        element.classList.add('active-filter');
                    }

                    // Re-renderizar la tabla de histórico con el filtro (o sin él)
                    sortAndRenderTable(historicalTableBody, historicalNews, true);
                });
            });
        }

        function getFormattedTimestamp() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0'); // Los meses son base 0
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${day}-${month}-${year}_${hours}h-${minutes}m-${seconds}s`;
        }


        // =============================================
        // MÓDULO: Gestión de datos históricos
        // =============================================

        /*
        * Utilerías de soporte para migraciones seguras
        */

        // Trocea un array en chunks de tamaño 'size'
        function chunkArray(arr, size) {
            const chunks = [];
            for (let i = 0; i < arr.length; i += size) {
                chunks.push(arr.slice(i, i + size));
            }
            return chunks;
        }

        // Pequeña espera (ms)
        function sleep(ms) {
            return new Promise(res => setTimeout(res, ms));
        }

        // Mapea de forma segura un objeto histórico/nota a la forma "newsData" esperada.
        // Si existe newsItem.newsData lo usa, si no, intenta reconstruir a partir de campos conocidos.
        function resolveNewsDataFromItem(newsItem) {
            if (!newsItem) return {};
            if (newsItem.newsData && typeof newsItem.newsData === 'object') return newsItem.newsData;
            // Fallback: reconstruir conservadoramente desde campos planos
            return {
                fecha: newsItem.fecha || '',
                fuente: newsItem.fuente || '',
                proyecto: newsItem.proyecto || '',
                subproyecto: newsItem.subproyecto || '',
                comentario: newsItem.comentario || '',
                cita: newsItem.cita || '',
                resumen: newsItem.resumen || '',
                categoria: newsItem.categoria || '',
                medio: newsItem.medio || ''
            };
        }


        /**
         * Elimina todos los registros del histórico EXCEPTO las conferencias.
         * Se utiliza antes de importar un nuevo archivo de Excel.
         */
        async function deleteNonConferenceHistorical() {
            const batch = db.batch();
            // Filtra los registros para encontrar solo las noticias (no las conferencias)
            const newsToDelete = historicalNews.filter(item => !specialMedios.includes(item.medio));

            newsToDelete.forEach(newsItem => {
                const ref = historicalNewsCollectionRef.doc(newsItem.id);
                batch.delete(ref);
            });
            await batch.commit();
        }

        async function importHistoricalData(data) {
            try {
                const batch = db.batch();
                data.forEach(item => {
                    const docRef = historicalNewsCollectionRef.doc();
                    batch.set(docRef, { ...item, importedAt: firebase.firestore.FieldValue.serverTimestamp() });
                });
                await batch.commit();
                showAlert(`Se han importado ${data.length} registros históricos.`, "success");
                
                updateDynamicSelectOptions();
                renderTable(historicalTableBody, historicalNews, true);

            } catch (error) {
                console.error("Error al importar datos históricos:", error);
                showAlert(`Error al importar: ${error.message}`, "error");
            }
        }

        // =============================================================
        // MÓDULO: Catálogos de opciones dinámicas (Actualizado)
        // =============================================================

        // Catálogo de proyectos ferroviarios
        const catalogoProyectos = [
        ];

        // Catálogo de subproyectos, actualizado con las nuevas opciones
        const catalogoSubproyectos = [
        ];

        // Catálogo de categorías
        const catalogoCategorias = [
        ];

        // Catálogo de medios de difusión
        const catalogoMedios = [
            "Conferencia de prensa matutina",
            "Evento Presidencial",
            "Informe de Gobierno"
        ];

        const specialMedios = ["Conferencia de prensa matutina", "Evento Presidencial", "Informe de Gobierno"];

        function updateDynamicSelectOptions() {
            const allData = [...news, ...historicalNews];

            // Inicializar sets con los catálogos (preservando comportamiento original)
            const proyectosSet = new Set(catalogoProyectos || []);
            const categoriasSet = new Set(catalogoCategorias || []);
            const mediosSet = new Set(catalogoMedios || []);
            const subproyectosSet = new Set(catalogoSubproyectos || []);

            // Un solo barrido sobre allData
            for (const item of allData) {
                if (!item) continue;

                const p = item.proyecto;
                if (p != null) {
                    const t = String(p).trim();
                    if (t) proyectosSet.add(t);
                }

                const c = item.categoria;
                if (c != null) {
                    const t = String(c).trim();
                    if (t) categoriasSet.add(t);
                }

                const m = item.medio;
                if (m != null) {
                    const t = String(m).trim();
                    if (t) mediosSet.add(t);
                }

                const s = item.subproyecto;
                if (s != null) {
                    const t = String(s).trim();
                    if (t) subproyectosSet.add(t);
                }
            }

            // Convertir a arrays ordenados y actualizar fieldOptions + selects
            const combinedProyectos = Array.from(proyectosSet).sort();
            fieldOptions.proyectos = combinedProyectos;
            updateSelectOptions('proyectos', fieldOptions.proyectos);

            const combinedCategorias = Array.from(categoriasSet).sort();
            fieldOptions.categorias = combinedCategorias;
            updateSelectOptions('categorias', fieldOptions.categorias);

            const combinedMedios = Array.from(mediosSet).sort();
            fieldOptions.medios = combinedMedios;
            updateSelectOptions('medios', fieldOptions.medios);

            const combinedSubproyectos = Array.from(subproyectosSet).sort();
            fieldOptions.subproyectos = combinedSubproyectos;
            updateSelectOptions('subproyectos', fieldOptions.subproyectos);
        }


        const specialMediosForNewsForm = [
            "Conferencia de prensa matutina",
            "Evento Presidencial",
            "Informe de Gobierno"
        ];
        function updateSelectOptions(field, options, selectedId = null) {
            const fieldToSelectMap = {
                'proyectos': ['news-project', 'edit-news-project'],
                'subproyectos': ['news-subproject', 'edit-news-subproject'],
                'categorias': ['news-category', 'edit-news-category'],
                'medios': ['news-medio', 'edit-news-medio']
            };

            let normalizedOptions = options.map(opt => ({id: opt, text: opt}));

            // Filtro especial para el campo 'medio' en los formularios de noticias
            if (field === 'medios') {
                normalizedOptions = normalizedOptions.filter(opt => !specialMediosForNewsForm.includes(opt.id));
            }

            
            if (fieldToSelectMap[field]) {
                fieldToSelectMap[field].forEach(selectId => {
                    const select = $(`#${selectId}`);
                    if (select.length) {
                        const currentValue = select.val();
                        
                        select.empty().select2({
                            data: normalizedOptions,
                            tags: true,
                            placeholder: "Seleccione o escriba una opción",
                            allowClear: true,
                            width: '100%'
                        });

                        if (currentValue && normalizedOptions.some(o => o.id === currentValue)) {
                            select.val(currentValue).trigger('change.select2');
                        }
                        else if (selectedId && normalizedOptions.some(o => o.id === selectedId)) {
                            select.val(selectedId).trigger('change.select2');
                        }
                    }
                });
            }
        }



        async function findAndReplaceInDatabase(field, oldValue, newValue, activeFormId, formStateBeforeEdit) {
            const fieldToDbFieldMap = {
                'proyectos': 'proyecto', 
                'categorias': 'categoria',
                'medios': 'medio',
                'subproyectos': 'subproyecto'
            };
            
            const dbField = fieldToDbFieldMap[field];
            if (!dbField) return;
            
            try {
                const newsQuery = newsCollectionRef.where(dbField, '==', oldValue);
                const newsSnapshot = await newsQuery.get();
                
                const batch = db.batch();
                newsSnapshot.forEach(doc => {
                    batch.update(doc.ref, { [dbField]: newValue });
                });
                
                const historicalQuery = historicalNewsCollectionRef.where(dbField, '==', oldValue);
                const historicalSnapshot = await historicalQuery.get();
                
                historicalSnapshot.forEach(doc => {
                    batch.update(doc.ref, { [dbField]: newValue });
                });
                
                await batch.commit();
                
                // 1. Actualizar las opciones globales y redibujar los selects
                fieldOptions[field] = [...new Set([...fieldOptions[field].filter(opt => opt !== oldValue), newValue])].sort();
                updateSelectOptions(field, fieldOptions[field]);
                
                // 2. Restaurar el estado del formulario
                if (formStateBeforeEdit) {
                    restoreFormState(activeFormId, formStateBeforeEdit);
                }

                // 3. Asegurarse de que el campo editado tenga el nuevo valor seleccionado
                if (activeSelectElement) {
                    $(activeSelectElement).val(newValue).trigger('change.select2');
                }
                
                showAlert(`Se actualizaron ${newsSnapshot.size + historicalSnapshot.size} registros.`, "success");
            } catch (error) {
                console.error("Error al actualizar registros:", error);
                showAlert("Error al actualizar registros existentes", "error");
            }
        }

        function getFormState(formId) {
            const form = document.getElementById(formId);
            if (!form) return null;
            const state = {};
            
            // Guardar estado de inputs y textareas
            $(form).find('input, textarea').each(function() {
                const input = $(this);
                const inputName = input.attr('name');
                if (inputName) {
                    state[inputName] = { value: input.val() };
                }
            });

            // Guardar estado de selects (incluyendo tags)
            $(form).find('select').each(function() {
                const select = $(this);
                const selectName = select.attr('name');
                if (selectName) {
                    const select2Data = select.select2('data') || [];
                    state[selectName] = {
                        value: select.val(),
                        tags: select2Data.filter(item => item.element === undefined || $(item.element).data('select2-tag') === true)
                    };
                }
            });
            
            return state;
        }

        function restoreFormState(formId, state) {
            const form = document.getElementById(formId);
            if (!form || !state) return;
            
            Object.entries(state).forEach(([fieldName, fieldState]) => {
                const element = $(form).find(`[name="${fieldName}"]`);
                if (element.is('select')) {
                    // Restaurar tags para selects
                    if (fieldState.tags) {
                        fieldState.tags.forEach(tag => {
                            if (!element.find(`option[value="${tag.id}"]`).length) {
                                const newOption = new Option(tag.text, tag.id);
                                $(newOption).attr('data-select2-tag', 'true'); // Marcar como etiqueta para la siguiente captura de estado.
                                element.append(newOption);
                            }
                        });
                    }
                    element.val(fieldState.value).trigger('change.select2');
                } else if(element.is('input') || element.is('textarea')) {
                    element.val(fieldState.value);
                }
            });
        }

        function setupAddEditButtons() {
            const buttonToFieldMap = {
                'edit-project-btn': 'proyectos',
                'edit-subproject-btn': 'subproyectos',
                'edit-category-btn': 'categorias',
                'edit-medio-btn': 'medios',
                'edit-source-btn': 'fuente',
                'edit-cita-btn': 'cita',
                'edit-summary-btn': 'resumen',
                'edit-comment-btn': 'comentario',
                'edit-project-edit-btn': 'proyectos',
                'edit-subproject-edit-btn': 'subproyectos',
                'edit-category-edit-btn': 'categorias',
                'edit-source-edit-btn': 'fuente',
                'edit-summary-edit-btn': 'resumen',
                'edit-cita-edit-btn': 'cita',
                'edit-comment-edit-btn': 'comentario',
                'edit-medio-edit-btn': 'medios'
            };
            
            Object.entries(buttonToFieldMap).forEach(([buttonId, field]) => {
                const button = document.getElementById(buttonId);
                if (!button) return;

                button.addEventListener('click', (e) => {
                    let inputElement;
                    
                    if (['fuente', 'resumen', 'comentario', 'cita'].includes(field)) {
                        inputElement = e.currentTarget.parentElement.querySelector('input') || 
                                      e.currentTarget.parentElement.querySelector('textarea') ||
                                      e.currentTarget.parentElement.querySelector('.contenteditable');
                    } else {
                        inputElement = e.currentTarget.parentElement.querySelector('select');
                        activeSelectElement = inputElement;
                    }
                    
                    const currentValue = inputElement.value;
                        
                    if (!currentValue) {
                        return showAlert("Por favor, ingrese un valor para editar.", "warning");
                    }
                       
                    currentEditingField = field;
                    currentEditingValue = currentValue;
                    editOptionInput.value = currentValue;
                    editOptionInput.placeholder = `Edite la opción para ${field}`;
                    openModalWithFocus(editOptionModal, editOptionInput);
                });
            });
            
            confirmEditOptionBtn.addEventListener('click', () => {
                const newValue = editOptionInput.value.trim();

                if (!newValue || !currentEditingField || !currentEditingValue) {
                    return;
                }

                closeModal(editOptionModal);
                
                const activeFormId = !newsModal.classList.contains('hidden') ? 'news-form' : 
                                     !editModal.classList.contains('hidden') ? 'edit-form' : null;
                
                const formStateBeforeEdit = activeFormId ? getFormState(activeFormId) : null;
                requirePassword(async () => {
                    try {
                        if (['proyectos', 'categorias', 'medios', 'subproyectos'].includes(currentEditingField)) {
                            await findAndReplaceInDatabase(currentEditingField, currentEditingValue, newValue, activeFormId, formStateBeforeEdit);
                        } else {
                            // Lógica para campos de texto (no afecta a otros campos)
                            let inputElement;
                            if (currentEditingField === 'fuente') {
                                inputElement = document.getElementById(activeFormId === 'news-form' ? 'news-source' : 'edit-news-source');
                            } else if (currentEditingField === 'cita') {
                                inputElement = document.getElementById(activeFormId === 'news-form' ? 'news-cita' : 'edit-news-cita');
                            } else if (currentEditingField === 'comentario') {
                                inputElement = document.getElementById(activeFormId === 'news-form' ? 'news-comment' : 'edit-news-comment');
                            } else if (currentEditingField === 'resumen') {
                                inputElement = document.getElementById(activeFormId === 'news-form' ? 'news-summary' : 'edit-news-summary');
                            }
                            
                            if (inputElement) {
                                inputElement.value = newValue;
                            }
                        }
                    } catch (dbErr) {
                        console.error('Error al actualizar la base de datos:', dbErr);
                        showAlert("Error al actualizar la opción", "error");
                    } finally {
                        activeSelectElement = null; // Limpiar el elemento activo
                    }
                });
            });
            cancelEditOptionBtn.addEventListener('click', () => {
                closeModal(editOptionModal);
                activeSelectElement = null;
            });
        }


        // =============================================
        // MÓDULO: Autenticación y seguridad
        // =============================================

        function verifyPassword() {
            const password = passwordInput.value;
            
            if (password === 'admin') {
                closeModal(passwordModal); // Usar la función closeModal mejorada
                passwordInput.value = '';
                if (pendingAction) {
                    pendingAction();
                    pendingAction = null;
                }
            } else {
                showAlert("Contraseña incorrecta", "error");
                passwordInput.value = '';
            }
        }

        function setupPasswordVerification() {
            confirmPasswordBtn.addEventListener('click', verifyPassword);
            cancelPasswordBtn.addEventListener('click', () => {
                closeModal(passwordModal);
                pendingAction = null;
            });
            
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });
        }

        function requirePassword(action, isAsync = false) {
            pendingAction = action;
            openModalWithFocus(passwordModal, passwordInput);
            
            if (isAsync) {
                return new Promise((resolve, reject) => {
                    const originalAction = pendingAction;
                    pendingAction = async () => {
                        try {
                            const result = await originalAction();
                            resolve(result);
                        } catch (error) {
                            reject(error);
                        }
                    };
                });
            }
        }

        //INICIALIZA APP CON AUTENTICACION

        async function initializeAppWithAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    userId = user.uid;
                    userInfo.textContent = `Usuario Anónimo: ${userId.substring(0, 8)}...`;
                    setupRealtimeListeners();
                    showApp();
                } else {
                    try {
                        await auth.signInAnonymously();
                    } catch (error) {
                        console.error("Error en autenticación anónima:", error);
                        showAlert("Error de conexión. Algunas funciones pueden no estar disponibles.", "warning");
                        // Mostrar la app de todos modos en modo offline
                        showApp();
                    }
                }
            });
        }
        
        //INICIALIZA LAS TABLAS Y DEMÁS

        function setupRealtimeListeners() {
            let noticiasCargadas = false;
            let historicoCargado = false;

            // Función para verificar si ambos están listos y ocultar el loader
            const checkAndHideLoader = () => {
                if (noticiasCargadas && historicoCargado) {
                showLoader(false); // ← Usa TU función existente
                }
            };

            // Listener para la colección de noticias
            newsCollectionRef.onSnapshot((snapshot) => {
                const startTotal = performance.now();
                console.log(`[NOTICIAS] Snapshot recibido en ${startTotal.toFixed(2)}ms`);

                // --- Paso 1: Procesamiento de datos ---
                const startProcessing = performance.now();
                news = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const endProcessing = performance.now();
                console.log(`[NOTICIAS] Procesamiento completado en ${(endProcessing - startProcessing).toFixed(2)}ms | Total docs: ${news.length}`);

                // --- Paso 2: Renderizado principal ---
                const startRender = performance.now();
                sortAndRenderTable(newsTableBody, news, false);
                const endRender = performance.now();
                console.log(`[NOTICIAS] sortAndRenderTable completado en ${(endRender - startRender).toFixed(2)}ms`);

                // --- Paso 3: Operaciones diferidas ---
                setTimeout(() => {
                const startAsync = performance.now();

                updateNewsMediosDashboard();
                updateDynamicSelectOptions();

                const alertCounts = calculateWeeklyAlertCounts();
                checkAndShowTrainAlerts(alertCounts);

                const endAsync = performance.now();
                console.log(`[NOTICIAS] Operaciones asíncronas completadas en ${(endAsync - startAsync).toFixed(2)}ms`);
                console.log(`[NOTICIAS] Tiempo total desde recepción: ${(endAsync - startTotal).toFixed(2)}ms`);
                }, 0);

                // Marcar como cargado
                noticiasCargadas = true;
                checkAndHideLoader(); // Verifica si ya puede ocultar el loader

            }, (error) => {
                console.error("Error en listener de noticias:", error);
                noticiasCargadas = true;
                checkAndHideLoader(); // No bloquear el loader si hay error
            });

            // Listener para la colección de histórico
            historicalNewsCollectionRef.onSnapshot((snapshot) => {
                const startTotal = performance.now();
                console.log(`[HISTÓRICO] Snapshot recibido en ${startTotal.toFixed(2)}ms`);

                // --- Paso 1: Procesamiento de datos ---
                const startProcessing = performance.now();
                historicalNews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const endProcessing = performance.now();
                console.log(`[HISTÓRICO] Procesamiento completado en ${(endProcessing - startProcessing).toFixed(2)}ms | Total docs: ${historicalNews.length}`);

                // --- Paso 2: Renderizado principal ---
                const startRender = performance.now();
                sortAndRenderTable(historicalTableBody, historicalNews, true);
                const endRender = performance.now();
                console.log(`[HISTÓRICO] sortAndRenderTable completado en ${(endRender - startRender).toFixed(2)}ms`);

                // --- Paso 3: Operaciones diferidas ---
                setTimeout(() => {
                const startAsync = performance.now();

                updateMediosDashboard();
                updateDynamicSelectOptions();

                const endAsync = performance.now();
                console.log(`[HISTÓRICO] Operaciones asíncronas completadas en ${(endAsync - startAsync).toFixed(2)}ms`);
                console.log(`[HISTÓRICO] Tiempo total desde recepción: ${(endAsync - startTotal).toFixed(2)}ms`);
                }, 0);

                // Marcar como cargado
                historicoCargado = true;
                checkAndHideLoader(); // Verifica si ya puede ocultar el loader

            }, (error) => {
                console.error("Error en listener de histórico:", error);
                historicoCargado = true;
                checkAndHideLoader(); // No bloquear el loader si hay error
            });

            // Mostrar loader al inicio de los listeners
            showLoader(true); // ← Usa TU función existente
        }


        /**
         * Actualiza el dashboard de medios basándose en los datos de Noticias.
         * Esta función ahora calcula sus propios contadores basándose en el array `news` global.
         */
        function updateNewsMediosDashboard() {
            // 1. Se inicializan los contadores dentro de la función.
            const counts = { noticias: 0, mananera: 0, evento: 0, informe: 0 };

            // 2. Se itera sobre el array `news` global para realizar los cálculos.
            news.forEach(newsItem => {
                if (newsItem.medio === "Conferencia de prensa matutina") {
                    counts.mananera++;
                } else if (newsItem.medio === "Evento Presidencial") {
                    counts.evento++;
                } else if (newsItem.medio === "Informe de Gobierno") {
                    counts.informe++;
                } else {
                    counts.noticias++;
                }
            });

            const totalElement = document.getElementById('news-medio-count-total');
            const mananeraElement = document.getElementById('news-medio-count-mananera');
            const eventoElement = document.getElementById('news-medio-count-evento');
            const informeElement = document.getElementById('news-medio-count-informe');

            if (totalElement) totalElement.textContent = counts.noticias;
            if (mananeraElement) mananeraElement.textContent = counts.mananera;
            if (eventoElement) eventoElement.textContent = counts.evento;
            if (informeElement) informeElement.textContent = counts.informe;
        }
        // =============================================
        // MÓDULO: Gráficos y reportes
        // =============================================
        
        /**
         * Obtiene y filtra los datos para los reportes según la configuración guardada.
         * @returns {Array} El conjunto de datos (news, historicalNews, o combinado) filtrado por fecha si aplica.
         */
        function getReportData() {
            const source = reportesDataSource.value;
            let baseData = [];

            if (source === 'noticias') baseData = news;
            else if (source === 'historico') baseData = historicalNews;
            else baseData = [...news, ...historicalNews];

            // Aplicar filtro de fecha si está configurado
            if (reportSettings.dateFilterMode === 'period' && reportSettings.startDate && reportSettings.endDate) {
                try {
                    return baseData.filter(item => {
                        // La comparación de strings 'YYYY-MM-DD' funciona correctamente para rangos.
                        return item.fecha && item.fecha >= reportSettings.startDate && item.fecha <= reportSettings.endDate;
                    });
                } catch (e) {
                    console.error("Error al filtrar fechas:", e);
                    return baseData; // Devuelve los datos sin filtrar en caso de error.
                }
            }
            return baseData; // Devuelve todos los datos si el filtro no está activo.
        }

        function updateCharts() {
            const source = reportesDataSource.value;
            let data = [];
            if (source === 'noticias') data = news;
            else if (source === 'historico') data = historicalNews;
            else data = [...news, ...historicalNews];
            
            if (charts.dynamic) charts.dynamic.destroy();
            if (charts.projectCategory) charts.projectCategory.destroy();
            if (charts.totalNewsByType) charts.totalNewsByType.destroy();

            // Update dynamic chart
            updateDynamicChart();
            updateProjectCategoryChart();
            updateTotalNewsByTypeChart();
        }
 
        /**
         * Navega a la pestaña de histórico y aplica los filtros especificados.
         * @param {string} targetTab - La pestaña de destino ('noticias' o 'historico').
         * @param {Object} filtersToApply - Un objeto donde las claves son los campos a filtrar y los valores son arrays de los valores a incluir.
         */
        function navigateAndFilter(targetTab, filtersToApply) {
            if (targetTab !== 'noticias' && targetTab !== 'historico') return;

            // 1. Cambiar a la pestaña correcta
            document.querySelector(`button[data-tab="${targetTab}"]`).click();

            const isHistorical = targetTab === 'historico';
            const filterKey = isHistorical ? 'historical' : 'main';
            const dataProvider = isHistorical ? () => historicalNews : () => news;
            const tableBody = isHistorical ? historicalTableBody : newsTableBody;
            const headerId = isHistorical ? 'historical-table-header' : 'main-table-header';
            const dashboardId = isHistorical ? 'tab-content-historico' : 'news-dashboard-medios';

            // 2. Limpiar filtros existentes en la tabla de destino
            isHistorical ? clearAllHistoricalFilters() : clearAllMainFilters();

            // --- INICIO DE LA MEJORA: Aplicar filtro de fecha si hay un periodo activo en reportes ---
            if (reportSettings.dateFilterMode === 'period' && reportSettings.startDate && reportSettings.endDate) {
                const dataForDateFiltering = dataProvider(); // Obtener todos los datos de la tabla de destino.
                
                // Encontrar todas las fechas únicas que caen dentro del rango del reporte.
                const datesInRange = [...new Set(
                    dataForDateFiltering
                        .filter(item => item.fecha && item.fecha >= reportSettings.startDate && item.fecha <= reportSettings.endDate)
                        .map(item => formatDate(item.fecha)) // Usar la fecha formateada, que es como el filtro la espera.
                )];

                // Añadir las fechas encontradas al objeto de filtros a aplicar.
                filtersToApply['fecha'] = datesInRange;
            }
            // --- FIN DE LA MEJORA ---

            // 3. Lógica de filtro especial para el dashboard de medios
            if (filtersToApply.medio) {
                const medioFilterValue = filtersToApply.medio[0];
                if (isHistorical) {
                    activeMedioDashboardFilter = medioFilterValue;
                } else {
                    activeNewsMedioFilter = medioFilterValue;
                }

                const indicator = document.querySelector(`#${dashboardId} .indicator-card[data-medio="${medioFilterValue}"]`);
                if (indicator) indicator.classList.add('active-filter');

                // Si el filtro es por tipo de medio, no lo aplicamos como filtro de columna
                if (medioFilterValue === '__NOTICIAS_ONLY__' || specialMedios.includes(medioFilterValue)) {
                    delete filtersToApply.medio;
                }
            }

            // 4. Aplicar los nuevos filtros de columna
            Object.entries(filtersToApply).forEach(([key, value]) => {
                activeFilters[filterKey][key] = Array.isArray(value) ? value : [value];
                const header = document.querySelector(`#${headerId} .filterable-header[data-filter-by="${key}"]`);
                if (header) header.classList.add('active');
            });

            // 5. Re-renderizar la tabla de destino con los filtros aplicados
            sortAndRenderTable(tableBody, dataProvider(), isHistorical);
        }

        function updateProjectCategoryChart() {
            const data = getReportData();
            const projectCategoryData = {};
            const projectTotals = {}; // Para ordenar los proyectos
            const allCategories = new Set();

            data.forEach(item => {
                if (specialMedios.includes(item.medio)) return; // Excluir conferencias de esta gráfica
                const project = item.proyecto || 'N/A';
                const category = item.categoria || 'N/A';

                // Contar el total por proyecto para ordenar
                projectTotals[project] = (projectTotals[project] || 0) + 1;

                if (project !== 'N/A' && category !== 'N/A') {
                    if (!projectCategoryData[project]) {
                        projectCategoryData[project] = {};
                    }
                    projectCategoryData[project][category] = (projectCategoryData[project][category] || 0) + 1;
                    allCategories.add(category);
                }
            });

            const sortedCategories = Array.from(allCategories).sort();
            // Ordenar los proyectos por el total de noticias, de mayor a menor
            const projects = Object.keys(projectCategoryData).sort((a, b) => {
                return (projectTotals[b] || 0) - (projectTotals[a] || 0);
            });

            // --- INICIO: Lógica de la tabla con totales ---
            const isClickable = reportesDataSource.value !== 'combinado';
            const table = document.getElementById('projectCategoryTable');
            // Encabezado con columna de Total
            table.querySelector('thead').innerHTML = `<tr><th>Proyecto</th>${sortedCategories.map(cat => `<th>${cat}</th>`).join('')}<th>Total</th></tr>`;
            
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            
            const categoryTotals = {};
            let grandTotal = 0;

            projects.forEach(project => {
                const row = document.createElement('tr');
                const clickableClass = isClickable ? 'clickable-cell hover:bg-slate-100 hover:text-primary' : '';
                let rowHTML = `<td class="${clickableClass}" data-filter-variable="proyecto" data-filter-value="${project}">${project}</td>`;
                let projectTotal = 0;

                sortedCategories.forEach(cat => {
                    const count = projectCategoryData[project][cat] || 0;
                    rowHTML += `<td class="${clickableClass}" data-filter-variable="proyecto" data-filter-value="${project}" data-filter-category="${cat}">${count}</td>`;
                    projectTotal += count;
                    categoryTotals[cat] = (categoryTotals[cat] || 0) + count;
                });

                // Añadir total horizontal (por proyecto)
                rowHTML += `<td class="font-bold">${projectTotal}</td>`;
                row.innerHTML = rowHTML;
                tbody.appendChild(row);
                grandTotal += projectTotal;
            });

            // Fila de totales verticales (tfoot)
            let footerHTML = `<tr class="bg-slate-200 font-bold"><td>Total</td>`;
            sortedCategories.forEach(cat => {
                footerHTML += `<td>${categoryTotals[cat] || 0}</td>`;
            });
            // Gran total
            footerHTML += `<td>${grandTotal}</td></tr>`;
            table.querySelector('tfoot').innerHTML = footerHTML;
            // --- FIN: Lógica de la tabla con totales ---

            // --- INICIO: Lógica del gráfico (sin cambios) ---
            const colors = ['#9C2348', '#A6802D', '#1E5B4F', '#64748B', '#3B82F6', '#F59E0B', '#10B981'];
            const datasets = sortedCategories.map((category, index) => ({
                label: category,
                data: projects.map(project => projectCategoryData[project][category] || 0),
                backgroundColor: colors[index % colors.length],
            }));

            if (charts.projectCategory) charts.projectCategory.destroy();

            charts.projectCategory = new Chart(document.getElementById('projectCategoryChart'), {
                type: 'bar',
                data: {
                    labels: projects,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: isProjectChartStacked },
                        y: { stacked: isProjectChartStacked, beginAtZero: true }
                    }
                }
            });
            // --- FIN: Lógica del gráfico ---
        }

        function updateDynamicChart() {
            const data = getReportData();
            // Filtrar los datos para excluir conferencias y eventos especiales, mostrando solo noticias.
            const onlyNewsData = data.filter(item => !specialMedios.includes(item.medio));

            const selectedVariable = dynamicChartVariable.value;
            const variableCounts = {};
            
            // Usar los datos filtrados (onlyNewsData) para contar las variables.
            onlyNewsData.forEach(newsItem => {
                const value = newsItem[selectedVariable] || 'N/A';
                variableCounts[value] = (variableCounts[value] || 0) + 1;
            });
            
            // Update dynamic table
            dynamicTableBody.innerHTML = '';
            dynamicTableHeader.textContent = selectedVariable.charAt(0).toUpperCase() + selectedVariable.slice(1);

            // --- INICIO DE LA MEJORA: Ordenar los datos por conteo descendente ---
            const sortedData = Object.entries(variableCounts).sort(([, a], [, b]) => b - a);
            // --- FIN DE LA MEJORA ---
            const isClickable = reportesDataSource.value !== 'combinado';

            let total = 0;

            // Usar los datos ordenados (sortedData) para renderizar la tabla
            sortedData.forEach(([value, count]) => {
                total += count;
                const clickableClass = isClickable ? 'clickable-cell hover:bg-slate-100 hover:text-primary' : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="clickable-cell hover:bg-slate-100 hover:text-primary" data-filter-variable="${selectedVariable}" data-filter-value="${value}">${value}</td>
                    <td class="clickable-cell hover:bg-slate-100 hover:text-primary" data-filter-variable="${selectedVariable}" data-filter-value="${value}">${count}</td>
                `;
                dynamicTableBody.appendChild(row);
            });

            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'bg-slate-200 font-bold';
            totalRow.innerHTML = `
                <td>Total</td>
                <td>${total}</td>
            `;
            dynamicTableBody.appendChild(totalRow);
            
            // Update dynamic chart
            if (charts.dynamic) charts.dynamic.destroy();
            
            // Usar los datos ordenados para la gráfica
            const labels = sortedData.map(([value]) => truncateText(value, 25));
            const chartData = sortedData.map(([, count]) => count);
            
            charts.dynamic = new Chart(dynamicChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad',
                        data: chartData,
                        backgroundColor: '#9C2348'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                display: showChartLabels,
                                maxRotation: showChartLabels ? 90 : 0,
                                minRotation: showChartLabels ? 45 : 0
                            }
                        }
                    }
                }
            });
        }
        
        function updateTotalNewsByTypeChart() {
            const data = getReportData();
            const counts = {
                noticias: 0,
                mananera: 0,
                evento: 0,
                informe: 0
            };

            data.forEach(item => {
                if (item.medio === "Conferencia de prensa matutina") counts.mananera++;
                else if (item.medio === "Evento Presidencial") counts.evento++;
                else if (item.medio === "Informe de Gobierno") counts.informe++;
                else counts.noticias++;
            });

            const tableBody = document.getElementById('totalNewsByTypeTableBody');
            const tableFoot = document.getElementById('totalNewsByTypeTable').querySelector('tfoot');
            tableBody.innerHTML = '';
            tableFoot.innerHTML = '';

            const isClickable = reportesDataSource.value !== 'combinado';
            const chartData = [
                { label: 'Noticias', count: counts.noticias, filterValue: '__NOTICIAS_ONLY__' },
                { label: 'Conferencia Matutina', count: counts.mananera, filterValue: 'Conferencia de prensa matutina' },
                { label: 'Evento Presidencial', count: counts.evento, filterValue: 'Evento Presidencial' },
                { label: 'Informe de Gobierno', count: counts.informe, filterValue: 'Informe de Gobierno' }
            ];

            let total = 0;
            chartData.forEach(item => {
                total += item.count;
                const clickableClass = isClickable ? 'clickable-cell hover:bg-slate-100 hover:text-primary' : '';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="${clickableClass}" data-filter-variable="medio" data-filter-value="${item.filterValue}">${item.label}</td>
                    <td class="${clickableClass}" data-filter-variable="medio" data-filter-value="${item.filterValue}">${item.count}</td>
                `;
                tableBody.appendChild(row);
            });

            // Fila de total
            const totalRow = document.createElement('tr');
            totalRow.className = 'bg-slate-200 font-bold';
            totalRow.innerHTML = `<td>Total</td><td>${total}</td>`;
            tableFoot.appendChild(totalRow);

            // Actualizar la gráfica
            if (charts.totalNewsByType) charts.totalNewsByType.destroy();

            charts.totalNewsByType = new Chart(document.getElementById('totalNewsByTypeChart'), {
                type: isTotalNewsChartPie ? 'pie' : 'bar',
                data: {
                    labels: chartData.map(d => d.label),
                    datasets: [{
                        label: 'Total de Registros',
                        data: chartData.map(d => d.count),
                        backgroundColor: [
                            '#9C2348', // Primary para Noticias
                            '#1E5B4F', // Accent para Mañanera
                            '#A6802D', // Secondary para Evento
                            '#64748B'  // Slate para Informe
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        // Ocultar ejes para la gráfica de pastel
                        y: { display: !isTotalNewsChartPie, beginAtZero: true },
                        x: { display: !isTotalNewsChartPie }
                    },
                    plugins: { 
                        // Mostrar leyenda para la gráfica de pastel, ocultarla para la de barras
                        legend: { display: isTotalNewsChartPie } 
                    }
                }
            });
        }

        function updateConferenceSummaryLabel(medio, labelElement) {
            let labelText = 'Resumen';
            if (medio === 'Conferencia de prensa matutina') {
                labelText = 'Resumen de la Conferencia';
            } else if (medio === 'Evento Presidencial') {
                labelText = 'Resumen del Evento';
            } else if (medio === 'Informe de Gobierno') {
                labelText = 'Resumen del Informe';
            }
            labelElement.textContent = labelText;
        }

        function populateConferenceMedioSelect(selectElementId) {
            const select = document.getElementById(selectElementId);
            select.innerHTML = specialMedios.map(medio => `<option value="${medio}">${medio}</option>`).join('');
        }


        // =============================================
        // MÓDULO: Exportación/Importación
        // =============================================

        const exportHeaders = [
            "No.", "Fecha", "Proyecto", "Subproyecto", "Categoría", "Noticia", "Cita", "Resumen", "Medio", "Enlace"
        ];

        function prepareExportData(data) {
            return data.map((newsItem, index) => ({
                "No.": index + 1, 
                "Fecha": formatDate(newsItem.fecha), 
                "Proyecto": newsItem.proyecto || "", 
                "Subproyecto": newsItem.subproyecto || "",
                "Categoría": newsItem.categoria || "",
                "Noticia": newsItem.comentario || "",
                "Cita": newsItem.cita || "",
                "Resumen": htmlToPlainText(newsItem.resumen) || "", //desactivada para exportar en HTML               
                //"Resumen": newsItem.resumen || "", // Exportar el HTML directamente para preservar el formato
                "Medio": newsItem.medio || "",
                "Enlace": newsItem.fuente || ""
            }));
        }

        /**
         * Exporta datos a un archivo Excel con formato personalizado.
         * @param {Array} data - Los datos a exportar.
         * @param {string} sheetName - El nombre de la hoja de Excel.
         * @param {string} fileName - El nombre del archivo a descargar.
         */
        function exportToExcelWithFormatting(data, sheetName, fileName) {
            if (data.length === 0) {
                return showAlert("No hay datos en la tabla para descargar.", "warning");
            }

            // 1. Crear estilos
            const titleStyle = {
                font: { name: "Noto Sans", sz: 12, bold: true },
            };
            const headerStyle = {
                font: { name: "Noto Sans", sz: 11, bold: true, color: { rgb: "FFFFFF" } },
                alignment: { horizontal: "center", vertical: "center" },
                fill: { fgColor: { rgb: "9C2348" } },
                border: {
                    top: { style: "thin" },
                    bottom: { style: "thin" },
                    left: { style: "thin" },
                    right: { style: "thin" },
                },
            };
            const cellStyle = {
                font: { name: "Noto Sans", sz: 10 },
                border: {
                    top: { style: "thin" },
                    bottom: { style: "thin" },
                    left: { style: "thin" },
                    right: { style: "thin" },
                },
            };
            const centeredCellStyle = {
                ...cellStyle, // Hereda el estilo base
                alignment: { horizontal: "center", vertical: "center" }
            };

            // 2. Preparar los datos
            const longDate = formatLongDate(new Date().toISOString().split('T')[0]);
            const title = `Noticias y Conferencias de Proyectos Ferroviarios al ${longDate}`;
            
            // Fila de título
            const titleRow = [[title]];

            // Fila de encabezados
            const headerRow = [exportHeaders];

            // Filas de datos (sin el campo "No." que se genera dinámicamente)
            const dataRows = data.map((item, index) => [
                index + 1,
                item["Fecha"],
                item["Proyecto"],
                item["Subproyecto"],
                item["Categoría"],
                item["Noticia"],
                item["Cita"],
                item["Resumen"],
                item["Medio"],
                item["Enlace"]
            ]);

            // Combinar todo
            const finalData = [...titleRow, ...headerRow, ...dataRows];

            // 3. Crear la hoja de cálculo
            const ws = XLSX.utils.aoa_to_sheet(finalData);

            // 4. Aplicar estilos
            // Título en A1
            ws["A1"].s = titleStyle;

            // Encabezados en la fila 2
            const headerRange = XLSX.utils.decode_range(ws['!ref']);
            for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
                const cellAddress = XLSX.utils.encode_cell({ r: 1, c: C });
                if (ws[cellAddress]) ws[cellAddress].s = headerStyle;
            }

            // Datos y bordes para toda la tabla (desde la fila 2)
            for (let R = 1; R <= headerRange.e.r; ++R) {
                for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
                    // Columnas a centrar: No.(0), Fecha(1), Proyecto(2), Subproyecto(3), Categoría(4), Medio(8)
                    const columnsToCenter = [0, 1, 2, 3, 4, 8];

                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    if (ws[cellAddress]) {
                        if (R === 1) { // Fila de encabezado
                            ws[cellAddress].s = headerStyle;
                        } else { // Filas de datos
                            if (columnsToCenter.includes(C)) {
                                ws[cellAddress].s = centeredCellStyle;
                            } else {
                                ws[cellAddress].s = cellStyle;
                            }
                        }
                    }
                }
            }

            // 5. Ajustar anchos de columna
            ws['!cols'] = [
                { wch: 5 }, // Columna "No."
                { wch: 12 }, // Fecha
                { wch: 30 }, // Proyecto
                { wch: 30 }, // Subproyecto
                { wch: 25 }, // Categoría
                { wch: 50 }, // Noticia
                { wch: 50 }, // Cita
                { wch: 60 }, // Resumen
                { wch: 30 }, // Medio
                { wch: 40 }, // Enlace
            ];

            // 6. Generar y descargar el archivo
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, fileName);
        }

        /**
         * Exporta una tabla HTML a un archivo Excel con formato profesional.
         * @param {string} tableId - El ID de la tabla HTML a exportar.
         * @param {string} sheetName - El nombre para la hoja de Excel.
         * @param {string} fileName - El nombre del archivo a descargar.
         */
        function exportTableToExcel(tableId, sheetName, fileName) {
            const table = document.getElementById(tableId);
            if (!table) {
                showAlert("No se encontró la tabla para exportar.", "error");
                return;
            }
        
            // 1. Extraer datos y encabezados de la tabla HTML
            const headers = [];
            const data = [];
            const merges = []; // Para las celdas combinadas del encabezado
        
            // Procesar encabezados (thead)
             const headerRows = Array.from(table.querySelectorAll('thead tr'));
             headerRows.forEach((tr, rowIndex) => {
                 if (!headers[rowIndex]) headers[rowIndex] = [];
                 let colIndex = 0;
                 Array.from(tr.children).forEach(th => {
                     // Saltar columnas ya ocupadas por un rowspan de una fila anterior
                     while (headers[rowIndex][colIndex] !== undefined) {
                         colIndex++;
                     }
 
                     const colspan = parseInt(th.getAttribute('colspan') || '1');
                     const rowspan = parseInt(th.getAttribute('rowspan') || '1');
                     
                     // Registrar la fusión de celdas
                     if (rowspan > 1 || colspan > 1) {
                         merges.push({ s: { r: rowIndex, c: colIndex }, e: { r: rowIndex + rowspan - 1, c: colIndex + colspan - 1 } });
                     }
 
                     // Rellenar la matriz de encabezados, marcando las celdas ocupadas por la fusión
                     for (let r = 0; r < rowspan; r++) {
                         if (!headers[rowIndex + r]) headers[rowIndex + r] = [];
                         for (let c = 0; c < colspan; c++) {
                             // La celda principal obtiene el texto, las demás se marcan como ocupadas
                             headers[rowIndex + r][colIndex + c] = (r === 0 && c === 0) ? th.innerText : null;
                         }
                     }
                     colIndex += colspan;
                 });
             });
 
             // Limpiar los valores nulos que se usaron para marcar celdas ocupadas
             headers.forEach(row => {
                 for (let i = 0; i < row.length; i++) {
                     if (row[i] === null) row[i] = '';
                 }
             });
        
            // Procesar cuerpo de la tabla (tbody) y pie (tfoot)
            table.querySelectorAll('tbody tr, tfoot tr').forEach(tr => {
                const rowData = [];
                tr.querySelectorAll('td').forEach(td => {
                    let cellValue = td.innerText;
                    // Convertir a número si es un valor monetario
                    if (cellValue.startsWith('$')) {
                        cellValue = parseFloat(cellValue.replace(/[$,]/g, ''));
                    } else if (!isNaN(cellValue) && cellValue.trim() !== '') {
                        // Convertir a número si es un string numérico (para conteos)
                        cellValue = Number(cellValue);
                    }
                    rowData.push(cellValue);
                });
                data.push(rowData);
            });
        
            // 2. Crear la hoja de cálculo
            const ws = XLSX.utils.aoa_to_sheet([...headers, ...data]);
        
            // 3. Definir y aplicar estilos
            const headerStyle = { font: { name: "Noto Sans", sz: 11, bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "9C2348" } }, alignment: { horizontal: "center", vertical: "center" }, border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } } };
            const totalRowStyle = { font: { name: "Noto Sans", sz: 11, bold: true }, fill: { fgColor: { rgb: "E2E8F0" } }, alignment: { horizontal: "center", vertical: "center" }, border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } } };
            const cellStyle = { font: { name: "Noto Sans", sz: 10 }, alignment: { horizontal: "center", vertical: "center" }, border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } } };
            const currencyStyle = { numFmt: "$#,##0.00" };
        
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
                    if (!ws[cell_ref]) continue;
                    ws[cell_ref].s = (R < headers.length) ? headerStyle : (ws[XLSX.utils.encode_cell({c: 0, r: R})]?.v === 'Total' ? totalRowStyle : cellStyle);
                    if (typeof ws[cell_ref].v === 'number' && String(ws[cell_ref].v).includes('.')) ws[cell_ref].s = { ...ws[cell_ref].s, numFmt: currencyStyle.numFmt };
                }
            }
        
            // 4. Aplicar fusiones y anchos de columna
            ws['!merges'] = merges;
            ws['!cols'] = Array((headers[0] || data[0] || []).length).fill({ wch: 20 });
        
            // 5. Generar y descargar el libro de trabajo
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, fileName);
        }

        // =============================================
        // MÓDULO: Migración de datos
        // =============================================
        
        async function migrateSelectedNewsToHistorical() {
            try {
                if (selectedNewsIdsToMigrate.size === 0) {
                    showAlert("No hay noticias seleccionadas para migrar.", "warning");
                    return;
                }
                
                showLoader(true);
                
                const batch = db.batch();
                // Obtener los datos filtrados actualmente en la tabla para solo migrar lo visible
                const currentlyVisibleNews = applyAllFilters(news, 'main');
                const newsToMigrate = currentlyVisibleNews.filter(item => selectedNewsIdsToMigrate.has(item.id));


                if (newsToMigrate.length === 0) return; // Doble verificación

                // --- Migración segura por chunks (forward) ---
                const CHUNK_SIZE = 450; // mantener por debajo de 500 (límite de writes por batch)
                const chunks = chunkArray(newsToMigrate, CHUNK_SIZE);
                let migratedCount = 0;

                for (let ci = 0; ci < chunks.length; ci++) {
                    const chunk = chunks[ci];
                    const batchChunk = db.batch();

                    chunk.forEach(newsItem => {
                        const historicalDocRef = historicalNewsCollectionRef.doc();
                        const { id } = newsItem;
                        const newsData = resolveNewsDataFromItem(newsItem);

                        batchChunk.set(historicalDocRef, {
                            ...newsData,
                            migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            originalId: id || newsItem.id || null
                        });

                        const newsDocRef = newsCollectionRef.doc(newsItem.id);
                        batchChunk.delete(newsDocRef);
                    });

                    // Intento con reintentos simples y backoff
                    let committed = false;
                    let attempt = 0;
                    const maxAttempts = 3;
                    while (!committed && attempt < maxAttempts) {
                        try {
                            await batchChunk.commit();
                            committed = true;
                            migratedCount += chunk.length;
                            console.log(`Forward migration: committed chunk ${ci + 1}/${chunks.length} (${chunk.length} docs).`);
                        } catch (err) {
                            attempt++;
                            const backoff = 300 * Math.pow(2, attempt);
                            console.warn(`Forward migration: commit failed (attempt ${attempt}) — retrying in ${backoff}ms`, err);
                            await sleep(backoff);
                        }
                    }
                    if (!committed) {
                        throw new Error(`Forward migration: fallo persistente al commitear chunk ${ci + 1}`);
                    }

                    // Pequeña pausa entre chunks para evitar throttling
                    await sleep(200);
                }

                showAlert(`Se migraron ${migratedCount} noticias al histórico.`, "success");
            } catch (error) {
                console.error("Error al migrar noticias:", error);
                showAlert(`Error al migrar: ${error.message}`, "error");
            } finally {
                showLoader(false);
                // Salir del modo migración después de completar
                toggleMigrationMode(false);
            }
        }

        function toggleMigrationMode(activate) {
            isMigrationModeActive = activate;
            selectedNewsIdsToMigrate.clear();

            // Referencias a los botones dentro de la función para asegurar que existen
            const startBtn = document.getElementById('start-migration-btn');
            const confirmBtn = document.getElementById('confirm-migration-btn');
            const cancelBtn = document.getElementById('cancel-migration-btn');
            const selectAllCheckbox = document.getElementById('select-all-news-checkbox');

            // Alternar visibilidad de botones
            startBtn.classList.toggle('hidden', activate);
            confirmBtn.classList.toggle('hidden', !activate);
            cancelBtn.classList.toggle('hidden', !activate);
            confirmBtn.disabled = true; // Siempre deshabilitar al entrar/salir del modo

            // Alternar visibilidad de la columna de checkboxes
            document.querySelectorAll('.migration-select-col').forEach(col => col.classList.toggle('hidden', !activate));

            // Re-renderizar la tabla principal para mostrar/ocultar los checkboxes en las filas
            sortAndRenderTable(newsTableBody, news, false);
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
        }

        // --- INICIO: Funciones para Migración Inversa ---

        function toggleReverseMigrationMode(activate) {
            isReverseMigrationModeActive = activate;
            selectedHistoricalNewsIdsToMigrate.clear();

            const startBtn = document.getElementById('start-reverse-migration-btn');
            const confirmBtn = document.getElementById('confirm-reverse-migration-btn');
            const cancelBtn = document.getElementById('cancel-reverse-migration-btn');

            startBtn.classList.toggle('hidden', activate);
            confirmBtn.classList.toggle('hidden', !activate);
            cancelBtn.classList.toggle('hidden', !activate);
            confirmBtn.disabled = true;

            document.querySelectorAll('.reverse-migration-select-col').forEach(col => col.classList.toggle('hidden', !activate));
            
            sortAndRenderTable(historicalTableBody, historicalNews, true);
            const selectAllCheckbox = document.getElementById('select-all-historical-news-checkbox');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;

        }

        async function migrateSelectedNewsToRegistry() {
            try {
                if (selectedHistoricalNewsIdsToMigrate.size === 0) {
                    showAlert("No hay noticias seleccionadas para migrar.", "warning");
                    return;
                }

                showLoader(true);

                // Obtener los datos filtrados actualmente en la tabla para solo migrar lo visible
                const currentlyVisibleNews = applyAllFilters(historicalNews, 'historical');
                const newsToMigrate = currentlyVisibleNews.filter(item => selectedHistoricalNewsIdsToMigrate.has(item.id));

                if (newsToMigrate.length === 0) {
                    showAlert("No hay noticias visibles seleccionadas para migrar.", "warning");
                    return;
                }

                const CHUNK_SIZE = 450;
                const chunks = chunkArray(newsToMigrate, CHUNK_SIZE);
                let migratedCount = 0;

                for (let ci = 0; ci < chunks.length; ci++) {
                    const chunk = chunks[ci];
                    const batchChunk = db.batch();

                    chunk.forEach(newsItem => {
                        const newNewsDocRef = newsCollectionRef.doc();
                        // resolver datos seguros (no usar destructuring inválido)
                        const newsData = resolveNewsDataFromItem(newsItem);
                        batchChunk.set(newNewsDocRef, {
                            ...newsData,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            restoredFromHistoricalId: newsItem.id || null
                        });

                        const historicalDocRef = historicalNewsCollectionRef.doc(newsItem.id);
                        batchChunk.delete(historicalDocRef);
                    });

                    // commit con reintentos simples y backoff
                    let committed = false;
                    let attempt = 0;
                    const maxAttempts = 3;
                    while (!committed && attempt < maxAttempts) {
                        try {
                            await batchChunk.commit();
                            committed = true;
                            migratedCount += chunk.length;
                            console.log(`Reverse migration: committed chunk ${ci + 1}/${chunks.length} (${chunk.length} docs).`);
                        } catch (err) {
                            attempt++;
                            const backoff = 300 * Math.pow(2, attempt);
                            console.warn(`Reverse migration: commit failed (attempt ${attempt}) — retrying in ${backoff}ms`, err);
                            await sleep(backoff);
                        }
                    }
                    if (!committed) {
                        throw new Error(`Reverse migration: fallo persistente al commitear chunk ${ci + 1}`);
                    }

                    await sleep(200);
                }

                showAlert(`Se migraron ${migratedCount} noticias al registro principal.`, "success");
            } catch (error) {
                console.error("Error en la migración inversa:", error);
                showAlert(`Error en la migración inversa: ${error.message}`, "error");
            } finally {
                showLoader(false);
                toggleReverseMigrationMode(false);
            }
        }

        // --- FIN: Funciones para Migración Inversa ---

        // Añadir función showLoader si no existe
        function showLoader(show) {
            const loaderElement = document.getElementById('loader');
            if (loaderElement) {
                loaderElement.style.display = show ? 'flex' : 'none';
            }
        }

        function handleRowDoubleClick(e, isHistorical) {
            const row = e.target.closest('tr');
            // Se previene la acción si se hace clic en un botón o en el span del enlace
            if (!row || e.target.closest('button') || e.target.closest('.link-cell')) {
                return; // No hacer nada si se hace clic en un botón o en el enlace
            }
            const newsId = row.querySelector('.edit-btn')?.dataset.id;
            if (!newsId) return;

            const data = isHistorical ? historicalNews : news;
            const newsItem = data.find(item => item.id === newsId);
            showDetailsModal(newsItem, isHistorical);
        }

        async function handleGenerateDocClick(button) {
            const newsId = button.dataset.id;
            const isHistorical = button.dataset.isHistorical === 'true';
            
            // Deshabilitar el botón para evitar múltiples clics
            button.disabled = true;
            const originalIcon = button.innerHTML;
            button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                // Llamada a la función de generación de documento
                await generateDoc(newsId, isHistorical);
            } finally {
                // Rehabilitar el botón y restaurar su ícono original
                button.innerHTML = originalIcon;
                button.disabled = false;
            }
        }

        // =============================================
        // MÓDULO: Notificación de Resumen Semanal (Adaptado de Llamadas)
        // =============================================
        function getWeekRange() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 (Dom) - 6 (Sáb)
            const diffToMonday = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Ajuste para que la semana empiece en Lunes
            
            const startOfWeek = new Date(now.setDate(diffToMonday));
            startOfWeek.setHours(0, 0, 0, 0);

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            return { start: startOfWeek, end: endOfWeek };
        }

        function calculateWeeklyAlertCounts() {
            // 1. Se obtienen las fechas de la semana y se inicializan los contadores.
            const { start, end } = getWeekRange();
            const alertCounts = { mananera: 0, evento: 0, informe: 0 };
        
            // 2. Se itera sobre el array `news` global para contar los registros de la semana.
            news.forEach(newsItem => {
                try {
                    const newsDate = new Date(newsItem.fecha);
                    if (newsDate >= start && newsDate <= end) {
                        if (newsItem.medio === "Conferencia de prensa matutina") alertCounts.mananera++;
                        else if (newsItem.medio === "Evento Presidencial") alertCounts.evento++;
                        else if (newsItem.medio === "Informe de Gobierno") alertCounts.informe++;
                    }
                } catch (e) { /* Ignorar fechas inválidas */ }
            });
        
            return alertCounts;
        }

        function checkAndShowTrainAlerts(alertCounts) {
            if (weeklyAlertsShown) return;
            if (alertCounts.mananera === 0 && alertCounts.evento === 0 && alertCounts.informe === 0) return;

            const alertsToShow = [
                { count: alertCounts.mananera, medio: "Conferencia de prensa matutina", target: "news-medio-indicator-mananera", icon: "fa-microphone-lines", color: "text-accent" },
                { count: alertCounts.evento, medio: "Evento Presidencial", target: "news-medio-indicator-evento", icon: "fa-users-rays", color: "text-secondary" },
                { count: alertCounts.informe, medio: "Informe de Gobierno", target: "news-medio-indicator-informe", icon: "fa-landmark-flag", color: "text-slate-500" }
            ];

            const wrapper = document.getElementById('notifications-wrapper');

            alertsToShow.forEach(alertInfo => {
                if (alertInfo.count > 0) {
                    const alertId = `train-alert-${alertInfo.target}`;
                    const alertHTML = `
                        <div id="${alertId}" data-target="${alertInfo.target}" class="train-alert bg-white rounded-xl shadow-2xl border border-slate-200 overflow-hidden cursor-pointer">
                            <div class="p-4">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <i class="fa-solid ${alertInfo.icon} ${alertInfo.color} text-xl"></i>
                                    </div>
                                    <div class="ml-3 w-0 flex-1 pt-0.5">
                                        <p class="text-sm font-bold text-slate-800">${alertInfo.medio}</p>
                                        <p class="mt-2 text-sm text-slate-600">Hay <strong>${alertInfo.count}</strong> registro(s) esta semana.</p>
                                    </div>
                                    <div class="ml-4 flex-shrink-0 flex">
                                        <button class="close-train-alert-btn bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                            <span class="sr-only">Cerrar</span>
                                            <i class="fa-solid fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    wrapper.insertAdjacentHTML('beforeend', alertHTML);
                    const newAlert = document.getElementById(alertId);
                    newAlert.classList.add('alert-enter');

                    // Set timeout for this specific alert
                    const timeoutId = setTimeout(() => newAlert.querySelector('.close-train-alert-btn').click(), 15000);
                    newAlert.dataset.timeoutId = timeoutId;
                }
            });

            weeklyAlertsShown = true;
        }

        function setupTrainAlertsListeners() {
            document.getElementById('notifications-wrapper').addEventListener('click', (e) => {
                const alertDiv = e.target.closest('.train-alert');
                const closeBtn = e.target.closest('.close-train-alert-btn');

                if (closeBtn) {
                    // Si se hace clic en el botón de cerrar, solo se cierra.
                    clearTimeout(alertDiv.dataset.timeoutId);
                    alertDiv.classList.remove('alert-enter');
                    alertDiv.classList.add('alert-leave');
                    setTimeout(() => alertDiv.remove(), 500);
                } else if (alertDiv) { // Si se hace clic en cualquier otra parte de la alerta
                    // Si se hace clic en cualquier otra parte de la notificación, se activa la vista.
                    document.querySelector('button[data-tab="noticias"]').click();
                    const targetIndicator = document.getElementById(alertDiv.dataset.target);
                    if (targetIndicator) targetIndicator.click();
                    // Y también se cierra la notificación.
                    clearTimeout(alertDiv.dataset.timeoutId);
                    alertDiv.classList.remove('alert-enter');
                    alertDiv.classList.add('alert-leave');
                    setTimeout(() => alertDiv.remove(), 500);
                }
            });

            document.getElementById('notifications-wrapper').addEventListener('mouseenter', (e) => {
                const alertDiv = e.target.closest('.train-alert');
                if (alertDiv) clearTimeout(alertDiv.dataset.timeoutId);
            }, true);

            document.getElementById('notifications-wrapper').addEventListener('mouseleave', (e) => {
                const alertDiv = e.target.closest('.train-alert');
                if (alertDiv) {
                    const timeoutId = setTimeout(() => alertDiv.querySelector('.close-train-alert-btn').click(), 15000);
                    alertDiv.dataset.timeoutId = timeoutId;
                }
            }, true);
        }

        // =============================================
        // MÓDULO: Configuración de eventos
        // =============================================
        
        function setupEventListeners() {
            setupTabs();
            setupColumnFilters('main-table-header', () => news, renderTable, 'main');
            setupColumnFilters('historical-table-header', () => historicalNews, renderTable, 'historical');
            setupFiltering('filter-input-main', () => news, renderTable, false);
            setupFiltering('filter-input-historical', () => historicalNews, renderTable, true);
            setupNewsMediosDashboardFilter();
            setupAddEditButtons();
            setupPasswordVerification();
            setupTrainAlertsListeners();
            setupQuickViewTooltip();
            
            reportesDataSource.addEventListener('change', updateCharts);
            dynamicChartVariable.addEventListener('change', updateDynamicChart);
            
            toggleLabelsBtn.addEventListener('click', () => {
                if (!charts.dynamic) return; // Prevenir error si el chart no existe

                showChartLabels = !showChartLabels;
                const icon = toggleLabelsBtn.querySelector('i');
                toggleLabelsBtn.classList.toggle('bg-primary', showChartLabels);
                toggleLabelsBtn.classList.toggle('text-white', showChartLabels);
                toggleLabelsBtn.classList.toggle('bg-slate-200', !showChartLabels);
                toggleLabelsBtn.classList.toggle('text-slate-700', !showChartLabels);
                icon.className = showChartLabels ? 'fa-solid fa-eye' : 'fa-solid fa-eye-slash';
                toggleLabelsBtn.title = showChartLabels ? 'Ocultar etiquetas del eje X' : 'Mostrar etiquetas del eje X';
                updateDynamicChart();
            });

            // Fortalecer la responsividad de las gráficas al cambiar el tamaño de la ventana (zoom)
            window.addEventListener('resize', updateCharts);

            // Inicializar el estado visual del botón de etiquetas
            toggleLabelsBtn.click(); toggleLabelsBtn.click(); // Doble clic para inicializar sin cambiar el estado
            // Listener para el nuevo botón de tipo de gráfica
            document.getElementById('toggle-chart-type-btn').addEventListener('click', (e) => {
                isProjectChartStacked = !isProjectChartStacked;
                const button = e.currentTarget;
                const icon = button.querySelector('i');
                
                button.classList.toggle('bg-primary', isProjectChartStacked);
                button.classList.toggle('text-white', isProjectChartStacked);
                button.classList.toggle('bg-slate-200', !isProjectChartStacked);
                button.classList.toggle('text-slate-700', !isProjectChartStacked);
                button.title = isProjectChartStacked ? "Cambiar a Gráfica Agrupada" : "Cambiar a Gráfica Apilada";
                icon.className = isProjectChartStacked ? 'fa-solid fa-layer-group' : 'fa-solid fa-chart-bar';
                updateProjectCategoryChart();
            });

            // Listener para el nuevo botón de tipo de gráfica de totales
            document.getElementById('toggle-total-news-chart-type-btn').addEventListener('click', (e) => {
                isTotalNewsChartPie = !isTotalNewsChartPie;
                const button = e.currentTarget;
                const icon = button.querySelector('i');

                button.classList.toggle('bg-primary', isTotalNewsChartPie);
                button.classList.toggle('text-white', isTotalNewsChartPie);
                button.classList.toggle('bg-slate-200', !isTotalNewsChartPie);
                button.classList.toggle('text-slate-700', !isTotalNewsChartPie);
                button.title = isTotalNewsChartPie ? "Cambiar a Gráfica de Barras" : "Cambiar a Gráfica de Pastel";
                icon.className = isTotalNewsChartPie ? 'fa-solid fa-chart-bar' : 'fa-solid fa-chart-pie';
                updateTotalNewsByTypeChart();
            });

            // Listener para la tabla de distribución dinámica (Reportes)
            dynamicTableBody.addEventListener('click', e => {
                const cell = e.target.closest('td.clickable-cell');
                if (!cell) return; // Solo actuar si la celda es clickeable

                const { filterVariable, filterValue } = cell.dataset;
                const targetTab = reportesDataSource.value; // 'noticias' o 'historico'
                
                if (filterVariable && filterValue && filterValue !== 'Total') {
                    navigateAndFilter(targetTab, { [filterVariable]: [filterValue] });
                }
            });

            // Listener para la tabla de proyectos por categoría (Reportes)
            document.getElementById('projectCategoryTable').addEventListener('click', e => {
                const cell = e.target.closest('td.clickable-cell');
                if (!cell) return; // Solo actuar si la celda es clickeable
        
                // Extraer todos los posibles datos de filtro de la celda
                const { filterVariable, filterValue, filterCategory } = cell.dataset;
                const filtersToApply = {};
                const targetTab = reportesDataSource.value;
        
                // Construir el objeto de filtros combinando los datos disponibles
                if (filterVariable && filterValue) {
                    filtersToApply[filterVariable] = [filterValue];
                }
                if (filterCategory) {
                    filtersToApply['categoria'] = [filterCategory];
                }
        
                if (Object.keys(filtersToApply).length > 0) {
                    navigateAndFilter(targetTab, filtersToApply);
                }
            });
            
            // Inicializar el estado visual del botón de tipo de gráfica
            document.getElementById('toggle-chart-type-btn').click(); document.getElementById('toggle-chart-type-btn').click();
            
            addNewsBtn.addEventListener('click', () => {
                // Clear form
                newsForm.reset();
                $('#news-project, #news-subproject, #news-category, #news-medio').val(null).trigger('change');

                // Limpiar el editor de texto
                document.getElementById('news-summary').innerHTML = '';

                // Establecer la fecha de hoy DESPUÉS de resetear el formulario
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('news-date').value = today;
                
                openModalWithFocus(newsModal, document.getElementById('news-source'));
            });
            
            addConferenceBtn.addEventListener('click', () => {
                conferenceForm.reset();
                document.getElementById('conference-summary').innerHTML = '';
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('conference-date').value = today;

                populateConferenceMedioSelect('conference-medio');
                // Actualizar la etiqueta del resumen basado en la opción por defecto
                const defaultMedio = document.getElementById('conference-medio').value;
                const summaryLabel = document.getElementById('conference-summary-label');
                updateConferenceSummaryLabel(defaultMedio, summaryLabel);

                openModalWithFocus(conferenceModal, document.getElementById('conference-date'));
            });

            closeConferenceModalBtn.addEventListener('click', () => closeModal(conferenceModal));

            conferenceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!conferenceForm.checkValidity()) {
                    return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                }
                
                // Construir el objeto de datos manualmente para evitar el objeto File
                const conferenceData = {
                    fecha: document.getElementById('conference-date').value,
                    medio: document.getElementById('conference-medio').value,
                    fuente: document.getElementById('conference-source').value,
                    resumen: document.getElementById('conference-summary').innerHTML,
                    conferenceDocx: await processFile(document.getElementById('conference-docx')),
                    // Añadir campos vacíos para mantener la estructura de datos consistente
                    proyecto: '', subproyecto: '', categoria: '', comentario: '', cita: ''
                };

                saveNews(conferenceData);
                closeModal(conferenceModal);
            });

            closeModalBtn.addEventListener('click', () => closeModal(newsModal));
            
            newsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!newsForm.checkValidity()) {
                    return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                }
                
                const formData = new FormData(newsForm);
                const newsData = Object.fromEntries(formData.entries());

                // Obtener el contenido HTML del editor y sobrescribir el resumen
                newsData.resumen = document.getElementById('news-summary').innerHTML;
                
                saveNews(newsData);
                closeModal(newsModal);
            });
            
            closeEditModalBtn.addEventListener('click', () => closeModal(editModal));
            closeEditConferenceModalBtn.addEventListener('click', () => closeModal(editConferenceModal));

            editConferenceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!editConferenceForm.checkValidity()) {
                    return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                }

                const id = document.getElementById('edit-conference-id').value;
                const newDocxFile = await processFile(document.getElementById('edit-conference-docx'));
                
                // Construir el objeto de datos manualmente para evitar el objeto File
                const updateData = {
                    fecha: document.getElementById('edit-conference-date').value,
                    medio: document.getElementById('edit-conference-medio').value,
                    fuente: document.getElementById('edit-conference-source').value,
                    resumen: document.getElementById('edit-conference-summary').innerHTML,                    
                    // Añadir campos vacíos para mantener la estructura de datos consistente
                    proyecto: '', subproyecto: '', categoria: '', comentario: '', cita: ''
                };

                // SOLUCIÓN: Solo actualizar el documento si se ha cargado uno nuevo.
                // Si no, el documento existente en la base de datos se preservará.
                if (newDocxFile) {
                    updateData.conferenceDocx = newDocxFile;
                }

                await updateNews(id, updateData, currentEditIsHistorical);
                closeModal(editConferenceModal);
            });
            
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!editForm.checkValidity()) {
                    return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                }
                
                const formData = new FormData(editForm);
                const updateData = Object.fromEntries(formData.entries());
                const id = document.getElementById('edit-id').value;

                // Obtener el contenido HTML del editor y sobrescribir el resumen
                updateData.resumen = document.getElementById('edit-news-summary').innerHTML;
                
                await updateNews(id, updateData, currentEditIsHistorical);
                closeModal(editModal);
            });

            let newsToDeleteId = null;
            let newsToDeleteIsHistorical = false;

            function handleDeleteClick(button) {
                requirePassword(() => {
                    newsToDeleteId = button.dataset.id;
                    newsToDeleteIsHistorical = button.dataset.isHistorical === 'true';
                    openModal(confirmModal);
                });
            }

            // comentadas para verificar si la mejora es correcta....
            //newsTableBody.addEventListener('click', handleTableClick);
            //historicalTableBody.addEventListener('click', handleTableClick);

            // CÓDIGO NUEVO Y MEJORADO
            function handlePrimaryTableClick(e) {
                // Primero, ejecuta el manejador de acciones de botones
                handleTableClick(e);

                // Si el clic fue en un botón o enlace, la función anterior ya hizo 'return',
                // así que no necesitamos preocuparnos. Ahora manejamos el clic en la fila.
                if (isMigrationModeActive) {
                    const row = e.target.closest('tr');
                    // Asegurarnos de no activar esto si se hizo clic en un botón o enlace
                    if (row && !e.target.closest('button, a, .link-cell')) {
                        const checkbox = row.querySelector('.news-migration-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            // Disparamos el evento 'change' para que la lógica de selección se active
                            checkbox.dispatchEvent(new Event('change', { 'bubbles': true }));
                        }
                    }
                }
            }

            function handleHistoricalTableClick(e) {
                // Primero, ejecuta el manejador de acciones de botones
                handleTableClick(e);

                // Lógica para la tabla de histórico
                if (isReverseMigrationModeActive) {
                    const row = e.target.closest('tr');
                    if (row && !e.target.closest('button, a, .link-cell')) {
                        const checkbox = row.querySelector('.historical-news-migration-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change', { 'bubbles': true }));
                        }
                    }
                }
            }

            // Asignamos los nuevos manejadores mejorados
            newsTableBody.addEventListener('click', handlePrimaryTableClick);
            historicalTableBody.addEventListener('click', handleHistoricalTableClick);



            if (document.getElementById('save-report-settings-btn')) {
                document.getElementById('save-report-settings-btn').addEventListener('click', () => {
                    const dateFilterMode = document.querySelector('input[name="date-filter-mode"]:checked').value;
                    const startDate = document.getElementById('report-start-date').value;
                    const endDate = document.getElementById('report-end-date').value;

                    // 3. Validación robusta: no guardar si el período está seleccionado pero las fechas están vacías.
                    if (dateFilterMode === 'period' && (!startDate || !endDate)) {
                        showAlert("Por favor, seleccione una fecha de inicio y una de fin para el período.", "warning");
                        return; // Detiene la ejecución
                    }

                    reportSettings.dateFilterMode = dateFilterMode;
                    reportSettings.startDate = startDate;
                    reportSettings.endDate = endDate;

                    showAlert("Configuración de reportes guardada.", "success");
                    updateCharts(); // Actualizar los gráficos inmediatamente después de guardar la nueva configuración.
                    closeModal(reportSettingsModal);
                });
            }

            // 1. Cierre del modal de configuración de reportes al hacer clic fuera.
            if (reportSettingsModal) {
                reportSettingsModal.addEventListener('click', (e) => {
                    if (e.target === reportSettingsModal) {
                        closeModal(reportSettingsModal);
                    }
                });

                // 2. Guardar cambios en el modal de configuración con la tecla "Enter".
                reportSettingsModal.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Prevenir cualquier comportamiento por defecto.
                        document.getElementById('save-report-settings-btn').click();
                    }
                });
            }

            if (closeReportSettingsModalBtn) {
                closeReportSettingsModalBtn.addEventListener('click', () => closeModal(reportSettingsModal));
            }

            if (openTemplateUploaderBtn) {
                openTemplateUploaderBtn.addEventListener('click', () => {
                    closeModal(reportSettingsModal);
                    openModal(templateUploadModal);
                });
            }
            closeTemplateUploadModalBtn.addEventListener('click', () => {
                closeModal(templateUploadModal);
            });

            closeTemplateUploadModalBtn.addEventListener('click', () => closeModal(templateUploadModal));

            document.querySelectorAll('.upload-template-type-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const templateType = e.currentTarget.dataset.templateType;
                    uploadTemplateFile(templateType);
                });
            });

            document.querySelectorAll('input[name="date-filter-mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isPeriod = e.target.value === 'period';
                    const container = document.getElementById('date-range-picker-container');
                    const startDateInput = document.getElementById('report-start-date');
                    const endDateInput = document.getElementById('report-end-date');

                    container.classList.toggle('opacity-50', !isPeriod);
                    startDateInput.disabled = !isPeriod;
                    endDateInput.disabled = !isPeriod;
                });
            });

            document.getElementById('conference-medio').addEventListener('change', (e) => {
                const summaryLabel = document.getElementById('conference-summary-label');
                updateConferenceSummaryLabel(e.target.value, summaryLabel);
            });

            document.getElementById('edit-conference-medio').addEventListener('change', (e) => {
                const summaryLabel = document.getElementById('edit-conference-summary-label');
                updateConferenceSummaryLabel(e.target.value, summaryLabel);
            });

            // --- Event Listeners para el modal de Múltiples Enlaces ---

            function openMultiLinkEditor(targetInput) {
                currentLinkTargetInput = targetInput;
                const existingLinks = (targetInput.value || '').split(';').map(link => link.trim()).filter(link => link);
                renderLinkList(existingLinks);
                openModal(multiLinkModal);
                newLinkInput.focus();
            }

            document.getElementById('manage-links-conference-btn').addEventListener('click', () => {
                openMultiLinkEditor(document.getElementById('conference-source'));
            });

            document.getElementById('manage-links-edit-conference-btn').addEventListener('click', () => {
                openMultiLinkEditor(document.getElementById('edit-conference-source'));
            });

            function renderLinkList(links) {
                linkListContainer.innerHTML = '';
                noLinksMessage.classList.toggle('hidden', links.length > 0);
                links.forEach((link, index) => {
                    const linkElement = document.createElement('div');
                    linkElement.className = 'flex items-center justify-between bg-white p-2 rounded shadow-sm';
                    linkElement.innerHTML = `
                        <span class="text-sm text-gray-800 truncate" title="${link}">${link}</span>
                        <button data-index="${index}" class="remove-link-btn text-red-500 hover:text-red-700 p-1 rounded-full">
                            <i class="fa-solid fa-trash-alt"></i>
                        </button>
                    `;
                    linkListContainer.appendChild(linkElement);
                });
            }

            addLinkBtn.addEventListener('click', () => {
                const newLink = newLinkInput.value.trim();
                if (newLink && isValidUrl(newLink)) {
                    const currentLinks = Array.from(linkListContainer.querySelectorAll('.truncate')).map(span => span.textContent);
                    currentLinks.push(newLink);
                    renderLinkList(currentLinks);
                    newLinkInput.value = '';
                } else {
                    showAlert('Por favor, ingrese un URL válido.', 'warning');
                }
            });

            newLinkInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addLinkBtn.click();
                }
            });

            linkListContainer.addEventListener('click', (e) => {
                if (e.target.closest('.remove-link-btn')) {
                    const button = e.target.closest('.remove-link-btn');
                    const indexToRemove = parseInt(button.dataset.index, 10);
                    let currentLinks = Array.from(linkListContainer.querySelectorAll('.truncate')).map(span => span.textContent);
                    currentLinks.splice(indexToRemove, 1);
                    renderLinkList(currentLinks);
                }
            });

            saveLinksBtn.addEventListener('click', () => {
                const links = Array.from(linkListContainer.querySelectorAll('.truncate')).map(span => span.textContent);
                currentLinkTargetInput.value = links.join('; ');
                closeModal(multiLinkModal);
            });

            cancelLinksBtn.addEventListener('click', () => closeModal(multiLinkModal));

            function uploadTemplateFile(templateType) {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.docx';
                fileInput.style.display = 'none';

                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        requirePassword(async () => {
                            showAlert(`Subiendo plantilla para '${templateType}'...`, "info");
                            const reader = new FileReader();
                            reader.onload = async (event) => {
                                const base64String = event.target.result;
                                try {
                                    const docRef = db.collection('config').doc(`wordTemplate_${templateType}`);
                                    await docRef.set({ templateData: base64String, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                                    showAlert(`¡Plantilla para '${templateType}' actualizada con éxito!`, "success");
                                    closeModal(templateUploadModal); // Cierra el modal de plantillas al terminar
                                } catch (dbError) {
                                    console.error("Error al guardar plantilla en Firestore:", dbError);
                                    showAlert("Error al guardar la plantilla.", "error");
                                }
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                };
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            }

            document.querySelectorAll('#news-summary, #edit-news-summary, #conference-summary, #edit-conference-summary').forEach(el => {
                el.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                    const html = (e.clipboardData || window.clipboardData).getData('text/html') || text;
                    const cleanedHTML = sanitizePastedHtml(html);
                    document.execCommand('insertHTML', false, cleanedHTML);
                });
            });

            newsTableBody.addEventListener('dblclick', (e) => handleRowDoubleClick(e, false));

            historicalTableBody.addEventListener('dblclick', (e) => handleRowDoubleClick(e, true));

            //Eventos de eliminacion de registro

            //Anterior sin delegación de eventos
            //cancelDeleteBtn.addEventListener('click', () => {
              //  closeModal(confirmModal);
                //newsToDeleteId = null;
            //});
            

            //Anterior sin delegacion de eventos
            //confirmDeleteBtn.addEventListener('click', async () => {
              //  if (newsToDeleteId) {
                //    await deleteNews(newsToDeleteId, newsToDeleteIsHistorical);
                  //  closeModal(confirmModal);
              //  }
           // });

            //Listener para cancelar eliminación de registro
            cancelDeleteBtn.addEventListener('click', () => {
                closeModal(confirmModal);
                delete confirmModal.dataset.pendingId;
                delete confirmModal.dataset.pendingIsHistorical;
                newsToDeleteId = null;
            });


        // --- Listener directo y robusto para confirmar eliminación ---
        // Pegar justo después de cancelDeleteBtn.addEventListener('click', ...)
        confirmDeleteBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            // Tomamos el id del dataset del modal (flujo con delegación en handleDeleteClick)
            const pendingId = confirmModal?.dataset?.pendingId;
            const isHist = confirmModal?.dataset?.pendingIsHistorical === 'true';

            if (!pendingId) {
                console.warn('Confirm delete clicked but no pendingId found on modal');
                return;
            }

            try {
                await deleteNews(pendingId, isHist);
            } catch (err) {
                console.error('Error eliminando noticia:', err);
                showAlert('Error al eliminar la noticia.', 'error');
            } finally {
                // limpiar dataset y estado
                delete confirmModal.dataset.pendingId;
                delete confirmModal.dataset.pendingIsHistorical;
                newsToDeleteId = null;
                newsToDeleteIsHistorical = false;
                closeModal(confirmModal);
            }
        });


            historicalFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    importHistoricalBtn.classList.remove('hidden');
                    importHistoricalBtn.disabled = false;
                } else {
                    importHistoricalBtn.classList.add('hidden');
                    importHistoricalBtn.disabled = true;
                }
            });

            // =============================================
            // MÓDULO: Eventos de la Importación de datos históricos (mejorado)
            // =============================================

            importHistoricalBtn.addEventListener('click', () => {
                openModal(importWarningModal);
            });

            cancelImportWarningBtn.addEventListener('click', () => {
                closeModal(importWarningModal);
            });

            confirmImportWarningBtn.addEventListener('click', () => {
                closeModal(importWarningModal);
                // Una vez que el usuario confirma la advertencia, se procede a pedir la contraseña.
                requirePassword(async () => { 
                    const file = historicalFileInput.files[0];
                    if (!file) {
                        showAlert("Por favor, selecciona un archivo Excel primero.", "warning");
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const workbook = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];

                            // --- LÓGICA CORREGIDA (v2): Detección de título y generación de objetos ---
                            const options = {}; // Por defecto, genera objetos usando la primera fila como encabezados.
                            const cellA1 = worksheet['A1'];
                            
                            // Si la celda A1 contiene el título, significa que los encabezados reales están en la fila 2.
                            if (cellA1 && typeof cellA1.v === 'string' && cellA1.v.startsWith('Noticias y Conferencias')) {
                                // Usamos 'range: 1' para indicarle a la librería que ignore la fila 0 (el título)
                                // y use la siguiente fila (la 1, que es la segunda fila) como encabezados.
                                options.range = 1;
                            }
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, options);
                            
                            if (jsonData.length === 0) return showAlert("El archivo no contiene datos válidos.", "warning");

                            const processedData = jsonData.map(row => {
                                const mapKeys = (obj, keyMap) => Object.keys(obj).reduce((acc, key) => {
                                    const newKey = keyMap[key.toLowerCase().trim()] || key.toLowerCase().trim();
                                    acc[newKey] = obj[key];
                                    return acc;
                                }, {});

                                const keyMapping = { 
                                    'no.': 'no', 
                                    'enlace': 'fuente', // Busca 'Enlace' primero
                                    'fuente': 'fuente', // Fallback a 'Fuente'
                                    'fuente de la noticia': 'fuente', // Fallback adicional
                                    'resumen de la noticia': 'resumen',
                                    'noticia': 'comentario', // Busca 'Noticia' primero,
                                    'categoría': 'categoria', // Mapea la versión con acento a la clave sin acento
                                    'título': 'comentario' // Fallback a 'Título'
                                };
                                const mappedRow = mapKeys(row, keyMapping);

                                // Procesamiento robusto de fecha
                                let fecha = mappedRow.fecha;
                                
                                if (fecha instanceof Date) {
                                    // Convertir objeto Date a formato YYYY-MM-DD
                                    const year = fecha.getFullYear();
                                    const month = (fecha.getMonth() + 1).toString().padStart(2, '0');
                                    const day = fecha.getDate().toString().padStart(2, '0');
                                    fecha = `${year}-${month}-${day}`;
                                } else if (typeof fecha === 'number') {
                                    // Convertir serial de Excel a formato YYYY-MM-DD
                                    // Excel cuenta desde 1900-01-01, pero con error en 1900 (no bisiesto)
                                    const excelEpoch = new Date(1900, 0, 1);
                                    const jsDate = new Date(excelEpoch.getTime() + (fecha - 2) * 24 * 60 * 60 * 1000);
                                    const year = jsDate.getFullYear();
                                    const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
                                    const day = jsDate.getDate().toString().padStart(2, '0');
                                    fecha = `${year}-${month}-${day}`;
                                } else if (typeof fecha === 'string') {
                                    // Intentar parsear string en varios formatos
                                    // Formato DD/MM/YYYY
                                    if (fecha.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                                        const [day, month, year] = fecha.split('/');
                                        fecha = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                    } 
                                    // Formato MM/DD/YYYY
                                    else if (fecha.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                                        const [month, day, year] = fecha.split('/');
                                        fecha = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                    }
                                    // Formato YYYY-MM-DD (ya correcto)
                                    else if (fecha.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                                        // Ya está en el formato correcto
                                    }
                                    // Otros formatos - intentar crear fecha
                                    else {
                                        try {
                                            const parsedDate = new Date(fecha);
                                            if (!isNaN(parsedDate)) {
                                                const year = parsedDate.getFullYear();
                                                const month = (parsedDate.getMonth() + 1).toString().padStart(2, '0');
                                                const day = parsedDate.getDate().toString().padStart(2, '0');
                                                fecha = `${year}-${month}-${day}`;
                                            } else {
                                                fecha = '';
                                            }
                                        } catch (e) {
                                            fecha = '';
                                        }
                                    }
                                } else {
                                    fecha = '';
                                }

                                return {
                                    fecha: fecha,
                                    fuente: mappedRow.fuente || '',
                                    proyecto: mappedRow.proyecto || '',
                                    subproyecto: mappedRow.subproyecto || '',
                                    comentario: mappedRow.comentario || '',
                                    cita: mappedRow.cita || '',
                                    resumen: mappedRow.resumen || '',
                                    categoria: mappedRow.categoria || '',
                                    medio: mappedRow.medio || ''
                                };
                            });

                            if (processedData.length === 0) return showAlert("El archivo Excel está vacío o no es válido.", "warning");
                            
                            // La lógica de reemplazo ahora se basa en la confirmación del nuevo modal.
                            // Borra solo las noticias, no las conferencias, antes de importar.
                            if (historicalNews.length > 0) {
                                await deleteNonConferenceHistorical();
                            }
                            await importHistoricalData(processedData);
                            historicalFileInput.value = '';
                            importHistoricalBtn.disabled = true;
                            importHistoricalBtn.classList.add('hidden');
                        
                        } catch (error) {
                            console.error("Error al procesar el archivo:", error);
                            showAlert("Error al procesar el archivo. Asegúrese de que es un Excel válido.", "error");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
            });




            downloadExcelBtn.addEventListener('click', () => {
                const dataToExport = prepareExportData(applyAllFilters(news, 'main'));
                const sheetName = "Noticias y Conferencias";
                const timestamp = getFormattedTimestamp();
                const fileName = `Resumen de Noticias y Conferencias - ${timestamp}.xlsx`;
                exportToExcelWithFormatting(dataToExport, sheetName, fileName);
            });
            
            document.getElementById('download-historical-excel-btn').addEventListener('click', () => {
                const filteredData = applyAllFilters(historicalNews, 'historical');
                const dataToExport = prepareExportData(filteredData);
                const sheetName = "Histórico de Noticias";
                const timestamp = getFormattedTimestamp();
                const fileName = `Resumen de Noticias y Conferencias Históricas - ${timestamp}.xlsx`;
                exportToExcelWithFormatting(dataToExport, sheetName, fileName);
            });
            
            // Limpiar el src al cerrar para detener la carga y liberar recursos
            closeWebviewBtn.addEventListener('click', () => {
                webviewFrame.src = 'about:blank';
                closeModal(webviewModal);
            });

            // --- FIN: Lógica para Migración ---

            // Mejora: Cerrar el modal de webview al hacer clic en el fondo
            webviewModal.addEventListener('click', (e) => {
                if (e.target === webviewModal) {
                    closeModal(webviewModal);
                }
            });

            document.getElementById('view-all-details-main-btn').addEventListener('click', () => {
                showMultiDetailsModal(false);
            });

            document.getElementById('view-all-details-historical-btn').addEventListener('click', () => {
                showMultiDetailsModal(true);
            });

            closeMultiDetailsModalBtn.addEventListener('click', () => closeModal(multiDetailsModal));
            closeDetailsModalBtn.addEventListener('click', () => closeModal(viewDetailsModal));

            // Mejora: Cerrar el modal de detalles múltiples al hacer clic en el fondo
            multiDetailsModal.addEventListener('click', (e) => {
                if (e.target === multiDetailsModal) {
                    closeModal(multiDetailsModal);
                }
            });

            // Listener para los botones de descarga en el modal de múltiples detalles
            multiDetailsContentContainer.addEventListener('click', e => {
                const target = e.target.closest('.generate-doc-btn');
                if (!target) return;
                handleGenerateDocClick(target);
            });

            // Mejora: Cerrar el modal de detalles al hacer clic en el fondo
            viewDetailsModal.addEventListener('click', (e) => {
                if (e.target === viewDetailsModal) {
                    closeModal(viewDetailsModal);
                }
            });

            // Listeners para los nuevos botones de limpiar filtros
            document.getElementById('clear-all-filters-main-btn').addEventListener('click', () => {
                clearAllMainFilters();
            });

            document.getElementById('clear-all-filters-historical-btn').addEventListener('click', () => {
                clearAllHistoricalFilters();
            });
            
            // Listeners para los nuevos botones de descarga de tablas de reportes
            document.getElementById('download-dynamic-table-excel-btn').addEventListener('click', () => {
                const variable = document.getElementById('dynamic-chart-variable').value;
                const fileName = `Reporte_Distribucion_por_${variable}.xlsx`;
                exportTableToExcel('dynamic-distribution-news-table', 'Distribución', fileName);
            });

            document.getElementById('download-project-category-table-excel-btn').addEventListener('click', () => {
                const fileName = `Reporte_Detallado_por_Categoria.xlsx`;
                exportTableToExcel('projectCategoryTable', 'Detalle por Categoría', fileName);
            });

            document.getElementById('download-total-news-type-table-excel-btn').addEventListener('click', () => {
                const fileName = `Reporte_Total_Registros_por_Tipo.xlsx`;
                exportTableToExcel('totalNewsByTypeTable', 'Total por Tipo', fileName);
            });

            document.getElementById('totalNewsByTypeTableBody').addEventListener('click', e => {
                const cell = e.target.closest('td');
                if (!cell || !cell.classList.contains('clickable-cell')) return;

                const { filterVariable, filterValue } = cell.dataset;
                const targetTab = reportesDataSource.value;

                if (filterVariable && filterValue) {
                    navigateAndFilter(targetTab, { [filterVariable]: [filterValue] });
                }
            });
        }

        // =============================================
        // DELEGACIÓN CENTRALIZADA DE EVENTOS (AQUÍ PONDRE LAS FUNCIONES)
        // =============================================

        /**
        * Configura la delegación global de eventos para elementos dinámicos.
        * Esta función se llama una sola vez al inicio.
        */
        function setupGlobalEventDelegation() {

        // === Delegación para cambios en checkboxes (migración) ===
        document.addEventListener('change', function(e) {
            const target = e.target;

            // Caso 1: Checkbox de noticias principales
            if (target.classList.contains('news-migration-checkbox')) {
            const newsId = target.dataset.id;
            if (target.checked) {
                selectedNewsIdsToMigrate.add(newsId);
            } else {
                selectedNewsIdsToMigrate.delete(newsId);
            }

            // Actualizar botón de migración
            const confirmBtn = document.getElementById('confirm-migration-btn');
            if (confirmBtn) {
                confirmBtn.disabled = selectedNewsIdsToMigrate.size === 0;
            }

            // Sincronizar "Seleccionar todos"
            const selectAllCheckbox = document.getElementById('select-all-news-checkbox');
            if (selectAllCheckbox) {
                const visibleCheckboxes = document.querySelectorAll('#news-table-body .news-migration-checkbox');
                const totalVisible = visibleCheckboxes.length;
                const totalChecked = selectedNewsIdsToMigrate.size;

                selectAllCheckbox.checked = totalVisible > 0 && totalChecked === totalVisible;
                selectAllCheckbox.indeterminate = totalChecked > 0 && totalChecked < totalVisible;
            }

            return;
            }

            // Caso 3: Checkbox "Seleccionar Todo" de noticias principales
            if (target.id === 'select-all-news-checkbox') {
                const isChecked = target.checked;
                const visibleCheckboxes = document.querySelectorAll('#news-table-body .news-migration-checkbox');
                
                visibleCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                    const newsId = checkbox.dataset.id;
                    if (isChecked) {
                        selectedNewsIdsToMigrate.add(newsId);
                    } else {
                        selectedNewsIdsToMigrate.delete(newsId);
                    }
                });

                const confirmBtn = document.getElementById('confirm-migration-btn');
                if(confirmBtn) confirmBtn.disabled = selectedNewsIdsToMigrate.size === 0;
                return;
            }

            // Caso 4: Checkbox "Seleccionar Todo" de noticias históricas
            if (target.id === 'select-all-historical-news-checkbox') {
                const isChecked = target.checked;
                const visibleCheckboxes = document.querySelectorAll('#historical-table-body .historical-news-migration-checkbox');
                
                visibleCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                    const newsId = checkbox.dataset.id;
                    isChecked ? selectedHistoricalNewsIdsToMigrate.add(newsId) : selectedHistoricalNewsIdsToMigrate.delete(newsId);
                });

                const confirmBtn = document.getElementById('confirm-reverse-migration-btn');
                if(confirmBtn) confirmBtn.disabled = selectedHistoricalNewsIdsToMigrate.size === 0;
                return;
            }

            // Caso 2: Checkbox de noticias históricas
            if (target.classList.contains('historical-news-migration-checkbox')) {
            const newsId = target.dataset.id;
            if (target.checked) {
                selectedHistoricalNewsIdsToMigrate.add(newsId);
            } else {
                selectedHistoricalNewsIdsToMigrate.delete(newsId);
            }

            // Actualizar botón de reversión
            const confirmBtn = document.getElementById('confirm-reverse-migration-btn');
            if (confirmBtn) {
                confirmBtn.disabled = selectedHistoricalNewsIdsToMigrate.size === 0;
            }

            // Sincronizar "Seleccionar todos" del historial
            const selectAllCheckbox = document.getElementById('select-all-historical-news-checkbox');
            if (selectAllCheckbox) {
                const visibleCheckboxes = document.querySelectorAll('#historical-table-body .historical-news-migration-checkbox');
                const totalVisible = visibleCheckboxes.length;
                const totalChecked = selectedHistoricalNewsIdsToMigrate.size;

                selectAllCheckbox.checked = totalVisible > 0 && totalChecked === totalVisible;
                selectAllCheckbox.indeterminate = totalChecked > 0 && totalChecked < totalVisible;
            }

            return;
            }
        });

        // === Delegación para clics en botones y elementos interactivos ===
        // === Delegación para celdas clickeables en reportes ===
        document.addEventListener('click', function(e) {
            const target = e.target;
            const button = target.closest('button'); // Encuentra el botón más cercano
            if (!button) return; // Si no se hizo clic en un botón, salimos

            const id = button.id;

            // --- Botones de Migración ---
            if (id === 'start-migration-btn') {
                toggleMigrationMode(true);
                return;
            }
            if (id === 'cancel-migration-btn') {
                toggleMigrationMode(false);
                return;
            }
            if (id === 'confirm-migration-btn') {
                if (selectedNewsIdsToMigrate.size > 0) {
                    requirePassword(async () => {
                        await migrateSelectedNewsToHistorical();
                    });
                }
                return;
            }

            // --- Botones de Migración Inversa ---
            if (id === 'start-reverse-migration-btn') {
                toggleReverseMigrationMode(true);
                return;
            }
            if (id === 'cancel-reverse-migration-btn') {
                toggleReverseMigrationMode(false);
                return;
            }
            if (id === 'confirm-reverse-migration-btn') {
                if (selectedHistoricalNewsIdsToMigrate.size > 0) {
                    requirePassword(async () => {
                        await migrateSelectedNewsToRegistry();
                    });
                }
                return;
            }

            // --- Botón de configuración de reportes ---
            if (id === 'report-settings-btn') {
                // Cargar la configuración actual en el modal antes de abrirlo
                document.querySelector(`input[name="date-filter-mode"][value="${reportSettings.dateFilterMode}"]`).checked = true;
                const startDateInput = document.getElementById('report-start-date');
                const endDateInput = document.getElementById('report-end-date');
                const dateContainer = document.getElementById('date-range-picker-container');

                startDateInput.value = reportSettings.startDate;
                endDateInput.value = reportSettings.endDate;

                if (reportSettings.dateFilterMode === 'period') {
                    dateContainer.classList.remove('opacity-50');
                    startDateInput.disabled = false;
                    endDateInput.disabled = false;
                } else {
                    dateContainer.classList.add('opacity-50');
                    startDateInput.disabled = true;
                    endDateInput.disabled = true;
                }

                openModal(reportSettingsModal);
                return;
            }

        });


        // === Delegación para celdas clickeables en reportes ===
        document.addEventListener('click', function(e) {
             const cell = e.target.closest('td.clickable-cell');
             if (!cell) return;
 
             // Extraer todos los posibles datos de filtro de la celda
             const { filterVariable, filterValue, filterCategory } = cell.dataset;
             const filtersToApply = {};
             const dataSourceSelect = document.getElementById('reportes-data-source');
             if (!dataSourceSelect) return;
             const targetTab = dataSourceSelect.value;
 
             // Construir el objeto de filtros combinando los datos disponibles
             if (filterVariable && filterValue && filterValue !== 'Total') {
                 filtersToApply[filterVariable] = [filterValue];
             }
             if (filterCategory) {
                 filtersToApply['categoria'] = [filterCategory];
             }
 
             if (Object.keys(filtersToApply).length > 0 && targetTab) {
                 navigateAndFilter(targetTab, filtersToApply);
             }
        });

        // === Doble clic en filas para vista rápida ===
        document.addEventListener('dblclick', function(e) {
            const row = e.target.closest('tr[data-quickview="true"]');
            if (!row) return;

            const isHistorical = row.closest('tbody')?.id === 'historical-table-body';
            handleRowDoubleClick(e, isHistorical);
        });
        }

        // =============================================
        // MÓDULO: Inicialización
        // =============================================

        document.addEventListener('DOMContentLoaded', () => {
            // Asignar elementos del DOM una vez que la página esté cargada
            loader = document.getElementById('loader');
            appContainer = document.getElementById('app');
            userInfo = document.getElementById('user-info');
            tabsContainer = document.getElementById('tabs');
            tabContents = document.querySelectorAll('.tab-content'); // Ya existe
            addNewsBtn = document.getElementById('add-news-btn');
            downloadExcelBtn = document.getElementById('download-excel-btn'); // Ya existe
            newsTableBody = document.getElementById('news-table-body');
            noNewsMessage = document.getElementById('no-news-message');
            historicalTableBody = document.getElementById('historical-table-body');
            noHistoricalMessage = document.getElementById('no-historical-message');
            historicalFileInput = document.getElementById('historical-file-input');
            historicalFileName = document.getElementById('file-name');
            importHistoricalBtn = document.getElementById('import-historical-btn');
            reportesDataSource = document.getElementById('reportes-data-source');
            dynamicChartCanvas = document.getElementById('dynamicChart');
            dynamicChartVariable = document.getElementById('dynamic-chart-variable');
            toggleLabelsBtn = document.getElementById('toggle-labels-btn');
            dynamicTableBody = document.getElementById('dynamic-table-body');
            dynamicTableHeader = document.getElementById('dynamic-table-header');
            newsModal = document.getElementById('news-modal');
            newsForm = document.getElementById('news-form');
            closeModalBtn = document.getElementById('close-modal-btn');
            editModal = document.getElementById('edit-modal');
            editForm = document.getElementById('edit-form');
            closeEditModalBtn = document.getElementById('close-edit-modal-btn');
            confirmModal = document.getElementById('confirm-modal');
            cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            replaceHistoricalModal = document.getElementById('replace-historical-modal');
            cancelReplaceBtn = document.getElementById('cancel-replace-btn');
            confirmReplaceBtn = document.getElementById('confirm-replace-btn');
            editOptionModal = document.getElementById('edit-option-modal');
            editOptionInput = document.getElementById('edit-option-input');
            cancelEditOptionBtn = document.getElementById('cancel-edit-option-btn');
            confirmEditOptionBtn = document.getElementById('confirm-edit-option-btn');
            passwordModal = document.getElementById('password-modal');
            passwordInput = document.getElementById('password-input');
            cancelPasswordBtn = document.getElementById('cancel-password-btn');
            confirmPasswordBtn = document.getElementById('confirm-password-btn');
            webviewFrame = document.getElementById('webview-frame');
            closeWebviewBtn = document.getElementById('close-webview-btn');
            uploadTemplateBtn = document.getElementById('upload-template-btn');
            viewDetailsModal = document.getElementById('view-details-modal');
            templateUploadModal = document.getElementById('template-upload-modal');
            closeTemplateUploadModalBtn = document.getElementById('close-template-upload-modal-btn');
            closeDetailsModalBtn = document.getElementById('close-details-modal-btn');
            detailsModalContent = document.getElementById('details-modal-content');
            addConferenceBtn = document.getElementById('add-conference-btn');
            conferenceModal = document.getElementById('conference-modal');
            conferenceForm = document.getElementById('conference-form');
            closeConferenceModalBtn = document.getElementById('close-conference-modal-btn');
            editConferenceModal = document.getElementById('edit-conference-modal');
            editConferenceForm = document.getElementById('edit-conference-form');
            closeEditConferenceModalBtn = document.getElementById('close-edit-conference-modal-btn');
            multiLinkModal = document.getElementById('multi-link-modal');
            newLinkInput = document.getElementById('new-link-input');
            addLinkBtn = document.getElementById('add-link-btn');
            linkListContainer = document.getElementById('link-list-container');
            noLinksMessage = document.getElementById('no-links-message');
            cancelLinksBtn = document.getElementById('cancel-links-btn');
            multiDetailsModal = document.getElementById('multi-details-modal');
            closeMultiDetailsModalBtn = document.getElementById('close-multi-details-modal-btn');
            multiDetailsContentContainer = document.getElementById('multi-details-content-container');
            saveLinksBtn = document.getElementById('save-links-btn');

            importWarningModal = document.getElementById('import-warning-modal');
            cancelImportWarningBtn = document.getElementById('cancel-import-warning-btn');
            confirmImportWarningBtn = document.getElementById('confirm-import-warning-btn');
            quickViewTooltip = document.getElementById('quick-view-tooltip');
            webviewModal = document.getElementById('webview-modal');
            reportSettingsModal = document.getElementById('report-settings-modal'); // Ya existe
            closeReportSettingsModalBtn = document.getElementById('close-report-settings-modal-btn'); // Ya existe
            openTemplateUploaderBtn = document.getElementById('open-template-uploader-btn'); // Ya existe
            reportSettingsBtn = document.getElementById('report-settings-btn'); // Ya existe

            projectCategoryChart = document.getElementById('projectCategoryChart');
            // Nuevas referencias para los botones de migración
            charts.totalNewsByType = null; // Inicializar la referencia al nuevo chart

            const confirmMigrationBtn = document.getElementById('confirm-migration-btn');
            const cancelMigrationBtn = document.getElementById('cancel-migration-btn');
            const selectAllNewsCheckbox = document.getElementById('select-all-news-checkbox');
            const startReverseMigrationBtn = document.getElementById('start-reverse-migration-btn');
            const confirmReverseMigrationBtn = document.getElementById('confirm-reverse-migration-btn');
            const cancelReverseMigrationBtn = document.getElementById('cancel-reverse-migration-btn');
            const selectAllHistoricalNewsCheckbox = document.getElementById('select-all-historical-news-checkbox');


            // Inicializar la autenticación y los listeners
            initializeAppWithAuth();
            setupEventListeners();
            setupGlobalEventDelegation();
            setupMediosDashboardFilter();

            // Configurar Select2 para los selects
            $('#news-project, #news-subproject, #news-category, #news-medio, #edit-news-project, #edit-news-subproject, #edit-news-category, #edit-news-medio').each(function() {
                 $(this).select2({
                     tags: true,
                     placeholder: "Seleccione o escriba una opción",
                     allowClear: true,
                     width: '100%'
                 });
             });
            
            // Poblar el select de medio en el modal de edición de conferencia
            populateConferenceMedioSelect('edit-conference-medio');

            // Mejora de UX: Auto-foco en el buscador de Select2 al abrirlo.
            $(document).on('select2:open', () => {
                // Usamos un pequeño timeout para asegurar que el campo de búsqueda ya es visible.
                setTimeout(() => document.querySelector('.select2-search__field').focus(), 50);
            });
            
             // Set current date as default
             const today = new Date().toISOString().split('T')[0];
             document.getElementById('news-date').value = today;
        });

        // Iniciar la aplicación
        // La inicialización ahora ocurre dentro del listener DOMContentLoaded

    </script>
</body>  
</html> 
